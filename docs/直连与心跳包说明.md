# 直连与心跳包说明

## 为什么直连收不到心跳包？

### 设备的双Socket架构

USR-WIFI232-B2 模块有两个独立的通信通道：

```
┌─────────────────────────────────────────────────────────┐
│              USR-WIFI232-B2 WiFi模块                      │
│                                                           │
│  ┌──────────────────────┐      ┌─────────────────────┐  │
│  │   Socket A           │      │   Socket B          │  │
│  │   (TCP Client)       │      │   (TCP Server)      │  │
│  │                      │      │                     │  │
│  │ • 主动连接服务器      │      │ • 监听端口18899      │  │
│  │ • 发送心跳包(10s)    │      │ • 被动等待连接       │  │
│  │ • 上报设备数据        │      │ • 命令-响应模式      │  │
│  │ • 接收服务器命令      │      │ • 不发送心跳包       │  │
│  └──────────────────────┘      └─────────────────────┘  │
│           ↓                              ↑               │
│      连接到 Go TCP            浏览器通过桥接连接           │
│      服务器(2024)                (18900→18899)           │
└─────────────────────────────────────────────────────────┘
```

### 核心原因

**Socket B（直连端口）不发送心跳包，只响应命令！**

- **Socket A**：设备作为客户端，主动连接到 Go TCP 服务器，每 10 秒发送一次心跳包
- **Socket B**：设备作为服务器，被动等待连接，只处理收到的命令并返回响应

心跳包的格式：
```
AA 00 0E 01 32 30 42 33 36 32 35 34 1D BE 55
│  │  │  │  └──────────────┬──────────────┘
│  │  │  │                设备序列号(ASCII)
│  │  │  └── 命令码 0x01 (心跳)
│  └──┴── 长度 0x000E (14字节)
└── 帧头 0xAA
```

## 如何与设备通信？

### 方案1：发送查询命令（推荐）

通过直连发送查询命令，设备会立即响应：

#### 在测试页面操作：
1. 确保已保存桥接地址：`ws://127.0.0.1:18900`
2. 输入设备ID并连接
3. 选择"十六进制 (HEX)"格式
4. 输入查询命令（根据设备序列号调整）：
   - `AA010541564B0615` - 查询01号设备
   - `AA0A0541564B0615` - 查询10号(0a)设备（注意：不同序列号可能需要不同CRC）
5. 点击"发送命令"
6. 在"接收日志"中查看设备响应

#### 命令说明：
```
AA 01 05 41 56 4B 06 15
│  │  │  └──┴──┘ └──┴──┘
│  │  │    "AVK"   CRC16校验
│  │  └── 长度 0x05
│  └── 设备序列号 (01-FF)
└── 帧头 0xAA
```

### 方案2：在控制台测试

打开浏览器控制台(F12)，输入：

```javascript
// 连接到桥接服务
const ws = new WebSocket('ws://127.0.0.1:18900');

ws.onopen = () => {
  console.log('✅ 已连接到设备');
  
  // 发送查询命令（01号设备，包含CRC）
  const hexCmd = "AA010541564B0615";
  const bytes = new Uint8Array(
    hexCmd.match(/.{1,2}/g).map(b => parseInt(b, 16))
  );
  ws.send(bytes.buffer);
  console.log('📤 已发送查询命令:', hexCmd);
};

ws.onmessage = (event) => {
  if (event.data instanceof Blob) {
    event.data.arrayBuffer().then(buffer => {
      const hex = Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join(' ');
      console.log('📥 收到设备响应:', hex);
    });
  }
};

ws.onerror = (error) => {
  console.error('❌ 连接错误:', error);
};
```

### 方案3：监听心跳包（通过服务器）

如果需要监听设备的心跳包和主动上报数据，需要查看 Go TCP 服务器的日志：

```powershell
# 1. 进入 Go TCP 服务所在目录
cd E:\test2\wire2\wire\cmd\pomo

# 2. 查看日志（如果有日志文件）
Get-Content -Path "tcp_server.log" -Tail 50 -Wait

# 或者查看控制台输出（如果服务在前台运行）
```

心跳包会显示为：
```
recv cmd=0x01 len=8
client: 192.168.2.10:xxxx
data: AA 00 0E 01 32 30 42 33 36 32 35 34 1D BE 55
```

## 各种通信方式对比

| 通信方式 | 使用场景 | 优点 | 缺点 |
|---------|---------|------|------|
| **Socket A → Go服务器** | 设备主动上报数据、心跳 | • 可接收心跳包<br>• 可接收设备主动数据<br>• 稳定可靠 | • 需要Go服务器运行<br>• 延迟稍高 |
| **Socket B ← 浏览器直连** | 快速发送命令、查询数据 | • 延迟低<br>• 直接通信<br>• 响应快 | • 无心跳包<br>• 无主动数据<br>• 仅命令-响应 |
| **PHP API（通过Go服务器）** | 后台管理、数据查询 | • 统一管理<br>• 权限控制<br>• 数据记录 | • 延迟最高<br>• 需要完整服务 |

## 实际应用建议

### 场景1：设备状态监控
**推荐方式**：查看 Go TCP 服务器日志或后台管理页面
- 可以看到心跳包
- 可以看到设备主动上报的数据
- 数据会被记录到数据库

### 场景2：快速控制设备
**推荐方式**：使用直连测试页面
- 发送运行/停止/复位命令
- 查询设备参数
- 低延迟响应

### 场景3：调试和测试
**推荐方式**：直连测试页面 + 控制台
- 实时查看命令和响应
- 十六进制格式便于调试
- 可以快速验证协议

## 常见问题

### Q1: 为什么设计成双Socket？
**A**: 
- Socket A 用于设备主动上报（心跳、数据），保持长连接
- Socket B 用于客户端快速命令，减少服务器负载
- 两者互不干扰，提高系统可靠性

### Q2: 能让 Socket B 也发送心跳包吗？
**A**: 
理论上可以，但需要：
1. 修改设备固件配置（如果模块支持）
2. 或在模块配置中设置 Socket B 的"心跳包功能"
3. 但这违背了 Socket B 作为命令通道的设计初衷

### Q3: 直连能收到什么数据？
**A**: 
只能收到你发送命令后的响应，包括：
- 查询命令的返回值
- 设置命令的确认信息
- 控制命令的执行状态

### Q4: 如何确认设备在线？
**A**: 
1. **通过直连**：发送查询命令，有响应说明在线
2. **通过后台**：查看设备管理页面的"最后在线时间"
3. **通过日志**：查看 Go TCP 服务器是否收到心跳包

## 测试步骤（完整流程）

### 1. 启动所有服务
```powershell
cd E:\test2\wire2\wire\scripts
.\start_all.ps1
```

### 2. 打开测试页面
访问：http://127.0.0.1:8000/static/admin/#/dev/direct-test

### 3. 配置桥接地址
- 输入：`ws://127.0.0.1:18900`
- 点击"保存"

### 4. 连接设备
- 输入设备ID（例如：1）
- 点击"连接设备"
- 确认状态显示"局域网直连"

### 5. 发送测试命令
- 选择"十六进制 (HEX)"
- 点击"查询(01)"快捷按钮
- 或手动输入：`aa010541564B`
- 点击"发送命令"

### 6. 查看响应
在"接收日志"中应该看到类似：
```
[HEX] aa 00 xx 02 55 01 xx 50 02 ...
```

这表示设备已响应查询命令！

## 总结

- **直连不会收到心跳包，这是正常的设计**
- **发送查询命令可以验证设备在线并获取数据**
- **需要监听心跳包请查看 Go TCP 服务器日志**
- **直连的优势是低延迟的命令-响应通信**

