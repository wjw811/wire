# 🧪 设备直连功能测试指南

## 📍 测试页面地址

访问测试页面：
```
http://127.0.0.1:8000/static/admin/#/dev/direct-test
```

或通过菜单导航：
```
管理后台 → 设备管理 → 设备直连测试
```

---

## 🔧 测试前准备

### 1. 确认系统运行
- ✅ PHP服务器已启动
- ✅ Redis已运行
- ✅ MySQL已运行

### 2. 获取测试设备ID
从设备管理页面查看设备ID，或使用现有的设备ID（如：1）

### 3. WiFi模块配置（可选）
如果要测试真实直连功能，需要先配置WiFi232-B2模块。
暂时不配置的话，系统会自动降级到服务器模式。

---

## 📝 测试步骤

### 测试1：基础连接测试

#### 步骤：
1. 打开测试页面
2. 在"设备ID"输入框输入：`1`（或你的设备ID）
3. 点击"连接设备"按钮
4. 观察连接状态

#### 预期结果：

**情况A - WiFi模块未配置（预期）**:
```
连接状态: 🟢 服务器模式
设备ID: 1
连接模式: 通过服务器
设备IP: - (或显示IP但连接失败)
错误信息: 无
```

日志显示：
```
[info] 开始连接设备 ID: 1
[info] 尝试直连模式...
[info] 直连测试超时（或失败）
[info] 直连失败，降级到服务器模式
[success] 连接成功 - 模式: 通过服务器
```

**情况B - WiFi模块已正确配置**:
```
连接状态: 🔵 直连模式 (蓝色闪烁)
设备ID: 1
连接模式: 局域网直连
设备IP: 192.168.1.xxx
错误信息: 无
```

日志显示：
```
[info] 开始连接设备 ID: 1
[info] 尝试直连模式...
[info] 直连测试成功
[success] 直连建立成功
[success] 连接成功 - 模式: 局域网直连
```

---

### 测试2：命令发送测试

#### 步骤：
1. 确保已连接设备
2. 在"命令数据"文本框输入：
```json
{"type": "test", "action": "ping"}
```
3. 点击"发送命令"按钮

#### 预期结果：

**直连模式**:
```
[success] 命令已发送(直连): {"type": "test", "action": "ping"}
```

**服务器模式**:
```
[warning] 需要通过API发送: {"type": "test", "action": "ping"}
```

---

### 测试3：数据接收测试

#### 步骤：
1. 保持连接状态
2. 观察日志窗口

#### 预期结果：
如果设备有数据返回，日志会显示：
```
[data] 收到数据: {...设备返回的数据...}
```

---

### 测试4：断开重连测试

#### 步骤：
1. 点击"断开连接"按钮
2. 观察连接状态变为"未连接"
3. 再次点击"连接设备"
4. 验证能否重新连接

#### 预期结果：
```
[info] 已断开连接
[info] 状态变化: 未连接 - 未连接

[info] 开始连接设备 ID: 1
[success] 连接成功 - 模式: 通过服务器 (或直连模式)
```

---

## 🐛 常见问题排查

### 问题1：页面无法访问

**现象**：访问测试页面显示404或空白

**排查**：
1. 确认URL正确：`http://127.0.0.1:8000/static/admin/#/dev/direct-test`
2. 清除浏览器缓存（Ctrl+Shift+Delete）
3. 强制刷新页面（Ctrl+F5）
4. 检查PHP服务器是否运行：
```powershell
# 在 wire 目录下
Get-Process php
```

**解决**：
```powershell
# 重启服务器
cd wire
php -S 127.0.0.1:8000 router.php
```

---

### 问题2：连接设备时报错

**现象**：点击连接后显示错误

**排查**：
1. 检查设备ID是否存在
2. 查看浏览器控制台（F12）的错误信息
3. 检查Redis是否运行：
```powershell
redis-cli ping
# 应返回 PONG
```

**解决**：
- 确认设备ID正确
- 重启Redis服务
- 查看后端日志：`wire/logs/frontend.err`

---

### 问题3：无法获取设备IP

**现象**：设备IP显示为 "-" 或空

**原因**：
1. 设备从未连接到服务器（Socket A未工作）
2. Redis缓存已过期（1小时）
3. 设备认证失败

**排查**：
```powershell
# 检查Redis中是否有设备IP记录
redis-cli
> keys gw:ip:*
> get gw:ip:1
```

**解决**：
1. 确保设备已通过Socket A连接到服务器
2. 让设备重新认证（重启设备或等待心跳）
3. 手动在Redis中设置（仅测试用）：
```powershell
redis-cli
> set gw:ip:1 "192.168.1.100" EX 3600
```

---

### 问题4：直连测试一直超时

**现象**：显示"直连测试超时"，然后降级到服务器模式

**原因**：
- WiFi模块Socket B未配置或未启动
- 端口18899被占用或防火墙阻止
- 设备不在同一局域网

**排查**：
1. 测试端口连通性：
```powershell
# 假设设备IP是 192.168.1.100
Test-NetConnection -ComputerName 192.168.1.100 -Port 18899
```

2. 检查防火墙：
```powershell
# 查看防火墙规则
Get-NetFirewallRule | Where-Object {$_.LocalPort -eq 18899}
```

**解决**：
1. 参考 `WiFi232_B2_配置指南.md` 配置WiFi模块
2. 关闭防火墙或添加规则
3. 确认设备和电脑在同一网络

---

### 问题5：浏览器控制台报错

**现象**：F12控制台显示红色错误

**常见错误及解决**：

#### 错误1：`WebSocket connection failed`
```
[DirectConnection] 连接错误: WebSocket connection failed
```
**原因**：无法连接到设备的18899端口  
**解决**：检查WiFi模块配置和网络连通性

#### 错误2：`API request failed`
```
Request failed with status code 500
```
**原因**：后端API错误  
**解决**：查看 `wire/logs/frontend.err` 日志

#### 错误3：`Cannot read property of undefined`
```
TypeError: Cannot read property 'localIP' of undefined
```
**原因**：API返回数据格式错误  
**解决**：检查后端 `localInfo` 接口

---

## 🎯 测试检查清单

### 基础功能测试
- [ ] 页面能正常访问
- [ ] 能输入设备ID
- [ ] 点击连接按钮有响应
- [ ] 连接状态正确显示
- [ ] 能断开连接

### 服务器模式测试（无需WiFi模块）
- [ ] 自动降级到服务器模式
- [ ] 显示🟢绿色"服务器模式"
- [ ] 日志正确记录连接过程
- [ ] 能发送命令（显示warning）

### 直连模式测试（需要WiFi模块）
- [ ] 能检测到设备IP
- [ ] 直连测试通过
- [ ] WebSocket连接成功
- [ ] 显示🔵蓝色"直连模式"
- [ ] 能通过WebSocket发送命令
- [ ] 能接收设备返回数据
- [ ] 断线自动重连

### UI功能测试
- [ ] 命令输入框正常
- [ ] JSON格式验证
- [ ] 日志显示彩色分类
- [ ] 自动滚动功能
- [ ] 清空日志功能
- [ ] 清空命令功能

---

## 📊 测试报告模板

```markdown
## 测试环境
- 测试日期: 2025-10-20
- 设备ID: 1
- 设备IP: 192.168.1.xxx (或 -)
- WiFi模块已配置: 是 / 否

## 测试结果
- [ ] 页面访问: ✅通过 / ❌失败
- [ ] 设备连接: ✅通过 / ❌失败
- [ ] 连接模式: 🔵直连 / 🟢服务器 / ❌错误
- [ ] 命令发送: ✅通过 / ❌失败
- [ ] 数据接收: ✅通过 / ❌失败 / ⏸️未测试
- [ ] 断开重连: ✅通过 / ❌失败

## 问题记录
1. [问题描述]
   - 现象: ...
   - 错误信息: ...
   - 解决方案: ...

## 备注
...
```

---

## 📞 获取帮助

1. **查看文档**：
   - `../x/admin/DIRECT_CONNECTION_USAGE.md` - 开发文档
   - `WiFi232_B2_配置指南.md` - 模块配置
   - `直连功能实施总结.md` - 功能概述

2. **查看日志**：
   - 浏览器控制台（F12）
   - `wire/logs/frontend.err`
   - `wire/logs/frontend.out`

3. **测试命令**：
```powershell
# 测试Redis
redis-cli ping

# 测试设备端口
Test-NetConnection -ComputerName [设备IP] -Port 18899

# 查看进程
Get-Process php
Get-Process redis-server
```

---

**祝测试顺利！** 🎉

如果遇到问题，请按照上述排查步骤逐一检查。






























