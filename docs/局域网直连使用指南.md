# 局域网直连使用指南

## 🎯 功能概述

现在系统支持在登录管理后台后，**自动通过局域网直连获取设备数据**，就像之前通过服务器模式一样，但延迟更低、响应更快！

### 核心特性
- ✅ **自动连接**：登录后进入仪表盘，自动连接所有设备
- ✅ **多设备支持**：可同时直连多个设备
- ✅ **可视化状态**：显示"直连"标签标识连接模式
- ✅ **自动降级**：直连失败时自动使用服务器模式
- ✅ **实时数据**：通过WebSocket获取设备实时数据

## 🚀 快速开始

### 步骤1：启动桥接服务

确保 WebSocket 桥接服务正在运行：

```powershell
# 检查桥接服务是否运行
netstat -ano | findstr :18900

# 如果没有运行，启动桥接服务
cd E:\test2\wire2\wire\scripts
.\start_bridge.ps1
```

### 步骤2：配置桥接地址（首次使用）

1. 登录管理后台
2. 进入 **设备管理 → 直连测试** 页面
3. 在"桥接地址"输入框输入：`ws://127.0.0.1:18900`
4. 点击"保存"按钮

**注意**：此配置会保存在浏览器 localStorage 中，只需配置一次。

### 步骤3：返回仪表盘

1. 点击左侧菜单"仪表盘 → 分析页"
2. 等待2-3秒，系统会自动连接设备
3. 成功连接的设备会显示蓝色"直连"标签

## 📊 仪表盘使用

### 查看设备状态

登录后进入仪表盘，每个设备卡片显示：

```
┌─────────────────────────────────────┐
│ 设备01         20:30:45  [直连] ⚠  │  ← 直连标签
├─────────────────────────────────────┤
│ 电压: 220 V                         │
│ 电流: 5.2 A                         │
│ 功率: 1144 W                        │
│ ...                                 │
├─────────────────────────────────────┤
│  ▶ 启动   ⏻ 停止   ↻ 复位   ⚙ 参数 │
└─────────────────────────────────────┘
```

### 连接模式标识

- **🔵 直连标签**：通过局域网WebSocket直连
- **无标签**：通过服务器模式（Go TCP）
- **⚠ 警告图标**：设备有告警

### 实时数据更新

- 直连模式下，数据通过WebSocket实时推送
- 无需手动刷新，自动更新显示
- 延迟低至几十毫秒

## 🔧 设备控制

### 控制命令

仪表盘支持的设备控制（直连模式优先）：

1. **▶ 启动**：发送运行命令到设备
2. **⏻ 停止**：发送停止命令到设备
3. **↻ 复位**：发送复位命令到设备
4. **⚙ 参数**：打开参数设置对话框

**工作原理**：
- 如果设备是直连模式，命令直接通过WebSocket发送
- 如果是服务器模式，通过API发送到后端

## 🔍 调试与监控

### 查看连接日志

打开浏览器开发者工具（F12），查看控制台：

```
[DevBox] 正在初始化设备直连...
[DeviceManager] Device 1 connected
[DevBox] 设备 1 已切换到直连模式
[DevBox] 收到设备 1 数据: ArrayBuffer(17)
```

### 检查连接状态

在控制台执行：

```javascript
// 查看所有设备连接状态
console.log(localStorage.getItem('wsBridgeUrl'));

// 清除桥接配置（恢复服务器模式）
localStorage.removeItem('wsBridgeUrl');
location.reload();
```

## 📱 多设备场景

### 同时管理多个设备

系统会自动连接仪表盘上显示的所有设备：

1. 设备01 → `ws://127.0.0.1:18900` → 192.168.2.10:18899
2. 设备02 → `ws://127.0.0.1:18900` → 192.168.2.11:18899
3. ...

**注意**：所有设备共享同一个桥接端口 (18900)，但会连接到不同的设备IP。

### 设备序列号配置

设备序列号用于生成查询命令，默认从设备信息中读取。如果需要手动指定：

1. 查看设备管理页面的设备序列号
2. 确保序列号与实际设备匹配
3. 如不匹配，联系管理员更新数据库

## ⚙️ 高级配置

### 修改桥接地址

如果桥接服务在其他端口或IP：

1. 进入"设备管理 → 直连测试"
2. 输入新地址，例如：`ws://192.168.1.100:8080`
3. 点击"保存"
4. 返回仪表盘刷新

### 禁用直连功能

临时禁用（不删除配置）：

```javascript
// 在控制台执行
localStorage.removeItem('wsBridgeUrl');
location.reload();
```

永久禁用：
1. 进入"设备管理 → 直连测试"
2. 点击"清除"按钮
3. 返回仪表盘

## 🐛 常见问题

### Q1: 仪表盘不显示"直连"标签？

**排查步骤**：

1. 检查桥接地址是否已保存
   ```javascript
   console.log(localStorage.getItem('wsBridgeUrl'));
   ```

2. 检查桥接服务是否运行
   ```powershell
   netstat -ano | findstr :18900
   ```

3. 查看浏览器控制台日志
   - 按 F12 打开开发者工具
   - 查看是否有连接错误信息

4. 检查设备网络连接
   ```powershell
   Test-NetConnection 192.168.2.10 -Port 18899
   ```

### Q2: 直连后没有收到数据？

**可能原因**：

1. **设备未响应查询命令**
   - 检查设备是否在线
   - 设备序列号是否正确
   - 查询命令CRC是否匹配

2. **WebSocket连接中断**
   - 查看控制台是否有断开日志
   - 尝试刷新页面重新连接

3. **数据解析未实现**
   - 当前版本显示原始数据
   - 完整的数据解析功能开发中

### Q3: 能同时使用直连和服务器模式吗？

**可以！** 系统支持混合模式：

- 有些设备使用直连（局域网可达）
- 其他设备使用服务器模式（局域网不可达）
- 系统会自动为每个设备选择最优方式

### Q4: 直连模式下控制命令是否生效？

**目前状态**：

- ✅ 命令可以发送
- ⚠️ 命令格式可能需要完善
- ⚠️ 设备响应解析待实现

**临时方案**：

- 控制命令仍通过服务器API发送（更可靠）
- 直连主要用于数据查询

## 🔄 工作流程图

```
用户登录
   ↓
进入仪表盘
   ↓
检查 localStorage.wsBridgeUrl
   ↓
┌─有配置?───────┐
│              │
是             否
│              │
↓              ↓
连接桥接服务    使用服务器模式
↓
发送查询命令 (AA010541564B0615)
↓
等待设备响应
↓
┌─收到响应?─────┐
│              │
是             否
│              │
↓              ↓
显示"直连"标签   降级服务器模式
解析并显示数据   通过API获取数据
```

## 📝 开发说明

### 核心组件

1. **DeviceManager** (`utils/device/deviceManager.ts`)
   - 全局设备连接管理器
   - 管理多个设备的WebSocket连接
   - 数据订阅和分发

2. **DirectConnection** (`utils/device/directConnection.ts`)
   - 单设备连接封装
   - 自动选择直连/服务器模式
   - 重连机制

3. **DevBox** (`views/dashboard/analysis/components/DevBox.vue`)
   - 设备卡片显示组件
   - 集成直连功能
   - 实时数据展示

### 扩展功能

如需添加新功能，参考以下接口：

```typescript
// 订阅设备数据
deviceManager.subscribeDeviceData(deviceId, (deviceId, data) => {
  console.log(`设备 ${deviceId} 数据:`, data);
  // 处理数据...
});

// 发送自定义命令
const hexCmd = "AA010541564B0615";
const bytes = new Uint8Array(
  hexCmd.match(/.{1,2}/g).map(b => parseInt(b, 16))
);
deviceManager.sendCommand(deviceId, bytes.buffer);

// 查询设备状态
const status = deviceManager.getDeviceStatus(deviceId);
console.log('连接状态:', status);
```

## 🚀 下一步计划

- [ ] 实现设备响应数据解析
- [ ] 支持更多控制命令（参数设置、单个/批量查询）
- [ ] 添加连接状态指示器
- [ ] 支持断线自动重连
- [ ] 添加数据统计和图表
- [ ] 移动端优化

## 📞 技术支持

如遇问题，请提供以下信息：

1. 浏览器控制台日志
2. 桥接服务日志
3. 设备IP和端口配置
4. 操作步骤描述

---

**注意**：局域网直连功能需要浏览器、桥接服务和设备在同一网络环境中。如果设备在远程网络，请使用服务器模式。





























