# 设备直连通信指南

## 一、协议格式

### 外层协议格式
```
AA [size(2)] [cmd(1)] [data] [serial(1)] [crc(1)] 55
```

- `AA`: 帧头
- `size`: 2字节，包含整个包的长度
- `cmd`: 1字节，命令码
- `data`: 可变长度的数据
- `serial`: 1字节，序列号
- `crc`: 1字节，校验码
- `55`: 帧尾

## 二、常用命令示例

### 1. 查询命令 (AVK)
```
格式：aa{serial}0541564B{CRC16}
示例：AA01 0541 564B 0615  (查询01号设备)
```

### 2. 运行命令 (RUN)
```
格式：aa{serial}0552554E
示例：aa01 0552 554E  (启动01号设备)
```

### 3. 停止命令 (STP)
```
格式：aa{serial}05535450
示例：aa01 0553 5450  (停止01号设备)
```

### 4. 复位命令 (RST)
```
格式：aa{serial}05525354
示例：aa01 0552 5354  (复位01号设备)
```

## 三、WebSocket发送方式

### 方式1：直接发送十六进制字符串
USR-WIFI232-B2 模块可能支持直接接收十六进制字符串，尝试发送：
```
AA010541564B0615
```

### 方式2：发送二进制数据
将十六进制字符串转换为二进制后发送：
```javascript
// 在浏览器控制台测试
const hexStr = "AA010541564B0615";
const bytes = new Uint8Array(hexStr.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
ws.send(bytes.buffer);
```

## 四、测试步骤

### 步骤1：确认桥接服务运行
```powershell
netstat -ano | findstr :18900
```
应该看到 `127.0.0.1:18900` 在监听

### 步骤2：在测试页面设置桥接地址
1. 打开：http://127.0.0.1:8000/static/admin/#/dev/direct-test
2. 在"桥接地址"框输入：`ws://127.0.0.1:18900`
3. 点击"保存"

### 步骤3：连接设备
1. 输入设备ID（例如：1）
2. 点击"连接设备"
3. 查看状态应显示"局域网直连"

### 步骤4：发送测试命令
在"命令数据"框输入以下任意一条（注意：命令中的设备序列号需要与实际设备匹配）：

#### 测试1：查询命令（推荐先测试这个）
```
AA010541564B0615
```

#### 测试2：如果设备序列号是10 (0x0A)
```
AA0A0541564B0615
```
*注意：不同设备序列号可能需要不同的CRC校验码*

#### 测试3：如果需要发送二进制
在浏览器控制台执行：
```javascript
// 1. 打开测试页
// 2. 按F12打开控制台
// 3. 执行以下代码

// 获取已建立的WebSocket连接（假设在直连模式下）
// 注意：需要修改directConnection.ts以暴露ws对象，或者在控制台直接创建连接

// 创建新连接测试
const ws = new WebSocket('ws://127.0.0.1:18900');
ws.onopen = () => {
  console.log('✅ 已连接');
  // 发送查询命令（01号设备）
  const hexStr = "AA010541564B0615";
  const bytes = new Uint8Array(hexStr.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
  ws.send(bytes.buffer);
  console.log('📤 命令已发送:', hexStr);
};

ws.onmessage = (event) => {
  console.log('收到响应:', event.data);
  // 如果是二进制数据
  if (event.data instanceof Blob) {
    event.data.arrayBuffer().then(buffer => {
      const hex = Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join(' ');
      console.log('二进制响应(十六进制):', hex);
    });
  }
};

ws.onerror = (error) => {
  console.error('连接错误:', error);
};
```

## 五、常见问题

### Q1: 发送命令后没有响应？
**可能原因：**
1. 设备序列号不匹配（检查设备实际序列号）
2. 设备未开机或网络断开
3. 命令格式错误（缺少CRC校验）

**解决方法：**
- 确认设备IP可ping通：`ping 192.168.2.10`
- 确认设备端口可连接：`Test-NetConnection 192.168.2.10 -Port 18899`
- 查看设备实际序列号（通过设备标签或后台管理页面）

### Q2: 如何知道设备的序列号？
设备序列号通常是1-255之间的数字，可以：
1. 查看设备背面标签
2. 在后台"设备管理"页面查看
3. 尝试常见序列号（01, 02, 0a等）

### Q3: 收到乱码或无法解析的响应？
这是正常的，设备返回的是二进制数据。需要：
1. 将返回的数据转换为十六进制查看
2. 根据协议格式解析（参考上面的"外层协议格式"）

### Q4: 如何确认命令发送成功？
1. 查看测试页面的"接收日志"
2. 如果设备响应，日志中会显示收到的数据
3. 可以通过物理观察（如设备LED灯、运行状态）确认

## 六、下一步计划

### 短期（已完成）
- [x] 设置WebSocket桥接
- [x] 实现直连测试页面
- [x] 添加桥接地址保存功能

### 中期（待实现）
- [ ] 修改测试页面支持二进制数据发送
- [ ] 添加命令模板（预设常用命令）
- [ ] 实现响应数据的可视化解析
- [ ] 支持自动重连

### 长期（规划中）
- [ ] 集成到主设备管理页面
- [ ] 支持批量设备操作
- [ ] 添加命令历史记录
- [ ] 实现设备状态实时监控

## 七、技术说明

### WebSocket桥接原理
```
浏览器 <--WebSocket--> websockify桥接服务 <--TCP--> USR-WIFI232-B2 <--串口--> 设备
```

- **浏览器**：只能使用WebSocket协议
- **websockify**：将WebSocket协议转换为原始TCP
- **USR-WIFI232-B2**：串口转WiFi模块，透传数据
- **设备**：接收串口数据，按协议解析并响应

### 为什么需要桥接？
浏览器出于安全考虑，不支持直接的TCP Socket连接，只能使用WebSocket。
USR-WIFI232-B2模块当前不支持WebSocket Server功能，所以需要在本地搭建桥接服务。

### 命令格式注意事项
1. **设备序列号**：必须与实际设备匹配
2. **CRC校验**：有些命令需要正确的CRC校验码
3. **大小端**：协议使用大端字节序（网络字节序）
4. **十六进制**：所有数值都以十六进制表示

