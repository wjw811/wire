# 云平台通信协议文档

## 一、协议架构

### 1.1 通信层次
```
设备 <--串口--> WiFi模块 <--TCP--> 云平台服务(pomo) <--HTTP/WebSocket--> 前端/后端
```

### 1.2 协议栈
- **传输层**: TCP (端口 2024)
- **应用层**: 自定义二进制协议
- **数据格式**: 十六进制字节流

---

## 二、外层协议格式

### 2.1 基本结构
```
AA [size(2)] [cmd(1)] [data] [serial(1)] [crc(1)] 55
```

| 字段 | 长度 | 说明 | 示例 |
|------|------|------|------|
| AA | 1字节 | 帧头，固定值 0xAA | AA |
| size | 2字节 | 整个包的长度（大端序） | 00 11 |
| cmd | 1字节 | 命令码 | 02 |
| data | 可变 | 数据载荷 | ... |
| serial | 1字节 | 序列号（0-255循环） | 01 |
| crc | 1字节 | 校验码（累加和） | 15 |
| 55 | 1字节 | 帧尾，固定值 0x55 | 55 |

### 2.2 命令码定义

| 命令码 | 十六进制 | 名称 | 说明 |
|--------|---------|------|------|
| C_HRT | 0x01 | 心跳 | 设备认证和心跳包 |
| C_DA1 | 0x02 | 数据透传1 | 设备数据上报（CK数据） |
| C_DA2 | 0x03 | 数据透传2 | 备用数据通道 |
| C_SET | 0x04 | 参数设置 | 参数设置命令 |
| C_BIN | 0x05 | 固件下发 | 固件升级 |
| C_UPD | 0x06 | 固件更新 | 固件更新确认 |

### 2.3 CRC校验算法
```go
func crc(buff []byte) byte {
    v := byte(0x00)
    for i := 0; i < len(buff); i++ {
        v = v + buff[i]
    }
    return v & 0xff
}
```
**计算范围**: 从 `size` 到 `serial` 的所有字节（不包括帧头AA和帧尾55）

---

## 三、内层协议格式

### 3.1 CK模式 - 数据上报

**用途**: 设备主动上报运行数据

**格式**:
```
55 [sn(1)] [len(1)] CK [data(120字节)] [crc(1)] 55
```

**完整示例**:
```
55 01 78 43 4B [120字节数据] [CRC] 55
```

**数据字段解析** (120字节，从第5字节开始):

| 字节位置 | 字段名 | 长度 | 单位 | 说明 |
|---------|--------|------|------|------|
| 5-6 | f01 | 2 | 0.01kW | 系统A相有功功率 |
| 7-8 | f02 | 2 | 0.01kvar | 系统A相无功功率 |
| 9-10 | f03 | 2 | 0.01 | 系统A相功率因数 |
| 11-12 | f04 | 2 | 0.01kW | 系统B相有功功率 |
| 13-14 | f05 | 2 | 0.01kvar | 系统B相无功功率 |
| 15-16 | f06 | 2 | 0.01 | 系统B相功率因数 |
| 17-18 | f07 | 2 | 0.01kW | 系统C相有功功率 |
| 19-20 | f08 | 2 | 0.01kvar | 系统C相无功功率 |
| 21-22 | f09 | 2 | 0.01 | 系统C相功率因数 |
| 23-24 | f10 | 2 | 0.01kW | 输出A相有功功率 |
| 25-26 | f11 | 2 | 0.01kvar | 输出A相无功功率 |
| 27-28 | f12 | 2 | 0.01 | 输出A相功率因数 |
| 29-30 | f13 | 2 | 0.01kW | 输出B相有功功率 |
| 31-32 | f14 | 2 | 0.01kvar | 输出B相无功功率 |
| 33-34 | f15 | 2 | 0.01 | 输出B相功率因数 |
| 35-36 | f16 | 2 | 0.01kW | 输出C相有功功率 |
| 37-38 | f17 | 2 | 0.01kvar | 输出C相无功功率 |
| 39-40 | f18 | 2 | 0.01 | 输出C相功率因数 |
| 41-42 | f19 | 2 | - | FPGA版本号 |
| 43 | f20 | 1 | - | 运行状态（Bit 1: 0=运行中, 1=已停止） |
| 44 | f21 | 1 | - | 预留 |
| 45-46 | f22 | 2 | - | DSPB版本号 |
| 47-48 | f23 | 2 | 0.1V | A相电网电压 |
| 49-50 | f24 | 2 | 0.1V | B相电网电压 |
| 51-52 | f25 | 2 | 0.1V | C相电网电压 |
| 53-54 | f26 | 2 | - | DSPA版本号 |
| 59-60 | f27 | 2 | 0.01 | 电网电流谐波畸变率最大值（预留） |
| 61-62 | f28 | 2 | 0.01Hz | 电网频率 |
| 63-64 | f29 | 2 | 0.1℃ | A相温度（有符号） |
| 65-66 | f30 | 2 | 0.01 | 电网电压谐波畸变率最大值（预留） |
| 67-68 | f31 | 2 | 1V | 直流母线电压 |
| 69-70 | f32 | 2 | 1V | 上分裂电容电压 |
| 71-72 | f33 | 2 | 1V | 下分裂电容电压 |
| 73-74 | f34 | 2 | 0.1℃ | B相温度（有符号） |
| 75-76 | f35 | 2 | 0.1℃ | C相温度（有符号） |
| 77-78 | f36 | 2 | 0.1A | 装置A相电流 |
| 79-80 | f37 | 2 | 0.1A | 装置B相电流 |
| 81-82 | f38 | 2 | 0.1A | 装置C相电流 |
| 83-84 | f39 | 2 | 0.1A | A相负载电流 |
| 85-86 | f40 | 2 | 0.1A | B相负载电流 |
| 87-88 | f41 | 2 | 0.1A | C相负载电流 |
| 89-90 | f42 | 2 | 0.1A | A相网侧电流 |
| 91-92 | f43 | 2 | 0.1A | B相网侧电流 |
| 93-94 | f44 | 2 | 0.1A | C相网侧电流 |
| 95-96 | f45 | 2 | 0.1A | A相设备电流 |
| 97-98 | f46 | 2 | 0.1A | B相设备电流 |
| 99-100 | f47 | 2 | 0.1A | C相设备电流 |
| 101 | f48 | 1 | - | 故障及状态信息5（位标志） |
| 102 | f49 | 1 | - | 故障及状态信息4（位标志） |
| 103 | f50 | 1 | - | 故障及状态信息3（位标志） |
| 104 | f51 | 1 | - | 故障及状态信息2（Bit 0-1: 运行模式） |
| 105 | f52 | 1 | - | EXTSTATE0（位标志） |
| 106 | f53 | 1 | - | EXTSTATE2（位标志） |
| 107-108 | f54 | 2 | 0.01kW | 负载A相有功功率 |
| 109-110 | f55 | 2 | 0.01kvar | 负载A相无功功率 |
| 111-112 | f56 | 2 | 0.01kW | 负载B相有功功率 |
| 113-114 | f57 | 2 | 0.01kvar | 负载B相无功功率 |
| 115-116 | f58 | 2 | 0.01kW | 负载C相有功功率 |
| 117-118 | f59 | 2 | 0.01kvar | 负载C相无功功率 |
| 119-120 | f60 | 2 | - | 工作模式（编码值） |

**数据解析说明**:
- **有符号16位整数**: 使用补码表示，最高位为符号位
- **大端序**: 高字节在前，低字节在后
- **位标志字段**: 每一位代表一个状态，0表示有故障/状态，1表示正常

### 3.2 P模式 - 参数查询/设置响应

**用途**: 单个参数查询或设置的响应

**格式**:
```
55 [sn(1)] 07 50 02 [addr_hi(1)] [addr_lo(1)] [val_hi(1)] [val_lo(1)] [crc(1)] 55
```

**完整示例**:
```
外层: AA 00 11 02 55 01 07 50 02 02 01 00 02 [CRC] 55
内层: 55 01 07 50 02 02 01 00 02 [CRC] 55
```

**字段说明**:
- `sn`: 设备序列号
- `07`: 数据长度（固定）
- `50`: 命令标识 'P'
- `02`: 固定标识
- `addr_hi/addr_lo`: 参数地址（大端序，16位）
- `val_hi/val_lo`: 参数值（大端序，16位）

**特殊处理**:
- 地址513且值低位为0x8X时，将低位从0x8X改为0x0X

### 3.3 E0/E1/E2模式 - 批量查询

**用途**: 批量查询多个连续地址的参数

**命令格式**:
```
外层: AA [size] 02 [内层数据] [serial] [crc] 55
内层: AA [dev(1)] 05 E0 [start_addr_hi(1)] [start_addr_lo(1)] [count(1)] [crc16(2)] 55
```

**响应格式**:
```
外层: AA [size] 02 [内层数据] [serial] [crc] 55
内层: 55 [addr(1)] [len(1)] 52 [values...] [crc(1)] 55
```

**字段说明**:
- `E0`: 批量查询命令标识
- `start_addr`: 起始地址（大端序）
- `count`: 查询数量
- `52`: 批量查询响应标识
- `values`: 连续的值数组，每个值2字节（大端序）

---

## 四、常用命令

### 4.1 设备控制命令

#### 4.1.1 查询命令 (AVK)
```
格式: AA [serial] 05 41 56 4B [CRC16] 55
示例: AA 01 05 41 56 4B 06 15 55
说明: 查询设备状态，触发设备上报CK数据
```

#### 4.1.2 运行命令 (RUN)
```
格式: AA [serial] 05 52 55 4E [CRC16] 55
示例: AA 01 05 52 55 4E [CRC] 55
说明: 启动设备运行
```

#### 4.1.3 停止命令 (STP)
```
格式: AA [serial] 05 53 54 50 [CRC16] 55
示例: AA 01 05 53 54 50 [CRC] 55
说明: 停止设备运行
```

#### 4.1.4 复位命令 (RST)
```
格式: AA [serial] 05 52 53 54 [CRC16] 55
示例: AA 01 05 52 53 54 [CRC] 55
说明: 复位设备
```

### 4.2 参数操作命令

#### 4.2.1 单个参数查询
```
格式: AA [serial] 05 E0 [addr_hi] [addr_lo] [CRC16] 55
示例: AA 01 05 E0 02 01 [CRC] 55  (查询地址513)
说明: 查询指定地址的参数值
```

#### 4.2.2 单个参数设置
```
格式: AA [serial] 07 E1 [addr_hi] [addr_lo] [val_hi] [val_lo] [CRC16] 55
示例: AA 01 07 E1 02 01 00 02 [CRC] 55  (设置地址513=2)
说明: 设置指定地址的参数值
```

#### 4.2.3 批量参数查询
```
格式: AA [serial] 05 E0 [start_addr_hi] [start_addr_lo] [count] [CRC16] 55
示例: AA 01 05 E0 02 00 02 [CRC] 55  (查询地址512-513)
说明: 批量查询连续地址的参数值
```

#### 4.2.4 批量参数设置
```
格式: AA [serial] [len] E2 [start_addr_hi] [start_addr_lo] [count] [values...] [CRC16] 55
说明: 批量设置连续地址的参数值
```

### 4.3 CRC16校验（用于部分命令）

**算法**: CRC16 XMODEM
**多项式**: 0x1021
**初始值**: 0x0000

**计算范围**: 从命令开始到CRC16之前的所有字节

---

## 五、HTTP API接口

### 5.1 设备命令接口

**URL**: `/admin/dash/cmd`

**方法**: GET/POST

**参数**:
- `id`: 设备ID
- `mode`: 命令模式 (run/stp/rst/pam/syn/query/batchQueryAsync/batchQueryResult/batchSave)
- `startAddr`: 起始地址（批量查询/保存时）
- `count`: 数量（批量查询/保存时）
- `taskId`: 任务ID（批量查询结果查询时）

**响应格式**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "taskId": "xxx",  // 批量查询时返回
    "status": "completed",  // 批量查询结果状态
    "result": {
      "values": [1, 2, 3]  // 查询结果值数组
    }
  }
}
```

### 5.2 设备信息接口

**URL**: `/admin/dash/info`

**方法**: GET

**参数**:
- `id`: 设备ID（可选）
- `serial`: 设备序列号（可选）

**响应格式**:
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "serial": "01",
      "name": "设备1",
      "status": "connected",
      "limit": ["run", "stp", "rst"],
      "data": {
        "f01": 100.5,
        "f20": 0,
        ...
      }
    }
  ]
}
```

---

## 六、WebSocket通信

### 6.1 连接地址
- **开发环境**: `ws://127.0.0.1:18900` (桥接服务)
- **生产环境**: 通过HTTP API轮询

### 6.2 数据格式
- **发送**: 十六进制字符串或二进制数据
- **接收**: 二进制数据，需转换为十六进制解析

---

## 七、重要参数地址

| 地址 | 名称 | 说明 | 取值范围 |
|------|------|------|---------|
| 9 | DI启停使能 | 数字输入启停使能 | 0-1 |
| 13 | 设备采样位置 | 0=柜体, 1=电容 | 0-1 |
| 14 | 设备采样方向 | 0=流出电网, 1=流入电网 | 0-1 |
| 15 | 输入采样方向 | 0=流出电网, 1=流入电网 | 0-1 |
| 16 | 设备采样使能 | 设备电流采样使能 | 0-1 |
| 17 | 输入采样位置 | 0=负载侧, 1=电网侧 | 0-1 |
| 151 | 并联柜数 | 并联柜数量 | 1-255 |
| 161 | 模块容量比 | 模块容量比例 | 0-65535 |
| 241 | 输入CT变比 | 输入电流互感器变比 | 0-65535 |
| 242 | 设备CT变比 | 设备电流互感器变比 | 0-65535 |
| 265-272 | 谐波组1-8 | 谐波组配置 | 0-65535 |
| 280 | 功率因数 | 目标功率因数 | 0-100 |
| 512 | 自启动使能 | 自动启动使能 | 0-1 |
| 513 | 运行模式 | 工作模式编码 | 0-65535 |

---

## 八、状态位说明

### 8.1 f20 状态字节
- **Bit 0**: 预留
- **Bit 1**: 运行状态 (0=运行中, 1=已停止)
- **Bit 2-7**: 其他状态位

### 8.2 故障状态字段 (f48-f51)
- 每一位代表一个故障或状态
- 0表示有故障/状态，1表示正常
- 具体含义参考设备手册

---

## 九、协议示例

### 9.1 完整数据上报流程
```
1. 设备主动上报CK数据:
   AA 00 7F 02 55 01 78 43 4B [120字节数据] [CRC] 55

2. 云平台解析并存储到Redis

3. 前端通过HTTP API获取:
   GET /admin/dash/info?id=1
```

### 9.2 参数查询流程
```
1. 前端发送查询请求:
   GET /admin/dash/cmd?id=1&mode=query&addr=513

2. 云平台发送查询命令:
   AA 01 05 E0 02 01 [CRC16] 55

3. 设备响应:
   AA 00 11 02 55 01 07 50 02 02 01 00 02 [CRC] 55

4. 云平台解析并返回:
   {"code": 0, "data": {"addr": 513, "val": 2}}
```

### 9.3 设备控制流程
```
1. 前端发送控制命令:
   GET /admin/dash/cmd?id=1&mode=run

2. 云平台发送运行命令:
   AA 01 05 52 55 4E [CRC16] 55

3. 设备执行并上报新状态（通过CK数据）
```

---

## 十、注意事项

1. **字节序**: 所有多字节数据使用大端序（网络字节序）
2. **序列号**: 序列号在0-255之间循环递增
3. **CRC校验**: 外层协议使用累加和，部分命令使用CRC16 XMODEM
4. **超时处理**: 单个查询建议超时时间10秒
5. **批量操作**: 批量查询/设置建议分组进行，每组不超过50个地址
6. **错误处理**: 收到CRC错误的数据包应丢弃，不进行解析
7. **兼容性**: 部分设备命令高位带通道标记（如0x82），需要兼容处理

---

## 十一、版本信息

- **协议版本**: Wire3
- **文档版本**: v1.0
- **最后更新**: 2025-12-20


