# 设备监控系统 - 客户部署指南

## 🎯 快速开始（2步完成）

### 步骤 1：在后台配置设备IP

1. 登录后台管理：http://127.0.0.1:8000/static/admin
2. 进入"设备管理" → "网关列表"
3. 编辑网关，填写"局域网IP"字段
   - 例如：`192.168.2.10`
4. 保存

![网关配置](https://via.placeholder.com/800x300?text=Gateway+Config)

**如何获取设备IP？**
- 方法1：使用 USR-WIFI232-B2 配置工具，点击"搜索"
- 方法2：查看路由器已连接设备列表
- 方法3：运行 `arp -a` 查看局域网设备

---

### 步骤 2：一键启动

双击运行：`scripts/setup_direct_connection.ps1`

![一键启动](https://via.placeholder.com/800x400?text=Setup+Direct+Connection)

**自动完成**：
- ✅ 检查数据库配置
- ✅ 从数据库读取设备IP
- ✅ 自动生成配置文件
- ✅ 检测设备在线状态
- ✅ 为每个在线设备启动桥接
- ✅ 后台运行，不影响其他操作

然后打开浏览器访问：`http://127.0.0.1:8000/static/admin`

**自动显示**：
- ✅ 自动连接设备
- ✅ 每 3 秒刷新数据
- ✅ 实时显示 60 个参数

---

## 📋 详细配置说明

### 如何获取设备 IP？

#### 方法 1：使用配置软件
1. 打开 `USR-WIFI232-B2 配置工具`
2. 点击"搜索"按钮
3. 记录显示的 IP 地址

#### 方法 2：查看路由器
1. 登录路由器管理页面
2. 查看"已连接设备"列表
3. 找到 WiFi 模块的 IP

#### 方法 3：使用命令行
```powershell
# Windows PowerShell
arp -a | Select-String "192.168"
```

---

### 设备离线怎么办？

桥接启动脚本会自动跳过离线设备，不影响其他设备使用。

**排查步骤**：
1. 检查设备是否上电
2. 测试网络连通：
   ```powershell
   ping 192.168.2.10
   Test-NetConnection 192.168.2.10 -Port 18899
   ```
3. 检查 WiFi 模块配置（Socket B 必须是 TCP Server）

---

### 如何添加新设备？

1. 在后台管理页面添加新设备
   - 进入"设备管理" → "网关列表"
   - 添加/编辑网关，填写局域网IP
   - 保存
2. 运行配置生成脚本
   ```powershell
   php scripts/generate_device_config.php
   ```
3. 重新启动桥接服务
   ```powershell
   .\scripts\stop_bridge.ps1
   .\scripts\start_multi_bridge.ps1
   ```
4. 刷新网页

**完全自动化**！无需手动编辑配置文件！

---

### 如何停止桥接服务？

双击运行：`scripts/stop_bridge.ps1`

---

## 🚀 开机自动启动（可选）

### Windows 任务计划程序

1. 打开"任务计划程序"
2. 创建基本任务：
   - 名称：`设备监控桥接`
   - 触发器：`登录时`
   - 操作：`启动程序`
   - 程序：`powershell.exe`
   - 参数：`-File "E:\test2\wire2\wire\scripts\start_multi_bridge.ps1"`
3. 保存

下次开机后，桥接服务会自动启动！

---

## 📱 移动设备访问

### 方法 1：通过局域网

1. 手机连接到与电脑相同的 WiFi
2. 查看电脑的局域网 IP：
   ```powershell
   ipconfig | Select-String "IPv4"
   ```
3. 手机浏览器访问：`http://<电脑IP>:8000/static/admin`

### 方法 2：直接连接设备 WiFi（AP 模式）

如果设备 WiFi 模块配置为热点模式：
1. 手机连接到设备的 WiFi 热点
2. 修改 `static/admin/device-config.json`：
   ```json
   {
     "devices": [
       {
         "id": 1,
         "name": "设备1",
         "bridgeUrl": "ws://192.168.4.1:18899"
       }
     ]
   }
   ```
3. 手机浏览器访问设备 IP

---

## ❓ 常见问题

### Q1: 网页显示"连接中..."但一直不成功
**A**: 
1. 检查桥接服务是否启动
2. 按 F12 打开浏览器控制台查看错误信息
3. 确认 `device-config.json` 中的 IP 和端口正确

### Q2: 数据显示"-"或"暂无数据"
**A**:
1. 设备可能离线或未上电
2. 检查设备序列号是否正确
3. 尝试点击"手动查询"按钮

### Q3: 如何查看桥接服务是否运行？
**A**:
```powershell
Get-Process | Select-String "python"
netstat -ano | findstr "18900"
```

### Q4: 端口被占用怎么办？
**A**:
1. 修改 `config/devices.json` 中的 `bridgePort`
2. 修改 `static/admin/device-config.json` 中的 `bridgeUrl`
3. 重新启动桥接服务

---

## 📞 技术支持

如有问题，请联系技术支持并提供：
- 浏览器控制台截图（按 F12）
- 桥接启动脚本运行截图
- `config/devices.json` 配置内容

---

## 🎉 完成！

现在您可以：
- ✅ 实时监控设备数据（3秒刷新）
- ✅ 查看 60 个参数详情
- ✅ 无需依赖外网服务器
- ✅ 支持多设备同时监控

享受使用！

