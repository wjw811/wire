var h=(a,t,e)=>new Promise((s,c)=>{var r=i=>{try{o(e.next(i))}catch(l){c(l)}},n=i=>{try{o(e.throw(i))}catch(l){c(l)}},o=i=>i.done?s(i.value):Promise.resolve(i.value).then(r,n);o((e=e.apply(a,t)).next())});import{l as u}from"./index.35535828.js";import"./index.69a4dfca.js";import"./utils.93213dc9.js";import"./ui.5d3da833.js";import"./vue.2e68d871.js";import"./table.68230543.js";var f=(a=>(a.DIRECT="direct",a.SERVER="server",a.UNKNOWN="unknown",a))(f||{});class m{constructor(){this.ws=null,this.deviceId=null,this.localIP=null,this.directPort=18899,this.mode="unknown",this.connected=!1,this.reconnectTimer=null,this.reconnectAttempts=0,this.maxReconnectAttempts=3,this.onMessageCallback=null,this.onStatusChangeCallback=null,this.onErrorCallback=null}detectDirectConnection(t){return h(this,null,function*(){try{return yield u({id:t})}catch(e){return{id:t,name:"",serial:"",gid:0,localIP:null,directPort:18899,canDirectConnect:!1}}})}testDirectConnection(t,e){return h(this,null,function*(){return new Promise(s=>{const c=setTimeout(()=>{r.close(),s(!1)},3e3),r=new WebSocket(`ws://${t}:${e}`);r.onopen=()=>{clearTimeout(c),r.close(),s(!0)},r.onerror=n=>{clearTimeout(c),s(!1)}})})}connect(t){return h(this,null,function*(){this.deviceId=t;const e="ws://127.0.0.1:18900";try{if(yield new Promise(r=>{const n=setTimeout(()=>{o.close(),r(!1)},3e3),o=new WebSocket(e);o.onopen=()=>{clearTimeout(n),o.close(),r(!0)},o.onerror=i=>{clearTimeout(n),r(!1)},o.onclose=i=>{}})){const r=e.replace("ws://",""),[n,o]=r.split(":"),i=Number(o||"18900");return this.connectDirect(n,i)}}catch(c){}const s=yield this.detectDirectConnection(t);return s.canDirectConnect&&s.localIP&&(yield this.testDirectConnection(s.localIP,s.directPort))?this.connectDirect(s.localIP,s.directPort):this.connectViaServer(t)})}connectDirect(t,e){return new Promise((s,c)=>{this.localIP=t,this.directPort=e,this.mode="direct";const r=`ws://${t}:${e}`;this.ws=new WebSocket(r),this.ws.onopen=()=>{this.connected=!0,this.reconnectAttempts=0;const n=this.getStatus();this.notifyStatusChange(n),s(n)},this.ws.onmessage=n=>h(this,null,function*(){if(n.data instanceof Blob){const o=yield n.data.arrayBuffer(),i=new Uint8Array(o);Array.from(i).map(l=>l.toString(16).padStart(2,"0")).join(" "),this.handleMessage(o)}else this.handleMessage(n.data)}),this.ws.onerror=n=>{this.notifyError("\u76F4\u8FDE\u9519\u8BEF"),c(new Error("\u76F4\u8FDE\u5931\u8D25"))},this.ws.onclose=()=>{this.connected=!1,this.notifyStatusChange(this.getStatus()),this.handleReconnect()}})}connectViaServer(t){this.mode="server",this.connected=!0;const e=this.getStatus();return this.notifyStatusChange(e),Promise.resolve(e)}send(t){if(this.mode==="direct"&&this.ws&&this.ws.readyState===WebSocket.OPEN){if(t instanceof ArrayBuffer){this.ws.send(t);const e=new Uint8Array(t);Array.from(e).map(s=>s.toString(16).padStart(2,"0")).join(" ")}else{const e=typeof t=="string"?t:JSON.stringify(t);this.ws.send(e)}return!0}else if(this.mode==="server")return!1;return!1}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.connected=!1,this.mode="unknown",this.notifyStatusChange(this.getStatus())}handleMessage(t){if(t instanceof ArrayBuffer)this.onMessageCallback&&this.onMessageCallback(t);else try{const e=JSON.parse(t);this.onMessageCallback&&this.onMessageCallback(e)}catch(e){this.onMessageCallback&&this.onMessageCallback(t)}}handleReconnect(){if(this.mode!=="direct")return;if(this.reconnectAttempts>=this.maxReconnectAttempts){this.notifyError("\u76F4\u8FDE\u5931\u8D25\uFF0C\u8BF7\u5237\u65B0\u9875\u9762\u91CD\u8BD5");return}this.reconnectAttempts++;const t=Math.min(1e3*Math.pow(2,this.reconnectAttempts),1e4);this.reconnectTimer=setTimeout(()=>{this.localIP&&this.deviceId&&this.connectDirect(this.localIP,this.directPort)},t)}getStatus(){return{mode:this.mode,connected:this.connected,deviceId:this.deviceId,localIP:this.localIP,error:null}}onMessage(t){this.onMessageCallback=t}onStatusChange(t){this.onStatusChangeCallback=t}onError(t){this.onErrorCallback=t}notifyStatusChange(t){this.onStatusChangeCallback&&this.onStatusChangeCallback(t)}notifyError(t){this.onErrorCallback&&this.onErrorCallback(t)}}const b=new m;export{f as ConnectionMode,m as DirectConnection,b as deviceConnection};
