<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µèƒ½è´¨é‡ç›‘æ§ç³»ç»Ÿ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* å…¨å±€æ»šåŠ¨æ¡æ ·å¼ */
        *::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        *::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }
        
        *::-webkit-scrollbar-thumb {
            background: #bfbfbf;
            border-radius: 3px;
        }
        
        *::-webkit-scrollbar-thumb:hover {
            background: #8c8c8c;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            padding: 15px;
        }
        
        /* é¡µé¢èƒŒæ™¯å›¾æ¡ˆ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(90deg, rgba(200, 200, 200, 0.1) 1px, transparent 1px),
                linear-gradient(rgba(200, 200, 200, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: #ffffff;
            border-radius: 4px;
            padding: 20px 25px;
            margin-bottom: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #1890ff;
            position: relative;
        }
        
        .fault-banner {
            background: #fff2f0;
            border-radius: 2px;
            padding: 12px 16px;
            margin-bottom: 15px;
            box-shadow: none;
            color: #262626;
            display: none;
            align-items: center;
            gap: 12px;
            border: 1px solid #ffccc7;
            border-left: 4px solid #ff4d4f;
        }
        
        .fault-banner.active {
            display: flex;
            animation: slideDown 0.3s ease-out;
        }
        
        .fault-banner.normal {
            background: #f6ffed;
            border-color: #b7eb8f;
            border-left-color: #52c41a;
        }
        
        .fault-icon {
            font-size: 20px;
            animation: none;
            filter: none;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .fault-banner .fault-icon {
            filter: grayscale(0);
        }
        
        .fault-banner.normal .fault-icon {
            filter: grayscale(0);
        }
        
        /* è¿è¡ŒçŠ¶æ€é½¿è½®å›¾æ ‡æ—‹è½¬åŠ¨ç”» */
        .fault-icon.running-gear {
            animation: rotateGear 2s linear infinite;
            display: inline-block;
        }
        
        @keyframes rotateGear {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fault-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .fault-title {
            font-size: 14px;
            font-weight: 600;
            color: #262626;
        }
        
        .fault-details {
            font-size: 14px;
            font-weight: 400;
            color: #595959;
            opacity: 1;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
        }
        
        /* æ— ç¼æ¨ªå‘æ»šåŠ¨ï¼šç¬¬ä¸€æ®µâ†’å¤§ç©ºç™½â†’ç¬¬äºŒæ®µ */
        .fault-scroll {
            display: inline-block;
            will-change: transform;
            animation: scroll-left 25s linear infinite;
        }
        
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            15% { transform: translateX(0); }  /* åˆå§‹åœç•™3.75ç§’ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€æ®µ */
            100% { transform: translateX(-100%); } /* ç¬¬ä¸€æ®µå®Œå…¨ç§»å‡ºï¼Œç¬¬äºŒæ®µä»å³è¿›å…¥ */
        }
        
        .mobile-access-panel {
            display: none;
            margin-top: 16px;
            padding: 20px 24px;
            background: linear-gradient(90deg, rgba(230, 247, 255, 0.65), rgba(255, 255, 255, 0.95));
            border: 1px solid #91d5ff;
            border-left: 4px solid #1890ff;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.08);
            transform-origin: top center;
            opacity: 0;
            transform: scaleY(0);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-height: 0;
            overflow: hidden;
        }

        .mobile-access-panel.active {
            display: block;
            animation: jellyExpand 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            opacity: 1;
            transform: scaleY(1);
            max-height: 1000px;
        }
        
        @keyframes jellyExpand {
            0% {
                transform: scaleY(0) scaleX(0.8);
                opacity: 0;
            }
            50% {
                transform: scaleY(1.05) scaleX(1);
                opacity: 0.8;
            }
            70% {
                transform: scaleY(0.95) scaleX(1);
                opacity: 0.9;
            }
            85% {
                transform: scaleY(1.02) scaleX(1);
                opacity: 0.95;
            }
            100% {
                transform: scaleY(1) scaleX(1);
                opacity: 1;
            }
        }
        
        @keyframes jellyCollapse {
            0% {
                transform: scaleY(1) scaleX(1);
                opacity: 1;
            }
            30% {
                transform: scaleY(1.05) scaleX(1);
                opacity: 0.8;
            }
            60% {
                transform: scaleY(0.9) scaleX(0.95);
                opacity: 0.5;
            }
            100% {
                transform: scaleY(0) scaleX(0.8);
                opacity: 0;
            }
        }

        .mobile-access-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .mobile-access-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #262626;
        }

        .mobile-access-title svg {
            flex-shrink: 0;
        }

        .mobile-access-tip {
            color: #595959;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .mobile-access-hint {
            color: #8c8c8c;
            font-size: 13px;
            margin-top: 12px;
        }

        .mobile-access-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #btnMobile.active {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        .mobile-access-actions .close-modal {
            margin-top: 0;
            padding: 6px 16px;
        }
        
        .url-display {
            background: #e6f7ff;
            color: #262626;
            padding: 16px;
            border-radius: 2px;
            margin: 20px 0;
            border: 1px solid #91d5ff;
            border-left: 4px solid #1890ff;
        }
        
        .url-display .url-text {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: 600;
            margin: 8px 0;
            word-break: break-all;
            overflow-wrap: break-word;
            line-height: 1.6;
            color: #1890ff;
        }
        
        .close-modal {
            background: #ffffff;
            color: #595959;
            border: 1px solid #d9d9d9;
            padding: 8px 24px;
            border-radius: 2px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }
        
        .close-modal:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }
        
        .header h1 {
            color: #262626;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #333333;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-dot.connected {
            background: #52c41a;
            box-shadow: 0 0 8px #52c41a, 0 0 16px rgba(82, 196, 26, 0.5);
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% {
                box-shadow: 0 0 8px #52c41a, 0 0 16px rgba(82, 196, 26, 0.5);
            }
            50% {
                box-shadow: 0 0 12px #52c41a, 0 0 24px rgba(82, 196, 26, 0.8);
            }
        }
        
        .card {
            background: #ffffff;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        .card h2 {
            color: #262626;
            font-size: 16px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card h2::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #1890ff;
            border-radius: 2px;
        }
        
        .config-group {
            margin-bottom: 20px;
        }
        
        .config-group label {
            display: block;
            margin-bottom: 5px;
            color: #333333;
            font-weight: 500;
        }
        
        .config-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 2px;
            font-size: 14px;
            background: #ffffff;
            color: #262626;
            transition: all 0.2s;
        }
        
        .config-group input:hover {
            border-color: #40a9ff;
        }
        
        .config-group input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }
        
        .config-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 2px;
            font-size: 14px;
            background: #ffffff;
            color: #262626;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .config-group select:hover {
            border-color: #40a9ff;
        }
        
        .config-group select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }
        
        .config-group select option {
            background: #ffffff;
            color: #333333;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            min-height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            background: #ffffff;
        }
        
        .btn:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
            border-color: #40a9ff;
            color: white;
        }
        
        .btn-success {
            background: #52c41a;
            color: #ffffff;
            border-color: #52c41a;
        }
        
        .btn-success:hover {
            background: #73d13d;
            border-color: #73d13d;
            color: #ffffff;
        }
        
        .btn-warning {
            background: #ffffff;
            color: #595959;
            border-color: #d9d9d9;
        }
        
        .btn-warning:hover {
            background: #ffffff;
            border-color: #40a9ff;
            color: #40a9ff;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: #ffffff;
            border-color: #ff4d4f;
        }
        
        .btn-danger:hover {
            background: #ff7875;
            border-color: #ff7875;
            color: #ffffff;
        }
        
        .btn-info {
            background: #ffffff;
            color: #595959;
            border-color: #d9d9d9;
        }
        
        .btn-info:hover {
            background: #ffffff;
            border-color: #40a9ff;
            color: #40a9ff;
        }
        
        .btn-secondary {
            background: #ffffff;
            color: #595959;
            border-color: #d9d9d9;
        }
        
        .btn-secondary:hover {
            background: #ffffff;
            border-color: #40a9ff;
            color: #40a9ff;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            padding: 0;
        }
        
        .param-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .param-name {
            color: #595959;
            font-weight: 500;
            font-size: 13px;
        }
        
        .param-value {
            color: #262626;
            font-weight: 600;
            font-size: 16px;
            font-family: 'Courier New', 'Consolas', monospace;
        }
        
        .param-unit {
            color: #8c8c8c;
            margin-left: 4px;
            font-size: 12px;
            font-weight: 400;
        }

        .info-card {
            background: #ffffff;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* åŠŸç‡æ•°æ®å¡ç‰‡é¢œè‰²åŠ æ·± */
        #paramsGridFunc .info-card {
            background: #fafafa;
            border-color: #d9d9d9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-card-header {
            font-size: 14px;
            font-weight: 600;
            color: #262626;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #595959;
            opacity: 0.7;
            flex-shrink: 0;
            margin-left: 8px;
            vertical-align: middle;
            line-height: 1;
        }
        
        .card-icon svg {
            width: 20px;
            height: 20px;
            display: block;
        }
        
        /* åŠŸç‡å› æ•°å›¾æ ‡æ”¾å¤§ - é€šè¿‡ç±»åæˆ–å±æ€§é€‰æ‹©å™¨ */
        #paramsGridFunc .card-icon svg[width="24"],
        #paramsGridFunc .card-icon svg[width="24px"] {
            width: 48px !important;
            height: 48px !important;
        }
        
        /* åŠŸç‡å› æ•°æ–‡å­—æ ·å¼ - æ›¿æ¢SVGå›¾æ ‡ */
        .power-factor-text {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-size: 13px;
            font-weight: 400;
            line-height: 1;
            color: #595959;
            opacity: 0.7;
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }
        
        /* åŠŸç‡å› æ•°å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
        #paramsGridFunc .info-card-header .card-icon {
            opacity: 0.7;
        }
        
        #paramsGridFunc .info-card-header .card-icon svg[width="24"],
        #paramsGridFunc .info-card-header .card-icon svg[width="24px"] {
            opacity: 0.85;
        }

        .info-card-body {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .info-card-empty {
            color: #8c8c8c;
            font-size: 12px;
            text-align: left;
        }
        
        .log-box {
            background: rgba(0, 0, 0, 0.5);
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.5;
            border: 1px solid rgba(0, 255, 0, 0.2);
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
        }
        
        .log-box::-webkit-scrollbar {
            width: 6px;
        }
        
        .log-box::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 3px;
        }
        
        .log-box::-webkit-scrollbar-thumb {
            background: #434343;
            border-radius: 3px;
        }
        
        .log-box::-webkit-scrollbar-thumb:hover {
            background: #595959;
        }
        
        .log-item {
            margin-bottom: 5px;
        }
        
        .log-item.info { color: #0f0; }
        .log-item.error { color: #f00; }
        .log-item.warn { color: #fa0; }
        
        .update-time {
            text-align: right;
            color: #999999;
            font-size: 12px;
            margin-top: 10px;
        }
        
        /* åŠŸç‡å› æ•°åœ†ç¯å›¾æ ·å¼ */
        .power-factor-ring {
            text-align: center;
            padding: 16px;
            background: #fafafa;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            transition: all 0.3s ease;
        }
        
        .power-factor-ring:hover {
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .power-factor-ring svg {
            display: block;
            margin: 0 auto;
        }
        
        .power-factor-ring circle {
            transition: stroke-dashoffset 0.6s ease;
        }
        
        /* ä¸»Tabå¯¼èˆªæ ·å¼ï¼ˆåœ¨ç™½è‰²èƒŒæ™¯ä¸Šçš„tabï¼‰ */
        .card > div:first-child > .tab-item {
            padding: 10px 16px;
            cursor: pointer;
            color: #595959;
            background: transparent;
            border: none;
            border-radius: 0;
            transition: all 0.2s ease;
            font-weight: 400;
            font-size: 14px;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-bottom: 2px solid transparent;
            margin-right: 8px;
        }
        
        .card > div:first-child > .tab-item svg {
            flex-shrink: 0;
            vertical-align: middle;
        }
        
        .card > div:first-child > .tab-item:hover {
            color: #1890ff;
        }
        
        .card > div:first-child > .tab-item:hover svg {
            stroke: #1890ff;
        }
        
        .card > div:first-child > .tab-item.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
            font-weight: 500;
        }
        
        .card > div:first-child > .tab-item.active svg {
            stroke: #1890ff;
        }
        
        /* å¡ç‰‡å†…éƒ¨å­Tabæ ·å¼ï¼ˆåœ¨ç™½è‰²èƒŒæ™¯ä¸Šçš„tabï¼‰ */
        .tab-content .tab-item {
            padding: 8px 16px;
            cursor: pointer;
            color: #595959;
            background: transparent;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: inline-block;
            margin-right: 12px;
            font-size: 14px;
        }
        
        /* å‚æ•°è®¾ç½®Tabé¡¹ - è¦†ç›–é»˜è®¤æ ·å¼ */
        .param-sub-tab-item {
            display: flex !important;
            align-items: center;
            justify-content: center;
            margin-right: 0 !important;
        }
        
        /* å•å‚æ•°è®¾ç½®tabæƒé™æ§åˆ¶ - é»˜è®¤éšè—ï¼Œç”±JavaScriptæ§åˆ¶æ˜¾ç¤º */
        .single-param-tab.hidden-by-role {
            display: none !important;
        }
        
        /* å¯†ç ç®¡ç†tabæƒé™æ§åˆ¶ - é»˜è®¤éšè—ï¼Œä»…è¶…çº§ç®¡ç†å‘˜å¯è§ */
        .password-manage-tab.hidden-by-role {
            display: none !important;
        }
        
        .tab-content .tab-item:hover {
            color: #1890ff;
        }
        
        .tab-content .tab-item.active {
            color: #1890ff;
            border-bottom-color: #1890ff;
            font-weight: 500;
        }
        
        .tab-content {
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .param-setting-item {
            margin-bottom: 15px;
        }
        
        .param-setting-item label {
            display: block;
            margin-bottom: 8px;
            color: #333333;
            font-size: 13px;
        }
        
        .param-setting-item input,
        .param-setting-item select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 2px;
            font-size: 14px;
            background: #ffffff;
            color: #262626;
            transition: all 0.2s;
        }
        
        .param-setting-item input:hover,
        .param-setting-item select:hover {
            border-color: #40a9ff;
        }
        
        .param-setting-item input:focus,
        .param-setting-item select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }
        
        /* è°æ³¢ç»„æŒ‰é’®æ ·å¼ */
        .harmonic-btn {
            min-width: 44px;
            height: 32px;
            padding: 4px 8px;
            margin: 4px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: #ffffff;
            color: #262626;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .harmonic-btn:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }
        
        .harmonic-btn.selected {
            background: #1890ff;
            border-color: #1890ff;
            color: #ffffff;
        }
        
        .harmonic-group-display {
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
            background: #fafafa;
        }
        
        .harmonic-buttons-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .harmonic-buttons-column {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .harmonic-buttons-column-title {
            font-size: 13px;
            font-weight: 600;
            color: #595959;
            margin-bottom: 8px;
            width: 100%;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background: #ffffff;
            border-radius: 2px;
            padding: 0;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: jellyIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 1px solid #e8e8e8;
            transform-origin: center center;
        }
        
        .modal-content.jelly-close {
            animation: jellyOut 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        
        @keyframes jellyIn {
            0% {
                transform: scale(0.3) translateY(-50px);
                opacity: 0;
            }
            50% {
                transform: scale(1.05) translateY(0);
                opacity: 0.8;
            }
            70% {
                transform: scale(0.95) translateY(0);
                opacity: 0.9;
            }
            85% {
                transform: scale(1.02) translateY(0);
                opacity: 0.95;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes jellyOut {
            0% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            30% {
                transform: scale(1.05) translateY(0);
                opacity: 0.8;
            }
            60% {
                transform: scale(0.9) translateY(20px);
                opacity: 0.5;
            }
            100% {
                transform: scale(0.3) translateY(50px);
                opacity: 0;
            }
        }
        
        /* ç‚¹å‡»æ—¶çš„æœå†»åé¦ˆæ•ˆæœ */
        .modal-content:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e8e8e8;
            position: relative;
        }
        
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #1890ff 0%, transparent 100%);
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #1a1a1a;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 24px;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
        }
        
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: #bfbfbf;
            border-radius: 3px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #8c8c8c;
        }
        
        /* ==================== å“åº”å¼è®¾è®¡ ==================== */
        
        /* å¹³æ¿å’Œå°å±å¹• (æœ€å¤§768px) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
            }
            
            /* å¤´éƒ¨ä¼˜åŒ– */
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .header h1 {
                font-size: 18px;
                text-align: center;
            }
            
            /* æŒ‰é’®ç»„ä¼˜åŒ– */
            .btn-group {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .btn {
                padding: 12px 8px;
                font-size: 14px;
                min-height: 44px; /* è§¦æ‘¸å‹å¥½ */
            }
            
            /* æ•…éšœæ¨ªå¹…ä¼˜åŒ– */
            .fault-banner {
                padding: 10px 15px;
                gap: 10px;
            }
            
            .fault-icon {
                font-size: 20px;
            }
            
            .fault-title {
                font-size: 13px;
            }
            
            .fault-details {
                font-size: 14px;
            }
            
            /* Tabå¯¼èˆªä¼˜åŒ– */
            .tab-item {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            /* å‚æ•°è®¾ç½®å­Tabå¯¼èˆª - ç§»åŠ¨ç«¯æ¢è¡Œæ˜¾ç¤º */
            .param-sub-tab-nav {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
                border-bottom: 1px solid #e8e8e8 !important;
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }
            
            .param-sub-tab-item {
                flex: 1 1 calc(50% - 4px) !important;
                min-width: calc(50% - 4px) !important;
                max-width: calc(50% - 4px) !important;
                text-align: center !important;
                padding: 10px 8px !important;
                font-size: 13px !important;
                white-space: normal !important;
                word-break: break-word !important;
            }
            
            /* å‚æ•°ç½‘æ ¼ä¼˜åŒ– */
            .params-grid {
                grid-template-columns: 1fr;
                max-height: none;
            }
            
            /* æ¨¡å—ä¿¡æ¯å“åº”å¼å¸ƒå±€ä¼˜åŒ– */
            /* å¹³æ¿å’Œå°å±ï¼ˆâ‰¤768pxï¼‰ï¼š2åˆ—å¸ƒå±€ */
            #paramsGridModule {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }
            
            /* ç¡®ä¿ç§»åŠ¨ç«¯ä¸åº”ç”¨æ¡Œé¢ç«¯çš„grid-columnè®¾ç½® */
            #paramsGridModule .info-card {
                grid-column: unset !important;
            }
            
            /* ç§»åŠ¨ç«¯æ¨¡å—ä¿¡æ¯å¡ç‰‡ä¼˜åŒ– */
            #paramsGridModule .info-card {
                padding: 14px !important;
                min-height: 0 !important;
            }
            
            #paramsGridModule .info-card-header {
                font-size: 13px !important;
                font-weight: 600 !important;
                margin-bottom: 10px !important;
            }
            
            #paramsGridModule .param-item {
                padding: 8px 0 !important;
                font-size: 13px !important;
            }
            
            #paramsGridModule .param-name {
                font-size: 12px !important;
            }
            
            #paramsGridModule .param-value {
                font-size: 15px !important;
            }
            
            /* è¿è¡Œæ¨¡å¼å¡ç‰‡ç‰¹æ®Šå¤„ç† */
            #paramsGridModule .info-card:has(.param-item:only-child) {
                min-height: 80px !important;
            }
            
            /* åŠŸç‡æ•°æ®å¡ç‰‡å›¾æ ‡ä¼˜åŒ– */
            #paramsGridFunc .card-icon {
                opacity: 0.6 !important;
            }
            
            #paramsGridFunc .card-icon svg {
                width: 18px !important;
                height: 18px !important;
            }
            
            /* åŠŸç‡å› æ•°å›¾æ ‡åœ¨å¹³æ¿ç«¯ä¿æŒè¾ƒå¤§å°ºå¯¸ */
            #paramsGridFunc .card-icon svg[width="24"],
            #paramsGridFunc .card-icon svg[width="24px"] {
                width: 44px !important;
                height: 44px !important;
            }
            
            .param-item {
                padding: 12px;
                font-size: 14px;
            }
            
            /* å¡ç‰‡ä¼˜åŒ– */
            .card {
                padding: 12px;
            }
            
            .card h2 {
                font-size: 15px;
            }
            
            /* å‚æ•°è®¾ç½®ä¼˜åŒ– */
            .param-setting-item label {
                font-size: 14px;
            }
            
            .param-setting-item input,
            .param-setting-item select {
                font-size: 14px;
            }
            
            /* é‡‡æ ·å‚æ•°æ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ */
            #paramTab1 > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            
            /* è°æ³¢ç»„æ”¹ä¸ºå•åˆ— */
            #paramTab2 > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            /* å¼¹çª—ä¼˜åŒ– */
            .modal-content {
                width: 95%;
                max-width: 95vw;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            /* æ‰‹æœºè®¿é—®ä¿¡æ¯åŒºåŸŸ */
            .mobile-access-panel {
                padding: 18px 20px;
            }

            .mobile-access-title {
                font-size: 18px;
            }
            
            .url-display .url-text {
                font-size: 14px;
            }
        }
        
        /* æ‰‹æœºç«–å± (æœ€å¤§480px) */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 16px;
            }
            
            /* æ¨¡å—ä¿¡æ¯åœ¨æ‰‹æœºç«¯æ”¹ä¸º2åˆ—å¸ƒå±€ */
            #paramsGridModule {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            #paramsGridModule .info-card {
                padding: 12px !important;
            }
            
            #paramsGridModule .info-card-header {
                font-size: 12px !important;
                margin-bottom: 8px !important;
            }
            
            #paramsGridModule .param-item {
                padding: 6px 0 !important;
                font-size: 12px !important;
            }
            
            #paramsGridModule .param-name {
                font-size: 11px !important;
            }
            
            #paramsGridModule .param-value {
                font-size: 14px !important;
            }
            
            /* åŠŸç‡æ•°æ®å¡ç‰‡å›¾æ ‡ä¼˜åŒ–ï¼ˆæ‰‹æœºç«¯ï¼‰ */
            #paramsGridFunc .card-icon {
                opacity: 0.5 !important;
            }
            
            #paramsGridFunc .card-icon svg {
                width: 16px !important;
                height: 16px !important;
            }
            
            /* åŠŸç‡å› æ•°å›¾æ ‡åœ¨æ‰‹æœºç«¯ä¿æŒè¾ƒå¤§å°ºå¯¸ */
            #paramsGridFunc .card-icon svg[width="24"],
            #paramsGridFunc .card-icon svg[width="24px"] {
                width: 40px !important;
                height: 40px !important;
            }
            
            /* æŒ‰é’®æ”¹ä¸º2åˆ—å¸ƒå±€ */
            .btn-group {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                padding: 12px 6px;
                font-size: 13px;
            }
            
            /* Tabå¯¼èˆªæ”¹ä¸ºå¯æ»šåŠ¨ */
            .card > div:first-child {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab-item {
                padding: 10px 10px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            /* å‚æ•°è®¾ç½®å­Tabå¯¼èˆª - æ‰‹æœºç«¯ä¸¤è¡Œæ˜¾ç¤º */
            .param-sub-tab-nav {
                gap: 6px !important;
                margin-bottom: 12px !important;
                padding-bottom: 8px !important;
            }
            
            .param-sub-tab-item {
                flex: 1 1 calc(50% - 3px) !important;
                min-width: calc(50% - 3px) !important;
                max-width: calc(50% - 3px) !important;
                padding: 8px 6px !important;
                font-size: 12px !important;
            }
            
            /* æ•…éšœæ¨ªå¹…ç´§å‡‘æ¨¡å¼ */
            .fault-banner {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            
            .fault-content {
                width: 100%;
            }
            
            .fault-title {
                font-size: 12px;
            }
            
            .fault-details {
                font-size: 13px;
            }
            
            /* å‚æ•°é¡¹å­—ä½“è°ƒæ•´ */
            .param-item {
                font-size: 13px;
                padding: 10px;
            }
            
            .param-name {
                font-size: 12px;
            }
            
            .param-value {
                font-size: 14px;
            }
            
            /* åŠŸç‡å› æ•°åœ†ç¯å›¾ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .power-factor-ring {
                padding: 12px;
            }
            
            .power-factor-ring svg {
                width: 80px;
                height: 80px;
            }
            
            /* é¥¼çŠ¶å›¾ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #harmonicPieChart {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            #harmonicPieChart svg {
                width: 150px;
                height: 150px;
            }
            
            #pieChartLegend {
                font-size: 12px;
                margin-top: 12px;
            }
        }
        
        /* æ‰‹æœºç«–å± (æœ€å¤§480px) */
        @media (max-width: 480px) {
            /* é¥¼çŠ¶å›¾æ‰‹æœºç«¯ä¼˜åŒ– */
            #harmonicPieChart svg {
                width: 120px;
                height: 120px;
            }
            
            #pieChartLegend {
                font-size: 11px;
                gap: 6px;
            }
            
            /* é¥¼çŠ¶å›¾æ•°å€¼ç§»åŠ¨ç«¯ä¼˜åŒ– */
            #pieChartAValue,
            #pieChartBValue,
            #pieChartCValue {
                font-size: 20px !important;
            }
            
            /* ç§»åŠ¨ç«¯é¥¼çŠ¶å›¾å¸ƒå±€ä¼˜åŒ– - æ•°å€¼æ˜¾ç¤ºåœ¨ä¸‹æ–¹ */
            .harmonic-pie-chart > div:nth-child(2) {
                flex-direction: column !important;
                gap: 8px !important;
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ– (æœ€å¤§360px) */
        @media (max-width: 360px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 10px;
            }
            
            .card {
                padding: 10px;
            }
            
            .btn {
                padding: 10px 4px;
                font-size: 12px;
            }
            
            .tab-item {
                padding: 8px 8px;
                font-size: 11px;
            }
            
            /* è¶…å°å±å¹•ï¼šæ¨¡å—ä¿¡æ¯æ”¹ä¸º1åˆ—å¸ƒå±€ */
            #paramsGridModule {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }
            
            #paramsGridModule .info-card {
                padding: 10px !important;
            }
            
            #paramsGridModule .info-card-header {
                font-size: 11px !important;
                margin-bottom: 6px !important;
            }
            
            #paramsGridModule .param-item {
                padding: 5px 0 !important;
                font-size: 11px !important;
            }
            
            #paramsGridModule .param-name {
                font-size: 10px !important;
            }
            
            #paramsGridModule .param-value {
                font-size: 13px !important;
            }
            
            /* åŠŸç‡æ•°æ®å¡ç‰‡å›¾æ ‡ä¼˜åŒ–ï¼ˆè¶…å°å±ï¼‰ */
            #paramsGridFunc .card-icon {
                opacity: 0.5 !important;
            }
            
            #paramsGridFunc .card-icon svg {
                width: 14px !important;
                height: 14px !important;
            }
            
            /* åŠŸç‡å› æ•°å›¾æ ‡åœ¨è¶…å°å±ä¿æŒè¾ƒå¤§å°ºå¯¸ */
            #paramsGridFunc .card-icon svg[width="24"],
            #paramsGridFunc .card-icon svg[width="24px"] {
                width: 36px !important;
                height: 36px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div>
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1890ff" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    ç”µèƒ½è´¨é‡ç›‘æ§ç³»ç»Ÿ
                </h1>
                <div class="status" style="margin-top: 5px;">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">æœªè¿æ¥</span>
                    <span style="margin-left: 10px; color: #999999; font-size: 12px;" id="updateTime">-</span>
                </div>
            </div>
            <div class="btn-group">
                <!-- éšè—è¿æ¥æŒ‰é’®ï¼Œç³»ç»Ÿå†…é»˜è®¤å·²åœ¨çº¿ -->
                <button class="btn btn-primary" onclick="connectDevice()" id="btnConnect" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                    </svg>
                    <span class="btn-label" id="btnConnectLabel">è¿æ¥</span>
                </button>
                <button class="btn btn-success" onclick="sendCommand('run')" id="btnRun">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    <span class="btn-label" id="btnRunLabel">å¯åŠ¨</span>
                </button>
                <button class="btn btn-danger" onclick="sendCommand('stp')" id="btnStop">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                    <span class="btn-label" id="btnStopLabel">åœæœº</span>
                </button>
                <button class="btn btn-warning" onclick="sendCommand('rst')" id="btnReset">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"></path>
                    </svg>
                    <span class="btn-label" id="btnResetLabel">å¤ä½</span>
                </button>
                <button class="btn btn-info" onclick="toggleLog()" id="btnLog">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span class="btn-label" id="btnLogLabel">æ—¥å¿—</span>
                </button>
                <button class="btn btn-secondary" onclick="showMobileAccess()" id="btnMobile">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                        <line x1="12" y1="18" x2="12.01" y2="18"></line>
                    </svg>
                    <span class="btn-label" id="btnMobileLabel">æ‰‹æœºè®¿é—®</span>
                </button>
                <button class="btn" id="roleBtn" style="background: rgba(255, 255, 255, 0.95); color: #722ed1; border: 1px solid #722ed1; font-weight: 600; min-width: 80px;" onclick="toggleRole()" title="åˆ‡æ¢æƒé™è§’è‰²">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span id="roleBtnLabel">ç”¨æˆ·</span>
                </button>
                <button class="btn" id="langBtn" style="background: rgba(255, 255, 255, 0.95); color: #1890ff; border: 1px solid #1890ff; font-weight: 600; min-width: 60px;" onclick="switchLanguage(currentLang === 'zh' ? 'en' : 'zh')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 2px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    EN
                </button>
            </div>
        </div>
        
    <!-- æ‰‹æœºè®¿é—®ä¿¡æ¯åŒºåŸŸ -->
    <div id="mobileAccessPanel" class="mobile-access-panel">
        <div class="mobile-access-header">
            <div class="mobile-access-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#1890ff" stroke-width="2">
                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                    <line x1="12" y1="18" x2="12.01" y2="18"></line>
                </svg>
                <span id="mobileAccessTitle">ğŸ“± æ‰‹æœº/å¹³æ¿è®¿é—®</span>
            </div>
            <div class="mobile-access-actions">
                <button class="close-modal" onclick="hideMobileAccess()" id="btnCloseMobile">å…³é—­</button>
            </div>
        </div>
        <p class="mobile-access-tip" id="mobileAccessTip">æ‰‹æœºè¿æ¥è®¾å¤‡WiFiåï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®ä»¥ä¸‹åœ°å€</p>
        <div class="url-display">
            <div style="font-size: 14px; margin-bottom: 10px;" id="mobileAccessUrlLabel">è®¿é—®åœ°å€ï¼š</div>
            <div class="url-text" id="mobileUrlText">http://10.10.100.101:18080/device_direct.html</div>
        </div>
        <p class="mobile-access-hint" id="mobileAccessHint">ğŸ’¡ æç¤ºï¼šå¯ä»¥å°†æ­¤åœ°å€æ·»åŠ åˆ°æ‰‹æœºä¸»å±å¹•ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è®¿é—®</p>
        </div>
        
        <!-- è‡ªå®šä¹‰å¯†ç è¾“å…¥å¯¹è¯æ¡† -->
        <div id="passwordModal" class="modal" style="display: none;" onclick="if(event.target === this) closePasswordModal();">
            <div class="modal-content" style="max-width: 400px; width: 90%;" onclick="event.stopPropagation();">
                <div class="modal-header">
                    <h2 id="passwordModalTitle">è¯·è¾“å…¥å¯†ç </h2>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #262626;">å¯†ç ï¼š</label>
                        <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç " 
                            style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                            autocomplete="off">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closePasswordModal()" style="min-width: 80px;">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="confirmPassword()" style="min-width: 80px;">ç¡®å®š</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•…éšœä¿¡æ¯æ¨ªå¹… -->
        <div id="faultBanner" class="fault-banner">
            <div class="fault-icon">âš ï¸</div>
            <div class="fault-content">
                <div class="fault-title" id="faultTitle">è®¾å¤‡çŠ¶æ€æ£€æµ‹ä¸­...</div>
                <div class="fault-details" id="faultDetails">æ­£åœ¨è·å–æ•…éšœä¿¡æ¯...</div>
            </div>
        </div>
        
        <!-- è¿æ¥é…ç½®ï¼ˆé»˜è®¤éšè—ï¼‰-->
        <div class="card" id="configCard" style="display: none;">
            <h2 id="cardConnectionTitle">è¿æ¥é…ç½®</h2>
            <div style="background: #e6f7ff; padding: 12px 16px; border-radius: 2px; margin-bottom: 15px; border-left: 4px solid #1890ff; border: 1px solid #91d5ff; border-left: 4px solid #1890ff;">
                <div style="font-size: 13px; color: #262626; line-height: 1.6;" id="offlineGuide">
                    <strong style="color: #1890ff; font-weight: 600;">ğŸ’¡ ç¦»çº¿ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    â€¢ æ­¤é¡µé¢ä¸ºå®Œå…¨æœ¬åœ°åŒ–ç‰ˆæœ¬ï¼Œæ— éœ€æœåŠ¡å™¨ï¼Œå¯ç›´æ¥ç”¨æµè§ˆå™¨æ‰“å¼€<br>
                    â€¢ <strong>æ¡¥æ¥æ¨¡å¼ï¼š</strong>éœ€è¦æœ¬åœ°è¿è¡Œæ¡¥æ¥æœåŠ¡ï¼ˆé»˜è®¤ ws://127.0.0.1:18900ï¼‰<br>
                    â€¢ <strong>ç›´è¿æ¨¡å¼ï¼š</strong>ç›´æ¥è¿æ¥åˆ°è®¾å¤‡çš„å±€åŸŸç½‘IPï¼ˆä¾‹å¦‚ ws://192.168.1.100:18899ï¼‰<br>
                    â€¢ æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨å†…å­˜ä¸­ï¼Œåˆ·æ–°é¡µé¢ä¼šæ¸…ç©º
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="config-group">
                    <label id="labelConnectMode">è¿æ¥æ¨¡å¼</label>
                    <select id="connectMode" onchange="updateConnectConfig()" style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;">
                        <option value="bridge" id="optionBridge">é€šè¿‡æ¡¥æ¥æœåŠ¡ï¼ˆæ¨èï¼‰</option>
                        <option value="direct" id="optionDirect">ç›´è¿è®¾å¤‡</option>
                    </select>
                </div>
                <div class="config-group" id="bridgeIpGroup">
                    <label id="labelBridgeAddr">æ¡¥æ¥æœåŠ¡åœ°å€</label>
                    <input type="text" id="bridgeIp" value="10.10.100.101:18900" placeholder="10.10.100.101:18900">
                </div>
                <div class="config-group" id="deviceIpGroup" style="display: none;">
                    <label id="labelDeviceAddr">è®¾å¤‡WebSocketåœ°å€</label>
                    <input type="text" id="deviceIp" value="10.10.100.254:18899" placeholder="10.10.100.254:18899">
                </div>
                <div class="config-group">
                    <label id="labelDeviceSerial">è®¾å¤‡åºåˆ—å·</label>
                    <input type="text" id="deviceSerial" value="1" placeholder="1">
                </div>
            </div>
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="connectDevice()" id="btnApplyConfig">
                    <span class="btn-label" id="btnApplyConfigLabel">åº”ç”¨é…ç½®</span>
                </button>
                <button class="btn btn-warning" onclick="disconnectDevice()" id="btnDisconnectConfig">
                    <span class="btn-label" id="btnDisconnectConfigLabel">æ–­å¼€</span>
                </button>
            </div>
        </div>
        
        <!-- Tabå¯¼èˆª -->
        <div class="card" id="mainTabCard">
            <div style="display: flex; gap: 8px; margin-bottom: 15px; padding-bottom: 5px;">
                <div class="tab-item active" onclick="switchTab(0)" id="tabNavGrid">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                    </svg>
                    <span class="tab-label" id="tabNavGridLabel">ä¸»é¡µç•Œé¢</span>
                </div>
                <div class="tab-item" onclick="switchTab(1)" id="tabNavPower">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    <span class="tab-label" id="tabNavPowerLabel">åŠŸç‡æ•°æ®</span>
                </div>
                <div class="tab-item" onclick="switchTab(2)" id="tabNavModule">
                    <svg width="16" height="16" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M339.879 498.423h-18.112c-7.515 0-13.592 6.077-13.592 13.577s6.077 13.577 13.592 13.577h18.112c7.5 0 13.592-6.077 13.592-13.577s-6.092-13.577-13.592-13.577zM720.213 321.122c17.549 0 31.837-14.289 31.837-31.838 0-5.751-1.57-11.413-4.535-16.363l-61.985-103.28c-5.692-9.545-16.156-15.445-27.272-15.445h-2.639c-11.116 0-21.581 5.899-27.302 15.445l-61.956 103.28a31.871 31.871 0 0 0-4.536 16.363c0 17.549 14.259 31.838 31.809 31.838h126.579z m-131.205-31.838c0-0.83 0.237-1.66 0.652-2.371l61.956-103.31a4.742 4.742 0 0 1 4.002-2.253h2.639c1.601 0 3.142 0.859 3.972 2.282l61.956 103.28c0.475 0.711 0.682 1.541 0.682 2.371a4.661 4.661 0 0 1-4.653 4.654h-126.58c-2.551 0.002-4.626-2.073-4.626-4.653zM267.415 498.423h-18.127c-7.5 0-13.577 6.077-13.577 13.577s6.077 13.577 13.577 13.577h18.127c7.5 0 13.577-6.077 13.577-13.577s-6.077-13.577-13.577-13.577zM412.344 525.577c7.515 0 13.592-6.077 13.592-13.577s-6.077-13.577-13.592-13.577h-18.112c-7.515 0-13.592 6.077-13.592 13.577s6.077 13.577 13.592 13.577h18.112zM398.768 357.999v-36.225c0-7.5-6.092-13.607-13.592-13.607-7.515 0-13.592 6.107-13.592 13.607v36.225c0 7.5 6.077 13.607 13.592 13.607 7.5 0 13.592-6.107 13.592-13.607z"></path>
                        <path d="M453.105 403.296V276.478c0-7.5-6.077-13.577-13.577-13.577h-54.352c-7.515 0-13.592 6.077-13.592 13.577s6.077 13.577 13.592 13.577h40.76v99.663H235.71v-99.663h95.113c7.5 0 13.592-6.077 13.592-13.577s-6.092-13.577-13.592-13.577H222.119c-7.515 0-13.592 6.077-13.592 13.577v126.817c0 7.5 6.092 13.577 13.592 13.577h217.409c7.5 0 13.577-6.076 13.577-13.576z"></path>
                        <path d="M330.823 308.168c-7.515 0-13.592 6.107-13.592 13.607V358c0 7.5 6.077 13.607 13.592 13.607 7.5 0 13.592-6.107 13.592-13.607v-36.225c0-7.5-6.092-13.607-13.592-13.607zM262.879 321.775V358c0 7.5 6.092 13.607 13.591 13.607 7.5 0 13.592-6.107 13.592-13.607v-36.225c0-7.5-6.092-13.607-13.592-13.607-7.499 0-13.591 6.107-13.591 13.607zM892.444 915.1h-22.648V131.549c0-27.48-22.352-49.832-49.802-49.832H493.88c-27.48 0-49.832 22.352-49.832 49.832v36.225c0 7.5 6.092 13.577 13.592 13.577 7.515 0 13.592-6.077 13.592-13.577v-36.225c0-12.51 10.153-22.648 22.648-22.648h326.114c12.48 0 22.648 10.138 22.648 22.648v240.058H548.218c-7.5 0-13.577 6.077-13.577 13.577s6.077 13.577 13.577 13.577h294.425v335.186h-330.65c-7.5 0-13.592 6.076-13.592 13.576s6.092 13.577 13.592 13.577h330.65v154h-77.016c-7.5 0-13.577 6.077-13.577 13.606 0 7.5 6.077 13.577 13.577 13.577h126.817c7.529 0 13.606-6.077 13.606-13.577-0.029-7.529-6.076-13.606-13.606-13.606z"></path>
                        <path d="M747.515 543.719c27.48 0 49.832-22.352 49.832-49.831 0-27.48-22.352-49.832-49.832-49.832-27.479 0-49.832 22.352-49.832 49.832 0 27.479 22.352 49.831 49.832 49.831z m0-72.479c12.48 0 22.648 10.168 22.648 22.648s-10.168 22.647-22.648 22.647-22.648-10.167-22.648-22.647c-0.001-12.481 10.167-22.648 22.648-22.648zM711.26 915.1H471.232V620.705c0-7.5-6.077-13.577-13.592-13.577-7.5 0-13.592 6.077-13.592 13.577v58.873h-67.93a4.526 4.526 0 0 1-4.535-4.536v-41.086c15.341-2.194 27.168-15.415 27.168-31.364v-22.647h77c17.49 0 31.705-14.229 31.705-31.72V240.253c0-17.49-14.214-31.719-31.705-31.719H185.879c-17.475 0-31.705 14.229-31.705 31.719v307.972c0 17.49 14.229 31.72 31.705 31.72h77v22.647c0 15.949 11.828 29.17 27.183 31.364v41.086c0 47.46 38.597 86.057 86.057 86.057h67.93V915.1H131.526c-7.5 0-13.577 6.077-13.577 13.606 0 7.5 6.077 13.577 13.577 13.577H711.26c7.53 0 13.606-6.077 13.606-13.577A13.587 13.587 0 0 0 711.26 915.1zM185.879 552.761a4.523 4.523 0 0 1-4.521-4.536V471.24h22.648c7.5 0 13.577-6.077 13.577-13.577 0-7.53-6.077-13.607-13.577-13.607h-22.648V240.253a4.523 4.523 0 0 1 4.521-4.535h289.874a4.526 4.526 0 0 1 4.536 4.535v203.803h-221.93c-7.515 0-13.592 6.077-13.592 13.607 0 7.5 6.077 13.577 13.592 13.577h221.93v76.985a4.526 4.526 0 0 1-4.536 4.536H185.879z m108.704 54.367c-2.49 0-4.521-2.046-4.521-4.536v-22.647h81.521v22.647a4.546 4.546 0 0 1-4.536 4.536h-72.464z m149.466 126.818h-67.93c-32.475 0-58.888-26.413-58.888-58.903v-40.761h27.184v40.761c0 17.49 14.214 31.72 31.689 31.72h67.944v27.183h0.001zM656.952 274.522c7.471 0 13.577-6.077 13.577-13.577v-23.3c0-7.5-6.106-13.577-13.577-13.577-7.529 0-13.606 6.077-13.606 13.577v23.3c0 7.5 6.077 13.577 13.606 13.577z"></path>
                        <path d="M638.81 543.719c17.49 0 31.72-14.229 31.72-31.719v-36.225c0-17.49-14.229-31.719-31.72-31.719h-54.367c-17.46 0-31.689 14.229-31.689 31.719V512c0 17.49 14.229 31.719 31.689 31.719h54.367zM579.937 512v-36.225c0-2.52 2.017-4.536 4.506-4.536h54.367a4.536 4.536 0 0 1 4.536 4.536V512c0 2.49-2.046 4.535-4.536 4.535h-54.367c-2.49 0-4.506-2.045-4.506-4.535zM516.528 620.705v36.225c0 17.49 14.199 31.719 31.689 31.719h90.592c17.49 0 31.72-14.229 31.72-31.719v-36.225c0-17.49-14.229-31.72-31.72-31.72h-90.592c-17.489 0.001-31.689 14.23-31.689 31.72z m126.818 0v36.225a4.535 4.535 0 0 1-4.536 4.535h-90.592c-2.49 0-4.506-2.016-4.506-4.535v-36.225c0-2.49 2.016-4.536 4.506-4.536h90.592c2.49 0 4.536 2.046 4.536 4.536zM729.402 851.692h-144.96c-7.47 0-13.576 6.076-13.576 13.606 0 7.5 6.106 13.577 13.576 13.577h144.96c7.5 0 13.577-6.077 13.577-13.577 0-7.53-6.077-13.606-13.577-13.606zM729.402 797.354h-144.96c-7.47 0-13.576 6.077-13.576 13.577s6.106 13.577 13.576 13.577h144.96c7.5 0 13.577-6.077 13.577-13.577s-6.077-13.577-13.577-13.577zM747.515 688.649c27.48 0 49.832-22.352 49.832-49.831 0-27.48-22.352-49.832-49.832-49.832-27.479 0-49.832 22.352-49.832 49.832 0 27.479 22.352 49.831 49.832 49.831z m0-72.48c12.48 0 22.648 10.168 22.648 22.648 0 12.479-10.168 22.647-22.648 22.647s-22.648-10.168-22.648-22.647c-0.001-12.48 10.167-22.648 22.648-22.648z"></path>
                    </svg>
                    <span class="tab-label" id="tabNavModuleLabel">æ¨¡å—ä¿¡æ¯</span>
                </div>
                <div class="tab-item" onclick="switchTab(3)" id="tabNavParam">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="4" y1="21" x2="4" y2="14"></line>
                        <line x1="4" y1="10" x2="4" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12" y2="3"></line>
                        <line x1="20" y1="21" x2="20" y2="16"></line>
                        <line x1="20" y1="12" x2="20" y2="3"></line>
                        <line x1="1" y1="14" x2="7" y2="14"></line>
                        <line x1="9" y1="8" x2="15" y2="8"></line>
                        <line x1="17" y1="16" x2="23" y2="16"></line>
                    </svg>
                    <span class="tab-label" id="tabNavParamLabel">å‚æ•°è®¾ç½®</span>
                </div>
                <div class="tab-item" onclick="switchTab(4)" id="tabNavVersion">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span class="tab-label" id="tabNavVersionLabel">ç‰ˆæœ¬ä¿¡æ¯</span>
                </div>
            </div>
            
            <!-- Tab 0: ä¸»é¡µç•Œé¢ -->
            <div id="tab0" class="tab-content">
                <!-- ç”µç½‘åŠŸç‡å› æ•°åœ†ç¯å›¾ -->
                <div style="margin-bottom: 24px;">
                    <div style="margin-bottom: 16px;">
                        <h3 style="font-size: 14px; color: #262626; margin: 0; font-weight: 600;" id="pfTitleGrid">ç”µç½‘åŠŸç‡å› æ•°</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px;">
                        <!-- ç”µç½‘Aç›¸åŠŸç‡å› æ•° -->
                        <div class="power-factor-ring">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #595959; font-weight: 500;" id="pfGridALabel">ç”µç½‘Aç›¸</div>
                            <svg width="100" height="100" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="#f0f0f0" stroke-width="8"></circle>
                                <circle id="pfRingAGrid" cx="50" cy="50" r="40" fill="none" stroke="#1890ff" stroke-width="8" 
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" 
                                    transform="rotate(-90 50 50)" stroke-linecap="round"></circle>
                                <text x="50" y="50" text-anchor="middle" dominant-baseline="middle" 
                                    font-size="18" font-weight="600" fill="#262626" id="pfValueAGrid">--</text>
                            </svg>
                        </div>
                        
                        <!-- ç”µç½‘Bç›¸åŠŸç‡å› æ•° -->
                        <div class="power-factor-ring">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #595959; font-weight: 500;" id="pfGridBLabel">ç”µç½‘Bç›¸</div>
                            <svg width="100" height="100" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="#f0f0f0" stroke-width="8"></circle>
                                <circle id="pfRingBGrid" cx="50" cy="50" r="40" fill="none" stroke="#1890ff" stroke-width="8" 
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" 
                                    transform="rotate(-90 50 50)" stroke-linecap="round"></circle>
                                <text x="50" y="50" text-anchor="middle" dominant-baseline="middle" 
                                    font-size="18" font-weight="600" fill="#262626" id="pfValueBGrid">--</text>
                            </svg>
                        </div>
                        
                        <!-- ç”µç½‘Cç›¸åŠŸç‡å› æ•° -->
                        <div class="power-factor-ring">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #595959; font-weight: 500;" id="pfGridCLabel">ç”µç½‘Cç›¸</div>
                            <svg width="100" height="100" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="40" fill="none" stroke="#f0f0f0" stroke-width="8"></circle>
                                <circle id="pfRingCGrid" cx="50" cy="50" r="40" fill="none" stroke="#1890ff" stroke-width="8" 
                                    stroke-dasharray="251.2" stroke-dashoffset="251.2" 
                                    transform="rotate(-90 50 50)" stroke-linecap="round"></circle>
                                <text x="50" y="50" text-anchor="middle" dominant-baseline="middle" 
                                    font-size="18" font-weight="600" fill="#262626" id="pfValueCGrid">--</text>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- THDUå’ŒTHDIé¥¼çŠ¶å›¾ -->
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 14px; color: #262626; margin: 0; font-weight: 600;" id="thdTitle">THD</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                        <!-- THDUé¥¼çŠ¶å›¾ -->
                        <div class="power-factor-ring">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #595959; font-weight: 500;" id="thduLabel">THDU (ç”µå‹)</div>
                            <svg width="100" height="100" viewBox="0 0 100 100">
                                <g id="thduPieChart" transform="translate(50,50)">
                                    <circle cx="0" cy="0" r="40" fill="#f0f0f0" stroke="#e8e8e8" stroke-width="2"></circle>
                                </g>
                                <text x="50" y="50" text-anchor="middle" dominant-baseline="middle" 
                                    font-size="16" font-weight="600" fill="#262626" id="thduValue">--</text>
                            </svg>
                        </div>
                        
                        <!-- THDIé¥¼çŠ¶å›¾ -->
                        <div class="power-factor-ring">
                            <div style="text-align: center; margin-bottom: 8px; font-size: 13px; color: #595959; font-weight: 500;" id="thdiLabel">THDI (ç”µæµ)</div>
                            <svg width="100" height="100" viewBox="0 0 100 100">
                                <g id="thdiPieChart" transform="translate(50,50)">
                                    <circle cx="0" cy="0" r="40" fill="#f0f0f0" stroke="#e8e8e8" stroke-width="2"></circle>
                                </g>
                                <text x="50" y="50" text-anchor="middle" dominant-baseline="middle" 
                                    font-size="16" font-weight="600" fill="#262626" id="thdiValue">--</text>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="params-grid" id="paramsGridPower">
                    <div id="gridPlaceholder" style="grid-column: 1/-1; text-align: center; color: #999999; padding: 20px;">
                        æœªè¿æ¥è®¾å¤‡ï¼Œè¯·ç‚¹å‡»"è¿æ¥"æŒ‰é’®
                    </div>
                </div>
                <div class="update-time" id="lastUpdate">-</div>
            </div>
            
            <!-- Tab 1: åŠŸç‡æ•°æ® -->
            <div id="tab1" class="tab-content" style="display: none;">
                <!-- åŠŸç‡æ•°æ®åˆ—è¡¨ -->
                <div class="params-grid" id="paramsGridFunc">
                    <div id="powerPlaceholder" style="grid-column: 1/-1; text-align: center; color: #999999; padding: 20px;">
                        æš‚æ— æ•°æ®
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: æ¨¡å—ä¿¡æ¯ -->
            <div id="tab2" class="tab-content" style="display: none;">
                <div class="params-grid" id="paramsGridModule">
                    <div id="modulePlaceholder" style="grid-column: 1/-1; text-align: center; color: #999999; padding: 20px;">
                        æš‚æ— æ•°æ®
                    </div>
                </div>
            </div>
            
            <!-- Tab 3: å‚æ•°è®¾ç½® -->
            <div id="tab3" class="tab-content" style="display: none;">
                <!-- å‚æ•°è®¾ç½®å­Tabå¯¼èˆª -->
                <div class="param-sub-tab-nav" style="display: flex; gap: 15px; border-bottom: 1px solid #e8e8e8; margin-bottom: 20px;">
                    <div class="tab-item param-sub-tab-item active" onclick="switchParamTab(0)" style="font-size: 14px;"><span id="mainParamTabNav0">è¡¥å¿ä¸è‡ªå¯åŠ¨</span></div>
                    <div class="tab-item param-sub-tab-item" onclick="switchParamTab(1)" style="font-size: 14px;"><span id="mainParamTabNav1">ç³»ç»Ÿå‚æ•°</span></div>
                    <div class="tab-item param-sub-tab-item" onclick="switchParamTab(2)" style="font-size: 14px;"><span id="mainParamTabNav2">é‡‡æ ·å‚æ•°</span></div>
                    <div class="tab-item param-sub-tab-item" onclick="switchParamTab(3)" style="font-size: 14px;"><span id="mainParamTabNav3">è°æ³¢ç»„</span></div>
                    <div class="tab-item param-sub-tab-item single-param-tab" onclick="switchParamTab(4)" style="font-size: 14px;"><span id="mainParamTabNav4">å•å‚æ•°è®¾ç½®</span></div>
                    <div class="tab-item param-sub-tab-item password-manage-tab hidden-by-role" onclick="switchParamTab(5)" style="font-size: 14px; display: none;"><span id="mainParamTabNav5">å¯†ç ç®¡ç†</span></div>
                </div>
                
                <!-- å‚æ•°è®¾ç½®å­Tabå†…å®¹ -->
                <div id="paramTabMain0" class="tab-content param-tab-panel" data-param-tab="0"></div>
                <div id="paramTabMain1" class="tab-content param-tab-panel" data-param-tab="1" style="display: none;"></div>
                <div id="paramTabMain2" class="tab-content param-tab-panel" data-param-tab="2" style="display: none;"></div>
                <div id="paramTabMain3" class="tab-content param-tab-panel" data-param-tab="3" style="display: none;"></div>
                <div id="paramTabMain4" class="tab-content param-tab-panel" data-param-tab="4" style="display: none;"></div>
                <div id="paramTabMain5" class="tab-content param-tab-panel" data-param-tab="5" style="display: none;"></div>
            </div>
            
            <!-- Tab 4: ç‰ˆæœ¬ä¿¡æ¯ -->
            <div id="tab4" class="tab-content" style="display: none;">
                <div class="params-grid" id="paramsGridVersion">
                    <div id="versionPlaceholder" style="grid-column: 1/-1; text-align: center; color: #999999; padding: 20px;">
                        æš‚æ— æ•°æ®
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å‚æ•°è®¾ç½®å¼¹çª— -->
        <div id="paramDialog" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 id="dialogParamTitle">ğŸ“ å‚æ•°è®¾ç½®</h2>
                    <button class="btn" onclick="closeParamDialog()" style="background: #ff4d4f; color: white; padding: 5px 15px;">âœ•</button>
                </div>
                <div class="modal-body">
                    <!-- Tabå¯¼èˆª -->
                    <div class="param-sub-tab-nav" style="display: flex; gap: 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px;">
                        <div class="tab-item param-sub-tab-item active" onclick="switchParamTab(0)"><span id="paramTabNav0">è¡¥å¿ä¸è‡ªå¯åŠ¨</span></div>
                        <div class="tab-item param-sub-tab-item" onclick="switchParamTab(1)"><span id="paramTabNav1">ç³»ç»Ÿå‚æ•°</span></div>
                        <div class="tab-item param-sub-tab-item" onclick="switchParamTab(2)"><span id="paramTabNav2">é‡‡æ ·å‚æ•°</span></div>
                        <div class="tab-item param-sub-tab-item" onclick="switchParamTab(3)"><span id="paramTabNav3">è°æ³¢ç»„</span></div>
                        <div class="tab-item param-sub-tab-item single-param-tab" onclick="switchParamTab(4)"><span id="paramTabNav4">å•å‚æ•°è®¾ç½®</span></div>
                        <div class="tab-item param-sub-tab-item password-manage-tab hidden-by-role" onclick="switchParamTab(5)" style="display: none;"><span id="paramTabNav5">å¯†ç ç®¡ç†</span></div>
                    </div>
                    
                    <!-- Tabå†…å®¹ -->
                    <div id="paramTabDialog0" class="tab-content param-tab-panel" data-param-tab="0"></div>
                    <div id="paramTabDialog1" class="tab-content param-tab-panel" data-param-tab="1" style="display: none;"></div>
                    <div id="paramTabDialog2" class="tab-content param-tab-panel" data-param-tab="2" style="display: none;"></div>
                    <div id="paramTabDialog3" class="tab-content param-tab-panel" data-param-tab="3" style="display: none;"></div>
                    <div id="paramTabDialog4" class="tab-content param-tab-panel" data-param-tab="4" style="display: none;"></div>
                    <div id="paramTabDialog5" class="tab-content param-tab-panel" data-param-tab="5" style="display: none;"></div>
                </div>
            </div>
        </div>
        
        <!-- é€šä¿¡æ—¥å¿—ï¼ˆé»˜è®¤éšè—ï¼‰-->
        <div class="card" id="logCard" style="display: none;">
            <h2><span id="cardCommLogTitle">é€šä¿¡æ—¥å¿—</span> 
                <button class="btn" style="float: right; padding: 4px 12px; background: #ffffff; color: #595959; border: 1px solid #d9d9d9; font-size: 12px; min-height: auto;" onclick="clearLogs()" id="btnClearLog">
                    <span class="btn-label" id="btnClearLogLabel">æ¸…ç©º</span>
                </button>
            </h2>
            <div class="log-box" id="logBox">
                <div class="log-item info" id="logInitialMessage"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== å¤šè¯­è¨€ç¿»è¯‘ç³»ç»Ÿ ==========
        let currentLang = 'zh'; // é»˜è®¤ä¸­æ–‡
        
        const translations = {
            zh: {
                // æ ‡é¢˜
                title: 'ç”µèƒ½è´¨é‡ç›‘æ§ç³»ç»Ÿ',
                // çŠ¶æ€
                connected: 'å·²è¿æ¥',
                disconnected: 'æœªè¿æ¥',
                connecting: 'è¿æ¥ä¸­...',
                serverMode: 'æœåŠ¡å™¨æ¨¡å¼',
                running: 'è¿è¡Œä¸­',
                stopped: 'å·²åœæ­¢',
                // æŒ‰é’®
                btnConnect: 'è¿æ¥',
                btnDisconnect: 'æ–­å¼€',
                btnStart: 'å¯åŠ¨',
                btnStop: 'åœæœº',
                btnReset: 'å¤ä½',
                btnLog: 'æ—¥å¿—',
                btnMobileAccess: 'æ‰‹æœºè®¿é—®',
                btnApplyConfig: 'åº”ç”¨é…ç½®',
                btnClearLog: 'æ¸…ç©º',
                roleAdmin: 'ç®¡ç†å‘˜',
                roleUser: 'ç”¨æˆ·',
                adminPasswordPrompt: 'è¯·è¾“å…¥å¯†ç ï¼š',
                adminPasswordError: 'å¯†ç é”™è¯¯ï¼Œæ— æ³•åˆ‡æ¢åˆ°ç®¡ç†å‘˜æƒé™',
                btnQuery: 'æŸ¥è¯¢',
                btnSave: 'ä¿å­˜',
                btnBatchQuery: 'æ‰¹é‡æŸ¥è¯¢',
                btnBatchSave: 'æ‰¹é‡ä¿å­˜',
                btnSyncParam: 'ğŸ” æŸ¥è¯¢å‚æ•°',
                btnSaveParam: 'âœ… è®¾ç½®å‚æ•°',
                // å¡ç‰‡æ ‡é¢˜
                cardConnection: 'è¿æ¥é…ç½®',
                cardGridInfo: 'ä¸»é¡µç•Œé¢',
                cardPowerData: 'åŠŸç‡æ•°æ®',
                cardModuleInfo: 'æ¨¡å—ä¿¡æ¯',
                cardParamSetting: 'å‚æ•°è®¾ç½®',
                cardVersionInfo: 'ç‰ˆæœ¬ä¿¡æ¯',
                cardCommLog: 'é€šä¿¡æ—¥å¿—',
                // ä¸»Tabå¯¼èˆª
                tabGridInfo: 'ä¸»é¡µç•Œé¢',
                tabPowerData: 'åŠŸç‡æ•°æ®',
                tabModuleInfo: 'æ¨¡å—ä¿¡æ¯',
                tabParamSetting: 'å‚æ•°è®¾ç½®',
                tabVersionInfo: 'ç‰ˆæœ¬ä¿¡æ¯',
                // å­Tabæ ‡ç­¾
                tabCompensation: 'è¡¥å¿ä¸è‡ªå¯åŠ¨',
                tabSystemParam: 'ç³»ç»Ÿå‚æ•°',
                tabSampling: 'é‡‡æ ·å‚æ•°',
                tabHarmonic: 'è°æ³¢ç»„',
                tabSingleParam: 'å•å‚æ•°è®¾ç½®',
                systemParamParallelCabinets: 'å¹¶è”æŸœä½“æ•°é‡',
                systemParamModuleCapacityRatio: 'æŸœå†…æ¨¡å—å®¹é‡å æ¯”',
                systemParamDIEnable: 'DIå¯åœä½¿èƒ½',
                systemParamAutoEnable: 'è‡ªå¯åœä½¿èƒ½',
                systemParamPowerFactor: 'åŠŸç‡å› æ•°',
                // æç¤ºä¿¡æ¯
                msgOfflineInfo: 'ğŸ’¡ ç¦»çº¿ä½¿ç”¨è¯´æ˜ï¼š',
                msgNoData: 'æš‚æ— æ•°æ®',
                msgNotConnected: 'æœªè¿æ¥è®¾å¤‡ï¼Œè¯·ç‚¹å‡»"è¿æ¥"æŒ‰é’®',
                msgClearLog: 'æ¸…ç©º',
                infoCardEmpty: 'æš‚æ— æ•°æ®',
                infoCardWaiting: 'ç­‰å¾…è®¾å¤‡ä¸ŠæŠ¥...',
                // é…ç½®
                cfgConnectMode: 'è¿æ¥æ¨¡å¼',
                cfgBridgeMode: 'é€šè¿‡æ¡¥æ¥æœåŠ¡ï¼ˆæ¨èï¼‰',
                cfgDirectMode: 'ç›´è¿è®¾å¤‡',
                cfgBridgeAddr: 'æ¡¥æ¥æœåŠ¡åœ°å€',
                cfgDeviceAddr: 'è®¾å¤‡WebSocketåœ°å€',
                cfgDeviceSerial: 'è®¾å¤‡åºåˆ—å·',
                // å…¶ä»–
                lastUpdate: 'æœ€åæ›´æ–°',
                lang: 'è¯­è¨€',
                // åŠŸç‡å› æ•°
                pfTitle: 'åŠŸç‡å› æ•°',
                pfTitleGrid: 'ç”µç½‘åŠŸç‡å› æ•°',
                legendExcellent: 'ä¼˜ç§€(â‰¥0.95)',
                legendGood: 'è‰¯å¥½(0.90-0.95)',
                legendImprove: 'éœ€æ”¹å–„(<0.90)',
                pfSystemA: 'ç”µç½‘Aç›¸',
                pfSystemB: 'ç”µç½‘Bç›¸',
                pfSystemC: 'ç”µç½‘Cç›¸',
                pfSystemTotal: 'ç”µç½‘æ€»',
                pfAverage: 'å¹³å‡å€¼',
                apparentPower: 'è§†åœ¨åŠŸç‡',
                pfGridA: 'ç”µç½‘Aç›¸',
                pfGridB: 'ç”µç½‘Bç›¸',
                pfGridC: 'ç”µç½‘Cç›¸',
                dialogParamTitle: 'ğŸ“ å‚æ•°è®¾ç½®',
                mobileAccessTitle: 'ğŸ“± æ‰‹æœº/å¹³æ¿è®¿é—®',
                mobileAccessTip: 'æ‰‹æœºè¿æ¥è®¾å¤‡WiFiåï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®ä»¥ä¸‹åœ°å€',
                mobileAccessUrlLabel: 'è®¿é—®åœ°å€ï¼š',
                mobileAccessHint: 'ğŸ’¡ æç¤ºï¼šå¯ä»¥å°†æ­¤åœ°å€æ·»åŠ åˆ°æ‰‹æœºä¸»å±å¹•ï¼Œæ–¹ä¾¿ä¸‹æ¬¡è®¿é—®',
                btnCloseMobile: 'å…³é—­',
                // å¡ç‰‡åˆ†ç»„æ ‡é¢˜
                cardGridVoltage: 'ç”µç½‘ç”µå‹',
                cardGridCurrent: 'ç”µç½‘ç”µæµ',
                cardPowerQuality: 'åŠŸç‡è´¨é‡',
                cardSystemAPower: 'ç”µç½‘Aç›¸åŠŸç‡',
                cardSystemBPower: 'ç”µç½‘Bç›¸åŠŸç‡',
                cardSystemCPower: 'ç”µç½‘Cç›¸åŠŸç‡',
                cardLoadAPower: 'è´Ÿè½½Aç›¸åŠŸç‡',
                cardLoadBPower: 'è´Ÿè½½Bç›¸åŠŸç‡',
                cardLoadCPower: 'è´Ÿè½½Cç›¸åŠŸç‡',
                cardGridActivePower: 'ç”µç½‘æœ‰åŠŸ',
                cardGridReactivePower: 'ç”µç½‘æ— åŠŸ',
                cardGridApparentPower: 'ç”µç½‘è§†åœ¨',
                cardLoadActivePower: 'è´Ÿè½½æœ‰åŠŸ',
                cardLoadReactivePower: 'è´Ÿè½½æ— åŠŸ',
                cardLoadApparentPower: 'è´Ÿè½½è§†åœ¨',
                cardTemperature: 'æ¸©åº¦æ£€æµ‹',
                cardBusVoltage: 'æ¯çº¿ç”µå‹',
                cardDeviceCurrent: 'è£…ç½®ç”µæµ',
                cardDeviceActivePower: 'è£…ç½®æœ‰åŠŸ',
                cardDeviceReactivePower: 'è£…ç½®æ— åŠŸ',
                cardDeviceApparentPower: 'è£…ç½®è§†åœ¨',
                cardLoadCurrent: 'è´Ÿè½½ç”µæµ',
                cardFrequency: 'ç”µç½‘é¢‘ç‡',
                cardEquipmentCurrent: 'è®¾å¤‡ç”µæµ',
                cardPowerStats: 'åŠŸç‡ç»Ÿè®¡',
                cardEnergyStats: 'èƒ½è€—ç»Ÿè®¡',
                cardRunMode: 'è¿è¡Œæ¨¡å¼',
                cardVersionInfoTitle: 'ç‰ˆæœ¬ä¿¡æ¯',
                cardDeviceStatus: 'è®¾å¤‡çŠ¶æ€',
                cardFaultInfo: 'æ•…éšœä¿¡æ¯',
                cardVoltageHarmonic: 'ç”µå‹æ€»è°æ³¢å«é‡',
                cardGridCurrentHarmonic: 'ç”µç½‘ç”µæµæ€»è°æ³¢å«é‡',
                cardLoadCurrentHarmonic: 'è´Ÿè½½ç”µæµæ€»è°æ³¢å«é‡',
                cardGridPowerFactor: 'ç”µç½‘åŠŸç‡å› æ•°',
                cardLoadPowerFactor: 'è´Ÿè½½åŠŸç‡å› æ•°',
                harmonicChartTitle: 'è´Ÿè½½ç”µæµè°æ³¢å«é‡',
                legendHarmonicA: 'Aç›¸',
                legendHarmonicB: 'Bç›¸',
                legendHarmonicC: 'Cç›¸',
                thdTitle: 'ç”µç½‘THD',
                thduLabel: 'THDU',
                thdiLabel: 'THDI',
                gridTotalActivePower: 'ç”µç½‘æ€»æœ‰åŠŸåŠŸç‡',
                gridTotalReactivePower: 'ç”µç½‘æ€»æ— åŠŸåŠŸç‡',
                gridTotalApparentPower: 'ç”µç½‘æ€»è§†åœ¨åŠŸç‡',
                gridAvgPowerFactor: 'ç”µç½‘å¹³å‡åŠŸç‡å› æ•°',
                loadTotalActivePower: 'è´Ÿè½½æ€»æœ‰åŠŸåŠŸç‡',
                loadTotalReactivePower: 'è´Ÿè½½æ€»æ— åŠŸåŠŸç‡',
                loadTotalApparentPower: 'è´Ÿè½½æ€»è§†åœ¨åŠŸç‡',
                loadAvgPowerFactor: 'è´Ÿè½½å¹³å‡åŠŸç‡å› æ•°',
                compModeLabel: 'å·¥ä½œæ¨¡å¼',
                selectPlaceholder: 'è¯·é€‰æ‹©',
                compModeOption1: 'ä¸å¹³è¡¡è¡¥å¿',
                compModeOption2: 'æ— åŠŸè¡¥å¿',
                compModeOption4: 'è°æ³¢è¡¥å¿',
                compModeOption6: 'æ— åŠŸ+è°æ³¢è¡¥å¿',
                compModeOption11: 'å…¶ä»–æ¨¡å¼',
                compModeOption13: 'è°æ³¢+ä¸å¹³è¡¡è¡¥å¿',
                compModeOption14: 'è°æ³¢+æ— åŠŸè¡¥å¿',
                compModeOption15: 'è°æ³¢+ä¸å¹³è¡¡+æ— åŠŸè¡¥å¿',
                compModeOption16: 'è‡ªè€åŒ–å‘æ— åŠŸ',
                compModeOption35: 'æ— åŠŸ+ä¸å¹³è¡¡è¡¥å¿',
                compModeOption39: 'æ— åŠŸ+ä¸å¹³è¡¡+è°æ³¢è¡¥å¿',
                autoEnableLabel: 'è‡ªå¯åŠ¨ä½¿èƒ½',
                autoEnableHint: 'å¸¸ç”¨å€¼: 0=ä¸ä½¿èƒ½, 1=ä½¿èƒ½',
                inputPlaceholder: 'è¯·è¾“å…¥',
                enablePlaceholder: '0=ä¸ä½¿èƒ½, 1=ä½¿èƒ½',
                deviceCurrentSamplingTitle: 'ğŸ”§ è®¾å¤‡ç”µæµé‡‡æ ·',
                devSampleEnableLabel: 'è®¾å¤‡é‡‡æ ·ä½¿èƒ½',
                devSamplePosLabel: 'è®¾å¤‡é‡‡æ ·ä½ç½®',
                devSampleDirLabel: 'è®¾å¤‡é‡‡æ ·æ–¹å‘',
                devCTLabel: 'è®¾å¤‡CTå˜æ¯”',
                unitPointOne: 'å•ä½: 0.1',
                ctInputPlaceholder: 'è¯·è¾“å…¥ï¼ˆå¦‚50è¡¨ç¤º5.0ï¼‰',
                inputCurrentSamplingTitle: 'ğŸ“¥ è¾“å…¥ç”µæµé‡‡æ ·',
                inSamplePosLabel: 'è¾“å…¥é‡‡æ ·ä½ç½®',
                inSampleDirLabel: 'è¾“å…¥é‡‡æ ·æ–¹å‘',
                inCTLabel: 'è¾“å…¥CTå˜æ¯”',
                singleParamTip: '<strong>ğŸ’¡ æç¤ºï¼š</strong>æ­¤åŠŸèƒ½ç›´æ¥ä½¿ç”¨WebSocketåè®®ä¸è®¾å¤‡é€šä¿¡ï¼Œå¯è®¾ç½®ä»»æ„åŠŸèƒ½ç å‚æ•°ã€‚',
                paramAddrLabel: '<span style="color: red;">*</span> å‚æ•°åœ°å€ï¼ˆåŠŸèƒ½ç ï¼‰',
                paramValueLabel: '<span style="color: red;">*</span> å‚æ•°å€¼',
                addrPlaceholder: 'è¯·è¾“å…¥åŠŸèƒ½ç ï¼ˆ2-1000ï¼‰',
                valuePlaceholder: 'è¯·è¾“å…¥å‚æ•°å€¼ï¼ˆ0-65535ï¼‰',
                queryResultTitle: 'æŸ¥è¯¢ç»“æœï¼š',
                singleParamResultMessage: 'åŠŸèƒ½ç  <strong>{addr}</strong> çš„å½“å‰å€¼ä¸º: <strong style="color: #1890ff; font-size: 16px;">{value}</strong>',
                singleParamSaveMessage: 'å·²å‘é€ä¿å­˜å‘½ä»¤ï¼šåŠŸèƒ½ç  <strong>{addr}</strong> = <strong style="color: #52c41a;">{value}</strong>',
                alertInvalidFuncCode: 'è¯·è¾“å…¥æœ‰æ•ˆçš„åŠŸèƒ½ç ï¼ˆ2-1000ï¼‰',
                alertEnterValue: 'è¯·å…ˆè¾“å…¥å‚æ•°å€¼',
                alertInvalidValueRange: 'è¯·è¾“å…¥æœ‰æ•ˆçš„å‚æ•°å€¼ï¼ˆ0-65535ï¼‰',
                harmGroup1Label: 'ç¬¬1ç»„è°æ³¢æ¬¡æ•°',
                harmGroup2Label: 'ç¬¬2ç»„è°æ³¢æ¬¡æ•°',
                harmGroup3Label: 'ç¬¬3ç»„è°æ³¢æ¬¡æ•°',
                harmGroup4Label: 'ç¬¬4ç»„è°æ³¢æ¬¡æ•°',
                harmGroup5Label: 'ç¬¬5ç»„è°æ³¢æ¬¡æ•°',
                harmGroup6Label: 'ç¬¬6ç»„è°æ³¢æ¬¡æ•°',
                harmGroup7Label: 'ç¬¬7ç»„è°æ³¢æ¬¡æ•°',
                harmGroup8Label: 'ç¬¬8ç»„è°æ³¢æ¬¡æ•°',
                oddHarmonics: 'å¥‡æ•°è°æ³¢æ¬¡æ•°',
                evenHarmonics: 'å¶æ•°è°æ³¢æ¬¡æ•°',
                currentHarmonicGroup: 'å½“å‰é€‰æ‹©çš„è°æ³¢ç»„',
                harmonicGroupClickHint: 'æœ€å¤šé€‰æ‹©8ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»æŒ‰é’®é€‰æ‹©/å–æ¶ˆé€‰æ‹©ï¼Œæ‰¹é‡ä¿å­˜æ—¶æŒ‰å·²é€‰æ‹©æŒ‰é’®çš„è°æ³¢æ¬¡æ•°ä»å°åˆ°å¤§ä¾æ¬¡å¡«å…¥8ç»„ï¼ˆ265-272ï¼‰ï¼Œæ¯ä¸ªç»„å­˜ä¸€ä¸ªè°æ³¢æ¬¡æ•°ï¼Œä¸è¶³8ä¸ªæ—¶åé¢è¡¥0',
                harmonicGroupMaxButtons: 'æœ€å¤šåªèƒ½é€‰æ‹©8ä¸ªæŒ‰é’®',
                currentEditingGroup: 'å½“å‰ç¼–è¾‘ç»„',
                harmonicGroupsStatus: 'è°æ³¢ç»„çŠ¶æ€',
                harmGroupEmpty: 'æœªé€‰æ‹©',
                harmonicGroupAllFull: 'æ‰€æœ‰ç»„éƒ½å·²æ»¡ï¼ˆæ¯ç»„1ä¸ªï¼‰',
                // ç¦»çº¿è¯´æ˜
                offlineGuideHtml: '<strong style="color: #1890ff;">ğŸ’¡ ç¦»çº¿ä½¿ç”¨è¯´æ˜ï¼š</strong><br>â€¢ æ­¤é¡µé¢ä¸ºå®Œå…¨æœ¬åœ°åŒ–ç‰ˆæœ¬ï¼Œæ— éœ€æœåŠ¡å™¨ï¼Œå¯ç›´æ¥ç”¨æµè§ˆå™¨æ‰“å¼€<br>â€¢ <strong>æ¡¥æ¥æ¨¡å¼ï¼š</strong>éœ€è¦æœ¬åœ°è¿è¡Œæ¡¥æ¥æœåŠ¡ï¼ˆé»˜è®¤ ws://127.0.0.1:18900ï¼‰<br>â€¢ <strong>ç›´è¿æ¨¡å¼ï¼š</strong>ç›´æ¥è¿æ¥åˆ°è®¾å¤‡çš„å±€åŸŸç½‘IPï¼ˆä¾‹å¦‚ ws://192.168.1.100:18899ï¼‰<br>â€¢ æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨å†…å­˜ä¸­ï¼Œåˆ·æ–°é¡µé¢ä¼šæ¸…ç©º',
                // è­¦å‘Š & æ—¥å¿—
                alertNotConnected: 'è®¾å¤‡æœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥è®¾å¤‡',
                alertNotConnectedSimple: 'è®¾å¤‡æœªè¿æ¥',
                logNotConnected: 'è®¾å¤‡æœªè¿æ¥ï¼Œæ— æ³•æŸ¥è¯¢',
                faultDetectingTitle: 'è®¾å¤‡çŠ¶æ€æ£€æµ‹ä¸­...',
                faultDetectingDetails: 'æ­£åœ¨è·å–æ•…éšœä¿¡æ¯...',
                faultCountLabel: 'è®¾å¤‡æ•…éšœ ({count}é¡¹)',
                deviceRunningTitle: 'è®¾å¤‡æ­£åœ¨è¿è¡Œä¸­',
                deviceRunningDesc: 'è¿è¡ŒçŠ¶æ€æ­£å¸¸ï¼Œæ‰€æœ‰ç³»ç»Ÿæ­£å¸¸å·¥ä½œ',
                deviceResettingTitle: 'è®¾å¤‡å¤ä½ä¸­',
                deviceResettingDesc: 'è®¾å¤‡æ­£åœ¨æ‰§è¡Œå¤ä½æ“ä½œï¼Œè¯·ç¨å€™...',
                deviceStandbyTitle: 'è®¾å¤‡å¾…æœºä¸­ï¼Œå·²å°±ç»ª',
                deviceStandbyDesc: 'è®¾å¤‡çŠ¶æ€æ­£å¸¸ï¼Œå¯éšæ—¶å¯åŠ¨',
                logPageLoaded: '[ç³»ç»Ÿ] é¡µé¢å·²åŠ è½½',
                logConfigSaved: '[ç³»ç»Ÿ] é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨',
                logConfigRestored: '[ç³»ç»Ÿ] å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤é…ç½®',
                logPageReady: '[ç³»ç»Ÿ] é¡µé¢åŠ è½½å®Œæˆï¼ˆå®Œå…¨æœ¬åœ°åŒ–ç‰ˆæœ¬ï¼‰',
                logOfflineTip: '[æç¤º] æ­¤é¡µé¢æ— éœ€æœåŠ¡å™¨ï¼Œå¯ç›´æ¥ç”¨æµè§ˆå™¨æ‰“å¼€ä½¿ç”¨'
            },
            en: {
                // Title
                title: 'Power Quality Monitoring System',
                // Status
                connected: 'Connected',
                disconnected: 'Disconnected',
                connecting: 'Connecting...',
                serverMode: 'Server Mode',
                // Buttons
                btnConnect: 'Connect',
                btnDisconnect: 'Disconnect',
                btnStart: 'Start',
                btnStop: 'Shutdown',
                btnReset: 'Reset',
                btnLog: 'Log',
                btnMobileAccess: 'Mobile Access',
                btnApplyConfig: 'Apply',
                btnClearLog: 'Clear',
                roleAdmin: 'Admin',
                roleUser: 'User',
                adminPasswordPrompt: 'Please enter admin password:',
                adminPasswordError: 'Incorrect password, cannot switch to admin role',
                btnQuery: 'Query',
                btnSave: 'Save',
                btnBatchQuery: 'Batch Query',
                btnBatchSave: 'Batch Save',
                btnSyncParam: 'ğŸ” Query Parameter',
                btnSaveParam: 'âœ… Set Parameter',
                // Card Titles
                cardConnection: 'Connection Config',
                cardGridInfo: 'Home',
                cardPowerData: 'Power Data',
                cardModuleInfo: 'Module Info',
                cardParamSetting: 'Parameters',
                cardVersionInfo: 'Version',
                cardCommLog: 'Communication Log',
                // Main Tabs
                tabGridInfo: 'Home',
                tabPowerData: 'Power Data',
                tabModuleInfo: 'Modules',
                tabParamSetting: 'Parameters',
                tabVersionInfo: 'Version',
                // Sub Tabs
                tabCompensation: 'Compensation & Auto-start',
                tabSystemParam: 'System Parameters',
                tabSampling: 'Sampling Parameters',
                tabHarmonic: 'Harmonic Group',
                tabSingleParam: 'Single Parameter',
                // System Parameters
                systemParamParallelCabinets: 'Parallel Cabinets Count',
                systemParamModuleCapacityRatio: 'Module Capacity Ratio',
                systemParamDIEnable: 'DI Start/Stop Enable',
                systemParamAutoEnable: 'Auto Start/Stop Enable',
                systemParamPowerFactor: 'Power Factor',
                // Messages
                msgOfflineInfo: 'ğŸ’¡ Offline Usage:',
                msgNoData: 'No Data',
                msgNotConnected: 'Device not connected, please click "Connect"',
                msgClearLog: 'Clear',
                infoCardEmpty: 'No data',
                infoCardWaiting: 'Waiting for device updates...',
                // Config
                cfgConnectMode: 'Connect Mode',
                cfgBridgeMode: 'Via Bridge Service (Recommended)',
                cfgDirectMode: 'Direct Connection',
                cfgBridgeAddr: 'Bridge Address',
                cfgDeviceAddr: 'Device WebSocket Address',
                cfgDeviceSerial: 'Device Serial Number',
                // Others
                lastUpdate: 'Last Update',
                lang: 'Language',
                // Power factor
                pfTitle: 'Power Factor',
                pfTitleGrid: 'Grid Power Factor',
                legendExcellent: 'Excellent (â‰¥0.95)',
                legendGood: 'Good (0.90-0.95)',
                legendImprove: 'Needs Improvement (<0.90)',
                pfSystemA: 'Grid Phase A',
                pfSystemB: 'Grid Phase B',
                pfSystemC: 'Grid Phase C',
                pfSystemTotal: 'Grid Total',
                pfAverage: 'Average',
                apparentPower: 'Apparent Power',
                pfGridA: 'Grid Phase A',
                pfGridB: 'Grid Phase B',
                pfGridC: 'Grid Phase C',
                dialogParamTitle: 'ğŸ“ Parameter Settings',
                mobileAccessTitle: 'ğŸ“± Mobile/Tablet Access',
                mobileAccessTip: 'Connect your phone to the device Wi-Fi and open the following URL in the browser',
                mobileAccessUrlLabel: 'Access URL:',
                mobileAccessHint: 'ğŸ’¡ Tip: Add this address to your home screen for quick access next time',
                btnCloseMobile: 'Close',
                // Card section titles
                cardGridVoltage: 'Grid Voltage',
                cardGridCurrent: 'Grid Current',
                cardPowerQuality: 'Power Quality',
                cardSystemAPower: 'Grid Phase A Power',
                cardSystemBPower: 'Grid Phase B Power',
                cardSystemCPower: 'Grid Phase C Power',
                cardLoadAPower: 'Load Phase A Power',
                cardLoadBPower: 'Load Phase B Power',
                cardLoadCPower: 'Load Phase C Power',
                cardGridActivePower: 'Grid Active Power',
                cardGridReactivePower: 'Grid Reactive Power',
                cardGridApparentPower: 'Grid Apparent Power',
                cardLoadActivePower: 'Load Active Power',
                cardLoadReactivePower: 'Load Reactive Power',
                cardLoadApparentPower: 'Load Apparent Power',
                cardTemperature: 'Temperature Monitoring',
                cardBusVoltage: 'DC Bus Voltage',
                cardDeviceCurrent: 'Device Current',
                cardDeviceActivePower: 'Device Active Power',
                cardDeviceReactivePower: 'Device Reactive Power',
                cardDeviceApparentPower: 'Device Apparent Power',
                cardLoadCurrent: 'Load Current',
                cardFrequency: 'Grid Frequency',
                cardEquipmentCurrent: 'Equipment Current',
                cardPowerStats: 'Power Statistics',
                cardEnergyStats: 'Energy Statistics',
                cardRunMode: 'Operation Mode',
                cardVersionInfoTitle: 'Version Info',
                cardDeviceStatus: 'Device Status',
                cardFaultInfo: 'Fault Info',
                cardVoltageHarmonic: 'Voltage Total Harmonic Content',
                cardGridCurrentHarmonic: 'Grid Current Total Harmonic Content',
                cardLoadCurrentHarmonic: 'Load Current Total Harmonic Content',
                cardGridPowerFactor: 'Grid Power Factor',
                cardLoadPowerFactor: 'Load Power Factor',
                harmonicChartTitle: 'Load Current Harmonic Content',
                legendHarmonicA: 'Phase A',
                legendHarmonicB: 'Phase B',
                legendHarmonicC: 'Phase C',
                thdTitle: 'THD',
                thduLabel: 'THDU',
                thdiLabel: 'THDI',
                gridTotalActivePower: 'Grid Total Active Power',
                gridTotalReactivePower: 'Grid Total Reactive Power',
                gridTotalApparentPower: 'Grid Total Apparent Power',
                gridAvgPowerFactor: 'Grid Average Power Factor',
                loadTotalActivePower: 'Load Total Active Power',
                loadTotalReactivePower: 'Load Total Reactive Power',
                loadTotalApparentPower: 'Load Total Apparent Power',
                loadAvgPowerFactor: 'Load Average Power Factor',
                compModeLabel: 'Compensation Mode (Func 513)',
                selectPlaceholder: 'Please select',
                compModeOption1: '1 Unbalance Compensation',
                compModeOption2: '2 Reactive Compensation',
                compModeOption4: '4 Harmonic Compensation',
                compModeOption6: '6 Reactive + Harmonic Compensation',
                compModeOption11: '11 Other Mode',
                compModeOption13: '13 Harmonic + Unbalance Compensation',
                compModeOption14: '14 Harmonic + Reactive Compensation',
                compModeOption15: '15 Harmonic + Unbalance + Reactive Compensation',
                compModeOption16: '16 Self-aging Reactive',
                compModeOption35: '35 Reactive + Unbalance Compensation',
                compModeOption39: '39 Reactive + Unbalance + Harmonic Compensation',
                autoEnableLabel: 'Auto Start Enable (Func 512)',
                autoEnableHint: 'Common values: 0=Disable, 1=Enable',
                inputPlaceholder: 'Please enter',
                enablePlaceholder: '0=Disable, 1=Enable',
                deviceCurrentSamplingTitle: 'ğŸ”§ Device Current Sampling',
                devSampleEnableLabel: 'Device Sampling Enable (Func 16)',
                devSamplePosLabel: 'Device Sampling Position (Func 13)',
                devSampleDirLabel: 'Device Sampling Direction (Func 14)',
                devCTLabel: 'Device CT Ratio (Func 242)',
                unitPointOne: 'Unit: 0.1',
                ctInputPlaceholder: 'Enter value (e.g. 50 means 5.0)',
                inputCurrentSamplingTitle: 'ğŸ“¥ Input Current Sampling',
                inSamplePosLabel: 'Input Sampling Position (Func 17)',
                inSampleDirLabel: 'Input Sampling Direction (Func 15)',
                inCTLabel: 'Input CT Ratio (Func 241)',
                singleParamTip: '<strong>ğŸ’¡ Tip:</strong> This function communicates with the device via WebSocket and allows setting arbitrary function codes.',
                paramAddrLabel: '<span style="color: red;">*</span> Parameter Address (Function Code)',
                paramValueLabel: '<span style="color: red;">*</span> Parameter Value',
                addrPlaceholder: 'Enter function code (2-1000)',
                valuePlaceholder: 'Enter value (0-65535)',
                queryResultTitle: 'Query Result:',
                singleParamResultMessage: 'Function code <strong>{addr}</strong> current value: <strong style="color: #1890ff; font-size: 16px;">{value}</strong>',
                singleParamSaveMessage: 'Save command sent: function code <strong>{addr}</strong> = <strong style="color: #52c41a;">{value}</strong>',
                alertInvalidFuncCode: 'Please enter a valid function code (2-1000)',
                alertEnterValue: 'Please enter a parameter value',
                alertInvalidValueRange: 'Please enter a valid value (0-65535)',
                harmGroup1Label: 'Harmonic Group 1 Count (Func 265)',
                harmGroup2Label: 'Harmonic Group 2 Count (Func 266)',
                harmGroup3Label: 'Harmonic Group 3 Count (Func 267)',
                harmGroup4Label: 'Harmonic Group 4 Count (Func 268)',
                harmGroup5Label: 'Harmonic Group 5 Count (Func 269)',
                harmGroup6Label: 'Harmonic Group 6 Count (Func 270)',
                harmGroup7Label: 'Harmonic Group 7 Count (Func 271)',
                harmGroup8Label: 'Harmonic Group 8 Count (Func 272)',
                oddHarmonics: 'Odd Harmonics',
                evenHarmonics: 'Even Harmonics',
                currentHarmonicGroup: 'Current Harmonic Group',
                harmonicGroupClickHint: 'Select up to 8 buttons, click to select/deselect, batch save assigns selected buttons by harmonic number (small to large) to 8 groups (265-272), each group stores one harmonic number, fill 0 if less than 8',
                harmonicGroupMaxButtons: 'Maximum 8 buttons can be selected',
                currentEditingGroup: 'Current Editing Group',
                harmonicGroupsStatus: 'Harmonic Groups Status',
                harmGroupEmpty: 'Not selected',
                harmonicGroupAllFull: 'All groups are full (1 per group)',
                // Offline guide
                offlineGuideHtml: '<strong style="color: #1890ff;">ğŸ’¡ Offline Usage:</strong><br>â€¢ This page runs fully offline without any server, open directly in the browser.<br>â€¢ <strong>Bridge Mode:</strong> Requires local bridge service (default ws://127.0.0.1:18900).<br>â€¢ <strong>Direct Mode:</strong> Connect directly to the device LAN IP (e.g. ws://192.168.1.100:18899).<br>â€¢ All data stays in browser memory and resets after refresh.',
                // Alerts & logs
                alertNotConnected: 'Device not connected, please connect first',
                alertNotConnectedSimple: 'Device not connected',
                logNotConnected: 'Device not connected, unable to query',
                faultDetectingTitle: 'Checking device status...',
                faultDetectingDetails: 'Fetching fault information...',
                faultCountLabel: 'Device Faults ({count})',
                deviceRunningTitle: 'Device is running',
                deviceRunningDesc: 'System is operating normally',
                deviceResettingTitle: 'Device resetting',
                deviceResettingDesc: 'Device is performing reset operation, please wait...',
                deviceStandbyTitle: 'Device on standby, ready',
                deviceStandbyDesc: 'System is ready to start',
                logPageLoaded: '[System] Page loaded',
                logConfigSaved: '[System] Configuration saved to local storage',
                logConfigRestored: '[System] Configuration restored from local storage',
                logPageReady: '[System] Page ready (fully offline build)',
                logOfflineTip: '[Tip] This page runs without a server and can be opened directly in the browser'
            }
        };
        
        // ç¿»è¯‘å‡½æ•°
        function t(key) {
            return (translations[currentLang] && translations[currentLang][key]) || (translations.zh && translations.zh[key]) || key;
        }

        function setTextById(id, key) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = t(key);
            }
        }

        function setHTMLById(id, key) {
            const el = document.getElementById(id);
            if (el) {
                el.innerHTML = t(key);
            }
        }
        
        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('preferredLanguage', lang);
            updatePageLanguage();
        }
        
        // æ›´æ–°é¡µé¢è¯­è¨€
        function updatePageLanguage() {
            document.title = t('title');
            // æ›´æ–°æ ‡é¢˜
            document.querySelector('.header h1').innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1890ff" stroke-width="2" style="vertical-align: middle; margin-right: 8px;">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                ${t('title')}
            `;
            
            // æ›´æ–°è¯­è¨€æŒ‰é’®æ–‡å­—
            const langBtn = document.getElementById('langBtn');
            if (langBtn) {
                langBtn.textContent = currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡';
            }
            
            // æŒ‰é’®æ–‡å­—
            setTextById('btnRunLabel', 'btnStart');
            setTextById('btnStopLabel', 'btnStop');
            setTextById('btnResetLabel', 'btnReset');
            setTextById('btnLogLabel', 'btnLog');
            setTextById('btnMobileLabel', 'btnMobileAccess');
            setTextById('btnApplyConfigLabel', 'btnApplyConfig');
            setTextById('btnDisconnectConfigLabel', 'btnDisconnect');
            setTextById('btnClearLogLabel', 'btnClearLog');
            setTextById('btnCloseMobile', 'btnCloseMobile');

            // ä¸»Tabå¯¼èˆª
            setTextById('tabNavGridLabel', 'tabGridInfo');
            setTextById('tabNavPowerLabel', 'tabPowerData');
            setTextById('tabNavModuleLabel', 'tabModuleInfo');
            setTextById('tabNavParamLabel', 'tabParamSetting');
            setTextById('tabNavVersionLabel', 'tabVersionInfo');

            // å‚æ•°è®¾ç½®å­Tab
            setTextById('mainParamTabNav0', 'tabCompensation');
            setTextById('mainParamTabNav1', 'tabSystemParam');
            setTextById('mainParamTabNav2', 'tabSampling');
            setTextById('mainParamTabNav3', 'tabHarmonic');
            setTextById('mainParamTabNav4', 'tabSingleParam');
            setTextById('paramTabNav0', 'tabCompensation');
            setTextById('paramTabNav1', 'tabSystemParam');
            setTextById('paramTabNav2', 'tabSampling');
            setTextById('paramTabNav3', 'tabHarmonic');
            setTextById('paramTabNav4', 'tabSingleParam');

            // å¡ç‰‡æ ‡é¢˜
            setTextById('cardConnectionTitle', 'cardConnection');
            setTextById('cardCommLogTitle', 'cardCommLog');

            setHTMLById('offlineGuide', 'offlineGuideHtml');
            setTextById('labelConnectMode', 'cfgConnectMode');
            setTextById('logInitialMessage', 'logPageLoaded');
            const optionBridge = document.getElementById('optionBridge');
            if (optionBridge) optionBridge.textContent = t('cfgBridgeMode');
            const optionDirect = document.getElementById('optionDirect');
            if (optionDirect) optionDirect.textContent = t('cfgDirectMode');
            setTextById('labelBridgeAddr', 'cfgBridgeAddr');
            setTextById('labelDeviceAddr', 'cfgDeviceAddr');
            setTextById('labelDeviceSerial', 'cfgDeviceSerial');

            // å ä½æç¤º
            setTextById('gridPlaceholder', 'msgNotConnected');
            setTextById('powerPlaceholder', 'msgNoData');
            setTextById('modulePlaceholder', 'msgNoData');
            setTextById('versionPlaceholder', 'msgNoData');

            // åŠŸç‡å› æ•°æ ‡é¢˜ä¸å›¾ä¾‹
            setTextById('pfTitle', 'pfTitle');
            setTextById('pfTitleGrid', 'pfTitleGrid');
            setTextById('legendExcellent', 'legendExcellent');
            setTextById('legendGood', 'legendGood');
            setTextById('legendImprove', 'legendImprove');
            setTextById('legendExcellentGrid', 'legendExcellent');
            setTextById('legendGoodGrid', 'legendGood');
            setTextById('legendImproveGrid', 'legendImprove');
            setTextById('pfSystemALabel', 'pfSystemA');
            setTextById('pfSystemBLabel', 'pfSystemB');
            setTextById('pfSystemCLabel', 'pfSystemC');
            setTextById('pfSystemTotalLabel', 'pfSystemTotal');
            setTextById('pfAverageLabel', 'pfAverage');
            setTextById('pfGridALabel', 'pfGridA');
            setTextById('pfGridBLabel', 'pfGridB');
            setTextById('pfGridCLabel', 'pfGridC');
            
            // é¥¼çŠ¶å›¾æ ‡é¢˜å’Œå›¾ä¾‹
            setTextById('harmonicChartTitle', 'harmonicChartTitle');
            setTextById('legendHarmonicA', 'legendHarmonicA');
            setTextById('legendHarmonicB', 'legendHarmonicB');
            setTextById('legendHarmonicC', 'legendHarmonicC');
            
            // THDUå’ŒTHDIæ ‡ç­¾
            setTextById('thdTitle', 'thdTitle');
            setTextById('thduLabel', 'thduLabel');
            setTextById('thdiLabel', 'thdiLabel');

            // å‚æ•°è®¾ç½®æ ‡é¢˜
            setTextById('dialogParamTitle', 'dialogParamTitle');

            // ç§»åŠ¨ç«¯è®¿é—®å¼¹çª—
            setTextById('mobileAccessTitle', 'mobileAccessTitle');
            setTextById('mobileAccessTip', 'mobileAccessTip');
            setTextById('mobileAccessUrlLabel', 'mobileAccessUrlLabel');
            setTextById('mobileAccessHint', 'mobileAccessHint');

            // æ•…éšœæ¨ªå¹…åˆå§‹æ–‡æœ¬
            setTextById('faultTitle', 'faultDetectingTitle');
            setTextById('faultDetails', 'faultDetectingDetails');

            // åˆ·æ–°å‚æ•°è®¾ç½®å†…å®¹ä»¥åº”ç”¨æœ€æ–°è¯­è¨€
            loadParamSettings(true);

            // update status button + text according to current state
            updateStatus(isConnected);
            
            // å¦‚æœæœ‰è®¾å¤‡æ•°æ®ï¼Œæ›´æ–°æ•…éšœæ¨ªå¹…ä»¥åº”ç”¨æ–°è¯­è¨€ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è§ï¼‰
            if (deviceData && Object.keys(deviceData).length > 0) {
                updateFaultBanner(deviceData);
            }
            
            // æ›´æ–°æƒé™æŒ‰é’®æ–‡å­—
            updateRoleButtonText();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ¢å¤è¯­è¨€è®¾ç½®å’Œæƒé™è®¾ç½®
        window.addEventListener('DOMContentLoaded', function() {
            const savedLang = localStorage.getItem('preferredLanguage');
            if (savedLang) {
                currentLang = savedLang;
                updatePageLanguage();
            }
            // åˆå§‹åŒ–æƒé™ç³»ç»Ÿ
            initRoleSystem();
        });
        
        // ========== æƒé™ç®¡ç†ç³»ç»Ÿ ==========
        let currentRole = 'user'; // å½“å‰æƒé™è§’è‰²ï¼š'user'ã€'admin' æˆ– 'superadmin'ï¼Œé»˜è®¤ç”¨æˆ·
        let ADMIN_PASSWORD = 'std123'; // ç®¡ç†å‘˜å¯†ç ï¼ˆä½¿ç”¨letä»¥ä¾¿ä¿®æ”¹ï¼‰
        const SUPERADMIN_PASSWORD = 'std123@'; // è¶…çº§ç®¡ç†å‘˜å¯†ç 
        
        // åˆå§‹åŒ–æƒé™ç³»ç»Ÿ
        function initRoleSystem() {
            // æ¯æ¬¡é‡æ–°åŠ è½½éƒ½è¿”å›ç”¨æˆ·æƒé™ï¼Œä¸ä¿å­˜æƒé™çŠ¶æ€
            currentRole = 'user';
            // æ¢å¤ç®¡ç†å‘˜å¯†ç ï¼ˆå¦‚æœå·²ä¿®æ”¹ï¼‰
            const storedPassword = localStorage.getItem('adminPassword');
            if (storedPassword) {
                ADMIN_PASSWORD = storedPassword;
            }
            // åº”ç”¨æƒé™è®¾ç½®
            applyRolePermissions();
        }
        
        // åˆ‡æ¢æƒé™è§’è‰²
        function toggleRole() {
            // å¦‚æœå½“å‰æ˜¯ç”¨æˆ·æƒé™ï¼Œåˆ‡æ¢åˆ°ç®¡ç†å‘˜/è¶…çº§ç®¡ç†å‘˜æ—¶éœ€è¦å¯†ç éªŒè¯
            if (currentRole === 'user') {
                // ä½¿ç”¨è‡ªå®šä¹‰å¯†ç è¾“å…¥å¯¹è¯æ¡†
                openPasswordModal((password) => {
                    try {
                        if (!password || password.trim() === '') {
                            // ç”¨æˆ·å–æ¶ˆè¾“å…¥æˆ–è¾“å…¥ä¸ºç©º
                            return;
                        }
                        // éªŒè¯å¯†ç 
                        if (password === SUPERADMIN_PASSWORD) {
                            // è¶…çº§ç®¡ç†å‘˜å¯†ç 
                            currentRole = 'superadmin';
                        } else if (password === ADMIN_PASSWORD) {
                            // ç®¡ç†å‘˜å¯†ç ï¼ˆæ”¯æŒä¿®æ”¹åçš„å¯†ç ï¼‰
                            currentRole = 'admin';
                        } else {
                            alert(t('adminPasswordError') || 'å¯†ç é”™è¯¯ï¼Œæ— æ³•åˆ‡æ¢åˆ°ç®¡ç†å‘˜æƒé™');
                            return;
                        }
                        // ä¸ä¿å­˜æƒé™çŠ¶æ€åˆ°localStorageï¼Œæ¯æ¬¡é‡æ–°åŠ è½½éƒ½è¿”å›ç”¨æˆ·æƒé™
                        applyRolePermissions();
                        updateRoleButtonText();
                    } catch (error) {
                        console.error('æƒé™åˆ‡æ¢é”™è¯¯:', error);
                        alert('æƒé™åˆ‡æ¢å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
                return;
            } else {
                // ä»ç®¡ç†å‘˜/è¶…çº§ç®¡ç†å‘˜åˆ‡æ¢åˆ°ç”¨æˆ·ï¼Œæ— éœ€å¯†ç 
                currentRole = 'user';
                // ä¸ä¿å­˜æƒé™çŠ¶æ€åˆ°localStorageï¼Œæ¯æ¬¡é‡æ–°åŠ è½½éƒ½è¿”å›ç”¨æˆ·æƒé™
                applyRolePermissions();
                updateRoleButtonText();
            }
        }
        
        // å¯†ç è¾“å…¥å¯¹è¯æ¡†ç›¸å…³å˜é‡
        let passwordModalCallback = null;
        
        // æ‰“å¼€å¯†ç è¾“å…¥å¯¹è¯æ¡†
        function openPasswordModal(callback) {
            const modal = document.getElementById('passwordModal');
            const input = document.getElementById('passwordInput');
            const title = document.getElementById('passwordModalTitle');
            if (modal && input && title) {
                passwordModalCallback = callback;
                title.textContent = t('adminPasswordPrompt') || 'è¯·è¾“å…¥å¯†ç ï¼š';
                input.value = '';
                modal.style.display = 'flex';
                // èšç„¦åˆ°è¾“å…¥æ¡†
                setTimeout(() => {
                    input.focus();
                }, 100);
                // ç›‘å¬å›è½¦é”®
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        confirmPassword();
                    } else if (e.key === 'Escape') {
                        closePasswordModal();
                    }
                };
            }
        }
        
        // å…³é—­å¯†ç è¾“å…¥å¯¹è¯æ¡†
        function closePasswordModal() {
            const modal = document.getElementById('passwordModal');
            if (modal) {
                modal.style.display = 'none';
            }
            passwordModalCallback = null;
        }
        
        // ç¡®è®¤å¯†ç 
        function confirmPassword() {
            const input = document.getElementById('passwordInput');
            if (input && passwordModalCallback) {
                const password = input.value;
                const callback = passwordModalCallback; // ä¿å­˜å›è°ƒå¼•ç”¨
                passwordModalCallback = null; // å…ˆæ¸…ç©ºå›è°ƒï¼Œé¿å…é‡å¤æ‰§è¡Œ
                closePasswordModal(); // å…³é—­å¯¹è¯æ¡†
                // æ‰§è¡Œå›è°ƒ
                if (callback && typeof callback === 'function') {
                    try {
                        callback(password);
                    } catch (error) {
                        console.error('å¯†ç å›è°ƒæ‰§è¡Œé”™è¯¯:', error);
                        alert('æƒé™åˆ‡æ¢å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            } else if (input) {
                // å¦‚æœæ²¡æœ‰å›è°ƒï¼Œç›´æ¥å…³é—­
                passwordModalCallback = null;
                closePasswordModal();
            }
        }
        
        // æ›´æ–°æƒé™æŒ‰é’®æ–‡å­—
        function updateRoleButtonText() {
            const roleBtnLabel = document.getElementById('roleBtnLabel');
            if (roleBtnLabel) {
                if (currentRole === 'superadmin') {
                    roleBtnLabel.textContent = 'è¶…çº§ç®¡ç†å‘˜';
                } else if (currentRole === 'admin') {
                    roleBtnLabel.textContent = 'ç®¡ç†å‘˜';
                } else {
                    roleBtnLabel.textContent = 'ç”¨æˆ·';
                }
            }
        }
        
        // åº”ç”¨æƒé™è®¾ç½®ï¼Œæ ¹æ®æƒé™æ˜¾ç¤º/éšè—ç›¸å…³å…ƒç´ 
        function applyRolePermissions() {
            const isAdmin = currentRole === 'admin' || currentRole === 'superadmin';
            const isSuperAdmin = currentRole === 'superadmin';
            
            // æ—¥å¿—æŒ‰é’®å’Œæ—¥å¿—å¡ç‰‡ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯è§
            const btnLog = document.getElementById('btnLog');
            const logCard = document.getElementById('logCard');
            if (btnLog) btnLog.style.display = isSuperAdmin ? '' : 'none';
            if (logCard && !isSuperAdmin) {
                logCard.style.display = 'none'; // éè¶…çº§ç®¡ç†å‘˜æ—¶å¼ºåˆ¶éšè—æ—¥å¿—
            }
            
            // è°æ³¢ç»„çŠ¶æ€æ ï¼ˆç®¡ç†å‘˜å’Œç”¨æˆ·éƒ½æ˜¾ç¤ºä¸€æ ·ï¼‰
            const harmonicGroupsStatusBar = document.getElementById('harmonicGroupsStatusBar');
            if (harmonicGroupsStatusBar) {
                // æ‰€æœ‰å…ƒç´ å¯¹æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¾ç¤º
                harmonicGroupsStatusBar.style.display = '';
            }
            
            // ç‰ˆæœ¬ä¿¡æ¯æ ‡ç­¾é¡µï¼ˆç”¨æˆ·ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä½†å†…å®¹å—é™ï¼‰
            const tabNavVersion = document.getElementById('tabNavVersion');
            // ç‰ˆæœ¬ä¿¡æ¯æ ‡ç­¾é¡µå¯¹æ‰€æœ‰ç”¨æˆ·å¯è§ï¼Œä½†å†…å®¹ä¼šæ ¹æ®æƒé™æ˜¾ç¤º
            // å¦‚æœå½“å‰åœ¨ç‰ˆæœ¬ä¿¡æ¯æ ‡ç­¾é¡µä¸”åˆ‡æ¢åˆ°ç”¨æˆ·æƒé™ï¼Œåˆ·æ–°æ˜¾ç¤ºä»¥åº”ç”¨æƒé™é™åˆ¶
            if (!isAdmin && currentMainTab === 4 && deviceData && Object.keys(deviceData).length > 0) {
                displayParams(deviceData);
            }
            
            // å•å‚æ•°è®¾ç½®é¡µé¢æƒé™æ§åˆ¶ï¼ˆä»…ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰
            // ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿tabé¡¹è¢«æ­£ç¡®éšè—
            // æ–¹æ³•1: é€šè¿‡classé€‰æ‹©å™¨ï¼ˆæœ€å¯é ï¼‰
            document.querySelectorAll('.single-param-tab').forEach(tabItem => {
                if (isAdmin) {
                    tabItem.style.display = '';
                    tabItem.classList.remove('hidden-by-role');
                } else {
                    tabItem.style.display = 'none';
                    tabItem.classList.add('hidden-by-role');
                }
            });
            
            // å¯†ç ç®¡ç†tabæƒé™æ§åˆ¶ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰
            document.querySelectorAll('.password-manage-tab').forEach(tabItem => {
                if (isSuperAdmin) {
                    tabItem.style.display = '';
                    tabItem.style.removeProperty('display');
                    tabItem.classList.remove('hidden-by-role');
                } else {
                    // å¼ºåˆ¶éšè—ï¼Œä½¿ç”¨!importantä¼˜å…ˆçº§
                    tabItem.style.setProperty('display', 'none', 'important');
                    tabItem.classList.add('hidden-by-role');
                }
            });
            
            // å¦‚æœå½“å‰åœ¨å¯†ç ç®¡ç†tabä½†ä¸æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªtab
            if (currentParamTabIndex === 5 && !isSuperAdmin) {
                switchParamTab(0);
            }
            
            // æ–¹æ³•2: é€šè¿‡IDæŸ¥æ‰¾ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
            const mainParamTabNav4 = document.getElementById('mainParamTabNav4');
            if (mainParamTabNav4) {
                let tabItem = mainParamTabNav4.closest('.param-sub-tab-item');
                if (!tabItem) {
                    tabItem = mainParamTabNav4.parentElement;
                }
                if (tabItem) {
                    if (isAdmin) {
                        tabItem.style.display = '';
                        tabItem.classList.remove('hidden-by-role');
                    } else {
                        tabItem.style.display = 'none';
                        tabItem.classList.add('hidden-by-role');
                    }
                }
            }
            
            const paramTabNav4 = document.getElementById('paramTabNav4');
            if (paramTabNav4) {
                let tabItem = paramTabNav4.closest('.param-sub-tab-item');
                if (!tabItem) {
                    tabItem = paramTabNav4.parentElement;
                }
                if (tabItem) {
                    if (isAdmin) {
                        tabItem.style.display = '';
                        tabItem.classList.remove('hidden-by-role');
                    } else {
                        tabItem.style.display = 'none';
                        tabItem.classList.add('hidden-by-role');
                    }
                }
            }
            
            // æ–¹æ³•3: é€šè¿‡æ–‡æœ¬å†…å®¹æŸ¥æ‰¾ï¼ˆæœ€åå¤‡ç”¨æ–¹æ¡ˆï¼‰
            document.querySelectorAll('.param-sub-tab-item').forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.includes('å•å‚æ•°è®¾ç½®') || text.includes('Single Parameter')) {
                    if (isAdmin) {
                        item.style.display = '';
                        item.classList.remove('hidden-by-role');
                    } else {
                        item.style.display = 'none';
                        item.classList.add('hidden-by-role');
                    }
                }
            });
            
            // å•å‚æ•°è®¾ç½®å†…å®¹åŒºåŸŸ
            const paramTabMain4 = document.getElementById('paramTabMain4');
            const paramTabDialog4 = document.getElementById('paramTabDialog4');
            if (paramTabMain4) {
                paramTabMain4.style.display = isAdmin ? (currentParamTabIndex === 4 ? 'block' : 'none') : 'none';
            }
            if (paramTabDialog4) {
                paramTabDialog4.style.display = isAdmin ? (currentParamTabIndex === 4 ? 'block' : 'none') : 'none';
            }
            
            // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹å•å‚æ•°è®¾ç½®é¡µé¢ä¸”åˆ‡æ¢åˆ°ç”¨æˆ·æƒé™ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªtab
            if (!isAdmin && currentParamTabIndex === 4) {
                switchParamTab(0);
            }
            
            // æ›´æ–°æŒ‰é’®æ–‡å­—
            updateRoleButtonText();
        }
        
        // ========== è®¾å¤‡é€šä¿¡å˜é‡ ==========
        let ws = null;
        let queryTimer = null;
        let deviceData = {};
        let currentMainTab = 0; // å½“å‰ä¸»Tabç´¢å¼•ï¼š0=ä¸»é¡µç•Œé¢, 1=åŠŸç‡ä¿¡æ¯é¡µé¢
        let deviceLimit = [];  // å­˜å‚¨è®¾å¤‡é™åˆ¶æ“ä½œåˆ—è¡¨
        let currentParamTabIndex = 0;  // å‚æ•°è®¾ç½®å­Tabç´¢å¼•
        let paramTabsLoaded = false;   // å‚æ•°è®¾ç½®å†…å®¹æ˜¯å¦å·²åŠ è½½
        let isConnected = false;  // è®°å½•å½“å‰è¿æ¥çŠ¶æ€
        let pendingQueries = {}; // å­˜å‚¨ç­‰å¾…å“åº”çš„æŸ¥è¯¢
        
        // æ™ºèƒ½åˆ‡æ¢æœºåˆ¶
        let connectionStartTime = null;  // è¿æ¥å¼€å§‹æ—¶é—´
        let connectionFailCount = 0;     // è¿æ¥å¤±è´¥æ¬¡æ•°
        let failoverTimer = null;        // æ•…éšœè½¬ç§»å®šæ—¶å™¨
        let isUsingServerMode = false;   // æ˜¯å¦ä½¿ç”¨æœåŠ¡å™¨æ¨¡å¼
        let serverPollingTimer = null;   // æœåŠ¡å™¨è½®è¯¢å®šæ—¶å™¨
        let paramCache = {};            // âœ¨ æ–°å¢ï¼šå…¨å±€å‚æ•°ç¼“å­˜
        const FAILOVER_TIMEOUT = 60000;  // 1åˆ†é’Ÿååˆ‡æ¢åˆ°æœåŠ¡å™¨æ¨¡å¼
        
        // å¤–å±‚åè®®åºåˆ—å·ç®¡ç†ï¼ˆ1-255å¾ªç¯ï¼‰
        let outerProtocolSerial = 1;
        
        // æ•°æ®æ¥æ”¶ç¼“å†²åŒºï¼ˆç”¨äºå¤„ç†åˆ†ç‰‡æ•°æ®åŒ…ï¼‰
        let receiveBuffer = new Uint8Array(0);
        const MAX_BUFFER_SIZE = 4096; // æœ€å¤§ç¼“å†²åŒºå¤§å°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
        
        // æ¸…ç†æ¥æ”¶ç¼“å†²åŒº
        function clearReceiveBuffer() {
            receiveBuffer = new Uint8Array(0);
        }
        
        // åˆå¹¶æ•°æ®åˆ°ç¼“å†²åŒº
        function appendToBuffer(newData) {
            if (receiveBuffer.length + newData.length > MAX_BUFFER_SIZE) {
                addLog('warn', `âš ï¸ æ¥æ”¶ç¼“å†²åŒºæº¢å‡ºï¼Œæ¸…ç©ºç¼“å†²åŒºï¼ˆå½“å‰${receiveBuffer.length}å­—èŠ‚ï¼Œæ–°å¢${newData.length}å­—èŠ‚ï¼‰`);
                clearReceiveBuffer();
            }
            const merged = new Uint8Array(receiveBuffer.length + newData.length);
            merged.set(receiveBuffer);
            merged.set(newData, receiveBuffer.length);
            receiveBuffer = merged;
        }
        
        // ä»ç¼“å†²åŒºæå–å®Œæ•´æ•°æ®åŒ…
        function extractPacketsFromBuffer() {
            const packets = [];
            
            // æŸ¥æ‰¾æ‰€æœ‰å®Œæ•´çš„æ•°æ®åŒ…ï¼ˆAAå¼€å¤´ï¼Œ55ç»“å°¾ï¼‰
            let searchStart = 0;
            while (searchStart < receiveBuffer.length) {
                // æŸ¥æ‰¾å¸§å¤´AA
                const headerIndex = receiveBuffer.indexOf(0xAA, searchStart);
                if (headerIndex === -1) {
                    // æ²¡æœ‰æ‰¾åˆ°å¸§å¤´ï¼Œæ¸…ç©ºç¼“å†²åŒº
                    clearReceiveBuffer();
                    break;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é•¿åº¦æ¥è§£æé•¿åº¦å­—æ®µï¼ˆè‡³å°‘éœ€è¦AA + size(2) = 3å­—èŠ‚ï¼‰
                if (headerIndex + 3 > receiveBuffer.length) {
                    // æ•°æ®ä¸å®Œæ•´ï¼Œä¿ç•™ä»headerIndexå¼€å§‹çš„æ•°æ®
                    receiveBuffer = receiveBuffer.slice(headerIndex);
                    break;
                }
                
                // è§£æé•¿åº¦å­—æ®µï¼ˆå¤§ç«¯åºï¼‰
                // lengthå­—æ®µè¡¨ç¤ºæ•´æ¡åè®®çš„æ€»å­—èŠ‚æ•°ï¼ˆåŒ…æ‹¬AAå’Œ55ï¼‰
                const lengthHi = receiveBuffer[headerIndex + 1];
                const lengthLo = receiveBuffer[headerIndex + 2];
                const length = (lengthHi << 8) | lengthLo;
                
                // éªŒè¯é•¿åº¦å­—æ®µåˆç†æ€§
                if (length === 0 || length > 2048) {
                    // é•¿åº¦å­—æ®µå¼‚å¸¸ï¼Œè·³è¿‡è¿™ä¸ªAAï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ª
                    searchStart = headerIndex + 1;
                    continue;
                }
                
                // lengthå­—æ®µå°±æ˜¯æ€»åŒ…é•¿åº¦
                const expectedTotalLength = length;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®
                if (headerIndex + expectedTotalLength > receiveBuffer.length) {
                    // æ•°æ®ä¸å®Œæ•´ï¼Œä¿ç•™ä»headerIndexå¼€å§‹çš„æ•°æ®
                    receiveBuffer = receiveBuffer.slice(headerIndex);
                    break;
                }
                
                // æ£€æŸ¥å¸§å°¾
                const tailIndex = headerIndex + expectedTotalLength - 1;
                if (receiveBuffer[tailIndex] !== 0x55) {
                    // å¸§å°¾ä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯æ•°æ®æŸåï¼Œå°è¯•æŸ¥æ‰¾ä¸‹ä¸€ä¸ªAA
                    addLog('debug', `å¤–å±‚åè®®å¸§å°¾ä¸åŒ¹é…ï¼šä½ç½®${tailIndex}æœŸæœ›0x55ï¼Œæ”¶åˆ°0x${receiveBuffer[tailIndex].toString(16).padStart(2, '0').toUpperCase()}ï¼Œlengthå­—æ®µ=${length}`);
                    searchStart = headerIndex + 1;
                    continue;
                }
                
                // æå–å®Œæ•´æ•°æ®åŒ…
                const packet = receiveBuffer.slice(headerIndex, headerIndex + expectedTotalLength);
                packets.push(packet);
                
                // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä½ç½®
                searchStart = headerIndex + expectedTotalLength;
            }
            
            // æ›´æ–°ç¼“å†²åŒºï¼ˆä¿ç•™æœªå¤„ç†çš„æ•°æ®ï¼‰
            if (searchStart < receiveBuffer.length) {
                receiveBuffer = receiveBuffer.slice(searchStart);
            } else {
                clearReceiveBuffer();
            }
            
            return packets;
        }
        
        // å¤–å±‚åè®®CRC8è®¡ç®—
        // æ ¹æ®åè®®å®šä¹‰ï¼šCRC8æ ¡éªŒ size+cmd+data+tk
        // æ ¹æ®ç¤ºä¾‹ï¼šAA000F02AA010541564B061507BE55
        // æ ¡éªŒæ•°æ®ï¼š00 0F 02 AA 01 05 41 56 4B 06 15 07ï¼ŒCRCåº”è¯¥æ˜¯BE
        function crc8(dataBytes) {
            // å°è¯•å¤šç§CRC8ç®—æ³•ï¼Œæ‰¾åˆ°æ­£ç¡®çš„
            // æ–¹æ³•1ï¼šCRC8-Dallas/Maximç®—æ³•ï¼ˆå¤šé¡¹å¼0x31ï¼Œåˆå§‹å€¼0x00ï¼‰
            let crc1 = 0x00;
            for (let i = 0; i < dataBytes.length; i++) {
                crc1 ^= dataBytes[i];
                for (let j = 0; j < 8; j++) {
                    if (crc1 & 0x01) {
                        crc1 = (crc1 >> 1) ^ 0x8C;
                    } else {
                        crc1 = crc1 >> 1;
                    }
                }
            }
            
            // æ–¹æ³•2ï¼šç®€å•ç´¯åŠ ï¼ˆå¦‚æœæ”¶åˆ°0x00å¯èƒ½æ˜¯ç´¯åŠ ç»“æœï¼‰
            let crc2 = 0;
            for (let i = 0; i < dataBytes.length; i++) {
                crc2 = (crc2 + dataBytes[i]) & 0xFF;
            }
            
            // æ–¹æ³•3ï¼šCRC8-CCITTï¼ˆå¤šé¡¹å¼0x07ï¼‰
            let crc3 = 0x00;
            for (let i = 0; i < dataBytes.length; i++) {
                crc3 ^= dataBytes[i];
                for (let j = 0; j < 8; j++) {
                    if (crc3 & 0x80) {
                        crc3 = (crc3 << 1) ^ 0x07;
                    } else {
                        crc3 = crc3 << 1;
                    }
                }
            }
            crc3 = crc3 & 0xFF;
            
            // æš‚æ—¶è¿”å›Dallasç®—æ³•ï¼Œå¦‚æœä¸å¯¹å†è°ƒæ•´
            // å¦‚æœæ”¶åˆ°çš„CRCæ˜¯0x00ï¼Œå¯èƒ½æ˜¯ç´¯åŠ ç®—æ³•
            return crc1 & 0xFF;
        }
        
        // å¤–å±‚åè®®è§£æå‡½æ•°
        // æ ¼å¼ï¼šAA [é•¿åº¦é«˜] [é•¿åº¦ä½] [å‘½ä»¤] [æ•°æ®...] [åºåˆ—å·] [CRC8] 55
        // lengthå­—æ®µè¡¨ç¤ºï¼šæ•´æ¡åè®®çš„æ€»å­—èŠ‚æ•°ï¼ˆåŒ…æ‹¬AAå’Œ55ï¼‰
        // ç¤ºä¾‹ï¼šAA000F02AA010541564B061507BE55
        //       - AA: å¸§å¤´
        //       - 00 0F: é•¿åº¦=15ï¼ˆæ•´æ¡åè®®15å­—èŠ‚ï¼‰
        //       - 02: å‘½ä»¤
        //       - AA 01 05 41 56 4B 06 15 07: æ•°æ®ï¼ˆ9å­—èŠ‚ï¼‰
        //       - BE: CRC8
        //       - 55: å¸§å°¾
        // æ€»åŒ…é•¿åº¦ = lengthå­—æ®µçš„å€¼
        // æ•°æ®é•¿åº¦ = length - 7ï¼ˆå‡å»AA(1) + size(2) + cmd(1) + tk(1) + crc(1) + 55(1)ï¼‰
        // è¿”å›ï¼š{success: bool, cmd: number, data: Uint8Array, tk: number, error?: string} æˆ– null
        function parseOuterProtocol(bytes) {
            try {
            // æ£€æŸ¥æœ€å°é•¿åº¦ï¼šAA(1) + size(2) + cmd(1) + data(è‡³å°‘1) + tk(1) + crc(1) + 55(1) = 8
            if (bytes.length < 8) {
                    addLog('debug', `å¤–å±‚åè®®æ•°æ®åŒ…å¤ªçŸ­ï¼š${bytes.length}å­—èŠ‚ï¼ˆæœ€å°8å­—èŠ‚ï¼‰`);
                return null;
            }
            
            // æ£€æŸ¥å¸§å¤´
            if (bytes[0] !== 0xAA) {
                    addLog('debug', `å¤–å±‚åè®®å¸§å¤´é”™è¯¯ï¼šæœŸæœ›0xAAï¼Œæ”¶åˆ°0x${bytes[0].toString(16).padStart(2, '0').toUpperCase()}`);
                return null;
            }
            
            // æ£€æŸ¥å¸§å°¾
            if (bytes[bytes.length - 1] !== 0x55) {
                    addLog('debug', `å¤–å±‚åè®®å¸§å°¾é”™è¯¯ï¼šæœŸæœ›0x55ï¼Œæ”¶åˆ°0x${bytes[bytes.length - 1].toString(16).padStart(2, '0').toUpperCase()}`);
                return null;
            }
            
            // è§£æé•¿åº¦ï¼ˆå¤§ç«¯åºï¼‰
            const lengthHi = bytes[1];
            const lengthLo = bytes[2];
            const length = (lengthHi << 8) | lengthLo;
            
                // éªŒè¯é•¿åº¦å­—æ®µåˆç†æ€§ï¼ˆä¸èƒ½ä¸º0ï¼Œä¸èƒ½è¿‡å¤§ï¼‰
                if (length === 0) {
                    addLog('warn', `å¤–å±‚åè®®é•¿åº¦å­—æ®µä¸º0ï¼Œæ•°æ®åŒ…å¯èƒ½æŸå`);
                    return null;
                }
                if (length > 2048) {
                    addLog('warn', `å¤–å±‚åè®®é•¿åº¦å­—æ®µå¼‚å¸¸å¤§ï¼š${length}ï¼Œæ•°æ®åŒ…å¯èƒ½æŸå`);
                    return null;
                }
                
                // lengthå­—æ®µè¡¨ç¤ºæ•´æ¡åè®®çš„æ€»å­—èŠ‚æ•°ï¼ˆåŒ…æ‹¬AAå’Œ55ï¼‰
                // æ€»åŒ…é•¿åº¦ = length
                const expectedTotalLength = length;
                
                // éªŒè¯å®é™…é•¿åº¦æ˜¯å¦åŒ¹é…
                if (bytes.length < expectedTotalLength) {
                    addLog('debug', `å¤–å±‚åè®®æ•°æ®åŒ…ä¸å®Œæ•´ï¼šæœŸæœ›${expectedTotalLength}å­—èŠ‚ï¼Œå®é™…${bytes.length}å­—èŠ‚`);
                    return null; // æ•°æ®ä¸å®Œæ•´ï¼Œç­‰å¾…æ›´å¤šæ•°æ®
                }
                
                // å¦‚æœå®é™…é•¿åº¦å¤§äºæœŸæœ›é•¿åº¦ï¼Œå¯èƒ½æ˜¯æ•°æ®åŒ…ç²˜è¿ï¼Œåªå¤„ç†å½“å‰åŒ…
                if (bytes.length > expectedTotalLength) {
                    addLog('debug', `å¤–å±‚åè®®æ•°æ®åŒ…å¯èƒ½ç²˜è¿ï¼šæœŸæœ›${expectedTotalLength}å­—èŠ‚ï¼Œå®é™…${bytes.length}å­—èŠ‚ï¼Œå°†åªå¤„ç†å‰${expectedTotalLength}å­—èŠ‚`);
                }
                
                // è®¡ç®—æ•°æ®éƒ¨åˆ†é•¿åº¦
                // æ€»åŒ… = AA(1) + size(2) + cmd(1) + data + tk(1) + crc(1) + 55(1)
                // length = 1 + 2 + 1 + dataé•¿åº¦ + 1 + 1 + 1 = dataé•¿åº¦ + 7
                // æ‰€ä»¥ dataé•¿åº¦ = length - 7
                const dataLength = expectedTotalLength - 7; // å‡å»AA(1) + size(2) + cmd(1) + tk(1) + crc(1) + 55(1)
                const dataStart = 4; // AA(1) + size(2) + cmd(1) = 4
                const dataEnd = dataStart + dataLength;
                const lengthInterpretation = 'æ€»åŒ…é•¿åº¦';
                
                // éªŒè¯æ•°æ®é•¿åº¦åˆç†æ€§
                if (dataLength < 0) {
                    addLog('warn', `å¤–å±‚åè®®è®¡ç®—çš„æ•°æ®é•¿åº¦ä¸ºè´Ÿæ•°ï¼š${dataLength}ï¼Œlengthå­—æ®µ=${length}ï¼ˆæ€»åŒ…é•¿åº¦ï¼‰`);
                        return null;
                }
                
                // æ£€æŸ¥æ•°æ®é•¿åº¦æ˜¯å¦è¶³å¤Ÿï¼ˆéœ€è¦èƒ½æå–tkå’Œcrcï¼‰
                if (dataEnd + 2 > expectedTotalLength) {
                    addLog('warn', `å¤–å±‚åè®®æ•°æ®é•¿åº¦ä¸è¶³ï¼šéœ€è¦${dataEnd + 2}å­—èŠ‚ï¼Œlengthå­—æ®µ=${length}ï¼ŒdataLength=${dataLength}`);
                return null;
            }
            
            // è§£æå‘½ä»¤
            const cmd = bytes[3];
            
                // æå–æ•°æ®ï¼ˆåªæå–å½“å‰åŒ…çš„æ•°æ®ï¼Œé¿å…ç²˜è¿æ•°æ®ï¼‰
                const actualBytes = bytes.slice(0, expectedTotalLength);
                const data = actualBytes.slice(dataStart, dataEnd);
            
            // æå–åºåˆ—å·ï¼ˆtkï¼‰
                const tk = actualBytes[dataEnd];
            
            // æå–CRC8
                const receivedCrc = actualBytes[dataEnd + 1];
            
            // éªŒè¯CRC8ï¼šæ ¡éªŒ size+cmd+data+tk
            const crcData = [lengthHi, lengthLo, cmd, ...Array.from(data), tk];
            
                // è®¡ç®—CRC8
            const calculatedCrc = crc8(crcData);
            
                // CRCæ ¡éªŒï¼ˆè®°å½•è¯¦ç»†ä¿¡æ¯ï¼Œä½†ä¸é˜»æ­¢å¤„ç†ï¼‰
                const crcMatch = receivedCrc === calculatedCrc;
                if (!crcMatch) {
                    const crcDataHex = Array.from(crcData.slice(0, Math.min(10, crcData.length))).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
                    addLog('warn', `å¤–å±‚åè®®CRCæ ¡éªŒå¤±è´¥ï¼šæœŸæœ›0x${calculatedCrc.toString(16).padStart(2, '0').toUpperCase()}ï¼Œæ”¶åˆ°0x${receivedCrc.toString(16).padStart(2, '0').toUpperCase()}ï¼Œtk=0x${tk.toString(16).padStart(2, '0').toUpperCase()}ï¼Œæ ¡éªŒæ•°æ®ï¼ˆå‰${Math.min(10, crcData.length)}å­—èŠ‚ï¼‰ï¼š${crcDataHex}...`);
            } else {
                    addLog('debug', `âœ… å¤–å±‚åè®®CRCæ ¡éªŒæˆåŠŸï¼š0x${calculatedCrc.toString(16).padStart(2, '0').toUpperCase()}ï¼Œtk=0x${tk.toString(16).padStart(2, '0').toUpperCase()}`);
            }
            
            return {
                success: true,
                cmd: cmd,
                data: data,
                tk: tk,
                    crc: receivedCrc,
                    crcValid: crcMatch,
                    lengthInterpretation: lengthInterpretation
                };
            } catch (error) {
                addLog('error', `å¤–å±‚åè®®è§£æå¼‚å¸¸ï¼š${error.message}`);
                addLog('error', `æ•°æ®åŒ…ï¼ˆå‰20å­—èŠ‚ï¼‰ï¼š${Array.from(bytes.slice(0, Math.min(20, bytes.length))).map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // å¤–å±‚åè®®å°è£…å‡½æ•°
        // æ ¼å¼ï¼šAA [é•¿åº¦é«˜] [é•¿åº¦ä½] [å‘½ä»¤] [æ•°æ®...] [åºåˆ—å·] [CRC8] 55
        // é•¿åº¦å­—æ®µï¼šå¤§ç«¯åºï¼ˆé«˜å­—èŠ‚åœ¨å‰ï¼‰ï¼Œè¡¨ç¤ºæ•´æ¡åè®®çš„æ€»å­—èŠ‚æ•°ï¼ˆåŒ…æ‹¬AAå’Œ55ï¼‰
        // æ€»åŒ…é•¿åº¦ = AA(1) + size(2) + cmd(1) + data + tk(1) + crc(1) + 55(1) = dataé•¿åº¦ + 7
        // CRC8æ ¡éªŒï¼šsize+cmd+data+tk
        function wrapOuterProtocol(cmd, dataHex) {
            const dataBytes = dataHex.match(/.{2}/g).map(b => parseInt(b, 16));
            const cmdByte = parseInt(cmd, 16);
            
            // è®¡ç®—æ€»åŒ…é•¿åº¦ï¼šAA(1) + size(2) + cmd(1) + data + tk(1) + crc(1) + 55(1) = dataé•¿åº¦ + 7
            // lengthå­—æ®µè¡¨ç¤ºæ•´æ¡åè®®çš„æ€»å­—èŠ‚æ•°ï¼ˆåŒ…æ‹¬AAå’Œ55ï¼‰
            const totalLength = 7 + dataBytes.length; // AA(1) + size(2) + cmd(1) + data + tk(1) + crc(1) + 55(1)
            const lengthHi = (totalLength >> 8) & 0xFF;  // é«˜å­—èŠ‚
            const lengthLo = totalLength & 0xFF;           // ä½å­—èŠ‚
            
            // åºåˆ—å·ï¼ˆå¾ªç¯é€’å¢ï¼‰
            const serial = outerProtocolSerial;
            outerProtocolSerial = (outerProtocolSerial % 255) + 1;
            
            // æ„å»ºCRC8æ ¡éªŒæ•°æ®ï¼šsize+cmd+data+tk
            const crcData = [lengthHi, lengthLo, cmdByte, ...dataBytes, serial];
            
            // è®¡ç®—CRC8ï¼ˆæ ¡éªŒsize+cmd+data+tkï¼‰
            const crc = crc8(crcData);
            
            // æ„å»ºå®Œæ•´æ•°æ®åŒ…ï¼šAA + é•¿åº¦(å¤§ç«¯åº) + å‘½ä»¤ + æ•°æ® + åºåˆ—å· + CRC + 55
            const fullPacket = [
                0xAA,           // å¸§å¤´
                lengthHi,       // é•¿åº¦é«˜å­—èŠ‚ï¼ˆå¤§ç«¯åºï¼‰
                lengthLo,       // é•¿åº¦ä½å­—èŠ‚
                cmdByte,        // å‘½ä»¤
                ...dataBytes,   // æ•°æ®
                serial,         // åºåˆ—å·
                crc,            // CRC8
                0x55            // å¸§å°¾
            ];
            
            return fullPacket;
        }
        
        // ç»Ÿä¸€å‘é€å‡½æ•°ï¼šå°†å†…å±‚åè®®æ•°æ®åŠ ä¸Šå¤–å±‚åè®®å°è£…åå‘é€
        // innerDataHex: å†…å±‚åè®®æ•°æ®ï¼ˆhexå­—ç¬¦ä¸²ï¼‰
        // cmd: å¤–å±‚åè®®å‘½ä»¤ï¼ˆé»˜è®¤0x02=æ•°æ®é€ä¼ 1ï¼‰
        function sendWithOuterProtocol(innerDataHex, cmd = '02') {
            if (!ws || ws.readyState !== 1) {
                addLog('warn', 'WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ•°æ®');
                return false;
            }
            
            // å¤–å±‚åè®®å°è£…
            const wrappedPacket = wrapOuterProtocol(cmd, innerDataHex);
            const bytes = new Uint8Array(wrappedPacket);
            ws.send(bytes.buffer);
            
            const hexString = Array.from(wrappedPacket).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join('');
            addLog('info', `ğŸ“¤ å‘é€å‘½ä»¤ï¼ˆå¤–å±‚åè®®å°è£…ï¼‰ï¼š${hexString.substring(0, 50)}${hexString.length > 50 ? '...' : ''}`);
            
            return true;
        }
        
        // CRC16-XMODEMç®—æ³•
        function crc16xmodem(hexString) {
            const bytes = hexString.match(/.{2}/g).map(b => parseInt(b, 16));
            let crc = 0x0000;
            
            for (let i = 0; i < bytes.length; i++) {
                crc ^= (bytes[i] << 8);
                
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) !== 0) {
                        crc = (crc << 1) ^ 0x1021;
                    } else {
                        crc = crc << 1;
                    }
                }
            }
            
            crc = crc & 0xFFFF;
            const crcHi = (crc >> 8) & 0xFF;
            const crcLo = crc & 0xFF;
            
            return crcHi.toString(16).padStart(2, '0') + crcLo.toString(16).padStart(2, '0');
        }
        
        // æ„é€ æŸ¥è¯¢å‘½ä»¤
        function buildQueryCmd(serial, funcCode) {
            const data = `aa${serial.toString(16).padStart(2, '0')}05E0${(funcCode >> 8).toString(16).padStart(2, '0')}${(funcCode & 0xff).toString(16).padStart(2, '0')}`;
            const crc = crc16xmodem(data);
            return data + crc;
        }
        
        // æ„é€ è®¾ç½®å‘½ä»¤
        function buildSetCmd(serial, funcCode, value) {
            const data = `aa${serial.toString(16).padStart(2, '0')}07E1${(funcCode >> 8).toString(16).padStart(2, '0')}${(funcCode & 0xff).toString(16).padStart(2, '0')}${(value >> 8).toString(16).padStart(2, '0')}${(value & 0xff).toString(16).padStart(2, '0')}`;
            const crc = crc16xmodem(data);
            return data + crc;
        }
        
        // æ„é€ æ‰¹é‡è¯»å–å‘½ä»¤ï¼ˆE2åè®®ï¼‰
        // æ ¼å¼ï¼šAA 01 07 E2 02 00 00 02 D5 10
        // å…¶ä¸­ï¼š01-è®¾å¤‡åœ°å€ï¼Œ07-ä»E2å¼€å§‹åˆ°æ ¡éªŒç çš„é•¿åº¦ï¼ŒE2-è¯»è¿ç»­æ ‡å¿—ä½
        // 02 00-èµ·å§‹åœ°å€ï¼ˆ512=0x0200ï¼Œé«˜å­—èŠ‚åœ¨å‰ï¼‰ï¼Œ00 02-å¯„å­˜å™¨ä¸ªæ•°ï¼ˆé«˜å­—èŠ‚åœ¨å‰ï¼‰ï¼ŒD5 10-æ ¡éªŒç 
        // é•¿åº¦ä»E2å¼€å§‹åˆ°æ ¡éªŒç çš„é•¿åº¦ = 1(E2) + 2(èµ·å§‹åœ°å€) + 2(å¯„å­˜å™¨ä¸ªæ•°) + 2(æ ¡éªŒç ) = 7
        function buildBatchQueryCmd(serial, startFuncCode, count) {
            // èµ·å§‹åœ°å€ï¼ˆåŠŸèƒ½ç ï¼‰- é«˜å­—èŠ‚åœ¨å‰
            const startAddrHi = (startFuncCode >> 8).toString(16).padStart(2, '0');
            const startAddrLo = (startFuncCode & 0xff).toString(16).padStart(2, '0');
            // å¯„å­˜å™¨ä¸ªæ•° - é«˜å­—èŠ‚åœ¨å‰
            const countHi = (count >> 8).toString(16).padStart(2, '0');
            const countLo = (count & 0xff).toString(16).padStart(2, '0');
            // ä»E2å¼€å§‹åˆ°æ ¡éªŒç çš„é•¿åº¦ = 1(E2) + 2(èµ·å§‹åœ°å€) + 2(å¯„å­˜å™¨ä¸ªæ•°) + 2(æ ¡éªŒç ) = 7
            const length = 7;
            const data = `aa${serial.toString(16).padStart(2, '0')}${length.toString(16).padStart(2, '0')}E2${startAddrHi}${startAddrLo}${countHi}${countLo}`;
            const crc = crc16xmodem(data);
            return data + crc;
        }
        
        // æ„é€ æ‰¹é‡ä¿å­˜å‘½ä»¤ï¼ˆE1åè®®ï¼‰- ä¸äº‘å¹³å°æ ¼å¼ä¸€è‡´
        // æ ¼å¼ï¼šAA [åœ°å€ç ] [é•¿åº¦] E1 [åœ°å€1(2å­—èŠ‚)][å€¼1(2å­—èŠ‚)][åœ°å€2(2å­—èŠ‚)][å€¼2(2å­—èŠ‚)]... [CRC]
        // é•¿åº¦ä»E1å¼€å§‹åˆ°æ ¡éªŒç çš„é•¿åº¦ = 1(E1) + (åœ°å€+å€¼)å¯¹æ•°é‡ * 4
        function buildBatchSaveCmd(serial, funcCodes, values) {
            if (!funcCodes || !values || funcCodes.length !== values.length) {
                throw new Error('åŠŸèƒ½ç æ•°ç»„å’Œå€¼æ•°ç»„é•¿åº¦å¿…é¡»ä¸€è‡´');
            }
            
            // æ•°æ®éƒ¨åˆ†ï¼šåœ°å€1+å€¼1+åœ°å€2+å€¼2+...
            let dataPart = '';
            for (let i = 0; i < funcCodes.length; i++) {
                const addr = funcCodes[i];
                const val = values[i];
                
                // åœ°å€ï¼ˆ2å­—èŠ‚ï¼Œé«˜å­—èŠ‚åœ¨å‰ï¼‰
                const addrHi = ((addr >> 8) & 0xff).toString(16).padStart(2, '0');
                const addrLo = (addr & 0xff).toString(16).padStart(2, '0');
                
                // å€¼ï¼ˆ2å­—èŠ‚ï¼Œé«˜å­—èŠ‚åœ¨å‰ï¼‰
                const valHi = ((val >> 8) & 0xff).toString(16).padStart(2, '0');
                const valLo = (val & 0xff).toString(16).padStart(2, '0');
                
                dataPart += `${addrHi}${addrLo}${valHi}${valLo}`;
            }
            
            // ä»E1å¼€å§‹åˆ°æ ¡éªŒç ç»“æŸçš„é•¿åº¦ = 1(E1) + (åœ°å€+å€¼)å¯¹æ•°é‡ * 4 + 2(CRC)
            const length = 1 + funcCodes.length * 4 + 2;
            const data = `aa${serial.toString(16).padStart(2, '0')}${length.toString(16).padStart(2, '0')}E1${dataPart}`;
            const crc = crc16xmodem(data);
            return data + crc;
        }
        
        // å‚æ•°åç§°æ˜ å°„è¡¨
        const featureNames = {
            zh: {
            f01: 'ç”µç½‘Aç›¸æœ‰åŠŸ', f02: 'ç”µç½‘Aç›¸æ— åŠŸ', f03: 'ç”µç½‘Aç›¸åŠŸç‡å› æ•°',
            f04: 'ç”µç½‘Bç›¸æœ‰åŠŸ', f05: 'ç”µç½‘Bç›¸æ— åŠŸ', f06: 'ç”µç½‘Bç›¸åŠŸç‡å› æ•°',
            f07: 'ç”µç½‘Cç›¸æœ‰åŠŸ', f08: 'ç”µç½‘Cç›¸æ— åŠŸ', f09: 'ç”µç½‘Cç›¸åŠŸç‡å› æ•°',
            f10: 'è¾“å‡ºAç›¸æœ‰åŠŸ', f11: 'è¾“å‡ºAç›¸æ— åŠŸ', f12: 'è¾“å‡ºAç›¸åŠŸç‡å› æ•°',
            f13: 'è¾“å‡ºBç›¸æœ‰åŠŸ', f14: 'è¾“å‡ºBç›¸æ— åŠŸ', f15: 'è¾“å‡ºBç›¸åŠŸç‡å› æ•°',
            f16: 'è¾“å‡ºCç›¸æœ‰åŠŸ', f17: 'è¾“å‡ºCç›¸æ— åŠŸ', f18: 'è¾“å‡ºCç›¸åŠŸç‡å› æ•°',
            f19: 'FPGAç‰ˆæœ¬å·', f20: 'çŠ¶æ€', f21: 'é¢„ç•™', f22: 'DSPBç‰ˆæœ¬å·',
            f23: 'Aç›¸ç”µç½‘ç”µå‹', f24: 'Bç›¸ç”µç½‘ç”µå‹', f25: 'Cç›¸ç”µç½‘ç”µå‹',
            f26: 'DSPAç‰ˆæœ¬å·', f27: 'ç”µç½‘ç”µæµè°æ³¢ç•¸å˜ç‡(THDI)', f28: 'ç”µç½‘é¢‘ç‡',
            f29: 'Aç›¸æ¸©åº¦', f30: 'ç”µç½‘ç”µå‹è°æ³¢ç•¸å˜ç‡(THDU)', f31: 'ç›´æµæ¯çº¿ç”µå‹',
            f32: 'ä¸Šåˆ†è£‚ç”µå®¹ç”µå‹', f33: 'ä¸‹åˆ†è£‚ç”µå®¹ç”µå‹',
            f34: 'Bç›¸æ¸©åº¦', f35: 'Cç›¸æ¸©åº¦',
            f36: 'Aç›¸è£…ç½®ç”µæµ', f37: 'Bç›¸è£…ç½®ç”µæµ', f38: 'Cç›¸è£…ç½®ç”µæµ',
            f39: 'Aç›¸è´Ÿè½½ç”µæµ', f40: 'Bç›¸è´Ÿè½½ç”µæµ', f41: 'Cç›¸è´Ÿè½½ç”µæµ',
            f42: 'Aç›¸ç”µç½‘ç”µæµ', f43: 'Bç›¸ç”µç½‘ç”µæµ', f44: 'Cç›¸ç”µç½‘ç”µæµ',
            f45: 'Aç›¸è®¾å¤‡ç”µæµ', f46: 'Bç›¸è®¾å¤‡ç”µæµ', f47: 'Cç›¸è®¾å¤‡ç”µæµ',
            f48: 'æ•…éšœä¿¡æ¯5', f49: 'æ•…éšœä¿¡æ¯4', f50: 'æ•…éšœä¿¡æ¯3',
            f51: 'æ•…éšœä¿¡æ¯2', f52: 'EXTSTATE0', f53: 'EXTSTATE2',
            f54: 'è´Ÿè½½Aç›¸æœ‰åŠŸ', f55: 'è´Ÿè½½Aç›¸æ— åŠŸ',
            f56: 'è´Ÿè½½Bç›¸æœ‰åŠŸ', f57: 'è´Ÿè½½Bç›¸æ— åŠŸ',
            f58: 'è´Ÿè½½Cç›¸æœ‰åŠŸ', f59: 'è´Ÿè½½Cç›¸æ— åŠŸ',
            f60: 'å·¥ä½œæ¨¡å¼',
            f747: 'ç”µç½‘Aç›¸è§†åœ¨åŠŸç‡', f748: 'ç”µç½‘Bç›¸è§†åœ¨åŠŸç‡', f749: 'ç”µç½‘Cç›¸è§†åœ¨åŠŸç‡',
            f753: 'è¾“å‡ºAç›¸è§†åœ¨åŠŸç‡', f754: 'è¾“å‡ºBç›¸è§†åœ¨åŠŸç‡', f755: 'è¾“å‡ºCç›¸è§†åœ¨åŠŸç‡',
            f770: 'è´Ÿè½½Aç›¸è§†åœ¨åŠŸç‡', f771: 'è´Ÿè½½Bç›¸è§†åœ¨åŠŸç‡', f772: 'è´Ÿè½½Cç›¸è§†åœ¨åŠŸç‡',
            f782: 'ç”µå‹Aç›¸æ€»è°æ³¢å«é‡', f783: 'ç”µå‹Bç›¸æ€»è°æ³¢å«é‡', f784: 'ç”µå‹Cç›¸æ€»è°æ³¢å«é‡',
            f785: 'ç”µç½‘ç”µæµAç›¸æ€»è°æ³¢å«é‡', f786: 'ç”µç½‘ç”µæµBç›¸æ€»è°æ³¢å«é‡', f787: 'ç”µç½‘ç”µæµCç›¸æ€»è°æ³¢å«é‡',
            f788: 'è´Ÿè½½ç”µæµAç›¸æ€»è°æ³¢å«é‡', f789: 'è´Ÿè½½ç”µæµBç›¸æ€»è°æ³¢å«é‡', f790: 'è´Ÿè½½ç”µæµCç›¸æ€»è°æ³¢å«é‡'
            },
            en: {
                f01: 'Grid Phase A Active Power', f02: 'Grid Phase A Reactive Power', f03: 'Grid Phase A Power Factor',
                f04: 'Grid Phase B Active Power', f05: 'Grid Phase B Reactive Power', f06: 'Grid Phase B Power Factor',
                f07: 'Grid Phase C Active Power', f08: 'Grid Phase C Reactive Power', f09: 'Grid Phase C Power Factor',
                f10: 'Output Phase A Active Power', f11: 'Output Phase A Reactive Power', f12: 'Output Phase A Power Factor',
                f13: 'Output Phase B Active Power', f14: 'Output Phase B Reactive Power', f15: 'Output Phase B Power Factor',
                f16: 'Output Phase C Active Power', f17: 'Output Phase C Reactive Power', f18: 'Output Phase C Power Factor',
                f19: 'FPGA Version', f20: 'Status', f21: 'Reserved', f22: 'DSPB Version',
                f23: 'Grid Voltage Phase A', f24: 'Grid Voltage Phase B', f25: 'Grid Voltage Phase C',
                f26: 'DSPA Version', f27: 'Grid Current THD (THDI)', f28: 'Grid Frequency',
                f29: 'Phase A Temperature', f30: 'Grid Voltage THD (THDU)', f31: 'DC Bus Voltage',
                f32: 'Upper Split Capacitor Voltage', f33: 'Lower Split Capacitor Voltage',
                f34: 'Phase B Temperature', f35: 'Phase C Temperature',
                f36: 'Device Current Phase A', f37: 'Device Current Phase B', f38: 'Device Current Phase C',
                f39: 'Load Current Phase A', f40: 'Load Current Phase B', f41: 'Load Current Phase C',
                f42: 'Grid Phase A Current', f43: 'Grid Phase B Current', f44: 'Grid Phase C Current',
                f45: 'Equipment Current Phase A', f46: 'Equipment Current Phase B', f47: 'Equipment Current Phase C',
                f48: 'Fault Info 5', f49: 'Fault Info 4', f50: 'Fault Info 3',
                f51: 'Fault Info 2', f52: 'EXTSTATE0', f53: 'EXTSTATE2',
                f54: 'Load Phase A Active Power', f55: 'Load Phase A Reactive Power',
                f56: 'Load Phase B Active Power', f57: 'Load Phase B Reactive Power',
                f58: 'Load Phase C Active Power', f59: 'Load Phase C Reactive Power',
                f60: 'Operation Mode',
                f747: 'Grid Phase A Apparent Power', f748: 'Grid Phase B Apparent Power', f749: 'Grid Phase C Apparent Power',
                f753: 'Output Phase A Apparent Power', f754: 'Output Phase B Apparent Power', f755: 'Output Phase C Apparent Power',
                f770: 'Load Phase A Apparent Power', f771: 'Load Phase B Apparent Power', f772: 'Load Phase C Apparent Power',
                f782: 'Voltage Phase A Total Harmonic Content', f783: 'Voltage Phase B Total Harmonic Content', f784: 'Voltage Phase C Total Harmonic Content',
                f785: 'Grid Current Phase A Total Harmonic Content', f786: 'Grid Current Phase B Total Harmonic Content', f787: 'Grid Current Phase C Total Harmonic Content',
                f788: 'Load Current Phase A Total Harmonic Content', f789: 'Load Current Phase B Total Harmonic Content', f790: 'Load Current Phase C Total Harmonic Content'
            }
        };
        
        const units = {
            f01: 'kW', f02: 'kvar', f04: 'kW', f05: 'kvar', f07: 'kW', f08: 'kvar',
            f10: 'kW', f11: 'kvar', f13: 'kW', f14: 'kvar', f16: 'kW', f17: 'kvar',
            f23: 'V', f24: 'V', f25: 'V', f27: '%', f28: 'Hz', f29: 'â„ƒ', f30: '%',
            f31: 'V', f32: 'V', f33: 'V', f34: 'â„ƒ', f35: 'â„ƒ',
            f36: 'A', f37: 'A', f38: 'A', f39: 'A', f40: 'A', f41: 'A',
            f42: 'A', f43: 'A', f44: 'A', f45: 'A', f46: 'A', f47: 'A',
            f54: 'kW', f55: 'kvar', f56: 'kW', f57: 'kvar', f58: 'kW', f59: 'kvar',
            f747: 'kVA', f748: 'kVA', f749: 'kVA',
            f753: 'kVA', f754: 'kVA', f755: 'kVA',
            f770: 'kVA', f771: 'kVA', f772: 'kVA',
            f782: '%', f783: '%', f784: '%', f785: '%', f786: '%', f787: '%',
            f788: '%', f789: '%', f790: '%'
        };
        
        // æ·»åŠ æ—¥å¿—
        function addLog(type, message) {
            const logBox = document.getElementById('logBox');
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            const time = new Date().toLocaleTimeString();
            logItem.textContent = `[${time}] ${message}`;
            logBox.appendChild(logItem);
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        // åˆ‡æ¢é…ç½®æ˜¾ç¤º
        function toggleConfig() {
            const card = document.getElementById('configCard');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
        }
        
        // åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º
        function toggleLog() {
            const card = document.getElementById('logCard');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
        }
        
        // æ‰“å¼€å‚æ•°è®¾ç½®å¼¹çª—
        function openParamDialog() {
            const dialog = document.getElementById('paramDialog');
            const modalContent = dialog.querySelector('.modal-content');
            loadParamSettings();
            switchParamTab(0);
            // ç¡®ä¿æƒé™æ§åˆ¶å·²åº”ç”¨
            setTimeout(() => {
                applyRolePermissions();
                // å¼ºåˆ¶éšè—å¯†ç ç®¡ç†tabï¼ˆå¦‚æœéè¶…çº§ç®¡ç†å‘˜ï¼‰
                if (currentRole !== 'superadmin') {
                    document.querySelectorAll('.password-manage-tab').forEach(tabItem => {
                        tabItem.style.setProperty('display', 'none', 'important');
                        tabItem.classList.add('hidden-by-role');
                    });
                }
            }, 50);
            // ç§»é™¤å…³é—­åŠ¨ç”»ç±»ï¼Œç¡®ä¿æ‰“å¼€åŠ¨ç”»æ­£å¸¸æ’­æ”¾
            if (modalContent) {
                modalContent.classList.remove('jelly-close');
            }
            dialog.style.display = 'flex';
        }
        
        // åˆ‡æ¢å‚æ•°è®¾ç½®çš„å­tab
        function switchParamTab(index) {
            // æƒé™æ£€æŸ¥ï¼šå•å‚æ•°è®¾ç½®ï¼ˆindex=4ï¼‰ä»…ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯è®¿é—®
            if (index === 4 && currentRole !== 'admin' && currentRole !== 'superadmin') {
                // ç”¨æˆ·æƒé™æ—¶ä¸å…è®¸åˆ‡æ¢åˆ°å•å‚æ•°è®¾ç½®é¡µé¢
                return;
            }
            // æƒé™æ£€æŸ¥ï¼šå¯†ç ç®¡ç†ï¼ˆindex=5ï¼‰ä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®
            if (index === 5 && currentRole !== 'superadmin') {
                // éè¶…çº§ç®¡ç†å‘˜æ—¶ä¸å…è®¸åˆ‡æ¢åˆ°å¯†ç ç®¡ç†é¡µé¢
                return;
            }
            
            currentParamTabIndex = index;
            // æ›´æ–°tabæ¿€æ´»çŠ¶æ€ï¼Œé€šè¿‡æŸ¥æ‰¾åŒ…å«data-param-tabæˆ–è€…é€šè¿‡onclickå‡½æ•°çš„å‚æ•°æ¥åŒ¹é…
            ['#tab3', '#paramDialog'].forEach(containerSelector => {
                const container = document.querySelector(containerSelector);
                if (!container) return;
                const navItems = container.querySelectorAll(':scope .param-sub-tab-nav .tab-item');
                navItems.forEach((item) => {
                    // è·å–onclickå±æ€§æ¥åŒ¹é…ç´¢å¼•
                    const onclickAttr = item.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/switchParamTab\((\d+)\)/);
                        if (match) {
                            const tabIndex = parseInt(match[1], 10);
                            if (tabIndex === index) {
                                item.classList.add('active');
                            } else {
                                item.classList.remove('active');
                            }
                        }
                    }
                });
            });

            document.querySelectorAll('.param-tab-panel').forEach(panel => {
                const tabIndex = parseInt(panel.dataset.paramTab, 10);
                if (!isNaN(tabIndex)) {
                    panel.style.display = tabIndex === index ? 'block' : 'none';
                }
            });
            
            // åº”ç”¨ç§»åŠ¨ç«¯æ ·å¼
            setTimeout(() => {
                applyMobileStyles();
            }, 50);
        }
        
        // å…³é—­å¼¹çª—
        function closeParamDialog() {
            const dialog = document.getElementById('paramDialog');
            const modalContent = dialog.querySelector('.modal-content');
            if (modalContent) {
                // æ·»åŠ å…³é—­åŠ¨ç”»ç±»
                modalContent.classList.add('jelly-close');
                // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†éšè—
                setTimeout(() => {
                    dialog.style.display = 'none';
                    modalContent.classList.remove('jelly-close');
                }, 400); // ä¸jellyOutåŠ¨ç”»æ—¶é•¿ä¸€è‡´
            } else {
                dialog.style.display = 'none';
            }
        }
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        document.addEventListener('click', (e) => {
            const dialog = document.getElementById('paramDialog');
            if (e.target === dialog) {
                closeParamDialog();
            }
        });
        
        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeParamDialog();
            }
        });
        
        // è¡¥å¿è®¾ç½®HTML
        function getCompSettingHTML() {
            return `
                <div style="max-width: 600px;">
                    <div class="param-setting-item">
                        <label>${t('compModeLabel')}</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="comp_mode" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <option value="">${t('selectPlaceholder')}</option>
                                <option value="1">${t('compModeOption1')}</option>
                                <option value="2">${t('compModeOption2')}</option>
                                <option value="4">${t('compModeOption4')}</option>
                                <option value="6">${t('compModeOption6')}</option>
                                <option value="13">${t('compModeOption13')}</option>
                                <option value="14">${t('compModeOption14')}</option>
                                <option value="15">${t('compModeOption15')}</option>
                                <option value="16">${t('compModeOption16')}</option>
                                <option value="35">${t('compModeOption35')}</option>
                                <option value="39">${t('compModeOption39')}</option>
                            </select>
                            <button class="btn btn-primary" onclick="queryParam(513, 'comp_mode')">${t('btnQuery')}</button>
                            <button class="btn btn-success" onclick="saveParam(513, 'comp_mode')">${t('btnSave')}</button>
                        </div>
                    </div>
                    
                    <div class="param-setting-item">
                        <label>${t('autoEnableLabel')}</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="auto_enable" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <option value="">${t('selectPlaceholder')}</option>
                                <option value="0">ä¸ä½¿èƒ½</option>
                                <option value="1">ä½¿èƒ½</option>
                            </select>
                            <button class="btn btn-primary" onclick="queryParam(512, 'auto_enable')">${t('btnQuery')}</button>
                            <button class="btn btn-success" onclick="saveParam(512, 'auto_enable')">${t('btnSave')}</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-primary" onclick="batchQuery([512, 513])">${t('btnBatchQuery')}</button>
                        <button class="btn btn-success" onclick="batchSave([512, 513])">${t('btnBatchSave')}</button>
                    </div>
                </div>
            `;
        }
        
        // é‡‡æ ·è®¾ç½®HTML - å·¦å³åˆ†å¸ƒ
        function getSampleSettingHTML() {
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 900px;">
                    <!-- å·¦ä¾§ï¼šè¾“å…¥ç”µæµé‡‡æ · -->
                    <div>
                        <h3 style="font-size: 14px; color: #666; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #722ed1;">${t('inputCurrentSamplingTitle')}</h3>
                        
                        <div class="param-setting-item">
                            <label>${t('inSamplePosLabel')}</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="in_sample_pos" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <option value="">${t('selectPlaceholder')}</option>
                                    <option value="0">è´Ÿè½½ä¾§</option>
                                    <option value="1">ç”µç½‘ä¾§</option>
                                </select>
                                <button class="btn btn-primary" onclick="queryParam(17, 'in_sample_pos')">${t('btnQuery')}</button>
                                <button class="btn btn-success" onclick="saveParam(17, 'in_sample_pos')">${t('btnSave')}</button>
                            </div>
                        </div>
                        
                        <div class="param-setting-item">
                            <label>${t('inSampleDirLabel')}</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="in_sample_dir" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <option value="">${t('selectPlaceholder')}</option>
                                    <option value="0">æµå‡ºç”µç½‘</option>
                                    <option value="1">æµå…¥ç”µç½‘</option>
                                </select>
                                <button class="btn btn-primary" onclick="queryParam(15, 'in_sample_dir')">${t('btnQuery')}</button>
                                <button class="btn btn-success" onclick="saveParam(15, 'in_sample_dir')">${t('btnSave')}</button>
                            </div>
                        </div>
                        
                        <div class="param-setting-item">
                            <label>${t('inCTLabel')}</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="in_ct_ratio" placeholder="${t('ctInputPlaceholder')}" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <button class="btn btn-primary" onclick="queryParam(241, 'in_ct_ratio')">${t('btnQuery')}</button>
                                <button class="btn btn-success" onclick="saveParam(241, 'in_ct_ratio')">${t('btnSave')}</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šè®¾å¤‡ç”µæµé‡‡æ · -->
                    <div>
                        <h3 style="font-size: 14px; color: #666; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #13c2c2;">${t('deviceCurrentSamplingTitle')}</h3>
                        
                        <div class="param-setting-item">
                            <label>${t('devSampleEnableLabel')}</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="dev_sample_enable" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <option value="">${t('selectPlaceholder')}</option>
                                    <option value="0">ä¸ä½¿èƒ½</option>
                                    <option value="1">ä½¿èƒ½</option>
                                </select>
                                <button class="btn btn-primary" onclick="queryParam(16, 'dev_sample_enable')">${t('btnQuery')}</button>
                                <button class="btn btn-success" onclick="saveParam(16, 'dev_sample_enable')">${t('btnSave')}</button>
                            </div>
                        </div>
                        
                        <div class="param-setting-item">
                            <label>${t('devSamplePosLabel')}</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="dev_sample_pos" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <option value="">${t('selectPlaceholder')}</option>
                                    <option value="0">æŸœä½“</option>
                                    <option value="1">ç”µå®¹</option>
                                </select>
                                <button class="btn btn-primary" onclick="queryParam(13, 'dev_sample_pos')">${t('btnQuery')}</button>
                                <button class="btn btn-success" onclick="saveParam(13, 'dev_sample_pos')">${t('btnSave')}</button>
                            </div>
                        </div>
                        
                        <div class="param-setting-item">
                            <label>${t('devSampleDirLabel')}</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="dev_sample_dir" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                    <option value="">${t('selectPlaceholder')}</option>
                                    <option value="0">æµå‡ºç”µç½‘</option>
                                    <option value="1">æµå…¥ç”µç½‘</option>
                                </select>
                                <button class="btn btn-primary" onclick="queryParam(14, 'dev_sample_dir')">${t('btnQuery')}</button>
                                <button class="btn btn-success" onclick="saveParam(14, 'dev_sample_dir')">${t('btnSave')}</button>
                            </div>
                        </div>
                        
                        <div class="param-setting-item">
                            <label>${t('devCTLabel')}</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="dev_ct_ratio" placeholder="${t('ctInputPlaceholder')}" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <button class="btn btn-primary" onclick="queryParam(242, 'dev_ct_ratio')">${t('btnQuery')}</button>
                                <button class="btn btn-success" onclick="saveParam(242, 'dev_ct_ratio')">${t('btnSave')}</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-primary" onclick="batchQuery([13, 14, 15, 16, 17, 241, 242])">${t('btnBatchQuery')}</button>
                    <button class="btn btn-success" onclick="batchSave([13, 14, 15, 16, 17, 241, 242])">${t('btnBatchSave')}</button>
                </div>
            `;
        }
        
        // ç³»ç»Ÿå‚æ•°è®¾ç½®HTML
        function getSystemParamHTML() {
            return `
                <div style="max-width: 600px;">
                    <div class="param-setting-item">
                        <label>${t('systemParamParallelCabinets')}</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="parallel_cabinets" placeholder="${t('inputPlaceholder')}" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            <button class="btn btn-primary" onclick="queryParam(151, 'parallel_cabinets')">${t('btnQuery')}</button>
                            <button class="btn btn-success" onclick="saveParam(151, 'parallel_cabinets')">${t('btnSave')}</button>
                        </div>
                    </div>
                    
                    <div class="param-setting-item">
                        <label>${t('systemParamModuleCapacityRatio')}</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="module_capacity_ratio" placeholder="${t('inputPlaceholder')}" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            <button class="btn btn-primary" onclick="queryParam(161, 'module_capacity_ratio')">${t('btnQuery')}</button>
                            <button class="btn btn-success" onclick="saveParam(161, 'module_capacity_ratio')">${t('btnSave')}</button>
                        </div>
                    </div>
                    
                    <div class="param-setting-item">
                        <label>${t('systemParamDIEnable')}</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="di_enable" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <option value="">${t('selectPlaceholder')}</option>
                                <option value="0">ä¸ä½¿èƒ½</option>
                                <option value="1">ä½¿èƒ½</option>
                            </select>
                            <button class="btn btn-primary" onclick="queryParam(9, 'di_enable')">${t('btnQuery')}</button>
                            <button class="btn btn-success" onclick="saveParam(9, 'di_enable')">${t('btnSave')}</button>
                        </div>
                    </div>
                    
                    <div class="param-setting-item">
                        <label>${t('systemParamAutoEnable')}</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="auto_enable_system" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                <option value="">${t('selectPlaceholder')}</option>
                                <option value="0">ä¸ä½¿èƒ½</option>
                                <option value="1">ä½¿èƒ½</option>
                            </select>
                            <button class="btn btn-primary" onclick="queryParam(512, 'auto_enable_system')">${t('btnQuery')}</button>
                            <button class="btn btn-success" onclick="saveParam(512, 'auto_enable_system')">${t('btnSave')}</button>
                        </div>
                    </div>
                    
                    <div class="param-setting-item">
                        <label>${t('systemParamPowerFactor')}</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="power_factor" placeholder="${t('inputPlaceholder')}" step="0.01" min="0" max="1" style="flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            <button class="btn btn-primary" onclick="queryPowerFactor()">${t('btnQuery')}</button>
                            <button class="btn btn-success" onclick="saveParam(280, 'power_factor')">${t('btnSave')}</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-primary" onclick="batchQuery([151, 161, 9, 512, 280])">${t('btnBatchQuery')}</button>
                        <button class="btn btn-success" onclick="batchSave([151, 161, 9, 512, 280])">${t('btnBatchSave')}</button>
                    </div>
                </div>
            `;
        }
        
        // å•å‚æ•°è®¾ç½®HTML
        function getSingleParamHTML() {
            return `
                <div style="max-width: 500px; margin: 0 auto;">
                    <div class="param-setting-item">
                        <label>${t('paramAddrLabel')}</label>
                        <input type="number" id="single_param_addr" placeholder="${t('addrPlaceholder')}" 
                            style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;"
                            min="2" max="1000">
                    </div>
                    
                    <div class="param-setting-item">
                        <label>${t('paramValueLabel')}</label>
                        <input type="number" id="single_param_val" placeholder="${t('valuePlaceholder')}" 
                            style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;"
                            min="0" max="65535">
                    </div>
                    
                    <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="querySingleParam()" style="min-width: 120px;">
                            ${t('btnSyncParam')}
                        </button>
                        <button class="btn btn-success" onclick="saveSingleParam()" style="min-width: 120px;">
                            ${t('btnSaveParam')}
                        </button>
                    </div>
                    
                    <div id="singleParamResult" style="margin-top: 20px; padding: 15px; background: #fafafa; border-radius: 6px; display: none;">
                        <div style="font-size: 13px; color: #666;">
                            <div style="margin-bottom: 8px;">
                                <strong>${t('queryResultTitle')}</strong>
                            </div>
                            <div id="singleParamResultContent" style="color: #333; font-size: 14px;"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æŸ¥è¯¢å•ä¸ªå‚æ•°ï¼ˆå‚æ•°åŒæ­¥ï¼‰
        async function querySingleParam() {
            const addr = parseInt(document.getElementById('single_param_addr').value);
            const valInput = document.getElementById('single_param_val');
            const resultDiv = document.getElementById('singleParamResult');
            const resultContent = document.getElementById('singleParamResultContent');
            
            if (!addr || addr < 2 || addr > 1000) {
                alert(t('alertInvalidFuncCode'));
                return;
            }
            
            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnected'));
                return;
            }
            
            try {
                const serial = parseInt(document.getElementById('deviceSerial').value) || 1;
                const cmdHex = buildQueryCmd(serial, addr);
                
                addLog('info', `[å•å‚æ•°] ğŸ“¤ æŸ¥è¯¢åŠŸèƒ½ç ${addr}ï¼Œå†…å±‚æŒ‡ä»¤: ${cmdHex.toUpperCase()}`);
                
                // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
                sendWithOuterProtocol(cmdHex, '02');
                
                // è®°å½•ç­‰å¾…çš„æŸ¥è¯¢
                pendingQueries[addr] = {
                    fieldId: 'single_param_val',
                    timestamp: Date.now(),
                    callback: (value) => {
                        valInput.value = value;
                        resultDiv.style.display = 'block';
                        resultContent.innerHTML = t('singleParamResultMessage')
                            .replace('{addr}', addr)
                            .replace('{value}', value);
                        addLog('info', `[å•å‚æ•°] âœ… æŸ¥è¯¢æˆåŠŸï¼ŒåŠŸèƒ½ç ${addr} = ${value}`);
                    }
                };
                
                addLog('info', '[å•å‚æ•°] â³ ç­‰å¾…è®¾å¤‡å“åº”...');
            } catch (error) {
                addLog('error', `[å•å‚æ•°] âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`);
            }
        }
        
        // ä¿å­˜å•ä¸ªå‚æ•°
        async function saveSingleParam() {
            const addr = parseInt(document.getElementById('single_param_addr').value);
            const val = parseInt(document.getElementById('single_param_val').value);
            const resultDiv = document.getElementById('singleParamResult');
            const resultContent = document.getElementById('singleParamResultContent');
            
            if (!addr || addr < 2 || addr > 1000) {
                alert(t('alertInvalidFuncCode'));
                return;
            }
            
            if (isNaN(val) || val < 0 || val > 65535) {
                alert(t('alertInvalidValueRange'));
                return;
            }
            
            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnected'));
                return;
            }
            
            try {
                const serial = parseInt(document.getElementById('deviceSerial').value) || 1;
                const cmdHex = buildSetCmd(serial, addr, val);
                
                addLog('info', `[å•å‚æ•°] ğŸ“¤ ä¿å­˜åŠŸèƒ½ç ${addr}ï¼Œå€¼: ${val}ï¼Œå†…å±‚æŒ‡ä»¤: ${cmdHex.toUpperCase()}`);
                
                // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
                sendWithOuterProtocol(cmdHex, '02');
                
                resultDiv.style.display = 'block';
                resultContent.innerHTML = t('singleParamSaveMessage')
                    .replace('{addr}', addr)
                    .replace('{value}', val);
                addLog('info', '[å•å‚æ•°] âœ… ä¿å­˜å‘½ä»¤å·²å‘é€');
                
                // 1ç§’åè‡ªåŠ¨æŸ¥è¯¢éªŒè¯
                setTimeout(() => {
                    querySingleParam();
                }, 1000);
            } catch (error) {
                addLog('error', `[å•å‚æ•°] âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }
        
        // å¯†ç ç®¡ç†HTMLï¼ˆä»…è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰
        function getPasswordManageHTML() {
            // è·å–å½“å‰ç®¡ç†å‘˜å¯†ç 
            const currentPassword = ADMIN_PASSWORD;
            return `
                <div style="max-width: 500px; margin: 0 auto;">
                    <div class="param-setting-item">
                        <label style="font-size: 14px; color: #262626; margin-bottom: 10px; display: block;">ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </label>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #666; font-size: 13px;">è¯·è¾“å…¥æ–°çš„ç®¡ç†å‘˜å¯†ç ï¼ˆå½“å‰å¯†ç ï¼š${currentPassword}ï¼‰</p>
                        </div>
                        
                        <div class="param-setting-item">
                            <label>æ–°ç®¡ç†å‘˜å¯†ç </label>
                            <input type="password" id="new_admin_password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " 
                                style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;">
                        </div>
                        
                        <div class="param-setting-item">
                            <label>ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="confirm_admin_password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " 
                                style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-success" onclick="changeAdminPassword()" style="min-width: 120px;">
                                ä¿®æ”¹å¯†ç 
                            </button>
                        </div>
                        
                        <div id="passwordChangeResult" style="margin-top: 20px; padding: 15px; background: #fafafa; border-radius: 6px; display: none;">
                            <div style="font-size: 13px; color: #666;" id="passwordChangeResultContent"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
        function changeAdminPassword() {
            const newPassword = document.getElementById('new_admin_password').value;
            const confirmPassword = document.getElementById('confirm_admin_password').value;
            const resultDiv = document.getElementById('passwordChangeResult');
            const resultContent = document.getElementById('passwordChangeResultContent');
            
            if (!newPassword || newPassword.trim() === '') {
                alert('è¯·è¾“å…¥æ–°å¯†ç ');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            // æ›´æ–°ç®¡ç†å‘˜å¯†ç 
            ADMIN_PASSWORD = newPassword;
            localStorage.setItem('adminPassword', newPassword);
            
            resultDiv.style.display = 'block';
            resultContent.innerHTML = `<strong style="color: #52c41a;">âœ… ç®¡ç†å‘˜å¯†ç å·²ä¿®æ”¹ä¸ºï¼š${newPassword}</strong>`;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('new_admin_password').value = '';
            document.getElementById('confirm_admin_password').value = '';
        }
        
        // è°æ³¢ç»„è®¾ç½®HTML
        function getHarmonicSettingHTML() {
            // ç”Ÿæˆ2-50çš„è°æ³¢æ¬¡æ•°æŒ‰é’®ï¼ˆæ’é™¤1æ¬¡è°æ³¢ï¼‰
            const oddHarmonics = []; // å¥‡æ•°ï¼š3, 5, 7, ..., 49ï¼ˆæ’é™¤1ï¼‰
            const evenHarmonics = []; // å¶æ•°ï¼š2, 4, 6, ..., 50
            
            for (let i = 2; i <= 50; i++) {
                if (i % 2 === 1) {
                    oddHarmonics.push(i);
                } else {
                    evenHarmonics.push(i);
                }
            }
            
            // ç”Ÿæˆè°æ³¢æŒ‰é’®HTML
            const generateHarmonicButtons = (harmonics) => {
                return harmonics.map(num => 
                    `<button class="harmonic-btn" data-harmonic="${num}" onclick="selectHarmonicForGroup(${num})" id="harmBtn${num}">${num}</button>`
                ).join('');
            };
            
            return `
                <div style="max-width: 1000px;">
                    <!-- è°æ³¢ç»„çŠ¶æ€æ ï¼ˆåªæ˜¾ç¤ºå½“å‰é€‰æ‹©çš„è°æ³¢ç»„ï¼‰ -->
                    <div id="harmonicGroupsStatusBar" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; border: 1px solid #d9d9d9;">
                        <div id="currentHarmonicGroupDisplay" style="padding: 8px; background: #fff; border-radius: 4px; border: 1px solid #d9d9d9;">
                            <div style="font-size: 12px; color: #8c8c8c; margin-bottom: 4px;">${t('currentHarmonicGroup') || 'å½“å‰é€‰æ‹©çš„è°æ³¢ç»„'}</div>
                            <div id="currentHarmonicGroupValue" style="font-size: 14px; color: #262626;">${t('harmGroupEmpty') || 'æœªé€‰æ‹©'}</div>
                        </div>
                    </div>
                    
                    <!-- è°æ³¢æ¬¡æ•°é€‰æ‹©åŒºåŸŸ -->
                    <div class="harmonic-buttons-container">
                        <div class="harmonic-buttons-column">
                            <div class="harmonic-buttons-column-title">${t('oddHarmonics') || 'å¥‡æ•°è°æ³¢æ¬¡æ•°'}</div>
                            ${generateHarmonicButtons(oddHarmonics)}
                        </div>
                        <div class="harmonic-buttons-column">
                            <div class="harmonic-buttons-column-title">${t('evenHarmonics') || 'å¶æ•°è°æ³¢æ¬¡æ•°'}</div>
                            ${generateHarmonicButtons(evenHarmonics)}
                        </div>
                    </div>
                    
                    <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary" onclick="batchQueryHarmonicGroups()" style="margin-right: 10px;">${t('btnBatchQuery')}</button>
                        <button class="btn btn-success" onclick="batchSaveHarmonicGroups()">${t('btnBatchSave')}</button>
                        </div>
                    </div>
            `;
        }
        
        // è®°å½•å·²é€‰æ‹©çš„æŒ‰é’®ï¼ˆæœ€å¤š8ä¸ªï¼Œæ¯ä¸ªè°æ³¢æ¬¡æ•°åªèƒ½é€‰æ‹©ä¸€æ¬¡ï¼‰
        const selectedHarmonics = new Set();
        // è®°å½•æŸ¥è¯¢åˆ°çš„è°æ³¢ç»„ï¼ˆç”¨äºæ˜¾ç¤ºåœ¨"å½“å‰é€‰æ‹©çš„è°æ³¢ç»„"ä¸­ï¼‰
        let queriedHarmonics = new Set();
        
        // æ›´æ–°è°æ³¢ç»„çŠ¶æ€æ æ˜¾ç¤ºï¼ˆä»…æ›´æ–°8ä¸ªç»„çš„çŠ¶æ€ï¼Œä¸æ›´æ–°"å½“å‰é€‰æ‹©çš„è°æ³¢ç»„"ï¼‰
        function updateHarmonicGroupsStatusBar() {
            // æ­¤å‡½æ•°ç°åœ¨åªç”¨äºä¿æŒå…¼å®¹æ€§ï¼Œå®é™…æ›´æ–°åœ¨updateQueriedHarmonicsDisplayä¸­å®Œæˆ
            // "å½“å‰é€‰æ‹©çš„è°æ³¢ç»„"åªæ˜¾ç¤ºæŸ¥è¯¢åˆ°çš„å€¼ï¼Œä¸æ˜¾ç¤ºç”¨æˆ·ç‚¹å‡»ä½†æœªä¿å­˜çš„é€‰æ‹©
            // è¿™ä¸ªå€¼åœ¨æ‰¹é‡æŸ¥è¯¢æ—¶æ›´æ–°ï¼Œä¸åœ¨ç‚¹å‡»æŒ‰é’®æ—¶æ›´æ–°
        }
        
        // æ›´æ–°"å½“å‰é€‰æ‹©çš„è°æ³¢ç»„"æ˜¾ç¤ºï¼ˆä»…æ˜¾ç¤ºæŸ¥è¯¢åˆ°çš„å€¼ï¼‰
        function updateQueriedHarmonicsDisplay() {
            const currentDisplay = document.getElementById('currentHarmonicGroupValue');
            if (currentDisplay) {
                const queried = Array.from(queriedHarmonics).sort((a, b) => a - b);
                if (queried.length > 0) {
                    currentDisplay.textContent = queried.join(', ');
                    currentDisplay.style.color = '#262626';
                } else {
                    currentDisplay.textContent = t('harmGroupEmpty') || 'æœªé€‰æ‹©';
                    currentDisplay.style.color = '#8c8c8c';
                }
            }
        }
        
        // é€‰æ‹©/å–æ¶ˆé€‰æ‹©è°æ³¢æ¬¡æ•°
        function selectHarmonicForGroup(harmonicNum) {
            const btn = document.getElementById(`harmBtn${harmonicNum}`);
            const isSelected = selectedHarmonics.has(harmonicNum);
            
            if (isSelected) {
                // å·²é€‰æ‹©ï¼Œå–æ¶ˆé€‰æ‹©
                selectedHarmonics.delete(harmonicNum);
                btn.classList.remove('selected');
            } else {
                // æœªé€‰æ‹©ï¼Œæ£€æŸ¥æ˜¯å¦å·²æ»¡8ä¸ª
                if (selectedHarmonics.size >= 8) {
                    alert(t('harmonicGroupMaxButtons') || 'æœ€å¤šåªèƒ½é€‰æ‹©8ä¸ªæŒ‰é’®');
                    return;
                }
                
                // é€‰æ‹©æŒ‰é’®
                selectedHarmonics.add(harmonicNum);
                btn.classList.add('selected');
            }
            
            // æ›´æ–°çŠ¶æ€æ ï¼ˆä»…æ›´æ–°æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨ä¿å­˜ï¼‰
            updateHarmonicGroupsStatusBar();
        }
        
        // è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        let autoSaveTimer = null;
        
        // è‡ªåŠ¨æ‰¹é‡ä¿å­˜è°æ³¢ç»„
        function autoSaveHarmonicGroups() {
            // å»¶è¿Ÿä¿å­˜ï¼Œé¿å…é¢‘ç¹ä¿å­˜
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            autoSaveTimer = setTimeout(() => {
                if (ws && ws.readyState === 1) {
                    batchSaveHarmonicGroups();
                }
            }, 300); // 300mså»¶è¿Ÿï¼Œé¿å…é¢‘ç¹ä¿å­˜
        }
        
        // æ ¹æ®å·²é€‰æ‹©çš„æŒ‰é’®åˆ†é…ç»„ï¼ˆæŒ‰è°æ³¢æ¬¡æ•°ä»å°åˆ°å¤§ï¼‰
        function assignGroupsBySelectedHarmonics() {
            // è·å–å·²é€‰æ‹©çš„è°æ³¢æ¬¡æ•°ï¼ŒæŒ‰æ•°å­—å¤§å°æ’åº
            const harmonics = Array.from(selectedHarmonics)
                .map(num => parseInt(num))
                .sort((a, b) => a - b);
            
            // åˆ†é…åˆ°8ä¸ªç»„ï¼ˆ265-272ï¼‰ï¼Œä¿å­˜çš„æ˜¯è°æ³¢æ¬¡æ•°æœ¬èº«
            const groups = [0, 0, 0, 0, 0, 0, 0, 0];
            harmonics.slice(0, 8).forEach((harmonic, index) => {
                groups[index] = harmonic;
            });
            
            return groups;
        }
        
        // æŸ¥è¯¢å‚æ•°å€¼ï¼ˆè¿”å›Promiseï¼‰
        function queryParamValue(funcCode) {
            return new Promise((resolve, reject) => {
                const serial = parseInt(document.getElementById('deviceSerial').value) || 1;
                const serialHex = parseInt(serial).toString(16).padStart(2, '0').toUpperCase();
                const cmdHex = buildQueryCmd(serial, funcCode);
                
                if (!ws || ws.readyState !== 1) {
                    reject(new Error('è®¾å¤‡æœªè¿æ¥'));
                    return;
                }
                
                const timeout = setTimeout(() => {
                    ws.removeEventListener('message', handler);
                    reject(new Error('æŸ¥è¯¢è¶…æ—¶'));
                }, 5000);
                
                const handler = (e) => {
                    try {
                        const buffer = e.data instanceof Blob ? e.data : e.data;
                        const bytes = new Uint8Array(buffer instanceof ArrayBuffer ? buffer : buffer);
                        
                        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯å¤–å±‚åè®®æ ¼å¼
                        if (bytes.length >= 8 && bytes[0] === 0xAA && bytes[bytes.length - 1] === 0x55) {
                            const outerResult = parseOuterProtocol(bytes);
                            if (outerResult && outerResult.success) {
                                // æå–å†…å±‚æ•°æ®
                                const innerData = outerResult.data;
                                // æ£€æŸ¥å†…å±‚æ•°æ®æ˜¯å¦æ˜¯å‚æ•°æŸ¥è¯¢å“åº”
                                if (innerData.length >= 8 && innerData[0] === 0xAA && innerData[1] === parseInt(serialHex, 16)) {
                                    const respFuncCode = (innerData[3] << 8) | innerData[4];
                                    if (respFuncCode === funcCode) {
                                        const value = (innerData[5] << 8) | innerData[6];
                                        ws.removeEventListener('message', handler);
                                        clearTimeout(timeout);
                                        resolve(value);
                                    }
                                }
                            }
                        }
                        // å…¼å®¹æ—§æ ¼å¼ï¼ˆæ— å¤–å±‚åè®®ï¼‰
                        else if (bytes.length >= 8 && bytes[0] === 0xAA && bytes[1] === parseInt(serialHex, 16)) {
                            const respFuncCode = (bytes[3] << 8) | bytes[4];
                            if (respFuncCode === funcCode) {
                                const value = (bytes[5] << 8) | bytes[6];
                                ws.removeEventListener('message', handler);
                                clearTimeout(timeout);
                                resolve(value);
                            }
                        }
                    } catch (err) {
                        // ç»§ç»­ç­‰å¾…
                    }
                };
                
                ws.addEventListener('message', handler);
                // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
                sendWithOuterProtocol(cmdHex, '02');
            });
        }
        
        // è§£æè°æ³¢å€¼ï¼ˆä»è®¾å¤‡è¿”å›çš„å€¼è½¬æ¢ä¸ºè°æ³¢æ¬¡æ•°æ•°ç»„ï¼‰
        function parseHarmonicValue(value) {
            if (!value && value !== 0) return [];
            
            // å¦‚æœæ˜¯æ•°å­—ï¼Œå¯èƒ½æ˜¯ä½æ©ç 
            if (typeof value === 'number') {
                const harmonics = [];
                for (let i = 1; i <= 50; i++) {
                    if ((value & (1 << (i - 1))) !== 0) {
                        harmonics.push(i);
                    }
                }
                return harmonics;
            }
            
            // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå¯èƒ½æ˜¯é€—å·åˆ†éš”çš„åˆ—è¡¨
            if (typeof value === 'string') {
                return value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 50);
            }
            
            return [];
        }
        
        // å°†è°æ³¢æ¬¡æ•°æ•°ç»„è½¬æ¢ä¸ºå€¼ï¼ˆä½æ©ç ï¼‰
        function convertHarmonicsToValue(harmonics) {
            let value = 0;
            harmonics.forEach(num => {
                if (num >= 1 && num <= 50) {
                    value |= (1 << (num - 1));
                }
            });
            return value;
        }
        
        // æ‰¹é‡æŸ¥è¯¢è°æ³¢ç»„
        function batchQueryHarmonicGroups() {
            if (!isUsingServerMode && !window.isUsingServerMode && (!ws || ws.readyState !== 1)) {
                alert(t('alertNotConnectedSimple') || 'è®¾å¤‡æœªè¿æ¥');
                return;
            }
            
            const funcCodes = [265, 266, 267, 268, 269, 270, 271, 272];
            addLog('info', `ğŸ“¤ æ‰¹é‡æŸ¥è¯¢è°æ³¢ç»„ï¼ˆåŠŸèƒ½ç 265-272ï¼‰...`);
            
            batchQuery(funcCodes, (results) => {
                if (!results || results.length === 0) {
                    addLog('warn', 'æ‰¹é‡æŸ¥è¯¢è°æ³¢ç»„ï¼šæœªæ”¶åˆ°æŸ¥è¯¢ç»“æœ');
                    return;
                }
                
                addLog('info', `ğŸ“¥ æ”¶åˆ°${results.length}ä¸ªè°æ³¢ç»„æŸ¥è¯¢ç»“æœ`);
                
                // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
                selectedHarmonics.clear();
                
                // æ¸…é™¤æ‰€æœ‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                for (let i = 1; i <= 50; i++) {
                    const btn = document.getElementById(`harmBtn${i}`);
                    if (btn) {
                        btn.classList.remove('selected');
                    }
                }
                
                // æŸ¥è¯¢ç»“æœä¸­çš„å€¼å°±æ˜¯è°æ³¢æ¬¡æ•°
                let selectedCount = 0;
                const funcCodeToValueMap = new Map(); // è®°å½•åŠŸèƒ½ç åˆ°å€¼çš„æ˜ å°„
                
                results.forEach((result, index) => {
                    const funcCode = result.funcCode;
                    const value = result.value;
                    
                    // è®°å½•åŠŸèƒ½ç åˆ°å€¼çš„æ˜ å°„ï¼ˆç”¨äºæ›´æ–°çŠ¶æ€æ ï¼‰
                    funcCodeToValueMap.set(funcCode, value);
                    
                    // å€¼å¿…é¡»å¤§äº1ä¸”å°äºç­‰äº50æ‰æ˜¯æœ‰æ•ˆçš„è°æ³¢æ¬¡æ•°ï¼ˆæ’é™¤1æ¬¡è°æ³¢ï¼‰
                    if (value !== undefined && value > 1 && value <= 50) {
                        // é€‰æ‹©å¯¹åº”çš„æŒ‰é’®
                        selectedHarmonics.add(value);
                        const btn = document.getElementById(`harmBtn${value}`);
                        if (btn) {
                            btn.classList.add('selected');
                            selectedCount++;
                            addLog('info', `âœ… ç‚¹äº®è°æ³¢æ¬¡æ•°æŒ‰é’®ï¼š${value} (åŠŸèƒ½ç ${funcCode})`);
                        } else {
                            addLog('warn', `âš ï¸ æœªæ‰¾åˆ°è°æ³¢æ¬¡æ•°${value}å¯¹åº”çš„æŒ‰é’®`);
                        }
                    } else if (value === 0) {
                        // 0å€¼è¡¨ç¤ºè¯¥ç»„æœªè®¾ç½®ï¼Œå¿½ç•¥
                        addLog('info', `   åŠŸèƒ½ç ${funcCode} = 0 (æœªè®¾ç½®)`);
                    } else if (value === 1) {
                        // 1æ¬¡è°æ³¢è¢«æ’é™¤ï¼Œè®°å½•ä½†ä¸æ˜¾ç¤º
                        addLog('info', `   åŠŸèƒ½ç ${funcCode} = 1 (1æ¬¡è°æ³¢å·²æ’é™¤ï¼Œä¸æ˜¾ç¤º)`);
                    } else {
                        addLog('warn', `âš ï¸ åŠŸèƒ½ç ${funcCode}çš„å€¼æ— æ•ˆï¼š${value} (åº”åœ¨2-50èŒƒå›´å†…)`);
                    }
                });
                
                // æ›´æ–°"å½“å‰é€‰æ‹©çš„è°æ³¢ç»„"æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºæŸ¥è¯¢åˆ°çš„æ‰€æœ‰è°æ³¢æ¬¡æ•°ï¼‰
                const currentDisplay = document.getElementById('currentHarmonicGroupValue');
                if (currentDisplay) {
                    const queriedHarmonics = Array.from(selectedHarmonics).sort((a, b) => a - b);
                    if (queriedHarmonics.length > 0) {
                        currentDisplay.textContent = queriedHarmonics.join(', ');
                        currentDisplay.style.color = '#262626';
                    } else {
                        currentDisplay.textContent = t('harmGroupEmpty') || 'æœªé€‰æ‹©';
                        currentDisplay.style.color = '#8c8c8c';
                    }
                }
                
                addLog('info', `âœ… æ‰¹é‡æŸ¥è¯¢è°æ³¢ç»„å®Œæˆï¼Œå…±ç‚¹äº®${selectedCount}ä¸ªæŒ‰é’®`);
            });
        }
        
        // æ‰¹é‡ä¿å­˜è°æ³¢ç»„
        function batchSaveHarmonicGroups() {
            if (!isUsingServerMode && !window.isUsingServerMode && (!ws || ws.readyState !== 1)) {
                alert(t('alertNotConnectedSimple') || 'è®¾å¤‡æœªè¿æ¥');
                return;
            }
            
            // æ ¹æ®å·²é€‰æ‹©çš„æŒ‰é’®åˆ†é…ç»„ï¼ˆæŒ‰è°æ³¢æ¬¡æ•°ä»å°åˆ°å¤§ï¼‰
            const groups = assignGroupsBySelectedHarmonics();
            
            const funcCodes = [265, 266, 267, 268, 269, 270, 271, 272];
            const values = groups; // å·²ç»æ˜¯8ä¸ªå€¼ï¼Œä¸è¶³çš„ä¸º0
            
            addLog('info', `ğŸ’¾ å¼€å§‹æ‰¹é‡ä¿å­˜è°æ³¢ç»„...`);
            addLog('info', `   å·²é€‰æ‹©çš„è°æ³¢æ¬¡æ•°ï¼š${Array.from(selectedHarmonics).sort((a, b) => a - b).join(', ')}`);
            addLog('info', `   åˆ†é…çš„å€¼ï¼š${values.map((v, i) => `åŠŸèƒ½ç ${funcCodes[i]}=${v}`).join(', ')}`);
            
            batchSave(funcCodes, values);
            
            // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤ºä¿å­˜çš„å€¼
            setTimeout(() => {
                updateHarmonicGroupsStatusBar();
            }, 100);
        }
        
        // æ›´æ–°è¿æ¥é…ç½®æ˜¾ç¤º
        function updateConnectConfig() {
            const mode = document.getElementById('connectMode').value;
            const bridgeGroup = document.getElementById('bridgeIpGroup');
            const deviceGroup = document.getElementById('deviceIpGroup');
            
            if (mode === 'bridge') {
                bridgeGroup.style.display = 'block';
                deviceGroup.style.display = 'none';
            } else {
                bridgeGroup.style.display = 'none';
                deviceGroup.style.display = 'block';
            }
            
            // è‡ªåŠ¨ä¿å­˜é…ç½®
            saveConfigToLocal();
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logBox').innerHTML = '';
            addLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // è¿æ¥è®¾å¤‡
        function connectDevice() {
            // å¦‚æœå·²ç»åœ¨ä½¿ç”¨æœåŠ¡å™¨æ¨¡å¼ï¼Œä¸å†å°è¯•WebSocket
            if (isUsingServerMode) {
                addLog('info', 'âœ… å·²ä½¿ç”¨æœåŠ¡å™¨æ¨¡å¼ï¼Œæ— éœ€é‡æ–°è¿æ¥');
                return;
            }
            
            const mode = document.getElementById('connectMode').value;
            let wsUrl = '';
            
            if (mode === 'bridge') {
                // é€šè¿‡æ¡¥æ¥æœåŠ¡è¿æ¥
                const bridgeAddr = document.getElementById('bridgeIp').value;
                if (!bridgeAddr) {
                    alert('è¯·å¡«å†™æ¡¥æ¥æœåŠ¡åœ°å€');
                    return;
                }
                wsUrl = `ws://${bridgeAddr}`;
                addLog('info', `æ­£åœ¨é€šè¿‡æ¡¥æ¥æœåŠ¡è¿æ¥: ${wsUrl}`);
            } else {
                // ç›´è¿è®¾å¤‡WebSocket
                const deviceAddr = document.getElementById('deviceIp').value;
                if (!deviceAddr) {
                    alert('è¯·å¡«å†™è®¾å¤‡åœ°å€');
                    return;
                }
                wsUrl = `ws://${deviceAddr}`;
                addLog('info', `æ­£åœ¨ç›´è¿è®¾å¤‡: ${wsUrl}`);
            }
            
            // è®°å½•è¿æ¥å¼€å§‹æ—¶é—´
            if (!connectionStartTime) {
                connectionStartTime = Date.now();
                connectionFailCount = 0;
                
                // å¯åŠ¨æ•…éšœè½¬ç§»å®šæ—¶å™¨ï¼š1åˆ†é’Ÿåå¦‚æœè¿˜æ²¡è¿ä¸Šï¼Œåˆ‡æ¢åˆ°æœåŠ¡å™¨æ¨¡å¼
                failoverTimer = setTimeout(() => {
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        addLog('warn', 'âš ï¸ WebSocketè¿æ¥1åˆ†é’Ÿå†…æœªæˆåŠŸ');
                        addLog('info', 'ğŸ”„ è‡ªåŠ¨åˆ‡æ¢åˆ°æœåŠ¡å™¨è½®è¯¢æ¨¡å¼...');
                        switchToServerMode();
                    }
                }, FAILOVER_TIMEOUT);
            }
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    addLog('info', 'âœ… è®¾å¤‡å·²è¿æ¥');
                    updateStatus(true);
                    
                    // è¿æ¥æˆåŠŸï¼Œæ¸…é™¤æ•…éšœè½¬ç§»å®šæ—¶å™¨
                    if (failoverTimer) {
                        clearTimeout(failoverTimer);
                        failoverTimer = null;
                    }
                    connectionStartTime = null;
                    connectionFailCount = 0;
                    
                    // ç«‹å³æŸ¥è¯¢ä¸€æ¬¡
                    queryDevice();
                    
                    // å¯åŠ¨è‡ªåŠ¨æŸ¥è¯¢ï¼ˆæ¯3ç§’ï¼‰
                    queryTimer = setInterval(queryDevice, 3000);
                };
                
                ws.onmessage = (event) => {
                    if (event.data instanceof Blob) {
                        event.data.arrayBuffer().then(buffer => {
                            const bytes = new Uint8Array(buffer);
                            const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ').toUpperCase();
                            
                            addLog('debug', `ğŸ“¥ æ”¶åˆ°åŸå§‹æ•°æ® ${buffer.byteLength} å­—èŠ‚: ${hex.substring(0, 50)}${hex.length > 50 ? '...' : ''}`);
                            
                            // å°†æ•°æ®æ·»åŠ åˆ°æ¥æ”¶ç¼“å†²åŒº
                            appendToBuffer(bytes);
                            
                            // ä»ç¼“å†²åŒºæå–å®Œæ•´çš„æ•°æ®åŒ…ï¼ˆå¤–å±‚åè®®æ ¼å¼ï¼‰
                            const packets = extractPacketsFromBuffer();
                            
                            // å¤„ç†æ¯ä¸ªå®Œæ•´çš„æ•°æ®åŒ…
                            let processedOuterProtocol = false;
                            for (const packet of packets) {
                                try {
                            // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯å¤–å±‚åè®®æ ¼å¼ï¼ˆAAå¼€å¤´ï¼Œ55ç»“å°¾ï¼‰
                                    if (packet.length >= 8 && packet[0] === 0xAA && packet[packet.length - 1] === 0x55) {
                                        const outerResult = parseOuterProtocol(packet);
                                if (outerResult && outerResult.success) {
                                            processedOuterProtocol = true;
                                            addLog('info', `âœ… å¤–å±‚åè®®è§£ææˆåŠŸï¼šå‘½ä»¤=0x${outerResult.cmd.toString(16).padStart(2, '0')}, åºåˆ—å·=${outerResult.tk}, æ•°æ®é•¿åº¦=${outerResult.data.length}, CRC=${outerResult.crcValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}, é•¿åº¦è§£é‡Š=${outerResult.lengthInterpretation}`);
                                    
                                    // æå–å†…å±‚æ•°æ®ï¼Œä¼ é€’ç»™ç°æœ‰è§£æé€»è¾‘
                                    const innerData = outerResult.data;
                                    
                                    // æ£€æŸ¥å†…å±‚æ•°æ®æ˜¯å¦æ˜¯CKæ¨¡å¼ï¼ˆ55å¼€å¤´ï¼Œç¬¬4å­—èŠ‚æ˜¯43 4Bï¼‰
                                    if (innerData.length >= 123 && innerData[0] === 0x55 && innerData[3] === 0x43 && innerData[4] === 0x4B) {
                                        // å°†å†…å±‚æ•°æ®ä¼ é€’ç»™parseAndDisplay
                                        parseAndDisplay(innerData.buffer);
                                    }
                                    // æ£€æŸ¥å†…å±‚æ•°æ®æ˜¯å¦æ˜¯ACKç¡®è®¤
                                    else if (innerData.length >= 8 && innerData[0] === 0x55 && innerData[1] === 0x01 && innerData[2] === 0x05 && 
                                        innerData[3] === 0x41 && innerData[4] === 0x43 && innerData[5] === 0x4B) {
                                        addLog('info', 'âœ… æ”¶åˆ°è®¾å¤‡ACKç¡®è®¤å“åº”ï¼ˆå¤–å±‚åè®®å°è£…ï¼‰');
                                    }
                                    // æ£€æŸ¥å†…å±‚æ•°æ®æ˜¯å¦æ˜¯æ‰¹é‡æŸ¥è¯¢å“åº”
                                    else if (innerData.length >= 6 && innerData[0] === 0x55 && innerData[1] === 0x01 && innerData[3] === 0x52) {
                                        addLog('info', `ğŸ“¥ æ£€æµ‹åˆ°æ‰¹é‡æŸ¥è¯¢å“åº”ï¼ˆå¤–å±‚åè®®å°è£…ï¼‰ï¼Œé•¿åº¦: ${innerData.length}`);
                                        if (pendingBatchQuery) {
                                            addLog('info', `ğŸ“¥ å¤„ç†æ‰¹é‡æŸ¥è¯¢å“åº”ï¼Œèµ·å§‹åŠŸèƒ½ç : ${pendingBatchQuery.startFuncCode}, æ•°é‡: ${pendingBatchQuery.count}`);
                                            const results = parseBatchQueryResponse(innerData, pendingBatchQuery.startFuncCode, pendingBatchQuery.count);
                                            if (results && results.length > 0) {
                                                addLog('info', `âœ… æ‰¹é‡æŸ¥è¯¢è§£ææˆåŠŸï¼Œæ”¶åˆ°${results.length}ä¸ªç»“æœ`);
                                                if (pendingBatchQuery.callback) {
                                                    pendingBatchQuery.callback(results);
                                                }
                                            } else {
                                                addLog('warn', 'æ‰¹é‡æŸ¥è¯¢å“åº”è§£æå¤±è´¥æˆ–ç»“æœä¸ºç©º');
                                            }
                                            pendingBatchQuery = null;
                                        }
                                    }
                                    // æ£€æŸ¥å†…å±‚æ•°æ®æ˜¯å¦æ˜¯å‚æ•°æŸ¥è¯¢å“åº”ï¼ˆæ ¼å¼ï¼š55 01 07 50 [addr_hi] [addr_lo] [val_hi] [val_lo] [CRC]ï¼‰
                                    else if (innerData.length >= 9 && innerData[0] === 0x55 && innerData[1] === 0x01 && innerData[2] === 0x07 && innerData[3] === 0x50) {
                                        parseQueryResponse(innerData);
                                    }
                                    // æ£€æŸ¥å†…å±‚æ•°æ®æ˜¯å¦æ˜¯å•å‚æ•°æŸ¥è¯¢å“åº”ï¼ˆæ ¼å¼ï¼šAA [åºåˆ—å·] 05 50 [addr_hi] [addr_lo] [val_hi] [val_lo] [CRC]ï¼‰
                                    else if (innerData.length >= 8 && innerData[0] === 0xAA && innerData[2] === 0x05 && innerData[3] === 0x50) {
                                        // æå–åœ°å€å’Œå€¼
                                        const addr = (innerData[4] << 8) | innerData[5];
                                        const val = (innerData[6] << 8) | innerData[7];
                                        addLog('info', `âœ… å•å‚æ•°æŸ¥è¯¢å“åº”ï¼ˆå¤–å±‚åè®®å°è£…ï¼‰ï¼šåœ°å€=${addr}, å€¼=${val}`);
                                        // æŸ¥æ‰¾å¯¹åº”çš„ç­‰å¾…æŸ¥è¯¢
                                        const query = pendingQueries[addr];
                                        if (query) {
                                            if (query.callback) {
                                                query.callback(val);
                                            } else {
                                                const element = document.getElementById(query.fieldId);
                                                if (element) {
                                                    // ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°å°†æ•°å€¼è½¬æ¢ä¸ºå¯¹åº”çš„æ–‡å­—æ˜¾ç¤º
                                                    element.value = formatParamValueForDisplay(addr, val, query.fieldId);
                                                }
                                            }
                                            delete pendingQueries[addr];
                                        }
                                    }
                                    // æ£€æŸ¥å†…å±‚æ•°æ®æ˜¯å¦æ˜¯æ‰¹é‡ä¿å­˜å“åº”ï¼ˆACKæ ¼å¼ï¼‰
                                    else if (innerData.length >= 8 && innerData[0] === 0x55 && innerData[1] === 0x01 && innerData[2] === 0x05 && 
                                        innerData[3] === 0x41 && innerData[4] === 0x43 && innerData[5] === 0x4B) {
                                        addLog('info', 'âœ… æ”¶åˆ°æ‰¹é‡ä¿å­˜ACKç¡®è®¤å“åº”ï¼ˆå¤–å±‚åè®®å°è£…ï¼‰');
                                        if (pendingBatchSave) {
                                            if (pendingBatchSave.callback) {
                                                pendingBatchSave.callback(true);
                                            }
                                            pendingBatchSave = null;
                                        }
                                    }
                                    else {
                                        addLog('warn', `å¤–å±‚åè®®å†…å±‚æ•°æ®æ ¼å¼æœªçŸ¥ï¼Œé•¿åº¦: ${innerData.length}, å‰10å­—èŠ‚: ${Array.from(innerData.slice(0, 10)).map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                                    }
                                        } else if (outerResult && !outerResult.success) {
                                            addLog('warn', `å¤–å±‚åè®®è§£æå¤±è´¥ï¼š${outerResult.error || 'æœªçŸ¥é”™è¯¯'}`);
                                        }
                                    }
                                } catch (error) {
                                    addLog('error', `å¤„ç†æ•°æ®åŒ…æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š${error.message}`);
                                    addLog('error', `æ•°æ®åŒ…ï¼ˆå‰20å­—èŠ‚ï¼‰ï¼š${Array.from(packet.slice(0, Math.min(20, packet.length))).map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                                }
                            }
                            
                            // å¦‚æœæ²¡æœ‰å¤„ç†å¤–å±‚åè®®æ•°æ®åŒ…ï¼Œå°è¯•å¤„ç†æ— å¤–å±‚åè®®çš„æ—§æ ¼å¼
                            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨åŸå§‹æ¥æ”¶åˆ°çš„bytesï¼Œå› ä¸ºæ—§æ ¼å¼å¯èƒ½ä¸æ˜¯AAå¼€å¤´
                            if (!processedOuterProtocol) {
                                try {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ACKç¡®è®¤å“åº”ï¼š55 01 05 41 43 4B [CRC]
                            if (bytes.length >= 8 && bytes[0] === 0x55 && bytes[1] === 0x01 && bytes[2] === 0x05 && 
                                bytes[3] === 0x41 && bytes[4] === 0x43 && bytes[5] === 0x4B) {
                                // ACKç¡®è®¤ï¼ˆ0x41=A, 0x43=C, 0x4B=Kï¼‰
                                addLog('info', 'âœ… æ”¶åˆ°è®¾å¤‡ACKç¡®è®¤å“åº”ï¼ˆæ— å¤–å±‚åè®®ï¼‰');
                            }
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰¹é‡æŸ¥è¯¢å“åº”ï¼š55 01 xx 52 [æ•°æ®...] [CRC]
                            else if (bytes.length >= 6 && bytes[0] === 0x55 && bytes[1] === 0x01 && bytes[3] === 0x52) {
                                addLog('info', `ğŸ“¥ æ£€æµ‹åˆ°æ‰¹é‡æŸ¥è¯¢å“åº”ï¼ˆæ— å¤–å±‚åè®®ï¼‰ï¼Œé•¿åº¦: ${bytes.length}, ç¬¬3å­—èŠ‚: 0x${bytes[3].toString(16).padStart(2, '0')}`);
                                if (pendingBatchQuery) {
                                    addLog('info', `ğŸ“¥ å¤„ç†æ‰¹é‡æŸ¥è¯¢å“åº”ï¼Œèµ·å§‹åŠŸèƒ½ç : ${pendingBatchQuery.startFuncCode}, æ•°é‡: ${pendingBatchQuery.count}`);
                                    const results = parseBatchQueryResponse(bytes, pendingBatchQuery.startFuncCode, pendingBatchQuery.count);
                                    if (results && results.length > 0) {
                                        addLog('info', `âœ… æ‰¹é‡æŸ¥è¯¢è§£ææˆåŠŸï¼Œæ”¶åˆ°${results.length}ä¸ªç»“æœ`);
                                        if (pendingBatchQuery.callback) {
                                        pendingBatchQuery.callback(results);
                                        }
                                    } else {
                                        addLog('warn', 'æ‰¹é‡æŸ¥è¯¢å“åº”è§£æå¤±è´¥æˆ–ç»“æœä¸ºç©º');
                                    }
                                    pendingBatchQuery = null;
                                } else {
                                    addLog('warn', 'æ”¶åˆ°æ‰¹é‡æŸ¥è¯¢å“åº”ï¼Œä½†æ²¡æœ‰ç­‰å¾…çš„æ‰¹é‡æŸ¥è¯¢');
                                }
                            }
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å‚æ•°æŸ¥è¯¢å“åº”ï¼š55 01 07 50 [addr_hi] [addr_lo] [val_hi] [val_lo] [CRC]
                            // bytes[4]æ˜¯åœ°å€é«˜å­—èŠ‚ï¼Œä¸åŒåŠŸèƒ½ç å€¼ä¸åŒï¼Œæ‰€ä»¥ä¸èƒ½é™åˆ¶ä¸º0x02
                            else if (bytes.length >= 9 && bytes[0] === 0x55 && bytes[1] === 0x01 && bytes[2] === 0x07 && bytes[3] === 0x50) {
                                addLog('info', 'ğŸ“¥ æ£€æµ‹åˆ°å‚æ•°æŸ¥è¯¢å“åº”ï¼ˆæ— å¤–å±‚åè®®ï¼‰');
                                parseQueryResponse(bytes);
                            }
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å•å‚æ•°æŸ¥è¯¢å“åº”ï¼ˆæ ¼å¼ï¼šAA [åºåˆ—å·] 05 50 [addr_hi] [addr_lo] [val_hi] [val_lo] [CRC]ï¼‰
                            else if (bytes.length >= 8 && bytes[0] === 0xAA && bytes[2] === 0x05 && bytes[3] === 0x50) {
                                addLog('info', 'ğŸ“¥ æ£€æµ‹åˆ°å•å‚æ•°æŸ¥è¯¢å“åº”ï¼ˆæ— å¤–å±‚åè®®ï¼‰');
                                const addr = (bytes[4] << 8) | bytes[5];
                                const val = (bytes[6] << 8) | bytes[7];
                                const query = pendingQueries[addr];
                                if (query) {
                                    if (query.callback) {
                                        query.callback(val);
                                    } else {
                                        const element = document.getElementById(query.fieldId);
                                        if (element) {
                                            // ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°å°†æ•°å€¼è½¬æ¢ä¸ºå¯¹åº”çš„æ–‡å­—æ˜¾ç¤º
                                            element.value = formatParamValueForDisplay(addr, val, query.fieldId);
                                        }
                                    }
                                    delete pendingQueries[addr];
                                }
                            }
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ç›‘æ§æ•°æ®
                            else if (bytes.length >= 123 && bytes[0] === 0x55 && bytes[3] === 0x43 && bytes[4] === 0x4B) {
                                addLog('info', 'ğŸ“¥ æ£€æµ‹åˆ°CKæ¨¡å¼æ•°æ®åŒ…ï¼ˆæ— å¤–å±‚åè®®ï¼‰');
                                parseAndDisplay(buffer);
                            }
                            else {
                                        addLog('debug', `æœªè¯†åˆ«çš„æ•°æ®æ ¼å¼ï¼Œé•¿åº¦: ${bytes.length}, å‰10å­—èŠ‚: ${Array.from(bytes.slice(0, Math.min(10, bytes.length))).map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                                    }
                                } catch (error) {
                                    addLog('error', `å¤„ç†æ— å¤–å±‚åè®®æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š${error.message}`);
                                }
                            }
                        });
                    }
                };
                
                ws.onerror = (error) => {
                    connectionFailCount++;
                    addLog('error', `âŒ è¿æ¥é”™è¯¯ (å°è¯• ${connectionFailCount} æ¬¡)`);
                    addLog('error', `âŒ é”™è¯¯è¯¦æƒ…: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                    updateStatus(false);
                };
                
                ws.onclose = (event) => {
                    let closeMessage = `ğŸ”Œ è¿æ¥å·²å…³é—­ (ä»£ç : ${event.code}`;
                    if (event.reason) {
                        closeMessage += `, åŸå› : ${event.reason}`;
                    }
                    closeMessage += ')';
                    addLog('warn', closeMessage);
                    
                    // æ ¹æ®å…³é—­ä»£ç æä¾›è¯¦ç»†çš„é”™è¯¯è¯´æ˜
                    if (event.code === 1006) {
                        addLog('error', 'âŒ è¿æ¥å¼‚å¸¸å…³é—­ (1006) - å¯èƒ½çš„åŸå› ï¼š');
                        addLog('error', '   1. æ¡¥æ¥æœåŠ¡æ— æ³•è¿æ¥åˆ°ç›®æ ‡è®¾å¤‡');
                        addLog('error', '   2. ç›®æ ‡è®¾å¤‡æœªè¿è¡Œæˆ–ç½‘ç»œä¸å¯è¾¾');
                        addLog('error', '   3. è¯·æ£€æŸ¥è®¾å¤‡åœ°å€é…ç½®å’Œç½‘ç»œè¿æ¥');
                        const mode = document.getElementById('connectMode').value;
                        if (mode === 'bridge') {
                            const bridgeAddr = document.getElementById('bridgeIp').value;
                            addLog('info', `   å½“å‰æ¡¥æ¥åœ°å€: ${bridgeAddr}`);
                            addLog('info', '   è¯·ç¡®è®¤æ¡¥æ¥æœåŠ¡å·²å¯åŠ¨ä¸”èƒ½è¿æ¥åˆ°ç›®æ ‡è®¾å¤‡');
                        }
                    } else if (event.code === 1001) {
                        addLog('warn', 'âš ï¸ æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿æ¥ (1001)');
                    } else if (event.code === 1000) {
                        addLog('info', 'âœ… æ­£å¸¸å…³é—­è¿æ¥ (1000)');
                    }
                    
                    updateStatus(false);
                    if (queryTimer) {
                        clearInterval(queryTimer);
                        queryTimer = null;
                    }
                    
                    // æ¸…ç†æ¥æ”¶ç¼“å†²åŒº
                    clearReceiveBuffer();
                    
                    // å¦‚æœä¸æ˜¯ä¸»åŠ¨å…³é—­ï¼Œå°è¯•è‡ªåŠ¨é‡è¿
                    if (event.code !== 1000 && !isUsingServerMode) {
                        addLog('info', 'ğŸ”„ 5ç§’åå°è¯•è‡ªåŠ¨é‡è¿...');
                        setTimeout(() => {
                            if (!ws || ws.readyState === 3) { // 3 = CLOSED
                                connectDevice();
                            }
                        }, 5000);
                    }
                };
                
            } catch (error) {
                connectionFailCount++;
                addLog('error', `è¿æ¥å¤±è´¥ (å°è¯• ${connectionFailCount} æ¬¡): ` + error.message);
            }
        }
        
        // åˆ‡æ¢åˆ°æœåŠ¡å™¨è½®è¯¢æ¨¡å¼
        function switchToServerMode() {
            isUsingServerMode = true;
            
            // å…³é—­WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }
            if (queryTimer) {
                clearInterval(queryTimer);
                queryTimer = null;
            }
            if (failoverTimer) {
                clearTimeout(failoverTimer);
                failoverTimer = null;
            }
            
            addLog('info', 'ğŸŒ å·²åˆ‡æ¢åˆ°æœåŠ¡å™¨æ¨¡å¼ï¼ˆé€šè¿‡HTTP APIè½®è¯¢ï¼‰');
            addLog('info', 'ğŸ“¡ æ¯3ç§’ä»æœåŠ¡å™¨è·å–è®¾å¤‡æ•°æ®');
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusDot = document.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');
            const btnConnect = document.getElementById('btnConnect');
            
            if (statusDot && statusText && btnConnect) {
                statusDot.classList.add('connected');
                statusDot.style.backgroundColor = '#1890ff';  // è“è‰²è¡¨ç¤ºæœåŠ¡å™¨æ¨¡å¼
                statusText.textContent = 'æœåŠ¡å™¨æ¨¡å¼';
                statusText.style.color = '#1890ff';
                btnConnect.textContent = 'åœæ­¢';
                btnConnect.className = 'btn btn-warning';
                btnConnect.onclick = stopServerMode;
            }
            
            // ç«‹å³æŸ¥è¯¢ä¸€æ¬¡
            queryDeviceFromServer();
            
            // å¯åŠ¨æœåŠ¡å™¨è½®è¯¢ï¼ˆæ¯3ç§’ï¼‰
            serverPollingTimer = setInterval(queryDeviceFromServer, 3000);
            
            // âœ¨ ä¿®å¤ï¼šæœåŠ¡å™¨æ¨¡å¼ä¸‹æ›´æ–° UI æ˜¾ç¤ºä¸ºâ€œå·²è¿æ¥â€
            updateStatus(true);
            
            // âœ¨ æ–°å¢ï¼šæœåŠ¡å™¨æ¨¡å¼ä¸‹è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡å…³é”®å‚æ•° (åœ°å€513)ï¼Œè§£å†³ä»ªè¡¨ç›˜æ˜¾ç¤ºé—®é¢˜
            setTimeout(() => {
                if (isUsingServerMode) {
                    addLog('debug', 'æ­£åœ¨è‡ªåŠ¨åŒæ­¥è¡¥å¿æ¨¡å¼ (513) ä»¥æ›´æ–°ä»ªè¡¨ç›˜æ˜¾ç¤º...');
                    queryParam(513, 'comp_mode');
                }
            }, 2000);
        }
        
        // ä»æœåŠ¡å™¨æŸ¥è¯¢è®¾å¤‡æ•°æ®
        function queryDeviceFromServer() {
            const urlParams = new URLSearchParams(window.location.search);
            const devId = urlParams.get('id');
            const deviceSerial = document.getElementById('deviceSerial').value || '1';
            
            // é€šè¿‡HTTP APIæŸ¥è¯¢è®¾å¤‡æ•°æ®
            fetch(`/admin/dash`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0 && data.result && data.result.info) {
                        // æŸ¥æ‰¾åŒ¹é…çš„è®¾å¤‡ï¼Œä¼˜å…ˆä½¿ç”¨ ID åŒ¹é…ï¼Œå…¶æ¬¡ä½¿ç”¨åºåˆ—å·
                        let deviceInfo = null;
                        if (devId) {
                            deviceInfo = data.result.info.find(d => String(d.id) === String(devId));
                        }
                        if (!deviceInfo) {
                            deviceInfo = data.result.info.find(d => d.serial === deviceSerial);
                        }
                        
                        if (deviceInfo && deviceInfo.data && deviceInfo.data.length > 0) {
                            // è½¬æ¢è®¾å¤‡æ•°æ®æ ¼å¼ä¸º f01-f60 æ ¼å¼
                            const deviceData = convertServerDataToDeviceFormat(deviceInfo);
                            
                            // è®°å½•æœåŠ¡å™¨è¿”å›çš„å‘Šè­¦çŠ¶æ€
                            deviceData._serverWarn = deviceInfo.warn;
                            
                            // æ˜¾ç¤ºæ•°æ®
                            displayParams(deviceData);
                            
                            // æ›´æ–°æŒ‰é’®çŠ¶æ€åŠæ¨ªå¹…çŠ¶æ€
                            updateButtonStates();
                            
                            // æ›´æ–°æ—¶é—´
                            document.getElementById('updateTime').textContent = deviceInfo.time || new Date().toLocaleTimeString();
                            
                            addLog('info', `ğŸ“¥ ä»æœåŠ¡å™¨è·å–æ•°æ®æˆåŠŸ (${deviceInfo.data.length}ä¸ªå‚æ•°)`);
                        } else {
                            addLog('warn', 'âš ï¸ æœåŠ¡å™¨æš‚æ— è®¾å¤‡æ•°æ®');
                        }
                    }
                })
                .catch(error => {
                    addLog('error', `æœåŠ¡å™¨æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                });
        }
        
        // è½¬æ¢æœåŠ¡å™¨æ•°æ®æ ¼å¼ä¸ºè®¾å¤‡æ•°æ®æ ¼å¼
        function convertServerDataToDeviceFormat(deviceInfo) {
            const deviceData = {};
            
            if (deviceInfo.data && Array.isArray(deviceInfo.data)) {
                deviceInfo.data.forEach((item, index) => {
                    // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ keyï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®ç´¢å¼•ç”Ÿæˆ
                    const key = item.key || `f${String(index + 1).padStart(2, '0')}`;
                    
                    // å¤„ç† null å€¼ï¼Œç¡®ä¿ä¸è¢«è½¬æ¢ä¸º 0
                    if (item.v === null || item.v === undefined) {
                        deviceData[key] = undefined;
                    } else {
                        deviceData[key] = parseFloat(item.v);
                        if (isNaN(deviceData[key])) {
                            deviceData[key] = item.v;
                        }
                    }
                });
            }
            
            // æ·»åŠ è®¾å¤‡é™åˆ¶ä¿¡æ¯
            if (deviceInfo.limit) {
                deviceLimit = deviceInfo.limit;
            }
            
            return deviceData;
        }
        
        // åœæ­¢æœåŠ¡å™¨æ¨¡å¼
        function stopServerMode() {
            isUsingServerMode = false;
            
            if (serverPollingTimer) {
                clearInterval(serverPollingTimer);
                serverPollingTimer = null;
            }
            
            connectionStartTime = null;
            connectionFailCount = 0;
            
            updateStatus(false);
            addLog('info', 'å·²åœæ­¢æœåŠ¡å™¨æ¨¡å¼');
        }
        
        // æ–­å¼€è¿æ¥
        function disconnectDevice() {
            // åœæ­¢WebSocket
            if (ws) {
                ws.close(1000, 'ç”¨æˆ·ä¸»åŠ¨æ–­å¼€'); // 1000 = æ­£å¸¸å…³é—­
                ws = null;
            }
            if (queryTimer) {
                clearInterval(queryTimer);
                queryTimer = null;
            }
            
            // åœæ­¢æœåŠ¡å™¨æ¨¡å¼
            if (isUsingServerMode) {
                stopServerMode();
            }
            
            // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
            if (failoverTimer) {
                clearTimeout(failoverTimer);
                failoverTimer = null;
            }
            
            connectionStartTime = null;
            connectionFailCount = 0;
            
            updateStatus(false);
            addLog('info', 'å·²æ–­å¼€è¿æ¥');
        }
        
        // æŸ¥è¯¢è®¾å¤‡æ•°æ®
        function queryDevice() {
            if (!ws || ws.readyState !== 1) {
                return;
            }
            
            const serial = document.getElementById('deviceSerial').value || '1';
            const serialHex = parseInt(serial).toString(16).padStart(2, '0').toUpperCase();
            
            // å†…å±‚AVKåè®®æ•°æ®ï¼šAA [åºåˆ—å·] 05 41 56 4B 06 15
            const innerDataHex = `AA${serialHex}0541564B0615`;
            
            // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
            sendWithOuterProtocol(innerDataHex, '02');
            // æ³¨æ„ï¼šæ‰¹é‡æŸ¥è¯¢782-790å°†åœ¨æ”¶åˆ°AVKå“åº”åå‘é€ï¼ˆåœ¨parseAndDisplayä¸­å¤„ç†ï¼‰
        }
        
        // æŸ¥è¯¢æ€»è°æ³¢å«é‡ï¼ˆ782-791ï¼‰
        function queryHarmonicContent(serial) {
            const serialNum = parseInt(serial) || 1;
            const startFuncCode = 782;
            const count = 10; // 782-791å…±10ä¸ª
            
            const cmdHex = buildBatchQueryCmd(serialNum, startFuncCode, count);
            addLog('info', `ğŸ“¤ å‘é€æ‰¹é‡æŸ¥è¯¢æ€»è°æ³¢å«é‡å‘½ä»¤ï¼ˆ782-791ï¼‰ï¼Œå†…å±‚æŒ‡ä»¤ï¼š${cmdHex.toUpperCase()}`);
            
            // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
            sendWithOuterProtocol(cmdHex, '02');
            
            // è®°å½•ç­‰å¾…çš„æ‰¹é‡æŸ¥è¯¢
            pendingBatchQuery = {
                startFuncCode: startFuncCode,
                count: count,
                callback: (results) => {
                    addLog('info', `ğŸ“¥ æ‰¹é‡æŸ¥è¯¢782-791å›è°ƒè¢«è°ƒç”¨ï¼Œç»“æœæ•°é‡: ${results ? results.length : 0}`);
                    if (results && results.length > 0) {
                        // ç¡®ä¿deviceDataå·²åˆå§‹åŒ–
                        if (!deviceData || Object.keys(deviceData).length === 0) {
                            deviceData = {};
                            addLog('warn', 'deviceDataæœªåˆå§‹åŒ–ï¼Œåˆ›å»ºæ–°å¯¹è±¡');
                        }
                        
                        // è§£æå¹¶æ›´æ–°deviceDataï¼ˆå³ä½¿å€¼ä¸º0ä¹Ÿä¿å­˜ï¼‰
                        results.forEach(({ funcCode, value }) => {
                            const fieldKey = `f${funcCode}`;
                            // å•ä½æ˜¯0.1%ï¼Œæ‰€ä»¥é™¤ä»¥10è½¬æ¢ä¸ºç™¾åˆ†æ¯”
                            // å³ä½¿å€¼ä¸º0ä¹Ÿä¿å­˜ï¼Œç¡®ä¿æ˜¾ç¤º
                            deviceData[fieldKey] = value / 10;
                            addLog('info', `âœ… æ€»è°æ³¢å«é‡ ${fieldKey} = ${deviceData[fieldKey].toFixed(2)}% (åŸå§‹å€¼: ${value})`);
                        });
                        
                        // é‡æ–°æ˜¾ç¤ºæ•°æ®ä»¥æ›´æ–°ç•Œé¢
                        addLog('info', `ğŸ”„ æ›´æ–°ç•Œé¢æ˜¾ç¤ºï¼ŒdeviceDataåŒ…å«${Object.keys(deviceData).length}ä¸ªå­—æ®µ`);
                        displayParams(deviceData);
                    } else {
                        addLog('warn', 'æ‰¹é‡æŸ¥è¯¢782-791ç»“æœä¸ºç©ºï¼Œåˆå§‹åŒ–é»˜è®¤å€¼0');
                        // å³ä½¿æ²¡æœ‰ç»“æœï¼Œä¹Ÿåˆå§‹åŒ–é»˜è®¤å€¼ä¸º0ï¼Œç¡®ä¿æ˜¾ç¤º
                        if (!deviceData) {
                            deviceData = {};
                        }
                        for (let i = 782; i <= 791; i++) {
                            deviceData[`f${i}`] = 0;
                        }
                        displayParams(deviceData);
                    }
                },
                timestamp: Date.now()
            };
            
            // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢pendingBatchQueryä¸€ç›´å­˜åœ¨
            setTimeout(() => {
                if (pendingBatchQuery && pendingBatchQuery.startFuncCode === startFuncCode) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢782-791è¶…æ—¶ï¼ˆ5ç§’ï¼‰`);
                    pendingBatchQuery = null;
                }
            }, 5000);
        }
        
        // æŸ¥è¯¢åŠŸç‡æ•°æ®ï¼ˆ747-778ï¼‰ï¼ŒåŒ…æ‹¬è§†åœ¨åŠŸç‡
        function queryPowerData(serial) {
            const serialNum = parseInt(serial) || 1;
            const startFuncCode = 747;
            const count = 32; // 747-778å…±32ä¸ª
            
            const cmdHex = buildBatchQueryCmd(serialNum, startFuncCode, count);
            addLog('info', `ğŸ“¤ å‘é€æ‰¹é‡æŸ¥è¯¢åŠŸç‡æ•°æ®å‘½ä»¤ï¼ˆ747-778ï¼‰ï¼Œå†…å±‚æŒ‡ä»¤ï¼š${cmdHex.toUpperCase()}`);
            
            // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
            sendWithOuterProtocol(cmdHex, '02');
            
            // è®°å½•ç­‰å¾…çš„æ‰¹é‡æŸ¥è¯¢
            pendingBatchQuery = {
                startFuncCode: startFuncCode,
                count: count,
                callback: (results) => {
                    addLog('info', `ğŸ“¥ æ‰¹é‡æŸ¥è¯¢747-778å›è°ƒè¢«è°ƒç”¨ï¼Œç»“æœæ•°é‡: ${results ? results.length : 0}`);
                    if (results && results.length > 0) {
                        // ç¡®ä¿deviceDataå·²åˆå§‹åŒ–
                        if (!deviceData || Object.keys(deviceData).length === 0) {
                            deviceData = {};
                            addLog('warn', 'deviceDataæœªåˆå§‹åŒ–ï¼Œåˆ›å»ºæ–°å¯¹è±¡');
                        }
                        
                        // è§£æå¹¶æ›´æ–°deviceData
                        results.forEach(({ funcCode, value }) => {
                            const fieldKey = `f${funcCode}`;
                            
                            // æ ¹æ®åŠŸèƒ½ç å¤„ç†ä¸åŒçš„å•ä½
                            if (funcCode >= 747 && funcCode <= 778) {
                                // è§†åœ¨åŠŸç‡ï¼ˆ747-749, 753-755, 770-772ï¼‰ï¼šå•ä½0.1kVA
                                if ((funcCode >= 747 && funcCode <= 749) || 
                                    (funcCode >= 753 && funcCode <= 755) || 
                                    (funcCode >= 770 && funcCode <= 772)) {
                                    deviceData[fieldKey] = value / 10; // è½¬æ¢ä¸ºkVA
                                    addLog('info', `âœ… è§†åœ¨åŠŸç‡ ${fieldKey} = ${deviceData[fieldKey].toFixed(2)} kVA (åŸå§‹å€¼: ${value})`);
                                } else {
                                    // å…¶ä»–åŠŸç‡ç›¸å…³æ•°æ®ï¼Œæ ¹æ®å®é™…æƒ…å†µå¤„ç†
                                    deviceData[fieldKey] = value;
                                    addLog('info', `âœ… åŠŸç‡æ•°æ® ${fieldKey} = ${deviceData[fieldKey]} (åŸå§‹å€¼: ${value})`);
                                }
                            }
                        });
                        
                        // é‡æ–°æ˜¾ç¤ºæ•°æ®ä»¥æ›´æ–°ç•Œé¢
                        addLog('info', `ğŸ”„ æ›´æ–°åŠŸç‡ä¿¡æ¯é¡µé¢æ˜¾ç¤ºï¼ŒdeviceDataåŒ…å«${Object.keys(deviceData).length}ä¸ªå­—æ®µ`);
                        displayParams(deviceData);
                    } else {
                        addLog('warn', 'æ‰¹é‡æŸ¥è¯¢747-778ç»“æœä¸ºç©º');
                    }
                },
                timestamp: Date.now()
            };
            
            // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢pendingBatchQueryä¸€ç›´å­˜åœ¨
            setTimeout(() => {
                if (pendingBatchQuery && pendingBatchQuery.startFuncCode === startFuncCode) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢747-778è¶…æ—¶ï¼ˆ5ç§’ï¼‰`);
                    pendingBatchQuery = null;
                }
            }, 5000);
        }
        
        // å‘é€æ§åˆ¶å‘½ä»¤
        function sendCommand(mode) {
            // å¦‚æœæ˜¯æœåŠ¡å™¨æ¨¡å¼ï¼Œé€šè¿‡ API å‘é€å‘½ä»¤
            if (isUsingServerMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const devId = urlParams.get('id');
                
                if (!devId) {
                    addLog('error', 'âŒ æœåŠ¡å™¨æ¨¡å¼ä¸‹å‘é€æŒ‡ä»¤éœ€è¦ URL åŒ…å« id å‚æ•°');
                    alert('æœåŠ¡å™¨æ¨¡å¼ä¸‹å‘é€æŒ‡ä»¤éœ€è¦ URL åŒ…å« id å‚æ•°');
                    return;
                }

        addLog('info', `ğŸ“¡ æœåŠ¡å™¨æ¨¡å¼ï¼šæ­£åœ¨é€šè¿‡ API å‘é€ ${mode} å‘½ä»¤...`);
        // ä¿®æ­£ï¼šæœåŠ¡å™¨æ¨¡å¼ä¸‹é€šè¿‡ /admin/dash/cmd è½¬å‘æ§åˆ¶å‘½ä»¤
        fetch(`/admin/dash/cmd?id=${devId}&mode=${mode}`)
            .then(response => response.json())
            .then(data => {
                if (data.code === 0) {
                    addLog('info', `âœ… æŒ‡ä»¤å‘é€æˆåŠŸ (${mode})`);
                    // æŒ‡ä»¤æˆåŠŸåç«‹å³è§¦å‘ä¸€æ¬¡åˆ·æ–°ï¼Œè·å–æœ€æ–°çŠ¶æ€
                    setTimeout(queryDeviceFromServer, 500); 
                } else {
                    addLog('error', `âŒ æŒ‡ä»¤å‘é€å¤±è´¥: ${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
                    .catch(error => {
                        addLog('error', `âŒ API è¯·æ±‚å¼‚å¸¸: ${error.message}`);
                    });
                return;
            }

            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnected'));
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å…è®¸è¯¥æ“ä½œï¼ˆlimitä¸­åŒ…å«çš„æ˜¯ç¦ç”¨çš„æ“ä½œï¼‰
            if (deviceLimit.includes(mode)) {
                const modeText = mode === 'run' ? 'å¯åŠ¨' : mode === 'stp' ? 'åœæœº' : 'å¤ä½';
                addLog('warn', `âš ï¸ å½“å‰è®¾å¤‡çŠ¶æ€ä¸å…è®¸æ‰§è¡Œ${modeText}æ“ä½œ`);
                alert(`å½“å‰è®¾å¤‡çŠ¶æ€ä¸å…è®¸æ‰§è¡Œ${modeText}æ“ä½œ`);
                return;
            }
            
            const serial = parseInt(document.getElementById('deviceSerial').value) || 1;
            const serialHex = serial.toString(16).padStart(2, '0');
            
            // WebSocketç›´è¿ä½¿ç”¨ASCIIå‘½ä»¤æ ¼å¼ï¼ˆå’Œåˆ†æé¡µä¸€æ ·ï¼‰
            let cmdStr, cmdName;
            switch(mode) {
                case 'run':
                    // AA åºåˆ—å· 05 52 55 4E + CRC  ("RUN" = 0x52 0x55 0x4E)
                    cmdStr = `aa${serialHex}0552554E`;
                    cmdName = 'å¯åŠ¨';
                    break;
                case 'stp':
                    // AA åºåˆ—å· 05 53 54 50 + CRC  ("STP" = 0x53 0x54 0x50)
                    cmdStr = `aa${serialHex}05535450`;
                    cmdName = 'åœæœº';
                    break;
                case 'rst':
                    // AA åºåˆ—å· 05 52 53 54 + CRC  ("RST" = 0x52 0x53 0x54)
                    cmdStr = `aa${serialHex}05525354`;
                    cmdName = 'å¤ä½';
                    break;
                default:
                    return;
            }
            
            // è®¡ç®—CRCå¹¶æ‹¼æ¥å®Œæ•´å‘½ä»¤
            const crc = crc16xmodem(cmdStr);
            const cmdHex = cmdStr + crc;  // æ‹¼æ¥å‘½ä»¤æœ¬ä½“å’ŒCRC
            
            addLog('info', `ğŸ“¤ å‘é€${cmdName}å‘½ä»¤ï¼Œå†…å±‚æŒ‡ä»¤: ${cmdHex.toUpperCase()}`);
            
            // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
            sendWithOuterProtocol(cmdHex, '02');
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(connected, running = null) {
            isConnected = connected;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('btnConnect');
            const btnLabel = document.getElementById('btnConnectLabel');
            
            if (connected) {
                dot.classList.add('connected');
                
                // æ ¹æ®è¿è¡ŒçŠ¶æ€æ›´æ–°æ˜¾ç¤º
                if (running === true) {
                    text.textContent = t('running');
                    text.style.color = '#52c41a';
                    dot.style.backgroundColor = '#52c41a';
                } else if (running === false) {
                    text.textContent = t('stopped');
                    text.style.color = '#faad14'; // æ©™è‰²/è­¦å‘Šè‰²è¡¨ç¤ºå·²åœæ­¢
                    dot.style.backgroundColor = '#faad14';
                } else {
                    // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„è¿è¡ŒçŠ¶æ€ï¼Œæ˜¾ç¤ºè¿æ¥çŠ¶æ€
                    text.textContent = isUsingServerMode ? t('serverMode') : t('connected');
                    text.style.color = isUsingServerMode ? '#1890ff' : '#52c41a';
                    dot.style.backgroundColor = isUsingServerMode ? '#1890ff' : '#52c41a';
                }
                
                btn.className = 'btn btn-warning';
                btn.onclick = disconnectDevice;
                if (btnLabel) btnLabel.textContent = t('btnDisconnect');
            } else {
                dot.classList.remove('connected');
                dot.style.backgroundColor = '#ccc';
                text.textContent = t('disconnected');
                text.style.color = '#999';
                btn.className = 'btn btn-primary';
                btn.onclick = connectDevice;
                if (btnLabel) btnLabel.textContent = t('btnConnect');
            }
        }
        
        // è§£ææŸ¥è¯¢å“åº”
            // æ ¼å¼ï¼š55 01 07 50 | 02 00 | 00 00 | 0B A0
            //      [0][1][2][3]|[4][5]|[6][7]|[8][9]
            //                   åœ°å€    å€¼     CRC
        function parseQueryResponse(bytes) {
            try {
                // æ£€æŸ¥æœ€å°é•¿åº¦
                if (bytes.length < 8) {
                    addLog('warn', `æŸ¥è¯¢å“åº”æ•°æ®å¤ªçŸ­ï¼š${bytes.length}å­—èŠ‚ï¼ˆæœ€å°8å­—èŠ‚ï¼‰`);
                    return;
                }
                
                // éªŒè¯å¸§å¤´æ ¼å¼ï¼š55 01 07 50
                if (bytes[0] !== 0x55) {
                    addLog('debug', `æŸ¥è¯¢å“åº”å¸§å¤´é”™è¯¯ï¼šæœŸæœ›0x55ï¼Œæ”¶åˆ°0x${bytes[0].toString(16).padStart(2, '0').toUpperCase()}`);
                    return;
                }
                if (bytes[1] !== 0x01) {
                    addLog('debug', `æŸ¥è¯¢å“åº”ç¬¬2å­—èŠ‚é”™è¯¯ï¼šæœŸæœ›0x01ï¼Œæ”¶åˆ°0x${bytes[1].toString(16).padStart(2, '0').toUpperCase()}`);
                    return;
                }
                if (bytes[2] !== 0x07) {
                    addLog('debug', `æŸ¥è¯¢å“åº”é•¿åº¦å­—èŠ‚é”™è¯¯ï¼šæœŸæœ›0x07ï¼Œæ”¶åˆ°0x${bytes[2].toString(16).padStart(2, '0').toUpperCase()}`);
                    return;
                }
                if (bytes[3] !== 0x50) {
                    addLog('debug', `æŸ¥è¯¢å“åº”å‘½ä»¤å­—èŠ‚é”™è¯¯ï¼šæœŸæœ›0x50ï¼Œæ”¶åˆ°0x${bytes[3].toString(16).padStart(2, '0').toUpperCase()}`);
                    return;
                }
            
            // æŒ‰ç…§ç”¨æˆ·æä¾›çš„æ­£ç¡®æ ¼å¼ï¼š
            // bytes[4], bytes[5] = åœ°å€ï¼ˆå¤§ç«¯åºï¼‰
            // bytes[6], bytes[7] = å€¼ï¼ˆå¤§ç«¯åºï¼‰
            const addr = (bytes[4] << 8) | bytes[5];
            const val = (bytes[6] << 8) | bytes[7];
            
            addLog('info', `âœ… æŸ¥è¯¢å“åº”ï¼šåœ°å€=${addr} (0x${addr.toString(16).toUpperCase()})ï¼Œå€¼=${val} (0x${val.toString(16).toUpperCase()})`);
                addLog('debug', `   å®Œæ•´æ•°æ®: ${Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ').toUpperCase()}`);
            
            // ä½¿ç”¨åœ°å€åŒ¹é…å¯¹åº”çš„æŸ¥è¯¢
            const query = pendingQueries[addr];
            if (query) {
                // å¦‚æœæœ‰callbackï¼Œè°ƒç”¨callback
                if (query.callback) {
                    query.callback(val);
                        addLog('debug', `âœ… å·²é€šè¿‡å›è°ƒå‡½æ•°å¤„ç†æŸ¥è¯¢å“åº”ï¼šåœ°å€=${addr}, å€¼=${val}`);
                } else {
                    // å¦åˆ™æŒ‰åŸæ¥çš„é€»è¾‘æ›´æ–°element
                    const element = document.getElementById(query.fieldId);
                    if (element) {
                        // ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°å°†æ•°å€¼è½¬æ¢ä¸ºå¯¹åº”çš„æ–‡å­—æ˜¾ç¤º
                        element.value = formatParamValueForDisplay(addr, val, query.fieldId);
                        addLog('info', `âœ… å·²æ›´æ–° ${query.fieldId} = ${element.value}`);
                        } else {
                            addLog('warn', `æŸ¥è¯¢å“åº”ï¼šæœªæ‰¾åˆ°å­—æ®µå…ƒç´  ${query.fieldId}`);
                    }
                }
                delete pendingQueries[addr];
            } else {
                    addLog('warn', `æ²¡æœ‰æ‰¾åˆ°åŠŸèƒ½ç ${addr}çš„ç­‰å¾…æŸ¥è¯¢ï¼Œå°è¯•æ—¶é—´åŒ¹é…`);
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æœ€æ–°çš„æŸ¥è¯¢
                const queries = Object.keys(pendingQueries).map(k => ({
                    funcCode: parseInt(k),
                    ...pendingQueries[k]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                if (queries.length > 0) {
                    const latestQuery = queries[0];
                        addLog('info', `ä½¿ç”¨æ—¶é—´åŒ¹é…ï¼šæœ€æ–°æŸ¥è¯¢ä¸ºåŠŸèƒ½ç ${latestQuery.funcCode}ï¼Œæ—¶é—´æˆ³=${latestQuery.timestamp}`);
                    const element = document.getElementById(latestQuery.fieldId);
                    if (element) {
                        // ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°å°†æ•°å€¼è½¬æ¢ä¸ºå¯¹åº”çš„æ–‡å­—æ˜¾ç¤º
                        element.value = formatParamValueForDisplay(latestQuery.funcCode, val, latestQuery.fieldId);
                        addLog('info', `âœ… å·²æ›´æ–° ${latestQuery.fieldId} = ${element.value} (æŒ‰æ—¶é—´åŒ¹é…)`);
                    }
                    delete pendingQueries[latestQuery.funcCode];
                    } else {
                        addLog('warn', `æŸ¥è¯¢å“åº”ï¼šåœ°å€${addr}æ²¡æœ‰åŒ¹é…çš„ç­‰å¾…æŸ¥è¯¢ï¼Œä¸”æ²¡æœ‰å¯ç”¨çš„å¤‡ç”¨æŸ¥è¯¢`);
                }
                }
            } catch (error) {
                addLog('error', `æŸ¥è¯¢å“åº”è§£æå¼‚å¸¸ï¼š${error.message}`);
                addLog('error', `æ•°æ®åŒ…ï¼ˆå‰20å­—èŠ‚ï¼‰ï¼š${Array.from(bytes.slice(0, Math.min(20, bytes.length))).map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
            }
        }
        
        // è§£ææ‰¹é‡æŸ¥è¯¢å“åº”ï¼ˆE2åè®®ï¼‰
        // æ ¼å¼ï¼š55 01 xx(é•¿åº¦) R(52) xx xx(æ•°æ®1) xx xx(æ•°æ®2) ... xx xx(æ•°æ®n) xx xx(æ ¡éªŒç )
        // é•¿åº¦ = Nï¼ˆæ•°æ®çš„ç»„æ•°ï¼‰*2 + 3
        // è¿”å›ï¼šè§£æç»“æœæ•°ç»„æˆ–nullï¼ˆè§£æå¤±è´¥ï¼‰
        function parseBatchQueryResponse(bytes, startFuncCode, count) {
            try {
                // æ£€æŸ¥æœ€å°é•¿åº¦
                if (bytes.length < 6) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”æ•°æ®å¤ªçŸ­ï¼š${bytes.length}å­—èŠ‚ï¼ˆæœ€å°6å­—èŠ‚ï¼‰`);
                    return null;
                }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‰¹é‡æŸ¥è¯¢å“åº”ï¼š55 01 xx 52
                if (bytes[0] !== 0x55) {
                    addLog('debug', `æ‰¹é‡æŸ¥è¯¢å“åº”å¸§å¤´é”™è¯¯ï¼šæœŸæœ›0x55ï¼Œæ”¶åˆ°0x${bytes[0].toString(16).padStart(2, '0').toUpperCase()}`);
                    return null;
                }
                if (bytes[1] !== 0x01) {
                    addLog('debug', `æ‰¹é‡æŸ¥è¯¢å“åº”ç¬¬2å­—èŠ‚é”™è¯¯ï¼šæœŸæœ›0x01ï¼Œæ”¶åˆ°0x${bytes[1].toString(16).padStart(2, '0').toUpperCase()}`);
                    return null;
                }
                if (bytes[3] !== 0x52) {
                    addLog('debug', `æ‰¹é‡æŸ¥è¯¢å“åº”å‘½ä»¤å­—èŠ‚é”™è¯¯ï¼šæœŸæœ›0x52ï¼Œæ”¶åˆ°0x${bytes[3].toString(16).padStart(2, '0').toUpperCase()}`);
                return null;
            }
            
            const length = bytes[2]; // ä»Råˆ°æ ¡éªŒç çš„é•¿åº¦
                
                // éªŒè¯é•¿åº¦å­—æ®µåˆç†æ€§
                if (length < 3) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”é•¿åº¦å­—æ®µå¼‚å¸¸å°ï¼š${length}ï¼ˆæœ€å°3ï¼‰`);
                    return null;
                }
                if (length > 255) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”é•¿åº¦å­—æ®µå¼‚å¸¸å¤§ï¼š${length}`);
                    return null;
                }
                
            // æ•°æ®ç»„æ•° = (length - 3) / 2
            const dataCount = (length - 3) / 2;
            
                // éªŒè¯æ•°æ®ç»„æ•°æ˜¯å¦ä¸ºæ•´æ•°
                if (dataCount !== Math.floor(dataCount)) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”æ•°æ®ç»„æ•°ä¸æ˜¯æ•´æ•°ï¼š${dataCount}ï¼Œé•¿åº¦å­—æ®µ=${length}`);
                    return null;
                }
                
                // éªŒè¯æ•°æ®åŒ…é•¿åº¦æ˜¯å¦è¶³å¤Ÿ
                const expectedLength = 4 + dataCount * 2 + 2; // 55 01 length 52 + æ•°æ® + æ ¡éªŒç 
                if (bytes.length < expectedLength) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”æ•°æ®åŒ…é•¿åº¦ä¸è¶³ï¼šæœŸæœ›${expectedLength}å­—èŠ‚ï¼Œå®é™…${bytes.length}å­—èŠ‚ï¼Œæ•°æ®ç»„æ•°=${dataCount}`);
                    return null;
                }
                
                // æ£€æŸ¥æ•°æ®ç»„æ•°æ˜¯å¦åŒ¹é…
            if (dataCount !== count) {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”æ•°æ®ç»„æ•°ä¸åŒ¹é…ï¼šæœŸæœ›${count}ï¼Œå®é™…${dataCount}ï¼Œé•¿åº¦å­—æ®µ=${length}`);
                    // ç»§ç»­å¤„ç†ï¼Œä½†åªå¤„ç†æœŸæœ›çš„æ•°é‡
            }
            
            const results = [];
            // æ•°æ®ä»bytes[4]å¼€å§‹ï¼Œæ¯2ä¸ªå­—èŠ‚ä¸€ç»„ï¼Œæœ€å2ä¸ªå­—èŠ‚æ˜¯æ ¡éªŒç 
            // æ‰€ä»¥æ•°æ®èŒƒå›´æ˜¯ bytes[4] åˆ° bytes[4 + dataCount*2 - 1]
                const actualCount = Math.min(dataCount, count);
                for (let i = 0; i < actualCount; i++) {
                const dataOffset = 4 + i * 2;
                if (dataOffset + 1 < bytes.length - 2) { // æ’é™¤æœ€å2ä¸ªå­—èŠ‚çš„æ ¡éªŒç 
                    const value = (bytes[dataOffset] << 8) | bytes[dataOffset + 1];
                    const funcCode = startFuncCode + i;
                    results.push({ funcCode, value });
                        addLog('debug', `   åŠŸèƒ½ç ${funcCode} = ${value} (0x${value.toString(16).toUpperCase()})`);
                    } else {
                        addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”æ•°æ®ç´¢å¼•${i}è¶…å‡ºèŒƒå›´ï¼šoffset=${dataOffset}, æ•°æ®åŒ…é•¿åº¦=${bytes.length}`);
                        break;
                    }
                }
                
                if (results.length > 0) {
                    addLog('info', `âœ… æ‰¹é‡æŸ¥è¯¢å“åº”è§£ææˆåŠŸï¼šæ”¶åˆ°${results.length}ä¸ªæ•°æ®ï¼ˆæœŸæœ›${count}ï¼Œå®é™…${dataCount}ï¼‰`);
                } else {
                    addLog('warn', `æ‰¹é‡æŸ¥è¯¢å“åº”è§£æå¤±è´¥ï¼šæœªæå–åˆ°ä»»ä½•æ•°æ®`);
                    return null;
                }
                
            return results;
            } catch (error) {
                addLog('error', `æ‰¹é‡æŸ¥è¯¢å“åº”è§£æå¼‚å¸¸ï¼š${error.message}`);
                addLog('error', `æ•°æ®åŒ…ï¼ˆå‰20å­—èŠ‚ï¼‰ï¼š${Array.from(bytes.slice(0, Math.min(20, bytes.length))).map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(' ')}`);
                return null;
            }
        }
        
        // å­˜å‚¨æ‰¹é‡æŸ¥è¯¢çš„ç­‰å¾…å“åº”
        let pendingBatchQuery = null;
        // å­˜å‚¨æ‰¹é‡ä¿å­˜çš„ç­‰å¾…å“åº”
        let pendingBatchSave = null;
        
        // è§£æå¹¶æ˜¾ç¤ºæ•°æ®
        function parseAndDisplay(buffer) {
            const bytes = new Uint8Array(buffer);
            
            // æ£€æŸ¥CKæ¨¡å¼
            if (bytes.length >= 123 && bytes[0] === 0x55 && bytes[3] === 0x43 && bytes[4] === 0x4B) {
                addLog('info', 'âœ… æ£€æµ‹åˆ°CKæ¨¡å¼æ•°æ®åŒ…ï¼ˆAVKå“åº”ï¼‰');
                
                const parsedData = parseCKData(bytes);
                // åˆå¹¶ç°æœ‰deviceDataï¼Œä¿ç•™æ€»è°æ³¢å«é‡æ•°æ®ï¼ˆf782-f790ï¼‰
                if (deviceData && Object.keys(deviceData).length > 0) {
                    // ä¿ç•™æ€»è°æ³¢å«é‡æ•°æ®
                    const harmonicData = {};
                    for (let i = 782; i <= 790; i++) {
                        const key = `f${i}`;
                        if (deviceData[key] !== undefined) {
                            harmonicData[key] = deviceData[key];
                        }
                    }
                    // åˆå¹¶æ•°æ®ï¼šå…ˆä½¿ç”¨CKæ•°æ®ï¼Œå†æ·»åŠ æ€»è°æ³¢å«é‡æ•°æ®
                    deviceData = { ...parsedData, ...harmonicData };
                    addLog('info', `ğŸ”„ åˆå¹¶æ•°æ®ï¼šä¿ç•™${Object.keys(harmonicData).length}ä¸ªæ€»è°æ³¢å«é‡å­—æ®µ`);
                } else {
                deviceData = parsedData;
                }
                deviceLimit = parsedData.limit || ['run', 'stp', 'rst'];
                
                // æ˜¾ç¤ºæ•°æ®
                displayParams(deviceData);
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                updateButtonStates();
                
                // æ›´æ–°æ—¶é—´
                const lastUpdateEl = document.getElementById('lastUpdate');
                if (lastUpdateEl) {
                lastUpdateEl.textContent = `${t('lastUpdate')}: ${new Date().toLocaleTimeString()}`;
                }
                const updateTimeEl = document.getElementById('updateTime');
                if (updateTimeEl) {
                    updateTimeEl.textContent = new Date().toLocaleTimeString();
                }
                
                // æ”¶åˆ°AVKå“åº”åï¼Œæ ¹æ®å½“å‰Tabå‘é€å¯¹åº”çš„æ‰¹é‡æŸ¥è¯¢å‘½ä»¤
                setTimeout(() => {
                    if (ws && ws.readyState === 1) {
                        const serial = document.getElementById('deviceSerial').value || '1';
                        // æ ¹æ®å½“å‰Tabå‘é€ä¸åŒçš„æ‰¹é‡æŸ¥è¯¢
                        if (currentMainTab === 1) {
                            // åŠŸç‡ä¿¡æ¯é¡µé¢ï¼šå‘é€747-778çš„æ‰¹é‡æŸ¥è¯¢
                            queryPowerData(serial);
                        }
                    }
                }, 200);
            } else {
                addLog('warn', 'æœªçŸ¥æ•°æ®æ ¼å¼ï¼Œé•¿åº¦: ' + bytes.length);
            }
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        // æ³¨æ„ï¼šlimitæ•°ç»„ä¸­åŒ…å«çš„æ˜¯ã€ç¦ç”¨ã€‘çš„æŒ‰é’®ï¼Œä¸æ˜¯å¯ç”¨çš„
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        // æ³¨æ„ï¼šlimitæ•°ç»„ä¸­åŒ…å«çš„æ˜¯ã€ç¦ç”¨ã€‘çš„æŒ‰é’®ï¼Œä¸æ˜¯å¯ç”¨çš„
        function updateButtonStates() {
            const btnStart = document.getElementById('btnRun');
            const btnStop = document.getElementById('btnStop');
            const btnReset = document.getElementById('btnReset');
            
            // æ ¹æ® deviceLimit åˆ¤æ–­å½“å‰è¿è¡ŒçŠ¶æ€
            let isRunning = null;
            if (deviceLimit.includes('run')) {
                isRunning = true;  // å¯åŠ¨æŒ‰é’®è¢«ç¦ç”¨ï¼Œè¯´æ˜æ­£åœ¨è¿è¡Œ
            } else if (deviceLimit.includes('stp')) {
                isRunning = false; // åœæœºæŒ‰é’®è¢«ç¦ç”¨ï¼Œè¯´æ˜å·²åœæ­¢
            }
            
            // æ›´æ–°æ¨ªå¹…çŠ¶æ€
            updateStatus(isConnected, isRunning);
            
            if (btnStart) {
                // å¦‚æœlimitåŒ…å«'run'ï¼Œè¯´æ˜å¯åŠ¨æŒ‰é’®åº”è¯¥ç¦ç”¨
                if (deviceLimit.includes('run')) {
                    btnStart.disabled = true;
                    btnStart.style.opacity = '0.3';
                    btnStart.style.cursor = 'not-allowed';
                } else {
                    btnStart.disabled = false;
                    btnStart.style.opacity = '1';
                    btnStart.style.cursor = 'pointer';
                }
            }
            
            if (btnStop) {
                // å¦‚æœlimitåŒ…å«'stp'ï¼Œè¯´æ˜åœæ­¢æŒ‰é’®åº”è¯¥ç¦ç”¨
                if (deviceLimit.includes('stp')) {
                    btnStop.disabled = true;
                    btnStop.style.opacity = '0.3';
                    btnStop.style.cursor = 'not-allowed';
                } else {
                    btnStop.disabled = false;
                    btnStop.style.opacity = '1';
                    btnStop.style.cursor = 'pointer';
                }
            }
            
            if (btnReset) {
                // å¦‚æœlimitåŒ…å«'rst'ï¼Œè¯´æ˜å¤ä½æŒ‰é’®åº”è¯¥ç¦ç”¨
                if (deviceLimit.includes('rst')) {
                    btnReset.disabled = true;
                    btnReset.style.opacity = '0.3';
                    btnReset.style.cursor = 'not-allowed';
                } else {
                    btnReset.disabled = false;
                    btnReset.style.opacity = '1';
                    btnReset.style.cursor = 'pointer';
                }
            }
        }
        
        // å·¥ä½œæ¨¡å¼è½¬æ¢å‡½æ•°ï¼ˆä¸è¡¥å¿æ¨¡å¼æ˜¾ç¤ºä¸€è‡´ï¼‰
        function convertWorkMode(value) {
            // å¦‚æœæ˜¯ç©ºæˆ–æ— æ•ˆå€¼ï¼Œæ˜¾ç¤ºâ€œ--â€
            if (value === undefined || value === null || value === '' || value === '-' || value === '_') {
                return '--';
            }

            // å¦‚æœå€¼å·²ç»æ˜¯ä¸­æ–‡å­—ç¬¦ä¸²ï¼ˆæœåŠ¡å™¨æ¨¡å¼ä¸‹ï¼‰ï¼Œç›´æ¥è¿”å›
            if (typeof value === 'string' && /[\u4e00-\u9fa5]/.test(value)) {
                return value;
            }

            const numValue = parseInt(value);
            if (isNaN(numValue)) {
                return '--';
            }

            const modeMap = {
                zh: {
                    0: 'åœæ­¢/å¾…æœº',
                    1: 'ä¸å¹³è¡¡è¡¥å¿',
                    2: 'æ— åŠŸè¡¥å¿',
                    4: 'è°æ³¢è¡¥å¿',
                    6: 'æ— åŠŸ+è°æ³¢è¡¥å¿',
                    13: 'è°æ³¢+ä¸å¹³è¡¡è¡¥å¿',
                    14: 'è°æ³¢+æ— åŠŸè¡¥å¿',
                    15: 'è°æ³¢+ä¸å¹³è¡¡+æ— åŠŸè¡¥å¿',
                    16: 'è‡ªè€åŒ–å‘æ— åŠŸ',
                    35: 'æ— åŠŸ+ä¸å¹³è¡¡è¡¥å¿',
                    39: 'æ— åŠŸ+ä¸å¹³è¡¡+è°æ³¢è¡¥å¿',
                    129: 'ä¸å¹³è¡¡è¡¥å¿',
                    130: 'æ— åŠŸè¡¥å¿',
                    132: 'è°æ³¢è¡¥å¿',
                    134: 'æ— åŠŸ+è°æ³¢è¡¥å¿',
                    141: 'è°æ³¢+ä¸å¹³è¡¡è¡¥å¿',
                    142: 'è°æ³¢+æ— åŠŸè¡¥å¿',
                    143: 'è°æ³¢+ä¸å¹³è¡¡+æ— åŠŸè¡¥å¿',
                    144: 'è‡ªè€åŒ–å‘æ— åŠŸ',
                    163: 'æ— åŠŸ+ä¸å¹³è¡¡è¡¥å¿',
                    167: 'æ— åŠŸ+ä¸å¹³è¡¡+è°æ³¢è¡¥å¿'
                }
            };
            const lang = 'zh';
            const converted = modeMap[lang][numValue];
            
            if (converted) return converted;
            
            // å¦‚æœæ˜¯æ•°å­—ä½†æ²¡åŒ¹é…åˆ°ï¼Œæ˜¾ç¤ºåŸå§‹æ¨¡å¼
            return 'æ¨¡å¼ ' + numValue;
        }
        
        // è§£æCKæ•°æ® - å®Œæ•´f01-f60
        function parseCKData(bytes) {
            function b(v, percent = 100) {
                if ((v & 0x8000) !== 0) {
                    return -((~v + 1) & 0xffff) / percent;
                }
                return v / percent;
            }
            
            // ä¿®æ”¹ï¼šè¿è¡Œæ¨¡å¼ï¼ˆå·¥ä½œæ¨¡å¼ï¼‰ä¼˜å…ˆæ ¹æ®åœ°å€513ï¼ˆf51ï¼Œå¯¹åº”bytes[104]ï¼‰æ˜¾ç¤º
            const f51Value = bytes[104] || 0;
            const f60Raw = (bytes[119] << 8) | bytes[120];
            // å¦‚æœ513åœ°å€æœ‰å€¼ä¸”ä¸ä¸º0ï¼Œä¼˜å…ˆä½¿ç”¨513åœ°å€çš„å€¼ä½œä¸ºè¿è¡Œæ¨¡å¼æ˜¾ç¤º
            const displayModeValue = f51Value > 0 ? f51Value : f60Raw;
            
            // è§£ææŒ‰é’®æ§åˆ¶é€»è¾‘ï¼ˆæ ¹æ®bytes[43]çš„bit1å’Œbit5ï¼‰
            // è°ƒè¯•ï¼šæ˜¾ç¤º f20 çš„åŸå§‹å€¼
            addLog('debug', `[çŠ¶æ€æ£€æŸ¥] f20 (bytes[43]) åŸå§‹å€¼: 0x${bytes[43].toString(16).padStart(2, '0').toUpperCase()} (äºŒè¿›åˆ¶: ${bytes[43].toString(2).padStart(8, '0')})`);
            
            // æ ¹æ®ç”¨æˆ·åé¦ˆï¼šé€»è¾‘å†æ¬¡åè½¬å›æ¥
            // b1=0 è¡¨ç¤ºè¿è¡Œä¸­ï¼Œç¦ç”¨å¯åŠ¨æŒ‰é’® (run)
            // b1=1 è¡¨ç¤ºå·²åœæ­¢ï¼Œç¦ç”¨åœæœºæŒ‰é’® (stp)
            const b1 = (bytes[43] & 0x02) === 0 ? 0 : 1;
            let limit = [];
            if (b1 === 0) {
                limit = ['run'];
            } else {
                limit = ['stp'];
            }
            
            return {
                limit: limit,  // æ·»åŠ æŒ‰é’®æ§åˆ¶å­—æ®µ
                f01: b((bytes[5] << 8) | bytes[6]),
                f02: b((bytes[7] << 8) | bytes[8]),
                f03: b((bytes[9] << 8) | bytes[10]),
                f04: b((bytes[11] << 8) | bytes[12]),
                f05: b((bytes[13] << 8) | bytes[14]),
                f06: b((bytes[15] << 8) | bytes[16]),
                f07: b((bytes[17] << 8) | bytes[18]),
                f08: b((bytes[19] << 8) | bytes[20]),
                f09: b((bytes[21] << 8) | bytes[22]),
                f10: b((bytes[23] << 8) | bytes[24]),
                f11: b((bytes[25] << 8) | bytes[26]),
                f12: b((bytes[27] << 8) | bytes[28]),
                f13: b((bytes[29] << 8) | bytes[30]),
                f14: b((bytes[31] << 8) | bytes[32]),
                f15: b((bytes[33] << 8) | bytes[34]),
                f16: b((bytes[35] << 8) | bytes[36]),
                f17: b((bytes[37] << 8) | bytes[38]),
                f18: b((bytes[39] << 8) | bytes[40]),
                f19: (bytes[41] << 8) | bytes[42],
                f20: bytes[43],
                f21: bytes[44],
                f22: (bytes[45] << 8) | bytes[46],
                f23: ((bytes[47] << 8) | bytes[48]) / 10,
                f24: ((bytes[49] << 8) | bytes[50]) / 10,
                f25: ((bytes[51] << 8) | bytes[52]) / 10,
                f26: (bytes[53] << 8) | bytes[54],
                f27: ((bytes[59] << 8) | bytes[60]) / 10,
                f28: ((bytes[61] << 8) | bytes[62]) / 100,
                f29: b((bytes[63] << 8) | bytes[64], 10),
                f30: ((bytes[65] << 8) | bytes[66]) / 10,
                f31: (bytes[67] << 8) | bytes[68],
                f32: (bytes[69] << 8) | bytes[70],
                f33: (bytes[71] << 8) | bytes[72],
                f34: b((bytes[73] << 8) | bytes[74], 10),
                f35: b((bytes[75] << 8) | bytes[76], 10),
                f36: ((bytes[77] << 8) | bytes[78]) / 10,
                f37: ((bytes[79] << 8) | bytes[80]) / 10,
                f38: ((bytes[81] << 8) | bytes[82]) / 10,
                f39: ((bytes[83] << 8) | bytes[84]) / 10,
                f40: ((bytes[85] << 8) | bytes[86]) / 10,
                f41: ((bytes[87] << 8) | bytes[88]) / 10,
                f42: ((bytes[89] << 8) | bytes[90]) / 10,
                f43: ((bytes[91] << 8) | bytes[92]) / 10,
                f44: ((bytes[93] << 8) | bytes[94]) / 10,
                f45: ((bytes[95] << 8) | bytes[96]) / 10,
                f46: ((bytes[97] << 8) | bytes[98]) / 10,
                f47: ((bytes[99] << 8) | bytes[100]) / 10,
                f48: bytes[101] || 0,
                f49: bytes[102] || 0,
                f50: bytes[103] || 0,
                f51: bytes[104] || 0,
                f52: bytes[105] || 0,
                f53: bytes[106] || 0,
                f54: b((bytes[107] << 8) | bytes[108]),
                f55: b((bytes[109] << 8) | bytes[110]),
                f56: b((bytes[111] << 8) | bytes[112]),
                f57: b((bytes[113] << 8) | bytes[114]),
                f58: b((bytes[115] << 8) | bytes[116]),
                f59: b((bytes[117] << 8) | bytes[118]),
                f60: displayModeValue  // è¿”å›åŸå§‹æ•°å€¼ï¼Œç”± formatParamValue è¿›è¡Œè½¬æ¢æ˜¾ç¤º
            };
        }
        
        function getFeatureName(key) {
            const localeMap = featureNames[currentLang] || featureNames.zh;
            return localeMap[key] || featureNames.zh[key] || key;
        }

        function formatParamValue(key, raw) {
            // ç‰¹æ®Šå¤„ç†ï¼šè¿è¡Œæ¨¡å¼ (f60) éœ€è¦è½¬æ¢
            if (key === 'f60') {
                return convertWorkMode(raw);
            }

            // å€¼ä¸º0æ—¶ä¹Ÿæ˜¾ç¤ºï¼ˆç‰¹åˆ«æ˜¯æ€»è°æ³¢å«é‡å­—æ®µï¼‰
            if (raw === 0 || raw === '0') {
                return '0.00';
            }
            if (raw === undefined || raw === null || raw === '') {
                return '--';
            }
            if (typeof raw === 'number') {
                return raw.toFixed(2);
            }
            const num = parseFloat(raw);
            if (!isNaN(num) && isFinite(num)) {
                return num.toFixed(2);
            }
            return raw;
        }

        function createInfoCard(container, titleKey, keys, data, cardConfig) {
            const card = document.createElement('div');
            card.className = 'info-card';
            // åŠŸç‡æ•°æ®å¡ç‰‡åœ¨å³ä¸Šè§’æ·»åŠ å›¾æ ‡
            const icon = getPowerCardIcon(titleKey);
            card.innerHTML = `<div class="info-card-header">${t(titleKey)}${icon ? `<span class="card-icon">${icon}</span>` : ''}</div>`;
            const body = document.createElement('div');
            body.className = 'info-card-body';

            let total = 0;
            keys.forEach((key, index) => {
                // ç‰¹æ®Šå¤„ç†ï¼šé¢‘ç‡å¡ç‰‡æ˜¾ç¤ºABCä¸‰ç›¸
                if (titleKey === 'cardFrequency' && key === 'f28') {
                    const phaseLabels = currentLang === 'en' ? ['Grid Phase A Frequency', 'Grid Phase B Frequency', 'Grid Phase C Frequency'] : ['ç”µç½‘Aç›¸é¢‘ç‡', 'ç”µç½‘Bç›¸é¢‘ç‡', 'ç”µç½‘Cç›¸é¢‘ç‡'];
                    const phaseLabel = phaseLabels[index] || (currentLang === 'en' ? 'Grid Frequency' : 'ç”µç½‘é¢‘ç‡');
                    if (data.hasOwnProperty(key)) {
                        const value = formatParamValue(key, data[key]);
                        const item = document.createElement('div');
                        item.className = 'param-item';
                        item.innerHTML = `
                            <span class="param-name">${phaseLabel}</span>
                            <span>
                                <span class="param-value">${value}</span>
                                <span class="param-unit">${units[key] || ''}</span>
                            </span>
                        `;
                        body.appendChild(item);
                        total++;
                    }
                    return;
                }
                
                // ç‰¹æ®Šå¤„ç†ï¼šç”µç½‘è§†åœ¨å’Œè´Ÿè½½è§†åœ¨ï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿæ˜¾ç¤º0
                if ((titleKey === 'cardGridApparentPower' && (key === 'f747' || key === 'f748' || key === 'f749')) ||
                    (titleKey === 'cardLoadApparentPower' && (key === 'f770' || key === 'f771' || key === 'f772'))) {
                    const value = data.hasOwnProperty(key) ? formatParamValue(key, data[key]) : '0.00';
                    createParamItem(body, key, value);
                    total++;
                    return;
                }
                
                // ä¿®æ”¹ï¼šå³ä½¿å€¼ä¸º0æˆ–undefinedï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºï¼ˆå¯¹äºæ€»è°æ³¢å«é‡ç­‰å­—æ®µï¼‰
                // å¦‚æœdataä¸­æœ‰è¿™ä¸ªkeyï¼ˆåŒ…æ‹¬å€¼ä¸º0ï¼‰ï¼Œå°±æ˜¾ç¤º
                if (data.hasOwnProperty(key)) {
                    const value = formatParamValue(key, data[key]);
                    createParamItem(body, key, value);
                    total++;
                } else if (key.startsWith('f78')) {
                    // å¯¹äºæ€»è°æ³¢å«é‡å­—æ®µï¼ˆf782-f790ï¼‰ï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿæ˜¾ç¤º0
                    createParamItem(body, key, '0.00');
                    total++;
                } else if (titleKey === 'cardDeviceApparentPower' && (key === 'f753' || key === 'f754' || key === 'f755')) {
                    // è£…ç½®è§†åœ¨åŠŸç‡ï¼šå¦‚æœæ²¡æœ‰æ‰¹é‡æŸ¥è¯¢æ•°æ®ï¼Œåˆ™æ ¹æ®è£…ç½®æœ‰åŠŸå’Œæ— åŠŸè®¡ç®—
                    let apparentPowerValue = null;
                    if (key === 'f753') {
                        // Aç›¸ï¼šæ ¹æ®f10ï¼ˆæœ‰åŠŸï¼‰å’Œf11ï¼ˆæ— åŠŸï¼‰è®¡ç®—
                        const activePower = data.f10 !== undefined ? parseFloat(data.f10) : 0;
                        const reactivePower = data.f11 !== undefined ? parseFloat(data.f11) : 0;
                        apparentPowerValue = Math.sqrt(activePower * activePower + reactivePower * reactivePower);
                    } else if (key === 'f754') {
                        // Bç›¸ï¼šæ ¹æ®f13ï¼ˆæœ‰åŠŸï¼‰å’Œf14ï¼ˆæ— åŠŸï¼‰è®¡ç®—
                        const activePower = data.f13 !== undefined ? parseFloat(data.f13) : 0;
                        const reactivePower = data.f14 !== undefined ? parseFloat(data.f14) : 0;
                        apparentPowerValue = Math.sqrt(activePower * activePower + reactivePower * reactivePower);
                    } else if (key === 'f755') {
                        // Cç›¸ï¼šæ ¹æ®f16ï¼ˆæœ‰åŠŸï¼‰å’Œf17ï¼ˆæ— åŠŸï¼‰è®¡ç®—
                        const activePower = data.f16 !== undefined ? parseFloat(data.f16) : 0;
                        const reactivePower = data.f17 !== undefined ? parseFloat(data.f17) : 0;
                        apparentPowerValue = Math.sqrt(activePower * activePower + reactivePower * reactivePower);
                    }
                    if (apparentPowerValue !== null) {
                        const value = formatParamValue(key, apparentPowerValue);
                        createParamItem(body, key, value);
                        total++;
                    }
                }
            });

            // å¦‚æœéœ€è¦æ˜¾ç¤ºè§†åœ¨åŠŸç‡ï¼ˆcalcApparentä¸ºtrueï¼‰
            if (cardConfig && cardConfig.calcApparent && keys.length >= 2) {
                let apparentKey = null;
                let apparentValue = null;
                
                // æ ¹æ®å¡ç‰‡ç±»å‹ç¡®å®šè§†åœ¨åŠŸç‡å­—æ®µ
                if (titleKey === 'cardSystemAPower') {
                    apparentKey = 'f747'; // ç”µç½‘Aç›¸è§†åœ¨åŠŸç‡
                } else if (titleKey === 'cardSystemBPower') {
                    apparentKey = 'f748'; // ç”µç½‘Bç›¸è§†åœ¨åŠŸç‡
                } else if (titleKey === 'cardSystemCPower') {
                    apparentKey = 'f749'; // ç”µç½‘Cç›¸è§†åœ¨åŠŸç‡
                } else if (titleKey === 'cardLoadAPower') {
                    apparentKey = 'f770'; // è´Ÿè½½Aç›¸è§†åœ¨åŠŸç‡
                } else if (titleKey === 'cardLoadBPower') {
                    apparentKey = 'f771'; // è´Ÿè½½Bç›¸è§†åœ¨åŠŸç‡
                } else if (titleKey === 'cardLoadCPower') {
                    apparentKey = 'f772'; // è´Ÿè½½Cç›¸è§†åœ¨åŠŸç‡
                }
                
                // ä¼˜å…ˆä½¿ç”¨æ‰¹é‡æŸ¥è¯¢è·å–çš„è§†åœ¨åŠŸç‡æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¡ç®—
                if (apparentKey) {
                    let apparentPowerValue = null;
                    
                    if (data[apparentKey] !== undefined) {
                        // ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢è·å–çš„è§†åœ¨åŠŸç‡æ•°æ®
                        apparentPowerValue = data[apparentKey];
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¹é‡æŸ¥è¯¢çš„è§†åœ¨åŠŸç‡æ•°æ®ï¼Œåˆ™è®¡ç®—
                        const activeKey = keys[0]; // æœ‰åŠŸåŠŸç‡å­—æ®µ
                        const reactiveKey = keys[1]; // æ— åŠŸåŠŸç‡å­—æ®µ
                        const activePower = data[activeKey] !== undefined ? parseFloat(data[activeKey]) : 0;
                        const reactivePower = data[reactiveKey] !== undefined ? parseFloat(data[reactiveKey]) : 0;
                        
                        // è®¡ç®—è§†åœ¨åŠŸç‡ï¼šS = sqrt(P^2 + Q^2)
                        apparentPowerValue = Math.sqrt(activePower * activePower + reactivePower * reactivePower);
                    }
                    
                    // ä½¿ç”¨ç›¸åŒçš„å­—æ®µåå’Œæ˜¾ç¤ºæ–¹å¼ï¼Œåªä¿®æ”¹æ•°å€¼
                    apparentValue = formatParamValue(apparentKey, apparentPowerValue);
                    createParamItem(body, apparentKey, apparentValue);
                    total++;
                }
            }
            
            // å¦‚æœéœ€è¦æ˜¾ç¤ºæ€»è®¡ï¼ˆshowTotalä¸ºtrueï¼‰
            if (cardConfig && cardConfig.showTotal && keys.length > 0) {
                let totalValue = 0;
                let hasData = false;
                
                // å¯¹äºç”µç½‘è§†åœ¨å’Œè´Ÿè½½è§†åœ¨ï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿè®¡ç®—æ€»è®¡ï¼ˆä½¿ç”¨0ï¼‰
                const isApparentPower = titleKey === 'cardGridApparentPower' || titleKey === 'cardLoadApparentPower';
                
                keys.forEach(key => {
                    if (data.hasOwnProperty(key)) {
                        const value = parseFloat(data[key]) || 0;
                        totalValue += value;
                        hasData = true;
                    } else if (isApparentPower) {
                        // ç”µç½‘è§†åœ¨å’Œè´Ÿè½½è§†åœ¨ï¼Œæ²¡æœ‰æ•°æ®æ—¶ä½¿ç”¨0
                        totalValue += 0;
                        hasData = true;
                    }
                });
                
                // å¯¹äºç”µç½‘è§†åœ¨å’Œè´Ÿè½½è§†åœ¨ï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿæ˜¾ç¤ºæ€»è®¡
                if (hasData || isApparentPower) {
                    // æ ¹æ®å¡ç‰‡ç±»å‹ç¡®å®šæ€»è®¡æ ‡ç­¾
                    let totalLabelKey = '';
                    if (titleKey === 'cardGridActivePower') {
                        totalLabelKey = 'gridTotalActivePower';
                    } else if (titleKey === 'cardGridReactivePower') {
                        totalLabelKey = 'gridTotalReactivePower';
                    } else if (titleKey === 'cardGridApparentPower') {
                        totalLabelKey = 'gridTotalApparentPower';
                    } else if (titleKey === 'cardLoadActivePower') {
                        totalLabelKey = 'loadTotalActivePower';
                    } else if (titleKey === 'cardLoadReactivePower') {
                        totalLabelKey = 'loadTotalReactivePower';
                    } else if (titleKey === 'cardLoadApparentPower') {
                        totalLabelKey = 'loadTotalApparentPower';
                    } else {
                        totalLabelKey = currentLang === 'en' ? 'Total' : 'æ€»è®¡';
                    }
                    
                    const totalLabel = totalLabelKey ? t(totalLabelKey) : (currentLang === 'en' ? 'Total' : 'æ€»è®¡');
                    const totalFormatted = formatParamValue(keys[0], totalValue);
                    const unit = units[keys[0]] || '';
                    const item = document.createElement('div');
                    item.className = 'param-item';
                    item.style.borderTop = '1px solid #e8e8e8';
                    item.style.paddingTop = '8px';
                    item.style.marginTop = '8px';
                    item.style.fontWeight = '600';
                    item.innerHTML = `
                        <span class="param-name">${totalLabel}</span>
                        <span>
                            <span class="param-value">${totalFormatted}</span>
                            <span class="param-unit">${unit}</span>
                        </span>
                    `;
                    body.appendChild(item);
                    total++;
                }
            }
            
            // å¦‚æœéœ€è¦æ˜¾ç¤ºå¹³å‡å€¼ï¼ˆshowAverageä¸ºtrueï¼‰
            if (cardConfig && cardConfig.showAverage && keys.length > 0) {
                let sumValue = 0;
                let count = 0;
                
                keys.forEach(key => {
                    if (data.hasOwnProperty(key)) {
                        const value = parseFloat(data[key]) || 0;
                        sumValue += value;
                        count++;
                    }
                });
                
                // å³ä½¿æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿæ˜¾ç¤ºå¹³å‡å€¼ï¼ˆä¸º0ï¼‰
                if (count === 0) {
                    count = keys.length; // ä½¿ç”¨æ‰€æœ‰é”®çš„æ•°é‡
                }
                
                if (count > 0) {
                    const avgValue = sumValue / count;
                    // æ ¹æ®å¡ç‰‡ç±»å‹ç¡®å®šå¹³å‡å€¼æ ‡ç­¾
                    let avgLabelKey = '';
                    if (titleKey === 'cardGridPowerFactor') {
                        avgLabelKey = 'gridAvgPowerFactor';
                    } else if (titleKey === 'cardLoadPowerFactor') {
                        avgLabelKey = 'loadAvgPowerFactor';
                    } else {
                        avgLabelKey = currentLang === 'en' ? 'Average' : 'å¹³å‡å€¼';
                    }
                    
                    const avgLabel = avgLabelKey ? t(avgLabelKey) : (currentLang === 'en' ? 'Average' : 'å¹³å‡å€¼');
                    const avgFormatted = formatParamValue(keys[0], avgValue);
                    const unit = units[keys[0]] || '';
                    const item = document.createElement('div');
                    item.className = 'param-item';
                    item.style.borderTop = '1px solid #e8e8e8';
                    item.style.paddingTop = '8px';
                    item.style.marginTop = '8px';
                    item.style.fontWeight = '600';
                    item.innerHTML = `
                        <span class="param-name">${avgLabel}</span>
                        <span>
                            <span class="param-value">${avgFormatted}</span>
                            <span class="param-unit">${unit}</span>
                        </span>
                    `;
                    body.appendChild(item);
                    total++;
                }
            }

            // å¯¹äºç”µç½‘è§†åœ¨å’Œè´Ÿè½½è§†åœ¨ï¼Œå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿæ˜¾ç¤ºï¼ˆå·²æ˜¾ç¤º0ï¼‰ï¼Œæ‰€ä»¥totalä¸ä¼šä¸º0
            // å¯¹äºå…¶ä»–å¡ç‰‡ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®æ˜¾ç¤º"æš‚æ— æ•°æ®"
            if (total === 0 && titleKey !== 'cardGridApparentPower' && titleKey !== 'cardLoadApparentPower') {
                body.innerHTML = `<div class="info-card-empty">${t('infoCardEmpty')}</div>`;
            }

            card.appendChild(body);
            container.appendChild(card);
            return total;
        }

        // æ›´æ–°THDUå’ŒTHDIé¥¼çŠ¶å›¾
        function updateTHDPieCharts(data) {
            const thdu = data.f30 !== undefined ? parseFloat(data.f30) : 0;
            const thdi = data.f27 !== undefined ? parseFloat(data.f27) : 0;
            
            // THDUé¢œè‰²è§„åˆ™ï¼š0-5%ç»¿è‰², 5-10%é»„è‰², 10%ä»¥ä¸Šçº¢è‰²
            let thduColor = '#52c41a'; // ç»¿è‰²
            if (thdu >= 10) {
                thduColor = '#ff4d4f'; // çº¢è‰²
            } else if (thdu >= 5) {
                thduColor = '#faad14'; // é»„è‰²
            }
            
            // THDIé¢œè‰²è§„åˆ™ï¼š0-10%ç»¿è‰², 10-20%é»„è‰², 20%ä»¥ä¸Šçº¢è‰²
            let thdiColor = '#52c41a'; // ç»¿è‰²
            if (thdi >= 20) {
                thdiColor = '#ff4d4f'; // çº¢è‰²
            } else if (thdi >= 10) {
                thdiColor = '#faad14'; // é»„è‰²
            }
            
            // æ›´æ–°THDUé¥¼çŠ¶å›¾
            updateSinglePieChart('thduPieChart', 'thduValue', thdu, thduColor, 40);
            
            // æ›´æ–°THDIé¥¼çŠ¶å›¾
            updateSinglePieChart('thdiPieChart', 'thdiValue', thdi, thdiColor, 40);
        }
        
        // æ›´æ–°åŠŸç‡å› æ•°åœ†ç¯å›¾
        function updatePowerFactorRings(data) {
            // åœ†å‘¨é•¿ = 2 * PI * r = 2 * 3.14159 * 40 = 251.2
            const circumference = 251.2;
            
            // å½’ä¸€åŒ–ï¼šå…¼å®¹ä¸¤ç§ä¸ŠæŠ¥æ ¼å¼ï¼ˆ0~1 æˆ– 0~100ï¼‰ï¼Œå¹¶å–ç»å¯¹å€¼ä¸è£å‰ª
            const normalizePf = (v) => {
                const n = Math.abs(parseFloat(v));
                if (isNaN(n)) return 0;
                // è‹¥å€¼å·²åœ¨0~1ä¹‹é—´ï¼Œç›´æ¥ä½¿ç”¨ï¼›è‹¥å¤§äº1ï¼ˆä¸€èˆ¬ä¸º0~100ï¼‰ï¼ŒæŒ‰ç™¾åˆ†æ¯”æ¢ç®—
                const scaled = n <= 1.2 ? n : n / 100;
                return Math.max(0, Math.min(1, scaled));
            };

            const pfA = data.f03 !== undefined ? normalizePf(data.f03) : 0;
            const pfB = data.f06 !== undefined ? normalizePf(data.f06) : 0;
            const pfC = data.f09 !== undefined ? normalizePf(data.f09) : 0;
            
            // æ ¹æ®åŠŸç‡å› æ•°å€¼è¿”å›é¢œè‰²ï¼š>=0.95ä¼˜ç§€(ç»¿è‰²)ï¼Œ>=0.90ä¸”<0.95è‰¯å¥½(è“è‰²)ï¼Œ<0.90éœ€æ”¹å–„(æ©™è‰²)
            const getPfColor = (pf) => {
                if (pf >= 0.95) return '#52c41a';  // ä¼˜ç§€
                if (pf >= 0.90) return '#1890ff';  // è‰¯å¥½
                return '#faad14';  // éœ€æ”¹å–„
            };
            
            // æ›´æ–°ä¸»é¡µç•Œé¢çš„Aç›¸åŠŸç‡å› æ•°
            const ringAGrid = document.getElementById('pfRingAGrid');
            const valueAGrid = document.getElementById('pfValueAGrid');
            if (ringAGrid && valueAGrid) {
                const offsetA = circumference - (pfA * circumference);
                ringAGrid.style.strokeDashoffset = offsetA;
                valueAGrid.textContent = pfA.toFixed(2);
                ringAGrid.setAttribute('stroke', getPfColor(pfA));
            }
            
            // æ›´æ–°ä¸»é¡µç•Œé¢çš„Bç›¸åŠŸç‡å› æ•°
            const ringBGrid = document.getElementById('pfRingBGrid');
            const valueBGrid = document.getElementById('pfValueBGrid');
            if (ringBGrid && valueBGrid) {
                const offsetB = circumference - (pfB * circumference);
                ringBGrid.style.strokeDashoffset = offsetB;
                valueBGrid.textContent = pfB.toFixed(2);
                ringBGrid.setAttribute('stroke', getPfColor(pfB));
            }
            
            // æ›´æ–°ä¸»é¡µç•Œé¢çš„Cç›¸åŠŸç‡å› æ•°
            const ringCGrid = document.getElementById('pfRingCGrid');
            const valueCGrid = document.getElementById('pfValueCGrid');
            if (ringCGrid && valueCGrid) {
                const offsetC = circumference - (pfC * circumference);
                ringCGrid.style.strokeDashoffset = offsetC;
                valueCGrid.textContent = pfC.toFixed(2);
                ringCGrid.setAttribute('stroke', getPfColor(pfC));
            }
        }
        
        // æ›´æ–°è´Ÿè½½ç”µæµè°æ³¢å«é‡é¥¼çŠ¶å›¾ï¼ˆABCä¸‰ç›¸ç‹¬ç«‹çš„é¥¼çŠ¶å›¾ï¼‰
        function updateHarmonicPieChart(data) {
            // è·å–è´Ÿè½½ç”µæµè°æ³¢å«é‡æ•°æ®ï¼ˆf788, f789, f790ï¼‰
            const harmonicA = data.f788 !== undefined ? parseFloat(data.f788) : 0;
            const harmonicB = data.f789 !== undefined ? parseFloat(data.f789) : 0;
            const harmonicC = data.f790 !== undefined ? parseFloat(data.f790) : 0;
            
            // æ›´æ–°Aç›¸é¥¼çŠ¶å›¾
            updateSinglePieChart('pieChartGroupA', 'pieChartAValue', harmonicA, '#1890ff', 60);
            
            // æ›´æ–°Bç›¸é¥¼çŠ¶å›¾
            updateSinglePieChart('pieChartGroupB', 'pieChartBValue', harmonicB, '#52c41a', 60);
            
            // æ›´æ–°Cç›¸é¥¼çŠ¶å›¾
            updateSinglePieChart('pieChartGroupC', 'pieChartCValue', harmonicC, '#faad14', 60);
        }
        
        // æ›´æ–°å•ä¸ªé¥¼çŠ¶å›¾
        function updateSinglePieChart(groupId, valueId, value, color, radius) {
            const pieChartGroup = document.getElementById(groupId);
            const valueElement = document.getElementById(valueId);
            
            if (!pieChartGroup || !valueElement) return;
            
            // æ›´æ–°æ•°å€¼ï¼ˆæ˜¾ç¤ºæ•°å­—å’Œ%å•ä½ï¼‰
            valueElement.textContent = value > 0 ? value.toFixed(2) + '%' : '0.00%';
            
            // æ¸…é™¤æ—§çš„é¥¼çŠ¶å›¾
            pieChartGroup.innerHTML = '';
            
            // å¦‚æœå€¼ä¸º0ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€ï¼ˆç°è‰²åœ†åœˆï¼‰
            if (value === 0 || isNaN(value)) {
                const emptyCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                emptyCircle.setAttribute('cx', '0');
                emptyCircle.setAttribute('cy', '0');
                emptyCircle.setAttribute('r', radius);
                emptyCircle.setAttribute('fill', '#f0f0f0');
                emptyCircle.setAttribute('stroke', '#e8e8e8');
                emptyCircle.setAttribute('stroke-width', '2');
                pieChartGroup.appendChild(emptyCircle);
                return;
            }
            
            // ç»˜åˆ¶å®Œæ•´çš„é¥¼çŠ¶å›¾ï¼ˆ100%å¡«å……ï¼‰
            // ä½¿ç”¨ä¸¤ä¸ªæ‰‡å½¢ï¼šä¸€ä¸ªå¡«å……è‰²ï¼Œä¸€ä¸ªèƒŒæ™¯è‰²ï¼Œæ ¹æ®å€¼è°ƒæ•´å¡«å……è‰²çš„è§’åº¦
            const fillAngle = (value / 100) * 360; // å‡è®¾100%ä¸ºæ»¡åœ†
            
            // èƒŒæ™¯åœ†ï¼ˆç°è‰²ï¼‰
            const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bgCircle.setAttribute('cx', '0');
            bgCircle.setAttribute('cy', '0');
            bgCircle.setAttribute('r', radius);
            bgCircle.setAttribute('fill', '#f0f0f0');
            bgCircle.setAttribute('stroke', '#e8e8e8');
            bgCircle.setAttribute('stroke-width', '2');
            pieChartGroup.appendChild(bgCircle);
            
            // å¡«å……æ‰‡å½¢ï¼ˆæ ¹æ®å€¼æ˜¾ç¤ºï¼‰
            if (fillAngle > 0) {
                const path = createPieSlice(0, 0, radius, -90, -90 + fillAngle);
                const slice = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                slice.setAttribute('d', path);
                slice.setAttribute('fill', color);
                slice.setAttribute('stroke', '#ffffff');
                slice.setAttribute('stroke-width', '2');
                pieChartGroup.appendChild(slice);
            }
        }
        
        // åˆ›å»ºé¥¼çŠ¶å›¾æ‰‡å½¢è·¯å¾„
        function createPieSlice(cx, cy, radius, startAngle, endAngle) {
            const start = polarToCartesian(cx, cy, radius, endAngle);
            const end = polarToCartesian(cx, cy, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';
            
            return [
                'M', cx, cy,
                'L', start.x, start.y,
                'A', radius, radius, 0, largeArcFlag, 0, end.x, end.y,
                'Z'
            ].join(' ');
        }
        
        // æåæ ‡è½¬ç¬›å¡å°”åæ ‡
        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }
        
        // è·å–åŠŸç‡æ•°æ®å¡ç‰‡çš„SVGå›¾æ ‡
        function getPowerCardIcon(titleKey) {
            const iconMap = {
                'cardGridActivePower': `<svg width="20" height="20" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M397.6 794.1c0 25.83 1.42 46.4 4.27 61.72 2.84 15.33 7.22 27.48 13.13 36.44 5.91 8.98 13.89 15.99 23.97 21.01 10.06 5.04 25.82 9.96 47.28 14.77v32.17H197.99v-32.17c27.14-7 45.31-14.77 54.5-23.31 9.19-8.54 15.2-20.68 18.06-36.44 2.84-15.76 4.27-39.83 4.27-72.23V228.1c0-30.2-1.1-52.2-3.28-65.99-2.2-13.79-5.81-24.51-10.83-32.17-5.04-7.65-11.72-13.79-20.03-18.39-8.32-4.6-22.55-9.74-42.68-15.43V63.95h325.68c102.43 0 178.7 19.6 228.83 58.77 50.12 39.18 75.18 98.82 75.18 178.93 0 45.53-7.88 86.46-23.64 122.79-15.76 36.34-38.08 66.1-66.97 89.3-28.89 23.21-63.03 39.84-102.43 49.9-39.4 10.08-80.76 15.1-124.1 15.1-48.59 0-86.24-0.87-112.94-2.63V794.1z m0-272.49h76.17c49.46 0 90.28-6.45 122.46-19.37 32.17-12.91 56.8-34.36 73.87-64.35 17.07-29.98 25.61-69.7 25.61-119.18 0-37.64-5.04-69.05-15.1-94.22-10.07-25.17-23.97-45.41-41.69-60.74-17.73-15.32-38.85-26.15-63.36-32.5-24.52-6.34-51.22-9.52-80.11-9.52-43.34 0-75.95 0.88-97.84 2.63v397.25z"></path></svg>`,
                'cardGridReactivePower': `<svg width="20" height="20" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M567.57 760.91l17.78 25.91c9.14 13.21 17.78 25.15 25.91 35.82a343.422 343.422 0 0 0 26.16 30.48c9.31 9.65 18.11 17.44 26.42 23.37 8.3 5.92 16.17 10.16 23.62 12.7 7.45 2.54 14.56 3.81 21.34 3.81 18.62 0 34.71-3.48 48.26-10.41 13.54-6.95 26.59-16.51 39.12-28.7l24.39 31.5c-26.42 26.42-50.98 45.38-73.67 56.9-22.69 11.51-46.06 17.27-70.11 17.27-19.3 0-35.23-1.87-47.76-5.59-12.53-3.73-24.98-9.83-37.34-18.29-12.37-8.47-26.16-21.34-41.41-38.61-15.24-17.27-32.86-40.82-52.84-70.62l-36.07-53.35c-84.34-4.06-148.1-35.73-191.28-95.01-43.18-59.27-64.78-143.78-64.78-253.52 0-75.52 11.51-140.39 34.55-194.58 23.03-54.19 55.96-95.43 98.82-123.71C381.52 78 431.22 63.86 487.79 63.86c60.28 0 111.01 13.3 152.16 39.88 41.15 26.59 72.14 65.71 92.97 117.36 20.83 51.65 31.24 114.56 31.24 188.74 0 94.16-16.77 171.3-50.3 231.42-33.5 60.13-82.28 100.01-146.29 119.65zM309.99 410.36c0 103.98 15.15 183.07 45.47 237.26 30.31 54.19 74.6 81.29 132.85 81.29 36.91 0 68.24-11.76 93.99-35.31 25.74-23.54 45.04-58 57.92-103.39 12.87-45.38 19.31-98.39 19.31-159.02 0-73.83-7.54-135.05-22.61-183.66-15.08-48.6-35.65-83.91-61.73-105.93-26.09-22.01-56.39-33.02-90.94-33.02-30.48 0-56.65 7.11-78.49 21.34-21.85 14.23-39.97 34.47-54.36 60.71-14.4 26.25-24.89 58.01-31.5 95.26-6.61 37.26-9.91 78.74-9.91 124.47z"></path></svg>`,
                'cardGridApparentPower': `<svg width="20" height="20" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M317.38 750.49c8.55 37.63 20.09 67.34 34.63 89.15 14.53 21.81 33.35 37.95 56.44 48.42 23.09 10.48 52.8 15.71 89.15 15.71 50.03 0 88.4-13.04 115.13-39.12 26.72-26.08 40.09-64.14 40.09-114.16 0-32.07-5.56-59.01-16.68-80.81-11.12-21.81-29.29-42.33-54.52-61.57-25.23-19.24-63.72-41.69-115.45-67.35-50.03-24.79-89.58-49.07-118.65-72.8-29.08-23.73-50.78-49.49-65.1-77.29-14.33-27.79-21.49-58.14-21.49-91.08 0-47.88 11.22-89.47 33.67-124.75 22.45-35.28 55.37-62.53 98.77-81.78 43.39-19.24 93.1-28.86 149.12-28.86 32.49 0 64.24 1.71 95.24 5.13 31 3.43 69.8 11.12 116.41 23.09v173.17h-63.5c-9.84-37.62-22.24-66.91-37.2-87.87-14.97-20.94-32.5-35.6-52.59-43.93-20.1-8.34-46.18-12.51-78.25-12.51-27.8 0-52.7 5.13-74.72 15.39-22.03 10.26-39.44 25.77-52.27 46.5-12.83 20.74-19.24 45.44-19.24 74.08 0 30.37 5.45 56.02 16.36 76.96 10.9 20.96 27.9 40.41 50.99 58.37 23.09 17.96 57.29 38.06 102.62 60.29 54.73 27.37 97.17 52.81 127.31 76.32 30.14 23.52 53.66 50.35 70.55 80.49 16.89 30.14 25.33 65.32 25.33 105.51 0 44.9-7.06 82.85-21.17 113.84-14.11 31.01-33.67 56.23-58.69 75.68-25.01 19.46-54.95 33.57-89.79 42.33-34.85 8.76-73.02 13.15-114.49 13.15-67.13 0-144.53-11.32-232.18-33.99V750.49h64.17z"></path></svg>`,
                'cardGridPowerFactor': `<span class="power-factor-text">COSÏ†</span>`,
                // è´Ÿè½½å¡ç‰‡ä½¿ç”¨ç›¸åŒçš„å›¾æ ‡
                'cardLoadActivePower': `<svg width="20" height="20" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M397.6 794.1c0 25.83 1.42 46.4 4.27 61.72 2.84 15.33 7.22 27.48 13.13 36.44 5.91 8.98 13.89 15.99 23.97 21.01 10.06 5.04 25.82 9.96 47.28 14.77v32.17H197.99v-32.17c27.14-7 45.31-14.77 54.5-23.31 9.19-8.54 15.2-20.68 18.06-36.44 2.84-15.76 4.27-39.83 4.27-72.23V228.1c0-30.2-1.1-52.2-3.28-65.99-2.2-13.79-5.81-24.51-10.83-32.17-5.04-7.65-11.72-13.79-20.03-18.39-8.32-4.6-22.55-9.74-42.68-15.43V63.95h325.68c102.43 0 178.7 19.6 228.83 58.77 50.12 39.18 75.18 98.82 75.18 178.93 0 45.53-7.88 86.46-23.64 122.79-15.76 36.34-38.08 66.1-66.97 89.3-28.89 23.21-63.03 39.84-102.43 49.9-39.4 10.08-80.76 15.1-124.1 15.1-48.59 0-86.24-0.87-112.94-2.63V794.1z m0-272.49h76.17c49.46 0 90.28-6.45 122.46-19.37 32.17-12.91 56.8-34.36 73.87-64.35 17.07-29.98 25.61-69.7 25.61-119.18 0-37.64-5.04-69.05-15.1-94.22-10.07-25.17-23.97-45.41-41.69-60.74-17.73-15.32-38.85-26.15-63.36-32.5-24.52-6.34-51.22-9.52-80.11-9.52-43.34 0-75.95 0.88-97.84 2.63v397.25z"></path></svg>`,
                'cardLoadReactivePower': `<svg width="20" height="20" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M567.57 760.91l17.78 25.91c9.14 13.21 17.78 25.15 25.91 35.82a343.422 343.422 0 0 0 26.16 30.48c9.31 9.65 18.11 17.44 26.42 23.37 8.3 5.92 16.17 10.16 23.62 12.7 7.45 2.54 14.56 3.81 21.34 3.81 18.62 0 34.71-3.48 48.26-10.41 13.54-6.95 26.59-16.51 39.12-28.7l24.39 31.5c-26.42 26.42-50.98 45.38-73.67 56.9-22.69 11.51-46.06 17.27-70.11 17.27-19.3 0-35.23-1.87-47.76-5.59-12.53-3.73-24.98-9.83-37.34-18.29-12.37-8.47-26.16-21.34-41.41-38.61-15.24-17.27-32.86-40.82-52.84-70.62l-36.07-53.35c-84.34-4.06-148.1-35.73-191.28-95.01-43.18-59.27-64.78-143.78-64.78-253.52 0-75.52 11.51-140.39 34.55-194.58 23.03-54.19 55.96-95.43 98.82-123.71C381.52 78 431.22 63.86 487.79 63.86c60.28 0 111.01 13.3 152.16 39.88 41.15 26.59 72.14 65.71 92.97 117.36 20.83 51.65 31.24 114.56 31.24 188.74 0 94.16-16.77 171.3-50.3 231.42-33.5 60.13-82.28 100.01-146.29 119.65zM309.99 410.36c0 103.98 15.15 183.07 45.47 237.26 30.31 54.19 74.6 81.29 132.85 81.29 36.91 0 68.24-11.76 93.99-35.31 25.74-23.54 45.04-58 57.92-103.39 12.87-45.38 19.31-98.39 19.31-159.02 0-73.83-7.54-135.05-22.61-183.66-15.08-48.6-35.65-83.91-61.73-105.93-26.09-22.01-56.39-33.02-90.94-33.02-30.48 0-56.65 7.11-78.49 21.34-21.85 14.23-39.97 34.47-54.36 60.71-14.4 26.25-24.89 58.01-31.5 95.26-6.61 37.26-9.91 78.74-9.91 124.47z"></path></svg>`,
                'cardLoadApparentPower': `<svg width="20" height="20" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M317.38 750.49c8.55 37.63 20.09 67.34 34.63 89.15 14.53 21.81 33.35 37.95 56.44 48.42 23.09 10.48 52.8 15.71 89.15 15.71 50.03 0 88.4-13.04 115.13-39.12 26.72-26.08 40.09-64.14 40.09-114.16 0-32.07-5.56-59.01-16.68-80.81-11.12-21.81-29.29-42.33-54.52-61.57-25.23-19.24-63.72-41.69-115.45-67.35-50.03-24.79-89.58-49.07-118.65-72.8-29.08-23.73-50.78-49.49-65.1-77.29-14.33-27.79-21.49-58.14-21.49-91.08 0-47.88 11.22-89.47 33.67-124.75 22.45-35.28 55.37-62.53 98.77-81.78 43.39-19.24 93.1-28.86 149.12-28.86 32.49 0 64.24 1.71 95.24 5.13 31 3.43 69.8 11.12 116.41 23.09v173.17h-63.5c-9.84-37.62-22.24-66.91-37.2-87.87-14.97-20.94-32.5-35.6-52.59-43.93-20.1-8.34-46.18-12.51-78.25-12.51-27.8 0-52.7 5.13-74.72 15.39-22.03 10.26-39.44 25.77-52.27 46.5-12.83 20.74-19.24 45.44-19.24 74.08 0 30.37 5.45 56.02 16.36 76.96 10.9 20.96 27.9 40.41 50.99 58.37 23.09 17.96 57.29 38.06 102.62 60.29 54.73 27.37 97.17 52.81 127.31 76.32 30.14 23.52 53.66 50.35 70.55 80.49 16.89 30.14 25.33 65.32 25.33 105.51 0 44.9-7.06 82.85-21.17 113.84-14.11 31.01-33.67 56.23-58.69 75.68-25.01 19.46-54.95 33.57-89.79 42.33-34.85 8.76-73.02 13.15-114.49 13.15-67.13 0-144.53-11.32-232.18-33.99V750.49h64.17z"></path></svg>`,
                'cardLoadPowerFactor': `<span class="power-factor-text">COSÏ†</span>`
            };
            return iconMap[titleKey] || '';
        }
        
        // æ˜¾ç¤ºå‚æ•° - æŒ‰ç”¨æˆ·å®šä¹‰çš„åˆ†ç±»æ˜¾ç¤º
        function displayParams(data) {
            const gridPower = document.getElementById('paramsGridPower');      // ä¸»é¡µç•Œé¢
            const gridFunc = document.getElementById('paramsGridFunc');        // åŠŸç‡æ•°æ®
            const gridModule = document.getElementById('paramsGridModule');    // æ¨¡å—ä¿¡æ¯
            const gridVersion = document.getElementById('paramsGridVersion');  // ç‰ˆæœ¬ä¿¡æ¯
            
            // æ›´æ–°åŠŸç‡å› æ•°åœ†ç¯å›¾
            updatePowerFactorRings(data);
            
            // æ›´æ–°THDUå’ŒTHDIé¥¼çŠ¶å›¾
            updateTHDPieCharts(data);
            
            const cardLayouts = {
                power: [
                    { titleKey: 'cardGridVoltage', keys: ['f23', 'f24', 'f25'] },
                    { titleKey: 'cardGridCurrent', keys: ['f42', 'f43', 'f44'] },
                    { titleKey: 'cardLoadCurrent', keys: ['f39', 'f40', 'f41'] },
                    { titleKey: 'cardFrequency', keys: ['f28', 'f28', 'f28'] }
                ],
                func: [
                    { titleKey: 'cardGridActivePower', keys: ['f01', 'f04', 'f07'], showTotal: true },
                    { titleKey: 'cardGridReactivePower', keys: ['f02', 'f05', 'f08'], showTotal: true },
                    { titleKey: 'cardGridApparentPower', keys: ['f747', 'f748', 'f749'], showTotal: true },
                    { titleKey: 'cardGridPowerFactor', keys: ['f03', 'f06', 'f09'], showAverage: true },
                    { titleKey: 'cardLoadActivePower', keys: ['f54', 'f56', 'f58'], showTotal: true },
                    { titleKey: 'cardLoadReactivePower', keys: ['f55', 'f57', 'f59'], showTotal: true },
                    { titleKey: 'cardLoadApparentPower', keys: ['f770', 'f771', 'f772'], showTotal: true },
                    { titleKey: 'cardLoadPowerFactor', keys: ['f12', 'f15', 'f18'], showAverage: true }
                ],
                module: [
                    { titleKey: 'cardRunMode', keys: ['f60'] },
                    { titleKey: 'cardDeviceCurrent', keys: ['f36', 'f37', 'f38'] },
                    { titleKey: 'cardBusVoltage', keys: ['f31', 'f32', 'f33'] },
                    { titleKey: 'cardTemperature', keys: ['f29', 'f34', 'f35'] },
                    { titleKey: 'cardDeviceActivePower', keys: ['f10', 'f13', 'f16'], alignRight: true },
                    { titleKey: 'cardDeviceReactivePower', keys: ['f11', 'f14', 'f17'], alignRight: true },
                    { titleKey: 'cardDeviceApparentPower', keys: ['f753', 'f754', 'f755'], alignRight: true }
                ],
                version: [
                    { titleKey: 'cardVersionInfoTitle', keys: ['f19', 'f22', 'f26'] },
                    // ç”¨æˆ·æƒé™æ—¶éšè—è®¾å¤‡çŠ¶æ€å’Œæ•…éšœä¿¡æ¯
                    ...(currentRole === 'admin' ? [
                    { titleKey: 'cardDeviceStatus', keys: ['f20', 'f21', 'f52'] },
                    { titleKey: 'cardFaultInfo', keys: ['f48', 'f49', 'f50', 'f51', 'f53'] }
                    ] : [])
                ]
            };

            const containers = {
                power: gridPower,
                func: gridFunc,
                module: gridModule,
                version: gridVersion
            };

            const counts = { power: 0, func: 0, module: 0, version: 0 };

            Object.keys(cardLayouts).forEach(category => {
                const container = containers[category];
                container.innerHTML = '';

                // ç‰¹æ®Šå¤„ç†ï¼šæ¨¡å—ä¿¡æ¯éœ€è¦ä¸¤è¡Œå¸ƒå±€ï¼Œç¬¬äºŒè¡Œå³å¯¹é½ï¼ˆæ¡Œé¢ç«¯ï¼‰
                if (category === 'module') {
                    // æ£€æµ‹å±å¹•å®½åº¦ï¼Œå†³å®šå¸ƒå±€æ–¹å¼
                    const isMobile = window.innerWidth <= 768;
                    const isSmallMobile = window.innerWidth <= 480;
                    
                    // æ¡Œé¢ç«¯ï¼š4åˆ—å¸ƒå±€ï¼Œç¬¬äºŒè¡Œå³å¯¹é½
                    // ç§»åŠ¨ç«¯ï¼šç”±CSSåª’ä½“æŸ¥è¯¢æ§åˆ¶ï¼ˆ2åˆ—æˆ–1åˆ—ï¼‰ï¼Œä¸è®¾ç½®grid-column
                    if (!isMobile) {
                    container.style.gridTemplateColumns = 'repeat(4, 1fr)';
                    container.style.gridAutoFlow = 'row';
                    } else {
                        // ç§»åŠ¨ç«¯ï¼šæ¸…é™¤grid-columnè®¾ç½®ï¼Œè®©CSSåª’ä½“æŸ¥è¯¢æ§åˆ¶å¸ƒå±€
                        container.style.gridTemplateColumns = '';
                        container.style.gridAutoFlow = '';
                    }
                    
                    let rightAlignIndex = 0; // ç”¨äºè·Ÿè¸ªå³å¯¹é½å¡ç‰‡çš„ç´¢å¼•
                    
                    cardLayouts[category].forEach((card, index) => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'info-card';
                        // æ‰€æœ‰å¡ç‰‡éƒ½æ˜¾ç¤ºæ ‡é¢˜ï¼ŒåŠŸç‡æ•°æ®å¡ç‰‡åœ¨å³ä¸Šè§’æ·»åŠ å›¾æ ‡
                        const icon = (category === 'func') ? getPowerCardIcon(card.titleKey) : '';
                        cardElement.innerHTML = `<div class="info-card-header">${t(card.titleKey)}${icon ? `<span class="card-icon">${icon}</span>` : ''}</div>`;
                        const body = document.createElement('div');
                        body.className = 'info-card-body';
                        
                        // è¿è¡Œæ¨¡å¼å¡ç‰‡å†…å®¹å±…ä¸­
                        if (card.titleKey === 'cardRunMode') {
                            body.style.display = 'flex';
                            body.style.justifyContent = 'center';
                            body.style.alignItems = 'center';
                            // ç§»åŠ¨ç«¯å‡å°æœ€å°é«˜åº¦
                            body.style.minHeight = isSmallMobile ? '60px' : '80px';
                        }
                        
                        // æ¡Œé¢ç«¯ï¼šå¦‚æœæ˜¯ç¬¬äºŒè¡Œçš„å¡ç‰‡ï¼ˆalignRightä¸ºtrueï¼‰ï¼Œè®¾ç½®grid-columnä½¿å…¶å³å¯¹é½
                        // ç§»åŠ¨ç«¯ï¼šä¸è®¾ç½®grid-columnï¼Œè®©å¡ç‰‡è‡ªç„¶æ’åˆ—
                        if (card.alignRight && !isMobile) {
                            // ç¬¬äºŒè¡Œï¼šç¬¬1åˆ—ç©ºï¼Œç¬¬2-4åˆ—æ˜¾ç¤º3ä¸ªå¡ç‰‡ï¼ˆå³å¯¹é½ï¼‰
                            // è£…ç½®æœ‰åŠŸåœ¨ç¬¬2åˆ—ï¼Œè£…ç½®æ— åŠŸåœ¨ç¬¬3åˆ—ï¼Œè£…ç½®è§†åœ¨ç¬¬4åˆ—
                            cardElement.style.gridColumn = (2 + rightAlignIndex).toString();
                            rightAlignIndex++;
                        } else if (card.alignRight && isMobile) {
                            // ç§»åŠ¨ç«¯ï¼šæ¸…é™¤grid-columnï¼Œè®©CSSæ§åˆ¶å¸ƒå±€
                            cardElement.style.gridColumn = '';
                        }
                        
                        let cardTotal = 0;
                        card.keys.forEach((key, keyIndex) => {
                            // ç‰¹æ®Šå¤„ç†ï¼šè¿è¡Œæ¨¡å¼ï¼ˆf60ï¼‰åªæ˜¾ç¤ºå†…å®¹ï¼Œä¸æ˜¾ç¤º"å·¥ä½œæ¨¡å¼"æ ‡ç­¾
                            if (card.titleKey === 'cardRunMode' && key === 'f60') {
                                if (data.hasOwnProperty(key)) {
                                    let displayVal = data[key];
                                    // ç‰¹æ®Šå¤„ç†ï¼šè¿è¡Œæ¨¡å¼ï¼Œå¦‚æœ f60 ä¸ºç©ºï¼ˆ-ï¼‰ï¼Œå°è¯•ç”¨ f51 (å¯¹åº”åœ°å€513) æˆ–ç¼“å­˜
                                    if ((displayVal === '-' || displayVal === '_' || !displayVal)) {
                                        if (data.f51 && data.f51 !== '-' && data.f51 !== '_') {
                                            displayVal = data.f51;
                                        } else if (paramCache[513] !== undefined) {
                                            displayVal = paramCache[513];
                                        }
                                    }
                                    
                                    const value = formatParamValue(key, displayVal);
                                    // æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œå¸®åŠ©æ’æŸ¥æœåŠ¡å™¨è¿”å›çš„å…·ä½“æ•°å€¼
                                    if (key === 'f60') {
                                        addLog('debug', `[è¿è¡Œæ¨¡å¼] æœ€ç»ˆå–å€¼: ${displayVal} (åŸå§‹f60=${data[key]}, f51=${data.f51}), è½¬æ¢å: ${value}`);
                                    }
                                    const item = document.createElement('div');
                                    item.className = 'param-item';
                                    item.style.display = 'flex';
                                    item.style.justifyContent = 'center';
                                    item.style.alignItems = 'center';
                                    item.style.textAlign = 'center';
                                    item.style.width = '100%';
                                    item.innerHTML = `
                                        <span class="param-value" style="font-size: 18px; font-weight: 600; color: #262626;">${value}</span>
                                    `;
                                    body.appendChild(item);
                                    cardTotal++;
                                }
                            } else if (data.hasOwnProperty(key)) {
                                const value = formatParamValue(key, data[key]);
                                createParamItem(body, key, value);
                                cardTotal++;
                            } else if (key.startsWith('f78')) {
                                createParamItem(body, key, '0.00');
                                cardTotal++;
                            } else if (card.titleKey === 'cardDeviceApparentPower' && (key === 'f753' || key === 'f754' || key === 'f755')) {
                                let apparentPowerValue = null;
                                if (key === 'f753') {
                                    const activePower = data.f10 !== undefined ? parseFloat(data.f10) : 0;
                                    const reactivePower = data.f11 !== undefined ? parseFloat(data.f11) : 0;
                                    apparentPowerValue = Math.sqrt(activePower * activePower + reactivePower * reactivePower);
                                } else if (key === 'f754') {
                                    const activePower = data.f13 !== undefined ? parseFloat(data.f13) : 0;
                                    const reactivePower = data.f14 !== undefined ? parseFloat(data.f14) : 0;
                                    apparentPowerValue = Math.sqrt(activePower * activePower + reactivePower * reactivePower);
                                } else if (key === 'f755') {
                                    const activePower = data.f16 !== undefined ? parseFloat(data.f16) : 0;
                                    const reactivePower = data.f17 !== undefined ? parseFloat(data.f17) : 0;
                                    apparentPowerValue = Math.sqrt(activePower * activePower + reactivePower * reactivePower);
                                }
                                if (apparentPowerValue !== null) {
                                    const value = formatParamValue(key, apparentPowerValue);
                                    createParamItem(body, key, value);
                                    cardTotal++;
                                }
                            }
                        });
                        
                        if (cardTotal === 0) {
                            body.innerHTML = `<div class="info-card-empty">${t('infoCardEmpty')}</div>`;
                        }
                        
                        cardElement.appendChild(body);
                        container.appendChild(cardElement);
                        counts[category] += cardTotal;
                    });
                } else {
                    // å…¶ä»–åˆ†ç±»ä½¿ç”¨åŸæ¥çš„é€»è¾‘
                    cardLayouts[category].forEach(card => {
                        counts[category] += createInfoCard(container, card.titleKey, card.keys, data, card);
                    });
                }

                if (counts[category] === 0) {
                    container.innerHTML = `<div class="info-card"><div class="info-card-header">${t('infoCardEmpty')}</div><div class="info-card-body"><div class="info-card-empty">${t('infoCardWaiting')}</div></div></div>`;
                }
            });
            
            // æ›´æ–°æ•…éšœä¿¡æ¯æ¨ªå¹…ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è§ï¼‰
            updateFaultBanner(data);
        }
        
        // æ•…éšœçŠ¶æ€ä½å®šä¹‰ï¼ˆå½“ä½ä¸º0æ—¶è¡¨ç¤ºæœ‰æ•…éšœï¼‰- æ”¯æŒå¤šè¯­è¨€
        const faultBitDef = {
            zh: {
                // æ•…éšœçŠ¶æ€1 ä½8ä½ï¼ˆ0-7ä½ï¼‰å¯¹åº”æ•…éšœä¿¡æ¯2 (f51)
                f51: {
                    0: 'VPæ•…éšœ1',
                    1: 'ç›´æµè½¯ä»¶è¿‡å‹',
                    2: 'WPæ•…éšœ1',
                    3: 'ä¸Šåˆ†è£‚è¿‡å‹',
                    4: 'ä¸‹åˆ†è£‚è¿‡å‹',
                    5: 'UNæ•…éšœ2',
                    6: 'æ¨¡å—è¿‡æ¸©',
                    7: 'VNæ•…éšœ2'
                },
                // æ•…éšœçŠ¶æ€1 é«˜8ä½ï¼ˆ8-15ä½ï¼‰å¯¹åº”æ•…éšœä¿¡æ¯3 (f50) - ä¸f48å¯¹è°ƒ
                f50: {
                    0: 'Aç›¸ç¡¬ä»¶è¿‡æµ',  // bit8
                    1: 'Bç›¸ç¡¬ä»¶è¿‡æµ',
                    2: 'Cç›¸ç¡¬ä»¶è¿‡æµ',
                    3: '24vç”µæºå¼‚å¸¸',
                    4: 'INODV1',
                    5: 'INODV3',
                    6: 'UPæ•…éšœ1',
                    7: 'ç›´æµè½¯ä»¶æ¬ å‹'   // bit15
                },
                // æ•…éšœçŠ¶æ€2 ä½8ä½ï¼ˆ0-7ä½ï¼‰å¯¹åº”æ•…éšœä¿¡æ¯4 (f49)
                f49: {
                    0: 'ç”µç½‘ç”µå‹ä¸å¹³è¡¡',
                    1: 'ç”µç½‘é¢‘ç‡å¼‚å¸¸',
                    2: 'è£…ç½®ç”µæµè¿‡ä½',
                    3: 'Aç›¸ç¼ºç›¸',
                    4: 'Bç›¸ç¼ºç›¸',
                    5: 'Cç›¸ç¼ºç›¸',
                    6: 'ç”µç½‘ç›¸åºå¼‚å¸¸',
                    7: 'ä¿ç•™'
                },
                // æ•…éšœçŠ¶æ€2 é«˜8ä½ï¼ˆ8-15ä½ï¼‰å¯¹åº”æ•…éšœä¿¡æ¯5 (f48) - ä¸f50å¯¹è°ƒ
                f48: {
                    0: 'äº¤æµè½¯ä»¶æ¬ å‹',  // bit8
                    1: 'WNæ•…éšœ2',
                    2: 'æ€¥åœ',
                    3: 'äº¤æµè½¯ä»¶è¿‡å‹',
                    4: 'è¿‡è½½',
                    5: 'Aç›¸è½¯ä»¶è¿‡æµ',
                    6: 'Bç›¸è½¯ä»¶è¿‡æµ',
                    7: 'Cç›¸è½¯ä»¶è¿‡æµ'   // bit15
                }
            },
            en: {
                // Fault status 1 low 8 bits (0-7) correspond to fault info 2 (f51)
                f51: {
                    0: 'VP Fault 1',
                    1: 'DC Software Overvoltage',
                    2: 'WP Fault 1',
                    3: 'Upper Split Overvoltage',
                    4: 'Lower Split Overvoltage',
                    5: 'UN Fault 2',
                    6: 'Module Overtemperature',
                    7: 'VN Fault 2'
                },
                // Fault status 1 high 8 bits (8-15) correspond to fault info 3 (f50)
                f50: {
                    0: 'Phase A Hardware Overcurrent',  // bit8
                    1: 'Phase B Hardware Overcurrent',
                    2: 'Phase C Hardware Overcurrent',
                    3: '24V Power Supply Abnormal',
                    4: 'INODV1',
                    5: 'INODV3',
                    6: 'UP Fault 1',
                    7: 'DC Software Undervoltage'   // bit15
                },
                // Fault status 2 low 8 bits (0-7) correspond to fault info 4 (f49)
                f49: {
                    0: 'Grid Voltage Unbalance',
                    1: 'Grid Frequency Abnormal',
                    2: 'Device Current Too Low',
                    3: 'Phase A Missing',
                    4: 'Phase B Missing',
                    5: 'Phase C Missing',
                    6: 'Grid Phase Sequence Abnormal',
                    7: 'Reserved'
                },
                // Fault status 2 high 8 bits (8-15) correspond to fault info 5 (f48)
                f48: {
                    0: 'AC Software Undervoltage',  // bit8
                    1: 'WN Fault 2',
                    2: 'Emergency Stop',
                    3: 'AC Software Overvoltage',
                    4: 'Overload',
                    5: 'Phase A Software Overcurrent',
                    6: 'Phase B Software Overcurrent',
                    7: 'Phase C Software Overcurrent'   // bit15
                }
            }
        };
        
        // è·å–æ•…éšœåç§°ï¼ˆæ ¹æ®å½“å‰è¯­è¨€ï¼‰
        function getFaultName(key, bit) {
            const lang = faultBitDef[currentLang] ? currentLang : 'zh';
            const faultMap = faultBitDef[lang][key];
            if (faultMap && faultMap[bit] !== undefined) {
                return faultMap[bit];
            }
            // å¦‚æœå½“å‰è¯­è¨€æ²¡æœ‰ï¼Œå›é€€åˆ°ä¸­æ–‡
            return faultBitDef.zh[key] ? faultBitDef.zh[key][bit] : '';
        }
        
        // æ›´æ–°æ•…éšœä¿¡æ¯æ¨ªå¹…
        function updateFaultBanner(data) {
            const banner = document.getElementById('faultBanner');
            const title = document.getElementById('faultTitle');
            const details = document.getElementById('faultDetails');
            const icon = banner.querySelector('.fault-icon');
            
            // å¦‚æœæœåŠ¡å™¨æ¨¡å¼ä¸‹æ˜ç¡®è¿”å›æ²¡æœ‰å‘Šè­¦ï¼Œç›´æ¥æ˜¾ç¤ºæ­£å¸¸
            if (isUsingServerMode && data._serverWarn === false) {
                showNormalStatus(banner, icon, title, details, data);
                return;
            }

            // è§£ææ•…éšœä½ï¼Œæ”¶é›†æ•…éšœä¿¡æ¯
            const faults = [];
            const faultKeys = ['f51', 'f50', 'f49', 'f48'];  // æ•…éšœä¿¡æ¯2,3,4,5
            
            let allZero = true;
            let hasData = false;

            faultKeys.forEach(key => {
                const value = data[key];
                if (value !== undefined) {
                    hasData = true;
                    if (parseInt(value) !== 0) allZero = false;
                }

                const lang = faultBitDef[currentLang] ? currentLang : 'zh';
                if (value !== undefined && faultBitDef[lang] && faultBitDef[lang][key]) {
                    const byteValue = parseInt(value);
                    
                    // æ£€æŸ¥æ¯ä¸€ä½ï¼ˆ0-7ä½ï¼‰
                    for (let bit = 0; bit < 8; bit++) {
                        // ä½ä¸º0è¡¨ç¤ºæœ‰æ•…éšœ
                        if (((byteValue >> bit) & 1) === 0) {
                            const faultName = getFaultName(key, bit);
                            // æ’é™¤"ä¿ç•™"å’Œ"Reserved"
                            if (faultName && faultName !== 'ä¿ç•™' && faultName !== 'Reserved') {
                                faults.push(faultName);
                            }
                        }
                    }
                }
            });

            // å¦‚æœæ‰€æœ‰æ•…éšœå¯„å­˜å™¨éƒ½æ˜¯0ä¸”æ²¡æœ‰çŠ¶æ€æ•°æ®ï¼Œå¯èƒ½æ˜¯æœªæ”¶åˆ°çœŸå®æ•°æ®ï¼Œä¸æ˜¾ç¤ºæ•…éšœ
            const finalFaults = (allZero && hasData && faults.length > 10) ? [] : faults;
            
            // æ ¹æ®æ•…éšœæƒ…å†µæ˜¾ç¤ºæ¨ªå¹…
            if (finalFaults.length > 0) {
                // æœ‰æ•…éšœï¼šçº¢è‰²è­¦å‘Š
                banner.className = 'fault-banner active';
                icon.textContent = 'âš ï¸';
                icon.className = 'fault-icon';  // é‡ç½®å›¾æ ‡ç±»åï¼Œç§»é™¤æ—‹è½¬åŠ¨ç”»
                title.textContent = t('faultCountLabel').replace('{count}', finalFaults.length);
                
                // å¯åŠ¨æ»šåŠ¨æ˜¾ç¤º
                startFaultScroll(finalFaults);
            } else if (data.f20 !== undefined || data.f51 !== undefined || (isUsingServerMode && hasData)) {
                showNormalStatus(banner, icon, title, details, data);
            } else {
                // æ— æ•°æ®ï¼šéšè—æ¨ªå¹…
                banner.className = 'fault-banner';
                icon.className = 'fault-icon';  // é‡ç½®å›¾æ ‡ç±»å
                stopFaultScroll();
                title.textContent = t('faultDetectingTitle');
                details.textContent = t('faultDetectingDetails');
            }
        }

        // æ˜¾ç¤ºæ­£å¸¸çŠ¶æ€ï¼ˆå¤ä½/è¿è¡Œ/å¾…æœºï¼‰
        function showNormalStatus(banner, icon, title, details, data) {
            // æ— æ•…éšœï¼šæ ¹æ®è®¾å¤‡è¿è¡ŒçŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
            banner.className = 'fault-banner active normal';
            icon.textContent = 'âœ…';
            
            // ä¼˜å…ˆæ£€æŸ¥å¤ä½çŠ¶æ€ï¼šf20ï¼ˆçŠ¶æ€ï¼‰ä¸º247è¡¨ç¤ºè®¾å¤‡æ­£åœ¨å¤ä½
            const isResetting = data.f20 === 247;
            
            if (isResetting) {
                // è®¾å¤‡å¤ä½ä¸­ï¼šæ˜¾ç¤ºæ—‹è½¬çš„é½¿è½®å›¾æ ‡
                icon.textContent = 'ğŸ”„';
                icon.className = 'fault-icon running-gear';
                title.textContent = t('deviceResettingTitle');
                details.innerHTML = `<div style="display: inline-block;">${t('deviceResettingDesc')}</div>`;
            } else {
                // åˆ¤æ–­è®¾å¤‡æ˜¯å¦æ­£åœ¨è¿è¡Œ
                // deviceLimitä¸­åŒ…å«'run'è¡¨ç¤ºå¯åŠ¨æŒ‰é’®ç¦ç”¨ï¼Œå³è®¾å¤‡æ­£åœ¨è¿è¡Œ
                const isRunning = deviceLimit.includes('run');
                
                if (isRunning) {
                    // è®¾å¤‡è¿è¡Œä¸­ï¼šæ˜¾ç¤ºæ—‹è½¬çš„é½¿è½®å›¾æ ‡
                    icon.textContent = 'âš™ï¸';
                    icon.className = 'fault-icon running-gear';
                    title.textContent = t('deviceRunningTitle');
                    details.innerHTML = `<div style="display: inline-block;">${t('deviceRunningDesc')}</div>`;
                } else {
                    // è®¾å¤‡å¾…æœºï¼šæ˜¾ç¤ºå¯¹å‹¾å›¾æ ‡
                    icon.textContent = 'âœ…';
                    icon.className = 'fault-icon';
                    title.textContent = t('deviceStandbyTitle');
                    details.innerHTML = `<div style="display: inline-block;">${t('deviceStandbyDesc')}</div>`;
                }
            }
            
            // åœæ­¢æ»šåŠ¨
            stopFaultScroll();
        }
        
        let lastFaultsStr = '';  // è®°å½•ä¸Šæ¬¡çš„æ•…éšœåˆ—è¡¨ï¼Œç”¨äºæ¯”è¾ƒ
        
        // å¯åŠ¨æ•…éšœæ¨ªå‘æ»šåŠ¨æ˜¾ç¤ºï¼ˆä»…æ˜¾ç¤ºå·¦ä¾§ä¸€æ®µï¼Œä¸æ»šåŠ¨ï¼‰
        function startFaultScroll(faults) {
            // å°†æ•…éšœåˆ—è¡¨è½¬ä¸ºå­—ç¬¦ä¸²ç”¨äºæ¯”è¾ƒ
            const faultsStr = faults.join('|');
            
            // å¦‚æœæ•…éšœåˆ—è¡¨æ²¡æœ‰å˜åŒ–ï¼Œä¸æ›´æ–°æ˜¾ç¤º
            if (faultsStr === lastFaultsStr) {
                return;  // æ•…éšœæœªå˜åŒ–ï¼Œä¿æŒå½“å‰æ˜¾ç¤º
            }
            
            // æ•…éšœåˆ—è¡¨æœ‰å˜åŒ–ï¼Œæ›´æ–°æ˜¾ç¤º
            lastFaultsStr = faultsStr;
            const details = document.getElementById('faultDetails');
            
            // åˆ›å»ºæ•…éšœæ˜¾ç¤ºå†…å®¹ï¼ˆåªæ˜¾ç¤ºä¸€æ®µï¼Œä¸æ»šåŠ¨ï¼‰
            const scrollText = faults.map((fault, index) => 
                `${fault} (${index + 1}/${faults.length})`
            ).join('ã€€ã€€ã€€');  // ç”¨å…¨è§’ç©ºæ ¼åˆ†éš”å„æ•…éšœé¡¹
            
            // åªæ˜¾ç¤ºå·¦ä¾§ä¸€æ®µï¼Œä¸ä½¿ç”¨æ»šåŠ¨åŠ¨ç”»
            details.innerHTML = `<div style="display: inline-block;">${scrollText}</div>`;
        }
        
        // åœæ­¢æ•…éšœæ»šåŠ¨
        function stopFaultScroll() {
            lastFaultsStr = '';  // é‡ç½®æ•…éšœåˆ—è¡¨è®°å½•
        }
        
        // åˆ›å»ºå‚æ•°é¡¹ï¼ˆå•ä½åœ¨æ•°æ®å³ä¾§ï¼‰
        function createParamItem(grid, key, value) {
            const item = document.createElement('div');
            item.className = 'param-item';
            item.innerHTML = `
                <span class="param-name">${getFeatureName(key)}</span>
                <span>
                    <span class="param-value">${value}</span>
                    <span class="param-unit">${units[key] || ''}</span>
                </span>
            `;
            grid.appendChild(item);
        }
        
        // Tabåˆ‡æ¢
        function switchTab(index) {
            // æ›´æ–°å½“å‰ä¸»Tabç´¢å¼•
            currentMainTab = index;
            
            // æ›´æ–°Tabæ ·å¼ï¼ˆä½¿ç”¨IDç²¾ç¡®é€‰æ‹©ä¸»tabå¡ç‰‡ï¼‰
            const mainCard = document.getElementById('mainTabCard');
            if (mainCard) {
                const tabs = mainCard.querySelectorAll(':scope > div:first-child > .tab-item');
                tabs.forEach((item, i) => {
                    if (i === index) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹ï¼ˆåªé’ˆå¯¹ä¸»tabçš„å†…å®¹ï¼‰
            for (let i = 0; i <= 4; i++) {
                const tabContent = document.getElementById('tab' + i);
                if (tabContent) {
                    tabContent.style.display = i === index ? 'block' : 'none';
                }
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°å‚æ•°è®¾ç½®tabï¼ˆindex=3ï¼‰ï¼ŒåŠ è½½å‚æ•°è®¾ç½®å†…å®¹
            if (index === 3) {
                loadParamSettings();
                // å»¶è¿Ÿåº”ç”¨ç§»åŠ¨ç«¯æ ·å¼å’Œæƒé™æ§åˆ¶ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                setTimeout(() => {
                    applyMobileStyles();
                    applyRolePermissions(); // ç¡®ä¿å•å‚æ•°è®¾ç½®tabæ ¹æ®æƒé™æ˜¾ç¤º/éšè—
                }, 100);
            } else {
                // åˆ‡æ¢åˆ°å…¶ä»–Tabæ—¶ä¹Ÿåº”ç”¨æ ·å¼ï¼ˆä»¥é˜²çª—å£å¤§å°å˜åŒ–ï¼‰
                setTimeout(() => {
                    applyMobileStyles();
                }, 50);
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°åŠŸç‡ä¿¡æ¯é¡µé¢ï¼ˆindex=1ï¼‰ï¼Œå‘é€å¯¹åº”çš„æ‰¹é‡æŸ¥è¯¢
            if (ws && ws.readyState === 1) {
                const serial = document.getElementById('deviceSerial')?.value || '1';
                if (index === 1) {
                    // åŠŸç‡ä¿¡æ¯é¡µé¢ï¼šå‘é€747-778çš„æ‰¹é‡æŸ¥è¯¢
                    setTimeout(() => {
                        queryPowerData(serial);
                    }, 200);
                }
            }
        }
        
        // åŠ è½½å‚æ•°è®¾ç½®å†…å®¹
        function loadParamSettings(forceRefresh = false) {
            if (forceRefresh) {
                paramTabsLoaded = false;
            }

            if (paramTabsLoaded) {
                switchParamTab(currentParamTabIndex);
                return;
            }

            const generators = [
                getCompSettingHTML,
                getSystemParamHTML,
                getSampleSettingHTML,
                getHarmonicSettingHTML,
                getSingleParamHTML,
                getPasswordManageHTML
            ];

            generators.forEach((generator, index) => {
                const html = generator();
                document.querySelectorAll(`.param-tab-panel[data-param-tab="${index}"]`).forEach(panel => {
                    panel.innerHTML = html;
                });
            });

            paramTabsLoaded = true;
            
            // ç«‹å³å¼ºåˆ¶éšè—å¯†ç ç®¡ç†tabï¼ˆå¦‚æœéè¶…çº§ç®¡ç†å‘˜ï¼‰ï¼Œåœ¨åˆ‡æ¢tabä¹‹å‰
            if (currentRole !== 'superadmin') {
                document.querySelectorAll('.password-manage-tab').forEach(tabItem => {
                    tabItem.style.setProperty('display', 'none', 'important');
                    tabItem.classList.add('hidden-by-role');
                });
                // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯å¯†ç ç®¡ç†tabï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªtab
                if (currentParamTabIndex === 5) {
                    currentParamTabIndex = 0;
                }
            }
            
            switchParamTab(currentParamTabIndex);
            
            // åˆå§‹åŒ–è°æ³¢ç»„çŠ¶æ€æ 
            setTimeout(() => {
                updateHarmonicGroupsStatusBar();
                // åº”ç”¨æƒé™æ§åˆ¶ï¼ˆç¡®ä¿çŠ¶æ€æ æ ¹æ®æƒé™æ˜¾ç¤º/éšè—ï¼‰
                applyRolePermissions();
                // å¼ºåˆ¶éšè—å¯†ç ç®¡ç†tabï¼ˆå¦‚æœéè¶…çº§ç®¡ç†å‘˜ï¼‰
                if (currentRole !== 'superadmin') {
                    document.querySelectorAll('.password-manage-tab').forEach(tabItem => {
                        tabItem.style.setProperty('display', 'none', 'important');
                        tabItem.classList.add('hidden-by-role');
                    });
                }
            }, 100);
            
            // åº”ç”¨ç§»åŠ¨ç«¯æ ·å¼
            setTimeout(() => {
                applyMobileStyles();
            }, 100);
        }
        
        // åº”ç”¨ç§»åŠ¨ç«¯æ ·å¼
        function applyMobileStyles() {
            const isMobile = window.innerWidth <= 768;
            const isPhone = window.innerWidth <= 480;
            
            // ç§»åŠ¨ç«¯éšè—æ‰‹æœºè®¿é—®æŒ‰é’®
            const btnMobile = document.getElementById('btnMobile');
            if (btnMobile) {
                btnMobile.style.display = isMobile ? 'none' : '';
            }
            
            if (!isMobile) return;
            
            // å‚æ•°è®¾ç½®Tabå¯¼èˆªå®¹å™¨ - ç§»åŠ¨ç«¯æ¢è¡Œæ˜¾ç¤ºï¼ˆä½¿ç”¨classé€‰æ‹©å™¨ï¼‰
            document.querySelectorAll('.param-sub-tab-nav').forEach(tabNav => {
                tabNav.style.display = 'flex';
                tabNav.style.flexWrap = 'wrap';
                tabNav.style.gap = isPhone ? '6px' : '8px';
            });
            
            // å‚æ•°è®¾ç½®Tabé¡¹ - ç§»åŠ¨ç«¯ä¸¤åˆ—æ˜¾ç¤ºï¼ˆæ’é™¤éšè—çš„å•å‚æ•°è®¾ç½®tabï¼‰
            document.querySelectorAll('.param-sub-tab-item:not(.hidden-by-role)').forEach(tabItem => {
                const width = `calc(50% - ${isPhone ? '3px' : '4px'})`;
                tabItem.style.flex = `1 1 ${width}`;
                tabItem.style.minWidth = width;
                tabItem.style.maxWidth = width;
                tabItem.style.textAlign = 'center';
                tabItem.style.whiteSpace = 'normal';
                tabItem.style.wordBreak = 'break-word';
                tabItem.style.flexShrink = '1';
                tabItem.style.padding = isPhone ? '8px 6px' : '10px 8px';
                tabItem.style.fontSize = isPhone ? '12px' : '13px';
            });
            
            // ç¡®ä¿éšè—çš„å•å‚æ•°è®¾ç½®tabä¿æŒéšè—
            document.querySelectorAll('.single-param-tab.hidden-by-role').forEach(tabItem => {
                tabItem.style.display = 'none';
            });
            
            // è¡¥å¿ä¸è‡ªå¯åŠ¨ - ç§»é™¤max-widthé™åˆ¶
            document.querySelectorAll('.param-tab-panel[data-param-tab="0"] > div, #paramTabMain0 > div, #paramTabDialog0 > div').forEach(div => {
                const style = div.getAttribute('style') || '';
                if (style.includes('max-width')) {
                    div.style.maxWidth = '100%';
                    div.style.width = '100%';
                }
            });
            
            // é‡‡æ ·å‚æ•°æ”¹ä¸ºå•åˆ—
            document.querySelectorAll('.param-tab-panel[data-param-tab="1"] > div, #paramTabMain1 > div, #paramTabDialog1 > div').forEach(div => {
                const style = div.getAttribute('style') || '';
                if (style.includes('grid-template-columns') || style.includes('display: grid')) {
                    div.style.gridTemplateColumns = '1fr';
                    div.style.gap = '20px';
                }
                if (style.includes('max-width')) {
                    div.style.maxWidth = '100%';
                    div.style.width = '100%';
                }
            });
            
            // è°æ³¢ç»„æ”¹ä¸ºå•åˆ—
            document.querySelectorAll('.param-tab-panel[data-param-tab="2"] > div, #paramTabMain2 > div, #paramTabDialog2 > div').forEach(div => {
                const style = div.getAttribute('style') || '';
                if (style.includes('grid-template-columns') || style.includes('display: grid')) {
                    div.style.gridTemplateColumns = '1fr';
                    div.style.gap = '15px';
                }
                if (style.includes('max-width')) {
                    div.style.maxWidth = '100%';
                    div.style.width = '100%';
                }
            });
            
            // æŒ‰é’®ç»„åœ¨ç§»åŠ¨ç«¯å‚ç›´æ’åˆ—
            document.querySelectorAll('.param-setting-item > div[style*="display: flex"]').forEach(btnGroup => {
                if (isPhone) {
                    btnGroup.style.flexDirection = 'column';
                    btnGroup.style.gap = '8px';
                } else {
                    btnGroup.style.flexWrap = 'wrap';
                    btnGroup.style.gap = '8px';
                }
            });
        }
        
        // æŸ¥è¯¢å‚æ•°
        async function queryParam(funcCode, fieldId) {
            // å¦‚æœæ˜¯æœåŠ¡å™¨æ¨¡å¼ï¼Œé€šè¿‡ API æŸ¥è¯¢
            if (isUsingServerMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const devId = urlParams.get('id');
                
                if (!devId) {
                    addLog('error', 'âŒ æœåŠ¡å™¨æ¨¡å¼ä¸‹æŸ¥è¯¢å‚æ•°éœ€è¦ URL åŒ…å« id å‚æ•°');
                    return;
                }

                addLog('info', `ğŸ“¡ æœåŠ¡å™¨æ¨¡å¼ï¼šæ­£åœ¨æŸ¥è¯¢åŠŸèƒ½ç  ${funcCode}...`);
                
                try {
                    // 1. å‘é€åŒæ­¥æŒ‡ä»¤
                    await fetch(`/admin/dash/cmd?id=${devId}&cmd=${funcCode}&mode=syn`);
                    
                    // 2. è½®è¯¢è·å–ç»“æœ (å°è¯• 5 æ¬¡)
                    let val = null;
                    for (let i = 0; i < 5; i++) {
                        await new Promise(r => setTimeout(r, 1000));
                        const res = await fetch(`/admin/dash/sync?id=${devId}&addr=${funcCode}`).then(r => r.json());
                        if (res.code === 0 && res.result && res.result.val !== undefined && res.result.val !== null) {
                            val = res.result.val;
                            break;
                        }
                    }

                    if (val !== null) {
                        addLog('info', `âœ… æŸ¥è¯¢æˆåŠŸï¼šåŠŸèƒ½ç  ${funcCode} = ${val}`);
                        // å­˜å…¥ç¼“å­˜
                        paramCache[funcCode] = val;
                        
                        const element = document.getElementById(fieldId);
                        if (element) {
                            element.value = formatParamValueForDisplay(funcCode, val, fieldId);
                        }
                    } else {
                        addLog('warn', `âš ï¸ æŸ¥è¯¢è¶…æ—¶ï¼šæœªæ”¶åˆ°åŠŸèƒ½ç  ${funcCode} çš„è®¾å¤‡å“åº”`);
                    }
                } catch (error) {
                    addLog('error', `âŒ æŸ¥è¯¢å¼‚å¸¸: ${error.message}`);
                }
                return;
            }

            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnectedSimple'));
                return;
            }
            
            const serial = parseInt(document.getElementById('deviceSerial').value) || 1;
            const cmdHex = buildQueryCmd(serial, funcCode);
            
            addLog('info', `ğŸ“¤ æŸ¥è¯¢åŠŸèƒ½ç ${funcCode}ï¼ŒæŒ‡ä»¤: ${cmdHex.toUpperCase()}`);
            
            // å‘é€æŸ¥è¯¢å‘½ä»¤
            const bytes = new Uint8Array(cmdHex.match(/.{2}/g).map(b => parseInt(b, 16)));
            ws.send(bytes.buffer);
            
            // è®°å½•ç­‰å¾…çš„æŸ¥è¯¢
            pendingQueries[funcCode] = {
                fieldId: fieldId,
                timestamp: Date.now()
            };
            
            addLog('info', 'â³ ç­‰å¾…è®¾å¤‡å“åº”...');
        }
        
        // ä¿å­˜å‚æ•°
        async function saveParam(funcCode, fieldId) {
            const element = document.getElementById(fieldId);
            const value = element.value;
            
            if (!value && value !== '0') {
                alert(t('alertEnterValue'));
                return;
            }

            const val = parseDisplayValueToNumber(funcCode, value, fieldId);
            if (val === null || val === undefined) {
                alert(t('alertEnterValue'));
                return;
            }

            // å¦‚æœæ˜¯æœåŠ¡å™¨æ¨¡å¼ï¼Œé€šè¿‡ API ä¿å­˜
            if (isUsingServerMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const devId = urlParams.get('id');
                
                if (!devId) {
                    addLog('error', 'âŒ æœåŠ¡å™¨æ¨¡å¼ä¸‹ä¿å­˜å‚æ•°éœ€è¦ URL åŒ…å« id å‚æ•°');
                    return;
                }

                addLog('info', `ğŸ“¡ æœåŠ¡å™¨æ¨¡å¼ï¼šæ­£åœ¨ä¿å­˜åŠŸèƒ½ç  ${funcCode}ï¼Œå€¼: ${val}...`);
                
                try {
                    const res = await fetch(`/admin/dash/cmd?id=${devId}&cmd=${funcCode}&val=${val}&mode=pam`).then(r => r.json());
                    if (res.code === 0) {
                        addLog('info', `âœ… ä¿å­˜æŒ‡ä»¤å‘é€æˆåŠŸ (${funcCode}=${val})`);
                        // å»¶è¿Ÿåè‡ªåŠ¨æŸ¥è¯¢éªŒè¯
                        setTimeout(() => {
                            queryParam(funcCode, fieldId);
                        }, 2000);
                    } else {
                        addLog('error', `âŒ ä¿å­˜æŒ‡ä»¤å‘é€å¤±è´¥: ${res.msg || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } catch (error) {
                    addLog('error', `âŒ ä¿å­˜è¯·æ±‚å¼‚å¸¸: ${error.message}`);
                }
                return;
            }

            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnectedSimple'));
                return;
            }
            const cmdHex = buildSetCmd(serial, funcCode, val);
            
            addLog('info', `ğŸ“¤ ä¿å­˜åŠŸèƒ½ç ${funcCode}ï¼Œå€¼: ${val}ï¼ŒæŒ‡ä»¤: ${cmdHex.toUpperCase()}`);
            
            // å‘é€è®¾ç½®å‘½ä»¤
            const bytes = new Uint8Array(cmdHex.match(/.{2}/g).map(b => parseInt(b, 16)));
            ws.send(bytes.buffer);
            
            addLog('info', 'âœ… ä¿å­˜å‘½ä»¤å·²å‘é€');
            
            // å»¶è¿Ÿåè‡ªåŠ¨æŸ¥è¯¢éªŒè¯
            setTimeout(() => {
                queryParam(funcCode, fieldId);
            }, 1000);
        }
        
        // æ‰¹é‡æŸ¥è¯¢ï¼ˆä½¿ç”¨E2åè®®ï¼‰
        // æ”¯æŒä¸è¿ç»­çš„åŠŸèƒ½ç ï¼Œè‡ªåŠ¨åˆ†æˆå¤šæ¬¡æŸ¥è¯¢
        // å¦‚æœæä¾›äº†callbackå‚æ•°ï¼Œåˆ™è°ƒç”¨å›è°ƒå‡½æ•°è€Œä¸æ˜¯è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†
        async function batchQuery(funcCodes, callback = null) {
            // å¦‚æœæ˜¯æœåŠ¡å™¨æ¨¡å¼ï¼Œé€šè¿‡ API æŸ¥è¯¢
            if (isUsingServerMode || window.isUsingServerMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const devId = urlParams.get('id');
                if (!devId) {
                    addLog('error', 'âŒ æœåŠ¡å™¨æ¨¡å¼ä¸‹æ‰¹é‡æŸ¥è¯¢éœ€è¦ URL åŒ…å« id å‚æ•°');
                    return;
                }

                // å°†åŠŸèƒ½ç åˆ†ç»„ï¼Œé¿å…æŸ¥è¯¢èŒƒå›´è¿‡å¤§å¯¼è‡´è¶…æ—¶
                const sortedCodes = [...funcCodes].sort((a, b) => a - b);
                const groups = [];
                if (sortedCodes.length > 0) {
                    let currentGroup = [sortedCodes[0]];
                    for (let i = 1; i < sortedCodes.length; i++) {
                        // å¦‚æœä¸¤ä¸ªç ä¹‹é—´å·®è·è¶…è¿‡ 50ï¼Œåˆ™åˆ†æ®µ
                        if (sortedCodes[i] - sortedCodes[i-1] > 50) {
                            groups.push(currentGroup);
                            currentGroup = [sortedCodes[i]];
                        } else {
                            currentGroup.push(sortedCodes[i]);
                        }
                    }
                    groups.push(currentGroup);
                }

                addLog('info', `ğŸ“¡ æœåŠ¡å™¨æ¨¡å¼ï¼šæ­£åœ¨åˆ† ${groups.length} ç»„è¿›è¡Œæ‰¹é‡æŸ¥è¯¢...`);
                
                try {
                    const allResults = [];
                    for (const group of groups) {
                        const startAddr = group[0];
                        const endAddr = group[group.length - 1];
                        const count = endAddr - startAddr + 1;
                        
                        addLog('info', `â³ æ­£åœ¨æŸ¥è¯¢å¯„å­˜å™¨ ${startAddr} - ${endAddr}...`);
                        
                        // ä¿®æ­£ï¼šç»Ÿä¸€ä½¿ç”¨ GET æ–¹å¼è¯·æ±‚ï¼Œå¢åŠ å…¼å®¹æ€§
                        const submitRes = await fetch(`/admin/dash/cmd?id=${devId}&startAddr=${startAddr}&count=${count}&mode=batchQueryAsync`).then(r => r.json());
                        
                        // ä¿®æ­£ï¼šæ ¹æ®æœåŠ¡å™¨å®é™…è¿”å›ç»“æ„ï¼Œä» .result ä¸­æå– taskId
                        const resData = submitRes.result || submitRes.data || submitRes;
                        const taskId = resData.taskId;
                        
                        if (submitRes.code !== 0 || !taskId) {
                            addLog('error', `âŒ ç»„ ${startAddr} æäº¤å¤±è´¥: ${submitRes.message || submitRes.msg || 'è¿”å›æ ¼å¼é”™è¯¯'}`);
                            continue;
                        }

                        addLog('info', `â³ ä»»åŠ¡å·²æäº¤ï¼ŒID: ${taskId}ï¼Œå¼€å§‹è½®è¯¢ç»“æœ...`);
                        let valArray = null;

                        // è½®è¯¢ç»“æœ
                        for (let i = 0; i < 15; i++) {
                            await new Promise(r => setTimeout(r, 1000));
                            addLog('debug', `ğŸ” æ­£åœ¨ç¬¬ ${i+1} æ¬¡æŸ¥è¯¢ä»»åŠ¡ ${taskId} çš„çŠ¶æ€...`);
                            
                            const statusRes = await fetch(`/admin/dash/cmd?taskId=${taskId}&mode=batchQueryResult`).then(r => r.json());
                            
                            // ä¿®æ­£ï¼šæ ¹æ®æœåŠ¡å™¨å®é™…è¿”å›ç»“æ„ï¼Œæå– status
                            const pollData = statusRes.result || statusRes.data || statusRes;
                            
                            if (pollData.status === 'completed') {
                                addLog('success', `âœ… ä»»åŠ¡ ${taskId} æŸ¥è¯¢å®Œæˆï¼`);
                                // ä¿®æ­£ï¼šæ ¹æ®æœåŠ¡å™¨å®é™…è¿”å›ç»“æ„ï¼Œæå– values
                                const result = pollData.result?.data || pollData.result || {};
                                valArray = result.values || (Array.isArray(result) ? result : []);
                                break;
                            } else if (pollData.status === 'failed') {
                                addLog('error', `âŒ ä»»åŠ¡ ${taskId} æŸ¥è¯¢å¤±è´¥ï¼ˆæœåŠ¡å™¨è¿”å›å¤±è´¥ï¼‰`);
                                break;
                            }
                            
                            if (i === 14) {
                                addLog('warn', `âš ï¸ ä»»åŠ¡ ${taskId} æŸ¥è¯¢è¶…æ—¶ï¼ˆ15ç§’æœªè¿”å›ï¼‰`);
                            }
                        }

                        if (valArray) {
                            for (let i = 0; i < valArray.length; i++) {
                                const code = startAddr + i;
                                if (group.includes(code)) {
                                    allResults.push({ funcCode: code, value: valArray[i] });
                                }
                            }
                        }
                    }

                    if (allResults.length > 0) {
                        addLog('info', `âœ… æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼ŒæˆåŠŸè¯»å– ${allResults.length} ä¸ªå‚æ•°`);
                        allResults.forEach(({ funcCode, value }) => {
                            const fieldId = findFieldIdByFuncCode(funcCode);
                            if (fieldId) {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = formatParamValueForDisplay(funcCode, value, fieldId);
                                }
                            }
                        });
                        if (callback) callback(allResults);
                    } else {
                        addLog('warn', 'âš ï¸ æ‰¹é‡æŸ¥è¯¢æœªæ”¶åˆ°æœ‰æ•ˆè®¾å¤‡å“åº”');
                    }
                } catch (error) {
                    addLog('error', `âŒ æ‰¹é‡æŸ¥è¯¢å¼‚å¸¸: ${error.message}`);
                }
                return;
            }

            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnected'));
                return;
            }

            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnected'));
                return;
            }
            
            if (!funcCodes || funcCodes.length === 0) {
                addLog('warn', 'æ‰¹é‡æŸ¥è¯¢ï¼šåŠŸèƒ½ç åˆ—è¡¨ä¸ºç©º');
                return;
            }
            
            // å¯¹åŠŸèƒ½ç æ’åº
            const sortedCodes = [...funcCodes].sort((a, b) => a - b);
            
            // å°†åŠŸèƒ½ç åˆ†ç»„ä¸ºè¿ç»­çš„æ®µ
            const groups = [];
            let currentGroup = [sortedCodes[0]];
            
            for (let i = 1; i < sortedCodes.length; i++) {
                // å¦‚æœå½“å‰åŠŸèƒ½ç ä¸å‰ä¸€ä¸ªè¿ç»­ï¼ŒåŠ å…¥å½“å‰ç»„
                if (sortedCodes[i] === sortedCodes[i - 1] + 1) {
                    currentGroup.push(sortedCodes[i]);
                } else {
                    // ä¸è¿ç»­ï¼Œå¼€å§‹æ–°ç»„
                    groups.push(currentGroup);
                    currentGroup = [sortedCodes[i]];
                }
            }
            groups.push(currentGroup); // æ·»åŠ æœ€åä¸€ç»„
            
            // å¡«å……æŸ¥è¯¢ç»“æœåˆ°è¾“å…¥æ¡†çš„é€šç”¨å‡½æ•°
            function fillQueryResults(results) {
                if (!results || results.length === 0) {
                    addLog('warn', 'æ‰¹é‡æŸ¥è¯¢å“åº”ä¸ºç©º');
                    return;
                }
                
                // å¦‚æœæä¾›äº†å›è°ƒå‡½æ•°ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°è€Œä¸æ˜¯å¡«å……åˆ°è¾“å…¥æ¡†
                if (callback && typeof callback === 'function') {
                    addLog('info', `ğŸ“¥ æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼Œè°ƒç”¨å›è°ƒå‡½æ•°å¤„ç†${results.length}ä¸ªç»“æœ`);
                    callback(results);
                    return;
                }
                
                // ç¡®ä¿å‚æ•°è®¾ç½®Tabå†…å®¹å·²åŠ è½½
                if (!paramTabsLoaded) {
                    loadParamSettings();
                }
                
                addLog('info', `ğŸ” å¼€å§‹å¡«å……${results.length}ä¸ªæŸ¥è¯¢ç»“æœåˆ°è¾“å…¥æ¡†...`);
                results.forEach(({ funcCode, value }) => {
                    addLog('info', `ğŸ” å¤„ç†ç»“æœï¼šåŠŸèƒ½ç ${funcCode} = ${value}`);
                    const fieldId = findFieldIdByFuncCode(funcCode);
                    if (fieldId) {
                        addLog('info', `ğŸ” æ‰¾åˆ°å­—æ®µID: ${fieldId}`);
                        const element = document.getElementById(fieldId);
                        if (element) {
                            // ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°å°†æ•°å€¼è½¬æ¢ä¸ºå¯¹åº”çš„æ–‡å­—æ˜¾ç¤º
                            element.value = formatParamValueForDisplay(funcCode, value, fieldId);
                            addLog('info', `âœ… å·²æ›´æ–° ${fieldId} (åŠŸèƒ½ç ${funcCode}) = ${element.value}`);
                        } else {
                            addLog('warn', `âš ï¸ æœªæ‰¾åˆ°å…ƒç´ ID: ${fieldId}ï¼Œå°è¯•å»¶è¿Ÿå¡«å……...`);
                            // å»¶è¿Ÿ100msåé‡è¯•ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                            setTimeout(() => {
                                const retryElement = document.getElementById(fieldId);
                                if (retryElement) {
                                    if (fieldId === 'in_ct_ratio' || fieldId === 'dev_ct_ratio') {
                                        retryElement.value = value / 10;
                                    } else if (fieldId === 'power_factor') {
                                        retryElement.value = (value / 100).toFixed(2);
                                    } else {
                                        retryElement.value = value;
                                    }
                                    addLog('info', `âœ… [å»¶è¿Ÿ] å·²æ›´æ–° ${fieldId} (åŠŸèƒ½ç ${funcCode}) = ${retryElement.value}`);
                                } else {
                                    addLog('error', `âŒ [å»¶è¿Ÿ] ä»æœªæ‰¾åˆ°å…ƒç´ ID: ${fieldId}`);
                                }
                            }, 100);
                        }
                    } else {
                        addLog('warn', `âš ï¸ æœªæ‰¾åˆ°åŠŸèƒ½ç ${funcCode}å¯¹åº”çš„å­—æ®µID`);
                    }
                });
                addLog('info', `âœ… æ‰¹é‡æŸ¥è¯¢å®Œæˆï¼Œå·²æ›´æ–°${results.length}ä¸ªå‚æ•°`);
            }
            
            // å¦‚æœåªæœ‰ä¸€ç»„ä¸”è¿ç»­ï¼Œä½¿ç”¨åŸæ¥çš„é€»è¾‘
            if (groups.length === 1) {
                const startFuncCode = groups[0][0];
                const count = groups[0].length;
                const results = await batchQuerySingle(startFuncCode, count);
                fillQueryResults(results);
                return results;
            }
            
            // å¤šç»„ä¸è¿ç»­ï¼Œä¾æ¬¡æŸ¥è¯¢
            addLog('info', `ğŸ“¤ æ‰¹é‡æŸ¥è¯¢ ${funcCodes.length} ä¸ªå‚æ•°ï¼Œåˆ†æˆ ${groups.length} ç»„æŸ¥è¯¢...`);
            
            const allResults = [];
            for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                const startFuncCode = group[0];
                const count = group.length;
                
                addLog('info', `ğŸ“¤ ç¬¬ ${i + 1}/${groups.length} ç»„ï¼šæŸ¥è¯¢åŠŸèƒ½ç  ${startFuncCode}-${startFuncCode + count - 1} (${count}ä¸ª)`);
                
                try {
                    const results = await batchQuerySingle(startFuncCode, count);
                    if (results && results.length > 0) {
                        allResults.push(...results);
                    }
                    // ç»„ä¹‹é—´ç­‰å¾…500msï¼Œé¿å…è®¾å¤‡å¤„ç†ä¸è¿‡æ¥
                    if (i < groups.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                } catch (error) {
                    addLog('error', `ç¬¬ ${i + 1} ç»„æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                }
            }
            
            // æ›´æ–°æ‰€æœ‰å­—æ®µæˆ–è°ƒç”¨å›è°ƒå‡½æ•°
            fillQueryResults(allResults);
            return allResults;
        }
        
        // å•æ¬¡æ‰¹é‡æŸ¥è¯¢ï¼ˆè¿ç»­åŠŸèƒ½ç ï¼‰
        async function batchQuerySingle(startFuncCode, count) {
            const serial = parseInt(document.getElementById('deviceSerial').value) || 1;
            const cmdHex = buildBatchQueryCmd(serial, startFuncCode, count);
            
            addLog('info', `ğŸ“¤ æ‰¹é‡æŸ¥è¯¢å‘½ä»¤ï¼Œå†…å±‚æŒ‡ä»¤ï¼š${cmdHex.toUpperCase()}`);
            
            // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
            sendWithOuterProtocol(cmdHex, '02');
            
            // ç­‰å¾…æ‰¹é‡æŸ¥è¯¢å“åº”
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    if (pendingBatchQuery) {
                        addLog('warn', `æ‰¹é‡æŸ¥è¯¢è¶…æ—¶ï¼ˆåŠŸèƒ½ç ${startFuncCode}ï¼Œ${count}ä¸ªï¼‰`);
                        pendingBatchQuery = null;
                        reject(new Error('æ‰¹é‡æŸ¥è¯¢è¶…æ—¶'));
                    }
                }, 5000);
                
                pendingBatchQuery = {
                    startFuncCode: startFuncCode,
                    count: count,
                    callback: (results) => {
                        clearTimeout(timeout);
                        pendingBatchQuery = null;
                        if (results && results.length > 0) {
                            resolve(results);
                        } else {
                            reject(new Error('æ‰¹é‡æŸ¥è¯¢å“åº”ä¸ºç©º'));
                        }
                    },
                    timestamp: Date.now()
                };
            });
        }
        
        // æ‰¹é‡ä¿å­˜ï¼ˆä½¿ç”¨E1åè®®ï¼‰
        async function batchSave(funcCodes, providedValues = null) {
            // å¦‚æœæ˜¯æœåŠ¡å™¨æ¨¡å¼ï¼Œé€šè¿‡ API ä¿å­˜
            if (isUsingServerMode || window.isUsingServerMode) {
                const urlParams = new URLSearchParams(window.location.search);
                const devId = urlParams.get('id');
                if (!devId) {
                    addLog('error', 'âŒ æœåŠ¡å™¨æ¨¡å¼ä¸‹æ‰¹é‡ä¿å­˜éœ€è¦ URL åŒ…å« id å‚æ•°');
                    return;
                }

                // å‡†å¤‡æ‰¹é‡ä¿å­˜æ•°æ®
                const batchData = [];
                const sortedCodes = [...funcCodes].sort((a, b) => a - b);
                
                if (providedValues && Array.isArray(providedValues)) {
                    sortedCodes.forEach((code, index) => {
                        if (providedValues[index] !== undefined && providedValues[index] !== null) {
                            batchData.push({ addr: code, val: providedValues[index] });
                        }
                    });
                } else {
                    for (const code of sortedCodes) {
                        const fieldId = findFieldIdByFuncCode(code);
                        if (fieldId) {
                            const element = document.getElementById(fieldId);
                            if (element) {
                                const val = parseDisplayValueToNumber(code, element.value, fieldId);
                                if (val !== null && val !== undefined) {
                                    batchData.push({ addr: code, val: val });
                                }
                            }
                        }
                    }
                }

                if (batchData.length === 0) {
                    addLog('warn', 'âš ï¸ æ‰¹é‡ä¿å­˜ï¼šæ²¡æœ‰è¾“å…¥æ•°å€¼');
                    alert('è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©éœ€è¦ä¿å­˜çš„å‚æ•°å€¼');
                    return;
                }

                addLog('info', `ğŸ“¡ æœåŠ¡å™¨æ¨¡å¼ï¼šæ­£åœ¨æ‰¹é‡ä¸‹å‘ ${batchData.length} ä¸ªå‚æ•°...`);
                try {
                    const res = await fetch(`/admin/dash/batch-save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: devId, data: batchData, mode: 'batch_save' })
                    }).then(r => r.json());

                    if (res.code === 0) {
                        addLog('info', 'âœ… æ‰¹é‡ä¿å­˜æˆåŠŸï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ·æ–°éªŒè¯...');
                        // ç¨å¾®åŠ é•¿å»¶è¿Ÿä»¥è·å¾—çœŸå®åé¦ˆ
                        setTimeout(() => batchQuery(funcCodes), 3000);
                    } else {
                        addLog('error', `âŒ æ‰¹é‡ä¿å­˜å¤±è´¥: ${res.msg || 'æœªçŸ¥é”™è¯¯'}`);
                        alert('ä¿å­˜å¤±è´¥: ' + (res.msg || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (error) {
                    addLog('error', `âŒ æ‰¹é‡ä¿å­˜è¯·æ±‚å¼‚å¸¸: ${error.message}`);
                }
                return;
            }

            if (!ws || ws.readyState !== 1) {
                alert(t('alertNotConnected'));
                return;
            }
            
            if (!funcCodes || funcCodes.length === 0) {
                addLog('warn', 'æ‰¹é‡ä¿å­˜ï¼šåŠŸèƒ½ç åˆ—è¡¨ä¸ºç©º');
                return;
            }
            
            const sortedCodes = [...funcCodes].sort((a, b) => a - b);
            const startFuncCode = sortedCodes[0];
            
            // å¦‚æœæä¾›äº†å€¼æ•°ç»„ï¼Œéœ€è¦ç¡®ä¿å€¼çš„é¡ºåºä¸æ’åºåçš„åŠŸèƒ½ç é¡ºåºå¯¹åº”
            let values = [];
            if (providedValues && Array.isArray(providedValues)) {
                // ç¡®ä¿valuesæ•°ç»„é•¿åº¦ä¸funcCodesä¸€è‡´
                if (providedValues.length === funcCodes.length) {
                    // æ£€æŸ¥åŠŸèƒ½ç æ˜¯å¦å·²ç»æ’åº
                    const isAlreadySorted = funcCodes.every((code, index) => 
                        index === 0 || code > funcCodes[index - 1]
                    );
                    
                    if (isAlreadySorted) {
                        // å¦‚æœåŠŸèƒ½ç å·²ç»æ’åºï¼Œç›´æ¥ä½¿ç”¨æä¾›çš„å€¼ï¼ˆå‡è®¾å€¼å·²ç»æŒ‰åŠŸèƒ½ç é¡ºåºæ’åˆ—ï¼‰
                        values = [...providedValues];
                        addLog('info', `ğŸ“ åŠŸèƒ½ç å·²æ’åºï¼Œç›´æ¥ä½¿ç”¨æä¾›çš„å€¼æ•°ç»„`);
                    } else {
                        // å¦‚æœåŠŸèƒ½ç æœªæ’åºï¼Œéœ€è¦é‡æ–°æ˜ å°„
                        const valueMap = new Map();
                        funcCodes.forEach((code, index) => {
                            valueMap.set(code, providedValues[index]);
                        });
                        
                        // æŒ‰ç…§æ’åºåçš„åŠŸèƒ½ç é¡ºåºé‡æ–°æ’åˆ—å€¼
                        values = sortedCodes.map(code => valueMap.get(code));
                        addLog('info', `ğŸ“ åŠŸèƒ½ç æœªæ’åºï¼Œå·²æŒ‰åŠŸèƒ½ç é¡ºåºé‡æ–°æ’åˆ—å€¼`);
                    }
                    
                    addLog('info', `   åŸå§‹å€¼ï¼š${providedValues.join(', ')}`);
                    addLog('info', `   åŠŸèƒ½ç ï¼š${funcCodes.join(', ')}`);
                    addLog('info', `   æ’åºååŠŸèƒ½ç ï¼š${sortedCodes.join(', ')}`);
                    addLog('info', `   æœ€ç»ˆå€¼ï¼š${values.join(', ')}`);
                } else {
                    addLog('warn', `æ‰¹é‡ä¿å­˜ï¼šæä¾›çš„å€¼æ•°ç»„é•¿åº¦(${providedValues.length})ä¸åŠŸèƒ½ç æ•°ç»„é•¿åº¦(${funcCodes.length})ä¸ä¸€è‡´ï¼Œä»DOMè¯»å–å€¼`);
                    providedValues = null; // æ ‡è®°ä¸ºæœªæä¾›ï¼Œä»DOMè¯»å–
                }
            }
            
            // å¦‚æœæ²¡æœ‰æä¾›å€¼ï¼Œä»DOMæ”¶é›†æ‰€æœ‰è¦ä¿å­˜çš„å€¼
            if (!providedValues) {
                for (const code of sortedCodes) {
                    const fieldId = findFieldIdByFuncCode(code);
                    if (fieldId) {
                        const element = document.getElementById(fieldId);
                        if (element && element.value !== '' && element.value !== null && element.value !== undefined) {
                            // ä½¿ç”¨åå‘å‡½æ•°å°†æ˜¾ç¤ºå€¼ï¼ˆå¯èƒ½æ˜¯æ–‡å­—ï¼‰è½¬æ¢å›æ•°å€¼
                            const value = parseDisplayValueToNumber(code, element.value, fieldId);
                            if (value !== null && value !== undefined && !isNaN(value) && value >= 0 && value <= 65535) {
                                values.push(value);
                            } else {
                                addLog('warn', `åŠŸèƒ½ç ${code}çš„å€¼æ— æ•ˆï¼š${element.value}`);
                                // å¦‚æœå€¼æ— æ•ˆï¼Œç”¨0å¡«å……ä»¥ä¿æŒè¿ç»­æ€§
                                values.push(0);
                            }
                        } else {
                            addLog('warn', `åŠŸèƒ½ç ${code}æ²¡æœ‰è¾“å…¥å€¼ï¼Œä½¿ç”¨0`);
                            values.push(0);
                        }
                    } else {
                        addLog('warn', `åŠŸèƒ½ç ${code}æ²¡æœ‰å¯¹åº”çš„å­—æ®µID`);
                        values.push(0);
                    }
                }
            }
            
            if (values.length === 0) {
                addLog('warn', 'æ‰¹é‡ä¿å­˜ï¼šæ²¡æœ‰æœ‰æ•ˆçš„å€¼');
                return;
            }
            
            const count = values.length;
            addLog('info', `ğŸ“¤ æ‰¹é‡ä¿å­˜ ${count} ä¸ªå‚æ•°ï¼ˆèµ·å§‹åŠŸèƒ½ç ï¼š${startFuncCode}ï¼‰...`);
            
            const serial = parseInt(document.getElementById('deviceSerial').value) || 1;
            
            // éªŒè¯å€¼æ•°ç»„
            addLog('info', `   å‡†å¤‡å‘é€çš„å€¼æ•°ç»„ï¼š${values.join(', ')}`);
            addLog('info', `   å¯¹åº”çš„åŠŸèƒ½ç ï¼š${sortedCodes.join(', ')}`);
            
            // ä½¿ç”¨æ–°çš„æ ¼å¼ï¼šä¼ å…¥åŠŸèƒ½ç æ•°ç»„å’Œå€¼æ•°ç»„çš„é…å¯¹
            const cmdHex = buildBatchSaveCmd(serial, sortedCodes, values);
            
            addLog('info', `ğŸ“¤ æ‰¹é‡ä¿å­˜å‘½ä»¤ï¼š${cmdHex.toUpperCase()}`);
            // ä½¿ç”¨å®é™…çš„åŠŸèƒ½ç é¡ºåºæ˜¾ç¤ºæ—¥å¿—
            addLog('info', `   ä¿å­˜çš„å€¼ï¼š${values.map((v, i) => `åŠŸèƒ½ç ${sortedCodes[i]}=${v}`).join(', ')}`);
            
            // è§£æå‘½ä»¤ä¸­çš„å€¼ï¼ŒéªŒè¯æ˜¯å¦æ­£ç¡®ï¼ˆæ–°æ ¼å¼ï¼šAA [åœ°å€ç ] [é•¿åº¦] E1 [åœ°å€1][å€¼1][åœ°å€2][å€¼2]... [CRC]ï¼‰
            const cmdBytes = cmdHex.match(/.{2}/g).map(b => parseInt(b, 16));
            if (cmdBytes.length >= 7) {
                const cmdPairs = [];
                // æ•°æ®ä»ç¬¬4ä¸ªå­—èŠ‚å¼€å§‹ï¼ˆè·³è¿‡AAã€åœ°å€ç ã€é•¿åº¦ã€E1ï¼‰
                let offset = 4; // E1ä¹‹å
                for (let i = 0; i < count && offset + 3 < cmdBytes.length - 2; i++) {
                    // æ¯ä¸ªé…å¯¹ï¼šåœ°å€(2å­—èŠ‚) + å€¼(2å­—èŠ‚)
                    const addr = (cmdBytes[offset] << 8) | cmdBytes[offset + 1];
                    const value = (cmdBytes[offset + 2] << 8) | cmdBytes[offset + 3];
                    cmdPairs.push({ addr, value });
                    offset += 4;
                }
                if (cmdPairs.length > 0) {
                    addLog('info', `   å‘½ä»¤ä¸­çš„åœ°å€+å€¼é…å¯¹ï¼š${cmdPairs.map(p => `åœ°å€${p.addr}=${p.value}`).join(', ')}`);
                }
            }
            
            // ä½¿ç”¨å¤–å±‚åè®®å°è£…å‘é€
            sendWithOuterProtocol(cmdHex, '02');
            
            addLog('info', `âœ… æ‰¹é‡ä¿å­˜å‘½ä»¤å·²å‘é€`);
        }
        
        // æŸ¥è¯¢åŠŸç‡å› æ•°ï¼ˆåŠŸèƒ½ç 280ï¼‰
        function queryPowerFactor() {
            queryParam(280, 'power_factor');
        }
        
        // æ ¼å¼åŒ–å‚æ•°å€¼æ˜¾ç¤ºï¼ˆå°†æ•°å€¼è½¬æ¢ä¸ºä¸‹æ‹‰æ¡†å€¼æˆ–æ–‡å­—ï¼‰
        function formatParamValueForDisplay(funcCode, value, fieldId) {
            const numValue = parseInt(value);
            const element = document.getElementById(fieldId);
            const isSelect = element && element.tagName === 'SELECT';
            
            // ä½¿èƒ½ç±»å‚æ•°ï¼šåŠŸèƒ½ç 9(DIå¯åœä½¿èƒ½)ã€16(è®¾å¤‡é‡‡æ ·ä½¿èƒ½)ã€512(è‡ªå¯åœä½¿èƒ½)
            if (funcCode === 9 || funcCode === 16 || funcCode === 512 || 
                fieldId === 'di_enable' || fieldId === 'dev_sample_enable' || fieldId === 'auto_enable' || fieldId === 'auto_enable_system') {
                // ä¸‹æ‹‰æ¡†è¿”å›æ•°å­—å­—ç¬¦ä¸²ï¼Œè¾“å…¥æ¡†è¿”å›æ–‡å­—
                if (isSelect) {
                    return numValue.toString();
                }
                if (numValue === 0) return 'ä¸ä½¿èƒ½';
                if (numValue === 1) return 'ä½¿èƒ½';
            }
            
            // è¾“å…¥ç”µæµé‡‡æ ·ä½ç½®ï¼ˆåŠŸèƒ½ç 17ï¼‰ï¼š0-è´Ÿè½½ä¾§ï¼Œ1-ç”µç½‘ä¾§
            if (funcCode === 17 || fieldId === 'in_sample_pos') {
                if (isSelect) {
                    return numValue.toString();
                }
                if (numValue === 0) return 'è´Ÿè½½ä¾§';
                if (numValue === 1) return 'ç”µç½‘ä¾§';
            }
            
            // è¾“å…¥ç”µæµé‡‡æ ·æ–¹å‘ï¼ˆåŠŸèƒ½ç 15ï¼‰ï¼š0-æµå‡ºç”µç½‘ï¼Œ1-æµå…¥ç”µç½‘
            if (funcCode === 15 || fieldId === 'in_sample_dir') {
                if (isSelect) {
                    return numValue.toString();
                }
                if (numValue === 0) return 'æµå‡ºç”µç½‘';
                if (numValue === 1) return 'æµå…¥ç”µç½‘';
            }
            
            // è®¾å¤‡ç”µæµé‡‡æ ·ä½ç½®ï¼ˆåŠŸèƒ½ç 13ï¼‰ï¼š0-æŸœä½“ï¼Œ1-ç”µå®¹
            if (funcCode === 13 || fieldId === 'dev_sample_pos') {
                if (isSelect) {
                    return numValue.toString();
                }
                if (numValue === 0) return 'æŸœä½“';
                if (numValue === 1) return 'ç”µå®¹';
            }
            
            // è®¾å¤‡ç”µæµé‡‡æ ·æ–¹å‘ï¼ˆåŠŸèƒ½ç 14ï¼‰ï¼š0-æµå‡ºç”µç½‘ï¼Œ1-æµå…¥ç”µç½‘
            if (funcCode === 14 || fieldId === 'dev_sample_dir') {
                if (isSelect) {
                    return numValue.toString();
                }
                if (numValue === 0) return 'æµå‡ºç”µç½‘';
                if (numValue === 1) return 'æµå…¥ç”µç½‘';
            }
            
            // åŠŸç‡å› æ•°éœ€è¦é™¤ä»¥100æ˜¾ç¤º
            if (funcCode === 280 || fieldId === 'power_factor') {
                return (value / 100).toFixed(2);
            }
            
            // CTå˜æ¯”éœ€è¦é™¤ä»¥10æ˜¾ç¤º
            if (funcCode === 241 || funcCode === 242 || fieldId === 'in_ct_ratio' || fieldId === 'dev_ct_ratio') {
                return (value / 10).toString();
            }
            
            // å…¶ä»–å‚æ•°ä¿æŒåŸå€¼
            return value.toString();
        }
        
        // å°†æ˜¾ç¤ºå€¼è½¬æ¢å›æ•°å€¼ï¼ˆç”¨äºä¿å­˜ï¼‰
        function parseDisplayValueToNumber(funcCode, displayValue, fieldId) {
            if (!displayValue || displayValue === '') return null;
            
            // å¯¹äºä¸‹æ‹‰æ¡†ï¼Œvalueå·²ç»æ˜¯æ•°å­—å­—ç¬¦ä¸²ï¼Œç›´æ¥è½¬æ¢å³å¯
            const element = document.getElementById(fieldId);
            if (element && element.tagName === 'SELECT') {
                // ä¸‹æ‹‰æ¡†çš„å€¼ç›´æ¥æ˜¯æ•°å­—å­—ç¬¦ä¸²ï¼Œç›´æ¥è½¬æ¢
                const num = parseInt(displayValue);
                if (!isNaN(num)) return num;
            }
            
            // ä½¿èƒ½ç±»å‚æ•°ï¼ˆå…¼å®¹è¾“å…¥æ¡†çš„æ–‡å­—è¾“å…¥ï¼‰
            if (funcCode === 9 || funcCode === 16 || funcCode === 512 || 
                fieldId === 'di_enable' || fieldId === 'dev_sample_enable' || fieldId === 'auto_enable' || fieldId === 'auto_enable_system') {
                if (displayValue === 'ä¸ä½¿èƒ½' || displayValue === '0') return 0;
                if (displayValue === 'ä½¿èƒ½' || displayValue === '1') return 1;
            }
            
            // è¾“å…¥ç”µæµé‡‡æ ·ä½ç½®ï¼ˆå…¼å®¹è¾“å…¥æ¡†çš„æ–‡å­—è¾“å…¥ï¼‰
            if (funcCode === 17 || fieldId === 'in_sample_pos') {
                if (displayValue === 'è´Ÿè½½ä¾§' || displayValue === '0') return 0;
                if (displayValue === 'ç”µç½‘ä¾§' || displayValue === '1') return 1;
            }
            
            // è¾“å…¥ç”µæµé‡‡æ ·æ–¹å‘ï¼ˆå…¼å®¹è¾“å…¥æ¡†çš„æ–‡å­—è¾“å…¥ï¼‰
            if (funcCode === 15 || fieldId === 'in_sample_dir') {
                if (displayValue === 'æµå‡ºç”µç½‘' || displayValue === '0') return 0;
                if (displayValue === 'æµå…¥ç”µç½‘' || displayValue === '1') return 1;
            }
            
            // è®¾å¤‡ç”µæµé‡‡æ ·ä½ç½®ï¼ˆå…¼å®¹è¾“å…¥æ¡†çš„æ–‡å­—è¾“å…¥ï¼‰
            if (funcCode === 13 || fieldId === 'dev_sample_pos') {
                if (displayValue === 'æŸœä½“' || displayValue === '0') return 0;
                if (displayValue === 'ç”µå®¹' || displayValue === '1') return 1;
            }
            
            // è®¾å¤‡ç”µæµé‡‡æ ·æ–¹å‘ï¼ˆå…¼å®¹è¾“å…¥æ¡†çš„æ–‡å­—è¾“å…¥ï¼‰
            if (funcCode === 14 || fieldId === 'dev_sample_dir') {
                if (displayValue === 'æµå‡ºç”µç½‘' || displayValue === '0') return 0;
                if (displayValue === 'æµå…¥ç”µç½‘' || displayValue === '1') return 1;
            }
            
            // åŠŸç‡å› æ•°éœ€è¦ä¹˜ä»¥100
            if (funcCode === 280 || fieldId === 'power_factor') {
                const num = parseFloat(displayValue);
                return isNaN(num) ? null : Math.round(num * 100);
            }
            
            // CTå˜æ¯”éœ€è¦ä¹˜ä»¥10
            if (funcCode === 241 || funcCode === 242 || fieldId === 'in_ct_ratio' || fieldId === 'dev_ct_ratio') {
                const num = parseFloat(displayValue);
                return isNaN(num) ? null : Math.round(num * 10);
            }
            
            // å…¶ä»–å‚æ•°ç›´æ¥è½¬æ¢
            const num = parseInt(displayValue);
            return isNaN(num) ? null : num;
        }
        
        // æ ¹æ®åŠŸèƒ½ç æŸ¥æ‰¾å­—æ®µID
        function findFieldIdByFuncCode(code) {
            // ç‰¹æ®Šå¤„ç†åŠŸèƒ½ç 512ï¼šæ ¹æ®å½“å‰æ‰€åœ¨Tabå†³å®šå­—æ®µID
            // currentParamTabIndex === 1 è¡¨ç¤ºå½“å‰å¤„äºâ€œç³»ç»Ÿå‚æ•°â€Tab
            if (code === 512 && typeof currentParamTabIndex !== 'undefined' && currentParamTabIndex === 1) {
                return 'auto_enable_system';
            }
            
            const mapping = {
                9: 'di_enable',
                512: 'auto_enable',
                513: 'comp_mode',
                151: 'parallel_cabinets',
                161: 'module_capacity_ratio',
                280: 'power_factor',
                13: 'dev_sample_pos',
                14: 'dev_sample_dir',
                15: 'in_sample_dir',
                16: 'dev_sample_enable',
                17: 'in_sample_pos',
                241: 'in_ct_ratio',
                242: 'dev_ct_ratio',
                265: 'harm_group1',
                266: 'harm_group2',
                267: 'harm_group3',
                268: 'harm_group4',
                269: 'harm_group5',
                270: 'harm_group6',
                271: 'harm_group7',
                272: 'harm_group8'
            };
            return mapping[code];
        }
        
        // æœ¬åœ°å­˜å‚¨ç®¡ç†
        function saveConfigToLocal() {
            try {
                const config = {
                    connectMode: document.getElementById('connectMode').value,
                    bridgeIp: document.getElementById('bridgeIp').value,
                    deviceIp: document.getElementById('deviceIp').value,
                    deviceSerial: document.getElementById('deviceSerial').value
                };
                localStorage.setItem('deviceDirectConfig', JSON.stringify(config));
                addLog('info', '[ç³»ç»Ÿ] é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            } catch (e) {
                console.warn(translateInline('ä¿å­˜é…ç½®å¤±è´¥:', 'Failed to save configuration:'), e);
            }
        }
        
        function loadConfigFromLocal() {
            try {
                const saved = localStorage.getItem('deviceDirectConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    document.getElementById('connectMode').value = config.connectMode || 'bridge';
                    document.getElementById('bridgeIp').value = config.bridgeIp || '10.10.100.101:18900';
                    document.getElementById('deviceIp').value = config.deviceIp || '10.10.100.254:18899';
                    document.getElementById('deviceSerial').value = config.deviceSerial || '1';
                    updateConnectConfig();
                    addLog('info', t('logConfigRestored'));
                }
            } catch (e) {
                console.warn(translateInline('åŠ è½½é…ç½®å¤±è´¥:', 'Failed to load configuration:'), e);
            }
        }
        
        // ç›‘å¬é…ç½®å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
        document.addEventListener('DOMContentLoaded', () => {
            loadConfigFromLocal();
            
            // ç›‘å¬é…ç½®å˜åŒ–
            ['connectMode', 'bridgeIp', 'deviceIp', 'deviceSerial'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', saveConfigToLocal);
                }
            });
        });
        
        // è‡ªåŠ¨æ£€æµ‹å±€åŸŸç½‘ç¯å¢ƒå¹¶è®¾ç½®ç›´è¿
        async function autoDetectAndConnect() {
            try {
                // æ£€æµ‹å½“å‰è®¿é—®åœ°å€
                const hostname = window.location.hostname;
                
                // å¦‚æœä»è®¾å¤‡å±€åŸŸç½‘è®¿é—®ï¼ˆ10.10.100.xï¼‰ï¼Œè‡ªåŠ¨é…ç½®æ¡¥æ¥æœåŠ¡
                if (hostname.startsWith('10.10.100')) {
                    addLog('info', translateInline(`[è‡ªåŠ¨æ£€æµ‹] ğŸŒ æ£€æµ‹åˆ°è®¾å¤‡å±€åŸŸç½‘è®¿é—® (æœåŠ¡å™¨: ${hostname})`, `[Auto Detect] ğŸŒ Device LAN detected (server: ${hostname})`));
                    
                    // è‡ªåŠ¨è®¾ç½®ä¸ºæ¡¥æ¥æ¨¡å¼ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨çš„æ¡¥æ¥æœåŠ¡
                    document.getElementById('connectMode').value = 'bridge';
                    document.getElementById('bridgeIp').value = `${hostname}:18900`;
                    updateConnectConfig();
                    
                    addLog('info', translateInline(`[è‡ªåŠ¨æ£€æµ‹] âœ… å·²é…ç½®æ¡¥æ¥æ¨¡å¼ (${hostname}:18900 â†’ 10.10.100.254:18899)`, `[Auto Detect] âœ… Bridge mode configured (${hostname}:18900 â†’ 10.10.100.254:18899)`));
                } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    addLog('info', translateInline('[è‡ªåŠ¨æ£€æµ‹] ğŸ  æœ¬åœ°è®¿é—®ï¼Œä½¿ç”¨æ¡¥æ¥æ¨¡å¼', '[Auto Detect] ğŸ  Local access, using bridge mode'));
                    // ä¿æŒé»˜è®¤æ¡¥æ¥æ¨¡å¼
                } else if (!hostname || hostname === '') {
                    // ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ï¼ˆfile://åè®®ï¼‰
                    addLog('info', translateInline('[è‡ªåŠ¨æ£€æµ‹] ğŸ“ æ£€æµ‹åˆ°ç›´æ¥æ‰“å¼€æ–‡ä»¶æ¨¡å¼', '[Auto Detect] ğŸ“ Detected local file mode'));
                    addLog('info', translateInline('[æç¤º] ğŸ’¡ å°†å°è¯•ç›´æ¥è¿æ¥è®¾å¤‡ï¼Œå¦‚å¤±è´¥è¯·æ‰‹åŠ¨é…ç½®', '[Tip] ğŸ’¡ Trying to connect directly to the device, if fails please manually configure'));
                    
                    // å°è¯•ç›´æ¥è¿æ¥è®¾å¤‡ï¼ˆå‡è®¾ç”¨æˆ·å·²è¿æ¥è®¾å¤‡WiFiï¼‰
                    document.getElementById('connectMode').value = 'direct';
                    document.getElementById('deviceIp').value = '10.10.100.254:18899';
                    updateConnectConfig();
                    
                    addLog('info', translateInline('[è‡ªåŠ¨æ£€æµ‹] âœ… å·²é…ç½®ç›´è¿æ¨¡å¼ (10.10.100.254:18899)', '[Auto Detect] âœ… Direct mode configured (10.10.100.254:18899)'));
                    addLog('info', translateInline('[æç¤º] âš ï¸ å¦‚æœæ— æ³•è¿æ¥ï¼Œè¯·ç¡®ä¿å·²è¿æ¥è®¾å¤‡WiFi', '[Tip] âš ï¸ If unable to connect, please ensure device Wi-Fi is connected'));
                } else {
                    addLog('info', translateInline(`[è‡ªåŠ¨æ£€æµ‹] å½“å‰è®¿é—®åœ°å€: ${hostname}`, `[Auto Detect] Current host: ${hostname}`));
                }
                
                // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨è¿æ¥
                setTimeout(() => {
                    connectDevice();
                }, 1000);
            } catch (error) {
                console.warn(translateInline('è‡ªåŠ¨æ£€æµ‹å¤±è´¥:', 'Auto detect failed:'), error);
                // å¤±è´¥åˆ™ç›´æ¥è¿æ¥
                setTimeout(() => {
                    connectDevice();
                }, 1000);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ - è‡ªåŠ¨è¿æ¥
        window.onload = () => {
            addLog('info', t('logPageReady'));
            addLog('info', t('logOfflineTip'));
             
            // å¤„ç† URL å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const serialParam = urlParams.get('serial');
            const modeParam = urlParams.get('mode');
            
            if (serialParam) {
                const serialInput = document.getElementById('deviceSerial');
                if (serialInput) {
                    serialInput.value = serialParam;
                    addLog('info', `[ç³»ç»Ÿ] ä» URL åŠ è½½è®¾å¤‡åºåˆ—å·: ${serialParam}`);
                }
            }
            
            if (modeParam === 'server') {
                addLog('info', '[ç³»ç»Ÿ] è‡ªåŠ¨åˆ‡æ¢åˆ°æœåŠ¡å™¨æ¨¡å¼');
                switchToServerMode();
            } else if (modeParam === 'bridge' || modeParam === 'direct') {
                const connectMode = document.getElementById('connectMode');
                if (connectMode) {
                    connectMode.value = modeParam;
                    updateConnectConfig();
                }
                connectDevice();
            } else {
                // é»˜è®¤é€»è¾‘
                autoDetectAndConnect();
            }

            // æ›´æ–°æ‰‹æœºè®¿é—®åœ°å€æ˜¾ç¤º
            updateMobileAccessUrl().catch(() => {});

            // åº”ç”¨ç§»åŠ¨ç«¯æ ·å¼
            applyMobileStyles();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', () => {
                applyMobileStyles();
            });
        };
        
        // è·å–æœ¬åœ°IPåœ°å€ï¼ˆä½¿ç”¨WebRTCï¼Œç±»ä¼¼ipconfig | findstr IPv4çš„æ•ˆæœï¼‰
        async function getLocalIPAddress() {
            return new Promise((resolve) => {
                const RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
                if (!RTCPeerConnection) {
                    resolve(null);
                    return;
                }
                
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                const ipAddresses = [];
                
                pc.createDataChannel('');
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        const candidate = event.candidate.candidate;
                        // åŒ¹é…IPv4åœ°å€ï¼ˆç±»ä¼¼ipconfig | findstr IPv4çš„ç»“æœï¼‰
                        const match = candidate.match(/([0-9]{1,3}\.){3}[0-9]{1,3}/);
                        if (match) {
                            const ip = match[0];
                            // æ’é™¤æœ¬åœ°å›ç¯åœ°å€å’Œæ— æ•ˆåœ°å€
                            if (ip !== '127.0.0.1' && !ip.startsWith('0.0.0.0') && !ip.startsWith('169.254.')) {
                                // ä¼˜å…ˆé€‰æ‹©10.10.100.xç½‘æ®µçš„IP
                                if (ip.startsWith('10.10.100.')) {
                                    pc.close();
                                    resolve(ip);
                                    return;
                                }
                                ipAddresses.push(ip);
                            }
                        }
                    } else {
                        // æ²¡æœ‰æ›´å¤šå€™é€‰åœ°å€ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„IPï¼Œæˆ–ä¼˜å…ˆé€‰æ‹©10.10.100.x
                        pc.close();
                        const preferredIP = ipAddresses.find(ip => ip.startsWith('10.10.100.'));
                        resolve(preferredIP || ipAddresses[0] || null);
                    }
                };
                
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .catch(() => {
                        pc.close();
                        resolve(null);
                    });
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    pc.close();
                    const preferredIP = ipAddresses.find(ip => ip.startsWith('10.10.100.'));
                    resolve(preferredIP || ipAddresses[0] || null);
                }, 3000);
            });
        }
        
        // æ›´æ–°æ‰‹æœºè®¿é—®åœ°å€æ˜¾ç¤º
        async function updateMobileAccessUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const search = window.location.search;
            let displayHostname = hostname;
            
            // é»˜è®¤ä¼˜å…ˆä½¿ç”¨å½“å‰è®¿é—®çš„åŸŸå/IP
            if (!hostname || hostname === 'localhost' || hostname === '127.0.0.1') {
                // å¦‚æœæ˜¯æœ¬åœ°è®¿é—®ï¼Œæä¾›ä¸€ä¸ªè®¾å¤‡é»˜è®¤IPä½œä¸ºå‚è€ƒ
                displayHostname = '10.10.100.100';
            }
            
            // æ„é€ å®Œæ•´URLï¼Œä¿ç•™å‚æ•°ï¼ˆå¦‚ id, serial, mode ç­‰ï¼‰
            const url = `http://${displayHostname}:${port}/device_direct.html${search}`;
            
            const urlElement = document.getElementById('mobileUrlText');
            if (urlElement) {
                urlElement.textContent = url;
            }
        }
        
        async function showMobileAccess() {
            const panel = document.getElementById('mobileAccessPanel');
            const btn = document.getElementById('btnMobile');
            if (!panel) {
                return;
            }

            await updateMobileAccessUrl();

            const isActive = !panel.classList.contains('active');
            panel.classList.toggle('active', isActive);

            if (btn) {
                btn.classList.toggle('active', isActive);
            }

            if (isActive) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function hideMobileAccess() {
            const panel = document.getElementById('mobileAccessPanel');
            const btn = document.getElementById('btnMobile');
            if (panel) {
                // æ·»åŠ å…³é—­åŠ¨ç”»
                panel.style.animation = 'jellyCollapse 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
                setTimeout(() => {
                    panel.classList.remove('active');
                    panel.style.animation = '';
                }, 300);
            }
            if (btn) {
                btn.classList.remove('active');
            }
        }

        function translateInline(zhText, enText) {
            return currentLang === 'en' ? enText : zhText;
        }
        
        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('preferredLanguage', lang);
            updatePageLanguage();
        }
    </script>
    
</body>
</html>

